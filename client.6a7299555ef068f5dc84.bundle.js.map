{"version":3,"sources":["webpack://discrelog/./src/actions/element-interact.ts","webpack://discrelog/./src/elements/definitions/interaction/momentary.tsx","webpack://discrelog/./src/elements/definitions/interaction/toggle.tsx","webpack://discrelog/./src/elements/definitions/logic/and.tsx","webpack://discrelog/./src/elements/definitions/logic/buffer.tsx","webpack://discrelog/./src/elements/definitions/logic/nand.tsx","webpack://discrelog/./src/elements/definitions/logic/nor.tsx","webpack://discrelog/./src/elements/definitions/logic/not.tsx","webpack://discrelog/./src/elements/definitions/logic/or.tsx","webpack://discrelog/./src/elements/definitions/logic/xor.tsx","webpack://discrelog/./src/elements/definitions/output/led.ts","webpack://discrelog/./src/elements/definitions/output/seg7.ts","webpack://discrelog/./src/elements/definitions/pins/high.tsx","webpack://discrelog/./src/elements/definitions/pins/input.tsx","webpack://discrelog/./src/elements/definitions/pins/output.tsx","webpack://discrelog/./src/elements/visuals/ShapePathElementVisual.tsx","webpack://discrelog/./src/elements/visuals/static-element-visual.tsx","webpack://discrelog/./src/evolvers/constants.ts","webpack://discrelog/./src/evolvers/definitions/input-momentary.ts","webpack://discrelog/./src/evolvers/definitions/input-toggle.ts","webpack://discrelog/./src/evolvers/definitions/logic-and.ts","webpack://discrelog/./src/evolvers/definitions/logic-buffer.ts","webpack://discrelog/./src/evolvers/definitions/logic-nand.ts","webpack://discrelog/./src/evolvers/definitions/logic-nor.ts","webpack://discrelog/./src/evolvers/definitions/logic-not.ts","webpack://discrelog/./src/evolvers/definitions/logic-or.ts","webpack://discrelog/./src/evolvers/definitions/logic-xor.ts","webpack://discrelog/./src/evolvers/definitions/output-led.ts","webpack://discrelog/./src/evolvers/definitions/output-seg7.ts","webpack://discrelog/./src/evolvers/definitions/pin-high.ts","webpack://discrelog/./src/geometry.ts","webpack://discrelog/./src/history.ts","webpack://discrelog/./src/services/circuit-editor-drag/state.ts","webpack://discrelog/./src/services/circuits/constants.ts","webpack://discrelog/./src/services/circuit-editors/constants.ts","webpack://discrelog/./src/services/circuit-editors/state.ts","webpack://discrelog/./src/services/circuit-graph/state.ts","webpack://discrelog/./src/services/circuit-layout/state.ts","webpack://discrelog/./src/services/circuit-properties/state.ts","webpack://discrelog/./src/services/clipboard/state.ts","webpack://discrelog/./src/services/dialog/state.ts","webpack://discrelog/./src/services/project/state.ts","webpack://discrelog/./src/services/selection/state.ts","webpack://discrelog/./src/services/simulator/state.ts","webpack://discrelog/./src/services/simulator-control/state.ts","webpack://discrelog/./src/services/tutorial/state.ts","webpack://discrelog/./src/utils.ts","webpack://discrelog/./src/styles/sizing.module.css?9a43","webpack://discrelog/./src/styles/flex.module.css?f6f1","webpack://discrelog/./src/components/Tessel/types.ts","webpack://discrelog/./src/hooks/useRefValue.ts","webpack://discrelog/./src/components/Tessel/Tessel.module.css?d43a","webpack://discrelog/./src/components/Tessel/TesselSplit.tsx","webpack://discrelog/./src/components/Tessel/TesselContext.tsx","webpack://discrelog/./src/components/Tessel/TesselSplitFrame.tsx","webpack://discrelog/./src/components/Tessel/TesselFrame.tsx","webpack://discrelog/./src/arrays.ts","webpack://discrelog/./src/hooks/useComponentBounds.ts","webpack://discrelog/./src/components/Tessel/drag-items/tessel-window.tsx","webpack://discrelog/./src/components/Tessel/TesselDropCapture.tsx","webpack://discrelog/./src/components/Tessel/utils.ts","webpack://discrelog/./src/components/Tessel/Tessel.tsx","webpack://discrelog/./src/components/Tessel/index.ts","webpack://discrelog/./src/pages/ProjectEditorPage/windows/CircuitEditorWindow/tessel-window.ts","webpack://discrelog/./src/services/ui-layout/state.ts","webpack://discrelog/./src/services/ui-settings/state.ts","webpack://discrelog/./src/services/state.ts","webpack://discrelog/./src/undo/state.ts","webpack://discrelog/./src/store/state.ts","webpack://discrelog/./src/env.ts","webpack://discrelog/./src/actions/circuit-add.ts","webpack://discrelog/./src/actions/circuit-delete.ts","webpack://discrelog/./src/actions/circuit-rename.ts","webpack://discrelog/./src/actions/element-add.ts","webpack://discrelog/./src/actions/element-delete.ts","webpack://discrelog/./src/actions/element-rename.ts","webpack://discrelog/./src/actions/selection-align-to-grid.ts","webpack://discrelog/./src/actions/selection-delete.ts","webpack://discrelog/./src/actions/selection-move.ts","webpack://discrelog/./src/actions/clipboard-paste.ts","webpack://discrelog/./src/actions/circuit-editor-drag-end.ts","webpack://discrelog/./src/actions/undo.ts","webpack://discrelog/./src/actions/redo.ts","webpack://discrelog/./src/actions/project-new.ts","webpack://discrelog/./src/actions/project-receive.ts","webpack://discrelog/./src/actions/wire-connect.ts","webpack://discrelog/./src/actions/wire-hydrate.ts","webpack://discrelog/./src/actions/wire-joint-move.ts","webpack://discrelog/./src/actions/wire-joint-delete.ts","webpack://discrelog/./src/actions/wire-segment-insert-joint.ts","webpack://discrelog/./src/actions/wire-segment-set-line.ts","webpack://discrelog/./src/project-mutation-actions.ts","webpack://discrelog/./src/services/service-state-utils.ts","webpack://discrelog/./src/services/circuit-editors/utils.ts","webpack://discrelog/./src/services/circuit-editors/selectors/editor.ts","webpack://discrelog/./src/undo/utils.ts","webpack://discrelog/./src/store/utils.ts","webpack://discrelog/./src/actions/circuit-editor-drag-abort.ts","webpack://discrelog/./src/services/circuit-editor-drag/utils.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/drag-abort.ts","webpack://discrelog/./src/actions/circuit-editor-drag-continue.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/drag-continue.ts","webpack://discrelog/./src/selection-mode.ts","webpack://discrelog/./src/actions/select-region.ts","webpack://discrelog/./src/services/circuit-editor-drag/selectors/snap.ts","webpack://discrelog/./src/services/circuit-graph/utils.ts","webpack://discrelog/./src/services/circuit-graph/selectors/elements.ts","webpack://discrelog/./src/services/circuit-layout/utils.ts","webpack://discrelog/./src/services/circuit-layout/selectors/element-positions.ts","webpack://discrelog/./src/services/circuit-properties/utils.ts","webpack://discrelog/./src/services/circuit-properties/selectors/circuits.ts","webpack://discrelog/./src/elements/definitions/integrated-circuits/utils.ts","webpack://discrelog/./src/elements/definitions/integrated-circuits/index.tsx","webpack://discrelog/./src/elements/definitions/interaction/index.ts","webpack://discrelog/./src/elements/definitions/index.ts","webpack://discrelog/./src/elements/definitions/logic/index.ts","webpack://discrelog/./src/elements/definitions/output/index.ts","webpack://discrelog/./src/elements/definitions/pins/index.ts","webpack://discrelog/./src/services/element-types/selectors/element-types.ts","webpack://discrelog/./src/services/circuit-layout/selectors/element-pin-positions.ts","webpack://discrelog/./src/services/simulator-graph/utils.ts","webpack://discrelog/./src/services/circuit-graph/types.ts","webpack://discrelog/./src/services/circuit-graph/selectors/connections.ts","webpack://discrelog/./src/services/simulator-graph/graph-production.ts","webpack://discrelog/./src/elements/types/element-production.ts","webpack://discrelog/./src/services/simulator-graph/types.ts","webpack://discrelog/./src/services/simulator-graph/selectors/graph.ts","webpack://discrelog/./src/services/simulator/selectors/elements.ts","webpack://discrelog/./src/services/circuit-graph/selectors/wires.ts","webpack://discrelog/./src/services/circuit-graph/selectors/wire-positions.ts","webpack://discrelog/./src/services/circuit-editor-drag/selectors/drag-wire.ts","webpack://discrelog/./src/actions/circuit-editor-drag-start-element.ts","webpack://discrelog/./src/actions/select-elements.ts","webpack://discrelog/./src/services/selection/utils.ts","webpack://discrelog/./src/services/selection/selectors/selection.ts","webpack://discrelog/./src/actions/circuit-editor-drag-start-select.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/drag-start-select.ts","webpack://discrelog/./src/actions/circuit-editor-drag-start-wire-joint.ts","webpack://discrelog/./src/actions/select-wire-joints.ts","webpack://discrelog/./src/actions/circuit-editor-drag-start-wire-segment.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/drag-start-wire-segment.ts","webpack://discrelog/./src/actions/circuit-editor-drag-start-wire.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/drag-start-wire.ts","webpack://discrelog/./src/actions/circuit-editor-mouse-leave.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/index.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/drag-end.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/drag-start-element.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/drag-start-wire-joint.ts","webpack://discrelog/./src/services/circuit-editor-drag/reducer/mouse-leave.ts","webpack://discrelog/./src/services/circuit-editors/reducer/circuit-delete.ts","webpack://discrelog/./src/actions/circuit-editor-receive-focus.ts","webpack://discrelog/./src/services/circuit-editors/reducer/editor-focus.ts","webpack://discrelog/./src/services/circuit-editors/reducer/project-new.ts","webpack://discrelog/./src/actions/view-circuit.ts","webpack://discrelog/./src/services/circuit-editors/reducer/view-circuit.ts","webpack://discrelog/./src/services/circuit-editors/reducer/index.ts","webpack://discrelog/./src/actions/clipboard-copy-elements.ts","webpack://discrelog/./src/services/circuit-graph/selectors/element-def.ts","webpack://discrelog/./src/services/circuit-graph/selectors/pins.ts","webpack://discrelog/./src/services/clipboard/utils.ts","webpack://discrelog/./src/services/clipboard/reducer/index.ts","webpack://discrelog/./src/services/clipboard/reducer/clipboard-copy.ts","webpack://discrelog/./src/services/clipboard/reducer/clipboard-paste.ts","webpack://discrelog/./src/actions/dialog-response-accept.ts","webpack://discrelog/./src/services/dialog/utils.ts","webpack://discrelog/./src/services/dialog/reducer/dialog-response-accept.ts","webpack://discrelog/./src/actions/dialog-response-cancel.ts","webpack://discrelog/./src/services/dialog/reducer/dialog-response-cancel.ts","webpack://discrelog/./src/actions/dialog-show.ts","webpack://discrelog/./src/services/dialog/reducer/index.ts","webpack://discrelog/./src/services/dialog/reducer/dialog-show.ts","webpack://discrelog/./src/services/circuit-graph/reducer/circuit-add.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-remove.ts","webpack://discrelog/./src/services/circuit-graph/reducer/errors/WireOperationError.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-create.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-joint-remove.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-segment-remove.ts","webpack://discrelog/./src/services/circuit-graph/reducer/operations/wire-segment-delete.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-split.ts","webpack://discrelog/./src/services/circuit-graph/reducer/operations/element-delete.ts","webpack://discrelog/./src/services/circuit-graph/reducer/circuit-delete.ts","webpack://discrelog/./src/store/priorities.ts","webpack://discrelog/./src/services/circuit-graph/reducer/element-add.ts","webpack://discrelog/./src/services/circuit-graph/reducer/element-delete.ts","webpack://discrelog/./src/services/circuit-graph/reducer/element-rename.ts","webpack://discrelog/./src/services/circuit-graph/reducer/project-new.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-segment-insert.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-joint-insert.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-merge.ts","webpack://discrelog/./src/services/circuit-graph/reducer/wire-connect.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-segment-add-joint.ts","webpack://discrelog/./src/services/circuit-graph/reducer/wire-hydrate.ts","webpack://discrelog/./src/services/circuit-graph/reducer/wire-insert-joint.ts","webpack://discrelog/./src/services/circuit-graph/reducer/wire-joint-delete.ts","webpack://discrelog/./src/services/circuit-graph/reducer/operations/wire-joint-merge-or-delete.ts","webpack://discrelog/./src/services/circuit-graph/reducer/primitives/wire-segment-merge.ts","webpack://discrelog/./src/services/circuit-graph/reducer/wire-joint-move.ts","webpack://discrelog/./src/actions/wire-segment-delete.ts","webpack://discrelog/./src/services/circuit-graph/reducer/index.ts","webpack://discrelog/./src/services/circuit-graph/reducer/wire-segment-delete.ts","webpack://discrelog/./src/services/circuit-graph/reducer/wire-segment-set-line.ts","webpack://discrelog/./src/services/circuit-layout/reducer/element-add.ts","webpack://discrelog/./src/services/circuit-layout/reducer/element-delete.ts","webpack://discrelog/./src/actions/element-move.ts","webpack://discrelog/./src/services/circuit-layout/reducer/index.ts","webpack://discrelog/./src/services/circuit-layout/reducer/element-move.ts","webpack://discrelog/./src/services/circuit-layout/reducer/project-new.ts","webpack://discrelog/./src/services/circuit-properties/reducer/index.ts","webpack://discrelog/./src/services/circuit-properties/reducer/circuit-add.ts","webpack://discrelog/./src/services/circuit-properties/reducer/circuit-delete.ts","webpack://discrelog/./src/services/circuit-properties/reducer/circuit-rename.ts","webpack://discrelog/./src/services/circuit-properties/reducer/project-new.ts","webpack://discrelog/./src/actions/circuit-import.ts","webpack://discrelog/./src/services/savedata/errors.ts","webpack://discrelog/./src/services/savedata/api.ts","webpack://discrelog/./src/services/circuits/reducer/index.ts","webpack://discrelog/./src/services/project/utils.ts","webpack://discrelog/./src/services/project/reducer/project-modified.ts","webpack://discrelog/./src/services/project/reducer/project-new.ts","webpack://discrelog/./src/actions/project-rename.ts","webpack://discrelog/./src/services/project/reducer/project-rename.ts","webpack://discrelog/./src/actions/project-save.ts","webpack://discrelog/./src/services/project/reducer/index.ts","webpack://discrelog/./src/services/project/reducer/project-receive.ts","webpack://discrelog/./src/services/project/reducer/project-save-success.ts","webpack://discrelog/./src/services/selection/reducer/element-delete.ts","webpack://discrelog/./src/services/selection/reducer/project-new.ts","webpack://discrelog/./src/actions/select-all.ts","webpack://discrelog/./src/services/selection/reducer/select-all.ts","webpack://discrelog/./src/actions/select-clear.ts","webpack://discrelog/./src/services/selection/reducer/select-clear.ts","webpack://discrelog/./src/services/selection/reducer/select-elements.ts","webpack://discrelog/./src/services/circuit-layout/selectors/element-bounds.ts","webpack://discrelog/./src/services/selection/reducer/select-region.ts","webpack://discrelog/./src/services/selection/reducer/select-wire-joints.ts","webpack://discrelog/./src/actions/select-wire-segments.ts","webpack://discrelog/./src/services/selection/reducer/select-wire-segments.ts","webpack://discrelog/./src/actions/selection-copy.ts","webpack://discrelog/./src/services/selection/reducer/wire-joint-delete.ts","webpack://discrelog/./src/services/selection/reducer/index.ts","webpack://discrelog/./src/services/selection/reducer/selection-align-to-grid.ts","webpack://discrelog/./src/services/selection/reducer/selection-copy.ts","webpack://discrelog/./src/services/selection/reducer/selection-delete.ts","webpack://discrelog/./src/services/selection/reducer/selection-move.ts","webpack://discrelog/./src/services/simulator/utils.ts","webpack://discrelog/./src/services/simulator/reducer/circuit-graph-invalidated.ts","webpack://discrelog/./src/evolvers/definitions/index.ts","webpack://discrelog/./src/services/simulator-graph/selectors/elements.ts","webpack://discrelog/./src/services/simulator-graph/selectors/connections.ts","webpack://discrelog/./src/services/simulator/reducer/utils.ts","webpack://discrelog/./src/services/simulator/reducer/element-interact.ts","webpack://discrelog/./src/actions/sim-start.ts","webpack://discrelog/./src/services/simulator/reducer/sim-start.ts","webpack://discrelog/./src/actions/sim-step.ts","webpack://discrelog/./src/actions/sim-tick.ts","webpack://discrelog/./src/actions/sim-stop.ts","webpack://discrelog/./src/services/simulator/reducer/sim-stop.ts","webpack://discrelog/./src/services/simulator/reducer/index.ts","webpack://discrelog/./src/services/simulator/reducer/sim-step.ts","webpack://discrelog/./src/services/simulator/reducer/sim-tick.ts","webpack://discrelog/./src/services/simulator-control/utils.ts","webpack://discrelog/./src/services/simulator-control/reducers/circuit-graph-invalidated.ts","webpack://discrelog/./src/actions/sim-pause.ts","webpack://discrelog/./src/services/simulator-control/selectors/run.ts","webpack://discrelog/./src/services/simulator-control/reducers/index.ts","webpack://discrelog/./src/services/simulator-control/reducers/sim-pause.ts","webpack://discrelog/./src/services/simulator-control/reducers/sim-start.ts","webpack://discrelog/./src/services/simulator-control/reducers/sim-step.ts","webpack://discrelog/./src/services/simulator-control/reducers/sim-stop.ts","webpack://discrelog/./src/actions/tutorial-annotate.ts","webpack://discrelog/./src/services/tutorial/utils.ts","webpack://discrelog/./src/services/tutorial/reducer/tutorial-annotate.ts","webpack://discrelog/./src/actions/tutorial-dismiss.ts","webpack://discrelog/./src/actions/tutorial-start.ts","webpack://discrelog/./src/services/tutorial/reducer/index.ts","webpack://discrelog/./src/services/tutorial/reducer/tutorial-dismiss.ts","webpack://discrelog/./src/services/tutorial/reducer/tutorial-start.ts","webpack://discrelog/./src/services/ui-layout/utils.ts","webpack://discrelog/./src/services/ui-layout/reducer/circuit-delete.ts","webpack://discrelog/./src/actions/layout-rearrange.ts","webpack://discrelog/./src/services/ui-layout/reducer/layout-rearrange.ts","webpack://discrelog/./src/services/ui-layout/reducer/project-new.ts","webpack://discrelog/./src/services/ui-layout/reducer/view-circuit.ts","webpack://discrelog/./src/actions/view-reset.ts","webpack://discrelog/./src/services/ui-layout/reducer/index.ts","webpack://discrelog/./src/services/ui-layout/reducer/view-reset.ts","webpack://discrelog/./src/actions/view-element-names.ts","webpack://discrelog/./src/services/ui-settings/utils.ts","webpack://discrelog/./src/services/ui-settings/reducer/index.ts","webpack://discrelog/./src/services/ui-settings/reducer/view-element-names.ts","webpack://discrelog/./src/store/reducer.ts","webpack://discrelog/./src/services/reducer.ts","webpack://discrelog/./src/services/circuits/reducer/circuit-import.ts","webpack://discrelog/./src/services/tutorial/selectors/tutorial.ts","webpack://discrelog/./src/services/autosave/saga/project-mutate.ts","webpack://discrelog/./src/services/autosave/api.ts","webpack://discrelog/./src/services/autosave/saga/project-reset.ts","webpack://discrelog/./src/services/autosave/saga/index.ts","webpack://discrelog/./src/actions/page-navigate.ts","webpack://discrelog/./src/actions/project-restore-previous.ts","webpack://discrelog/./src/services/project/selectors/project.ts","webpack://discrelog/./src/services/project/saga/page-navigate-editor.ts","webpack://discrelog/./src/services/dialog/api.ts","webpack://discrelog/./src/actions/project-export-link.ts","webpack://discrelog/./src/services/project/saga/project-export-link.ts","webpack://discrelog/./src/actions/project-import-circuits.ts","webpack://discrelog/./src/services/project/saga/project-import-circuits.ts","webpack://discrelog/./src/actions/project-import-link.ts","webpack://discrelog/./src/services/project/saga/project-import-link.ts","webpack://discrelog/./src/actions/project-load.ts","webpack://discrelog/./src/services/project/saga/project-load.ts","webpack://discrelog/./src/services/project/saga/project-new.ts","webpack://discrelog/./src/services/project/saga/project-restore-previous.ts","webpack://discrelog/./src/services/project/saga/project-save.ts","webpack://discrelog/./src/services/project/saga/index.ts","webpack://discrelog/./src/services/simulator-control/saga/mode-run.ts","webpack://discrelog/./src/services/simulator-control/saga/index.ts","webpack://discrelog/./src/components/CircuitEditor/ids.ts","webpack://discrelog/./src/actions/tutorial-next.ts","webpack://discrelog/./src/services/tutorial/saga/tutorials/utils.ts","webpack://discrelog/./src/services/tutorial/saga/tutorials/basic.ts","webpack://discrelog/./src/pages/ProjectEditorPage/windows/CircuitsTreeWindow/ids.ts","webpack://discrelog/./src/services/tutorial/saga/tutorials/circuits.ts","webpack://discrelog/./src/services/tutorial/saga/tutorials.ts","webpack://discrelog/./src/services/tutorial/saga/index.ts","webpack://discrelog/./src/store/saga.ts","webpack://discrelog/./src/store/store.ts","webpack://discrelog/./src/undo/reducer/index.ts","webpack://discrelog/./src/undo/reducer/undo.ts","webpack://discrelog/./src/undo/reducer/redo.ts","webpack://discrelog/./src/undo/reducer/capture-undo-state.ts","webpack://discrelog/./src/hooks/useAction.ts","webpack://discrelog/./src/services/saga.ts","webpack://discrelog/./src/actions/init.ts","webpack://discrelog/./src/components/Button/Button.module.css?a282","webpack://discrelog/./src/components/Button/Button.tsx","webpack://discrelog/./src/components/Button/index.ts","webpack://discrelog/./src/pages/HomePage/HomePage.module.css?ee05","webpack://discrelog/./src/pages/HomePage/index.ts","webpack://discrelog/./src/pages/HomePage/HomePage.tsx","webpack://discrelog/./src/hooks/useSelector.ts","webpack://discrelog/./src/hooks/useNativeEvent.ts","webpack://discrelog/./src/services/ui-layout/selectors/layout.ts","webpack://discrelog/./src/components/TitleBar/index.ts","webpack://discrelog/./src/components/TitleBar/TitleBar.tsx","webpack://discrelog/./src/components/TitleBar/TitleBar.module.css?c6e3","webpack://discrelog/./src/components/Popover/PopoverChildContext.tsx","webpack://discrelog/./src/components/Popover/Popover.tsx","webpack://discrelog/./src/components/Popover/index.ts","webpack://discrelog/./src/hooks/useArrayState.ts","webpack://discrelog/./src/hooks/useOutsideMouseEvent.ts","webpack://discrelog/./src/components/Menus/MenuCloseContext.ts","webpack://discrelog/./src/components/AutoPopover.tsx","webpack://discrelog/./src/components/Menus/Menus.module.css?27a7","webpack://discrelog/./src/components/Menus/Menu.tsx","webpack://discrelog/./src/components/Menus/MenuItem.tsx","webpack://discrelog/./src/components/Menus/DividerMenuItem.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/components/FileMenu.tsx","webpack://discrelog/./src/runtime-env.ts","webpack://discrelog/./src/undo/selectors.ts","webpack://discrelog/./src/services/clipboard/selectors/clipboard.ts","webpack://discrelog/./src/pages/ProjectEditorPage/components/EditMenu.tsx","webpack://discrelog/./src/services/ui-settings/selectors/element-name.ts","webpack://discrelog/./src/components/Checkbox/index.ts","webpack://discrelog/./src/components/Checkbox/Checkbox.tsx","webpack://discrelog/./src/components/Checkbox/Checkbox.module.css?4fe9","webpack://discrelog/./src/components/Menus/CheckboxMenuItem.tsx","webpack://discrelog/./src/components/Menus/SubMenuItem.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/components/ViewMenu.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/components/HelpMenu.tsx","webpack://discrelog/./src/services/simulator/selectors/performance.ts","webpack://discrelog/./src/components/Icons/Icons.module.css?682c","webpack://discrelog/./src/components/Icons/Play.tsx","webpack://discrelog/./src/components/Icons/Stop.tsx","webpack://discrelog/./src/components/Icons/Pause.tsx","webpack://discrelog/./src/components/Icons/Step.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/components/SimControls/SimControls.module.css?e05b","webpack://discrelog/./src/pages/ProjectEditorPage/components/SimControls/index.ts","webpack://discrelog/./src/pages/ProjectEditorPage/components/SimControls/SimControls.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/components/ProjectEditorTitleBar/index.ts","webpack://discrelog/./src/pages/ProjectEditorPage/components/ProjectEditorTitleBar/ProjectEditorTitleBar.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/components/ProjectEditorTitleBar/ProjectEditorTitleBar.module.css?4065","webpack://discrelog/./src/components/CircuitNodeBreadcrumb/CircuitNodeBreadcrumb.module.css?4319","webpack://discrelog/./src/components/CircuitNodeBreadcrumb/CircuitNodeBreadcrumb.tsx","webpack://discrelog/./src/components/CircuitNodeBreadcrumb/index.ts","webpack://discrelog/./src/services/circuit-layout/selectors/field.ts","webpack://discrelog/./src/components/CircuitEditor/drag-items/new-element.ts","webpack://discrelog/./src/components/CircuitEditor/contexts/viewport-context.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/contexts/fieldSvgElement.tsx","webpack://discrelog/./src/services/circuit-graph/selectors/circuits.ts","webpack://discrelog/./src/components/CircuitEditor/contexts/circuit-editor-context.tsx","webpack://discrelog/./src/components/CircuitEditor/utils.ts","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/hooks/useMouseCoords.ts","webpack://discrelog/./src/styles/interaction.module.css?621c","webpack://discrelog/./src/elements/visuals/element-visuals.module.css?2bb3","webpack://discrelog/./src/elements/visuals/index.tsx","webpack://discrelog/./src/elements/visuals/IntegratedCircuitElementVisual.tsx","webpack://discrelog/./src/elements/visuals/MomentaryInteractionElementVisual.tsx","webpack://discrelog/./src/elements/visuals/ToggleInteractionElementVisual.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ElementVisual.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/DragNewElementLayer.tsx","webpack://discrelog/./src/services/circuit-editor-drag/selectors/drag.ts","webpack://discrelog/./src/services/circuit-editor-drag/selectors/drag-move.ts","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/DragMovePreviewLayer.tsx","webpack://discrelog/./src/hooks/useMouseDragDetector.ts","webpack://discrelog/./src/modifier-keys.ts","webpack://discrelog/./src/services/circuit-editor-drag/selectors/drag-select.ts","webpack://discrelog/./src/components/ContextMenu.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ContextMenuItems.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/FieldContextMenu.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/FieldMouseLayer.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/GridBackground.tsx","webpack://discrelog/./src/components/AtomicTextInput.tsx","webpack://discrelog/./src/components/EditableText.tsx","webpack://discrelog/./src/components/Menus/EditableTextMenuItem.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ElementContextMenu.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/Element/Element.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/Element/index.ts","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ElementsLayer.tsx","webpack://discrelog/./src/services/circuit-graph/selectors/lines.ts","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/PinContextMenu.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ElementPin/ElementPin.module.css?534f","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ElementPin/index.ts","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ElementPin/ElementPin.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ElementPins.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/ElementPinsLayer.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/EditorDragReceiver.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/WireSegment/index.ts","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/WireSegment/WireSegment.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/WireSegment/WireSegment.module.css?531b","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/WireJoint/index.ts","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/WireJoint/WireJoint.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/WireJoint/WireJoint.module.css?156d","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/Wire.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/WiresLayer.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/components/DragWirePreviewLayer.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/index.ts","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/CircuitFieldSurface.tsx","webpack://discrelog/./src/components/CircuitEditor/components/CircuitFieldSurface/CircuitFieldSurface.module.css?4f8f","webpack://discrelog/./src/components/CircuitEditor/CircuitEditor.tsx","webpack://discrelog/./src/components/CircuitEditor/index.ts","webpack://discrelog/./src/components/CircuitEditor/CircuitEditor.module.css?a428","webpack://discrelog/./src/components/Icons/Close.tsx","webpack://discrelog/./src/components/Tessel/TesselWindow.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/windows/CircuitEditorWindow/keymap.ts","webpack://discrelog/./src/pages/ProjectEditorPage/windows/CircuitEditorWindow/CircuitEditorWindow.tsx","webpack://discrelog/./src/components/SelectionList/SelectionList.tsx","webpack://discrelog/./src/components/SelectionList/SelectionList.module.css?89a4","webpack://discrelog/./src/components/SelectionList/index.ts","webpack://discrelog/./src/pages/ProjectEditorPage/windows/CircuitsTreeWindow/CircuitsTreeWindow.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/windows/CircuitsTreeWindow/CircuitsTreeWindow.module.css?916b","webpack://discrelog/./src/components/Tooltip/index.ts","webpack://discrelog/./src/components/Tooltip/Tooltip.tsx","webpack://discrelog/./src/components/Tooltip/Tooltip.module.css?a017","webpack://discrelog/./src/pages/ProjectEditorPage/windows/ElementTrayWindow/ElementTrayWindow.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/windows/ElementTrayWindow/ElementTrayWindow.module.css?56cd","webpack://discrelog/./src/pages/ProjectEditorPage/ProjectEditorPage.tsx","webpack://discrelog/./src/pages/ProjectEditorPage/index.ts","webpack://discrelog/./src/pages/ProjectImporterPage/index.ts","webpack://discrelog/./src/pages/ProjectImporterPage/ProjectImporterPage.tsx","webpack://discrelog/./src/router.tsx","webpack://discrelog/./src/services/dialog/selectors/dialog.ts","webpack://discrelog/./src/components/Modal/Modal.module.css?d409","webpack://discrelog/./src/components/Modal/index.ts","webpack://discrelog/./src/components/Modal/Modal.tsx","webpack://discrelog/./src/components/Dialog/index.ts","webpack://discrelog/./src/components/Dialog/Dialog.tsx","webpack://discrelog/./src/components/Dialog/Dialog.module.css?a332","webpack://discrelog/./src/dialogs/dialog-types/export-project-link/ExportProjectLinkDialog.tsx","webpack://discrelog/./src/dialogs/dialog-types/export-project-link/ExportProjectLinkDialog.module.css?13e0","webpack://discrelog/./src/dialogs/dialog-types/import-project-circuits/ImportProjectCircuitsDialog.tsx","webpack://discrelog/./src/dialogs/dialog-types/import-project-circuits/ImportProjectCircuitsDialog.module.css?16e9","webpack://discrelog/./src/components/DialogManager/DialogManager.tsx","webpack://discrelog/./src/components/DialogManager/index.ts","webpack://discrelog/./src/dialogs/renderer.tsx","webpack://discrelog/./src/components/Tutorial/Tutorial.tsx","webpack://discrelog/./src/hooks/useQuerySelector.ts","webpack://discrelog/./src/components/Tutorial/Tutorial.module.css?c91d","webpack://discrelog/./src/components/Tutorial/index.ts","webpack://discrelog/./src/index.tsx","webpack://discrelog/./src/components/App/App.tsx","webpack://discrelog/./src/svg.ts"],"names":["ACTION_ELEMENT_INTERACT","interactElement","elementIdPath","data","type","payload","isInteractElementAction","action","category","displayName","elementProduction","visual","hitRect","p1","x","y","p2","component","pins","OUT","direction","hitPath","d","fill","stroke","className","strokeWidth","A","B","IN","transform","fillRule","path","state","value","OFFSET","createSeg","name","points","start","p","slice","C","D","E","F","G","cx","cy","r","ShapePathElementVisual","elementId","elementPath","shapePath","evolverState","dispatch","onClick","e","defaultPrevented","preventDefault","body","normalizeVisuals","map","v","i","key","ShapePathElementTrayItem","width","height","viewBox","TrayShapePadding","createShapePathVisual","trayComponent","props","Array","isArray","createStaticElementVisual","element","TrayComponentPadding","EVOLVER_RESPONSE_TIME","inputPins","outputPins","interact","undefined","transitions","tickOffset","valuesByPin","Math","round","defaultToggleState","toggleState","nextState","Object","assign","evolve","_","inputs","ZeroPoint","freeze","ZeroRect","boundsToRect","bounds","snapValue","snap","snapPoint","magnitude","sqrt","normalize","m","dotProduct","a","b","scale","scaler","normalizeRectangle","args","length","min","max","offsetRectangle","rect","offset","pointAdd","pointSubtract","pointEquals","pointIntersectsRect","calcSize","union","r1","r2","rectIntersectsRect","linePointIntercept","lineStart","lineEnd","point","threshhold","axialGridSnap","lineSub","lineLength","lineVector","Number","isNaN","interceptDistance","interceptPoint","abs","lineToDotDist","interceptLineLengthDistance","interceptLinePointDistance","defaultCircuitEditorDragServiceState","dragMode","ROOT_CIRCUIT_ID","DEFAULT_CIRCUIT_EDITOR_ID","circucitEditorsById","circuitId","activeEditorId","defaultCircuitEditorServiceState","elementIdsByCircuitId","elementsById","wireIdsByCircuitId","wiresByWireId","wireSegmentsById","wireJointPositionsByJointId","defaultCircuitGraphServiceState","defaultCircuitLayoutServiceState","elementPositionsById","circuitNamesByCircuitId","defaultCircuitPropertiesServiceState","defaultClipboardServiceState","clipboardElements","clipboardPasteOrigin","defaultDialogServiceState","dialogType","defaultProjectServiceState","projectLoadState","projectName","projectModified","defaultSelectionServiceState","selectedElementIds","selectedWireJointIds","selectedWireSegmentIds","defaultSimulatorServiceState","initialized","tick","lastTickProcessingTimeMs","evolverStatesByEvolverId","evolverOutputValuesByEvolverId","transitionsById","transitionWindows","defaultSimulatorControlServiceState","mode","ticksPerSecond","defaultTutorialServiceState","activeTutorial","annotatedElements","preTutorialState","cls","values","filter","Boolean","join","fpSet","fpSetByArray","String","target","firstPaths","lastPath","newData","clone","rollingTarget","seg","obj","isTruthy","windowId","isTesselWindow","item","normalizeTesselDivision","firstPercent","isTesselPercentDivision","isTesselFixedDivision","useRefValue","ref","current","top","left","bottom","right","toJSON","onChangePercentage","pointerCaptureRef","directionRef","onChangePercentageRef","onHandlePointerMove","parentRect","parentElement","getBoundingClientRect","percentage","position","pageX","pageY","leading","onPointerMove","persist","onPointerDown","setPointerCapture","pointerId","onPointerUp","releasePointerCapture","tesselPathContext","useTesselPath","TesselPathProvider","pathKey","children","newPath","Provider","noop","tesselInteractionContext","moveWindow","closeWindow","useTesselInteraction","TesselInteractionProvider","context","applyDivisionChange","division","percent","absolute","secondSize","firstSize","renderWindow","onLayoutChange","first","second","divisionValue","sizeDirection","onFirstLayoutChange","onSecondLayoutChange","firstFix","secondFix","firstSizeDiv","secondSizeDiv","style","asArray","arrayEquals","every","EmptyArray","immutableEmptyArray","dropIndexFp","array","index","newArray","push","useComponentBounds","size","setSize","observer","el","observe","disconnect","TESSEL_WINDOW_DRAG_OBJECT","tesselWindowDragObject","isTesselWindowDragObject","id","forwardRef","tesselPath","dropPos","setDropPos","onHover","monitor","isOver","shallow","pos","getClientOffset","xPercent","yPercent","onDrop","draggingPath","draggingSelf","dropRef","useDrop","accept","collect","getItem","hover","drop","dropMarkerClassname","divRef","filterTesselValues","normalized","pruneEmptyTesselValues","rootItem","from","to","newRoot","movingElement","newItem","Error","CIRCUIT_FIELD_WINDOW_ID","circuitEditorTesselWindow","circuitEditorId","windowProps","editorId","isCircuitEditorTesselWindow","layout","defaultUiLayoutServiceState","defaultUiSettingsState","elementNameMode","_defaultServiceState","circuitEditorDrag","circuitEditors","circuitGraph","circuitLayout","circuitProperties","clipboard","dialog","project","selection","simulator","simulatorControl","tutorial","uiLayout","uiSettings","defaultServicesState","UndoServicesStateKeys","_defaultAppState","services","undo","undoStack","redoStack","defaultAppState","rootUrlBuilder","URL","window","location","origin","pathname","rootUrl","toString","ACTION_CIRCUIT_ADD","addCircuit","circuitName","edit","isAddCircuitAction","ACTION_CIRCUIT_DELETE","isDeleteCircuitAction","ACTION_CIRCUIT_RENAME","ACTION_ELEMENT_ADD","addElement","elementType","opts","isAddElementAction","ACTION_ELEMENT_DELETE","isDeleteElementAction","ACTION_ELEMENT_RENAME","ACTION_SELECTION_ALIGN_TO_GRID","selectionAlignToGrid","ACTION_SELECTION_DELETE","deleteSelection","ACTION_SELECTION_MOVE","ACTION_PASTE","paste","ACTION_CIRCUIT_EDITOR_DRAG_END","ACTION_UNDO","isUndoAction","ACTION_REDO","redo","isRedoAction","ACTION_PROJECT_NEW","newProject","isNewProjectAction","ACTION_PROJECT_RECEIVE","receiveProject","fileName","saveData","ACTION_WIRE_CONNECT","wireConnect","ACTION_WIRE_HYDRATE","hydrateWire","settings","ACTION_WIRE_JOINT_MOVE","moveWireJoint","jointId","relative","snapMode","jointIds","ACTION_WIRE_JOINT_DELETE","isWireJointDeleteAction","ACTION_WIRE_SEGMENT_INSERT_JOINT","ACTION_WIRE_SEGMENT_SET_LINE","wireSegmentSetLine","wireSegmentId","lineId","PROJECT_MUTATION_ACTIONS","isProjectMutationAction","indexOf","createServiceReducerCreator","service","reducer","newState","createServiceSelectorCreator","selector","appSelector","s","local","createCircuitEditorsReducer","createCircuitEditorsSelector","circuitEditorStateFromIdSelector","circuitIdForEditorIdSelector","editorState","activeCircuitEditorIdSelector","keys","activeCircuitEditorStateSelector","activeCircuitIdSelector","editorIdsFromCircuitIdSelector","captureUndoState","viewCircuitId","activeEditor","serviceStates","concatReducers","reducers","concat","ACTION_CIRCUIT_EDITOR_DRAG_ABORT","circuitEditorDragAbort","createCircuitEditorDragReducer","createCircuitEditorDragSelector","isCircuitEditorDragAbortAction","ACTION_CIRCUIT_EDITOR_DRAG_CONTINUE","isCircuitEditorDragContinueAction","dragPos","modifierKeys","dragEnd","dragEndEditorId","dragModifierKeys","getSelectMode","modifiers","defaultMode","shiftKey","ctrlMetaKey","combineSelection","selectedIds","chosenIds","chosen","combineExtraniousSelection","ACTION_SELECT_REGION","gridElementSnapSelector","gridJointSnapSelector","applyGridElementSnapSelector","applyGridJointSnapSelector","createCircuitGraphReducer","createCircuitGraphSelector","getSegmentIdsFromJoint","wireId","wire","jointedSegmentIds","Set","segmentId","wireSegmentIds","segment","add","jointAId","jointBId","getJointIdsFromSegment","collectWireLineIds","inputLineIds","outputLineIds","segId","elementsByElementIdSelector","elementIdsSelector","elementTypesByElementIdSelector","elementFromElementIdSelector","elementIdsFromTypeSelector","desiredType","elementIds","elementTypeFromElementIdSelector","elementIdsByCircuitIdSelector","EmptyElementIds","elementIdsFromCircuitIdSelector","circuitIdFromElementIdSelector","elementNamesByElementIdSelector","elementName","elementNameOrDefaultFromElementIdSelector","substr","elementNameFromElementIdSelector","createCircuitLayoutReducer","createCircuitLayoutSelector","elementPositionsByElementIdSelector","elementPositionFromElementIdSelector","createCircuitPropertiesReducer","createCircuitPropertiesSelector","circuitIdsSelector","circuitNamesByIdSelector","circuitNameFromIdSelector","circuitIdToElementType","elementTypeToCircuitId","startsWith","getICBorderPath","inputPinCount","outputPinCount","circuitPinPosition","pinIndex","elementTypesByElementId","elementPositionsByElementId","circuitNamesById","pinElementIds","inputPinIds","outputPinIds","pinElementId","componentProps","x1","y1","x2","y2","elementDefinitionsDerivedStateSelector","elementDefinitionsSelector","derivedState","source","resolved","resolveSources","elementDefinitionsByTypeSelector","defs","defsByType","def","elementDefinitionFromTypeSelector","definitions","elementPinPositionsByPinIdByElementIdSelector","elementDefsByType","elementPinPositionsByPinIdByElementId","elementPinPositionsByPinId","elementPosition","pinIds","pinId","relPinPosition","pinPosition","elementPinPositionFromElementPinSelector","elementPinPositions","getEvolverIdFromElementIdPath","evolverIdPath","icElementId","pop","evolverIdItem","evolverId","elementPinEquals","isOutputWireSegment","isInputWireSegment","isInputOutputWireSegment","wireSegmentHasInput","connectionsSelector","wiresById","segmentsById","connections","wireIds","segments","inputPin","outputPin","input","EMPTY_PRODUCTION","evolversById","evolverIdsByElementId","inputElementPinsByCircuitPinId","outputElementPinsByCircuitPinId","produceCircuitGraph","dependencies","inputElementIds","outputElementIds","elementInputPinsByPinIdByElementId","elementOutputPinsByPinIdByElementId","productionResult","produceEvolver","outputSimPin","inputSimPins","outputEvolver","outputsByOutputPin","outputsByPin","inputSimPin","inputsByPin","elementDefsByElementType","production","simProduction","evolverType","subElementIds","produceElementNode","circuitProuction","produceCircuitNode","EmptySimulatorGraph","console","error","elementOutputsFromCircuitElementIdSelector","elementOutputsBySimulatorElementId","wiresByWireIdSelector","wireIdsSelector","wireSegmentsByWireSegmentIdSelector","wireSegmentIdsFromWireIdSelector","segmentsBySegmentId","wireIdFromWireSegmentIdSelector","wireJointIdsFromWireIdSelector","wireJointIds","circuitIdFromWireJointIdSelector","wireIdFromWireJointIdSelector","wireSegmentTypeFromSegmentIdSelector","wireJointIdsByWireIdSelector","segmentIds","wireSegmentByWireSegmentIdSelector","wireSegmentIdFromElementPinSelector","inputPinIsWiredSelector","wireIdsFromCircuitIdSelector","circuitIdForWireIdSelector","wireJointIdsFromCircuitIdSelector","wireSegmentIdsFromCircuitIdSelector","segmentIdsForJointIdSelector","wireSegmentSourcesBySegmentIdSelector","sources","collectSegmentSources","segmentSources","addSegmentSource","traceSegmentToInput","entryJointId","outputSegment","connectedSegmentIds","hasAtLeastOneInput","connectedSegmentId","wireSegmentPoweredSelector","some","sourcePin","elementPin","resolveOutputPin","pin","outputs","elementOutputFromCircuitElementPinSelector","getPoweredStateFromOutputPin","icId","icPath","getOutputPinForInputPin","search","wireJointPositionByJointIdSelector","wireJointPositionFromJointIdSelector","startPositionForWireSegmentId","endPositionForWireSegmentId","getDragTargetPoint","segmentInsertLength","startPos","endPos","dragWireEndTargetByPointSelector","dragService","dragStartEditorId","snapToGrid","targetPin","pinPositionsByPinIdByElementId","pinPositionsByPinId","elementPinFromPoint","jointTarget","jointPos","wireJointFromPoint","segmentTarget","intercept","wireSegmentFromPoint","dragWireSegmentStartPositionSelector","dragWireEndTargetSelector","dragWireSegmentStartPositionCache","pt","dragStartTarget","dragWireSegmentEndPositionCache","dragWireSegmentEndPositionSelector","endTarget","dragWireJointPositionSelector","dragJointGhostLinesSelector","dragWireSegmentId","jointPosition","ACTION_CIRCUIT_EDITOR_DRAG_START_ELEMENT","ACTION_SELECT_ELEMENTS","selectElements","createSelectionReducer","createSelectionSelector","selectedElementIdsSelector","selectedJointIdsSelector","isElementSelectedFromElementIdSelector","isJointSelectedFromJointIdSelector","isSegmentSelectedFromSegmentIdSelector","ACTION_CIRCUIT_EDITOR_DRAG_START_SELECT","isCircuitEditorDragStartSelectAction","dragStart","ACTION_CIRCUIT_EDITOR_DRAG_START_WIRE_JOINT","ACTION_SELECT_WIRE_JOINTS","selectWireJoints","CIRCUIT_EDITOR_DRAG_START_WIRE_SEGMENT_ACTION","rootState","isCircuitEditorDragStartWireSegmentAction","dragWireId","CIRCUIT_EDITOR_DRAG_START_WIRE_ACTION","circuitEditorDragStartWire","isCircuitEditorDragStartWireAction","ACTION_CIRCUIT_EDITOR_MOUSE_LEAVE","isCircuitEditorDragEndAction","dragState","selectionMode","region","selectRegion","executeSelectDrag","moveBy","hasElements","offsetX","offsetY","moveSelection","executeMoveDrag","dragEndTarget","executeWireDrag","executeWireNewJointDrag","executeDragMode","isCircuitEditorDragStartElementAction","isCircuitEditorDragStartWireJointAction","isCircuitEditorMouseLeaveAction","keepIds","ACTION_CIRCUIT_EDITOR_RECEIVE_FOCUS","isCircuitEditorReceiveFocusAction","ACTION_VIEW_CIRCUIT","viewCircuit","newWindowId","newWindow","isViewCircuitAction","appState","targetWindowId","findActiveEditorId","ACTION_COPY_ELEMENTS","elementDefinitionFromElementIdSelector","pinDirectionFromElementPinSelector","pinDef","pinNameFromElementPinSelector","createClipboardReducer","createClipboardSelector","isCopyElementsAction","copyIds","rootPosition","copyElements","outputConnections","result","connection","elementOutputSourcesByPinIdFromElementIdSelector","elementIsSelected","isPasteAction","pastePosition","gridSnap","pasteIds","sourceId","output","targetCopyId","targetId","ACTION_DIALOG_RESPONSE_ACCEPT","acceptDialog","createDialogReducer","createDialogSelector","isAcceptDialogAction","ACTION_DIALOG_RESPONSE_CANCEL","cancelDialog","isCancelDialogAction","ACTION_DIALOG_SHOW","isShowDialogAction","wireRemove","wiresInCircuit","WireOperationError","message","super","this","setPrototypeOf","prototype","wireCreate","wireJointRemove","wireSegmentRemove","deleteWireIfLastSegment","removeOrphanJoints","remainingSegmentIds","joints","remainingSegmentId","wireSegmentDelete","removedSegment","oldWireId","collectSegment","has","forEach","collectJoint","collectWireNetwork","oldWire","remainingWireSegmentIds","remainingWireJointIds","lineIdMap","wireSplit","elementDelete","removedElementIds","remainingElementIds","circuitElementIds","removedIcPins","icElementType","elementPinsFromPinElementSelector","removedSegmentIds","isSegmentForRemovedElement","removedPin","isSegmentForRemovedPin","reduce","remainingCircuitIds","elementIdsForCircuit","circuitElementType","reducerPriority","priority","weight","priorityBefore","isRenameElementAction","trim","wireSegmentInsert","wireJointInsert","setWireLineIds","isWireConnectAction","unchangedState","fromState","fromJointId","fromPin","fromCircuitId","targetToParts","toState","toJointId","toPin","toCircuitId","fromDirection","toDirection","wirePins","fromWireId","toWireId","mergedState","targetWireId","subjectWireId","targetCircuitId","subjectCircuitId","targetWire","subjectWire","targetInputs","targetOutputs","subjectInputs","subjectOutputs","sourceLineId","remainingWireIds","wireMerge","wireJoints","defaultLineIdFromWiredPin","wireJointToPin","segmentSplitLength","splitJointId","targetSegment","firstSegmentId","secondSegmentId","firstSegment","secondSegment","wireSegmentAddJoint","isHydrateWireAction","wireSegments","newSegments","wireSegment","newJoints","joint","isWireSegmentInsertJointAction","newJointId","segmentId1","segmentId2","wireId1","wireId2","seg1","seg2","inputSegment","bridge","alt","bridgeRemainderJoint","altRemainderJoint","wireSegmentMerge","wireJointMergeOrDelete","isWireJointMoveAction","movedJointPositions","movedP","ACTION_WIRE_SEGMENT_DELETE","isWireSegmentDeleteAction","isWireSegmentSetLineAction","ACTION_ELEMENT_MOVE","moveElement","isMoveElementAction","movedElementPositions","isRenameCircuitAction","trimmedName","ACTION_CIRCUIT_IMPORT","SaveFormatError","code","createSave","jointPositionsByJointId","circuits","elements","wires","createProjectReducer","createProjectSelector","ACTION_PROJECT_RENAME","isRenameProjectAction","ACTION_PROJECT_SAVE","saveProject","ACTION_PROJECT_SAVE_SUCCESS","isReceiveProjectAction","save","loadSave","isSaveProjectSuccessAction","selectedConnectionIds","ACTION_SELECT_CLEAR","isSelectAllAction","isClearSelectionAction","isSelectElementsAction","elementRectsByIdSelector","positionsById","elementTypesById","isSelectRegionAction","rects","chosenElementIds","jointPositions","chosenJointIds","isSelectWireJointsAction","ACTION_SELECT_WIRE_SEGMENTS","isSelectWireSegmentsAction","ACTION_SELECTION_COPY","copySelection","isSelectionAlignToGridAction","selectedJointIds","elementPositions","elementPos","snappedPos","isCopySelectionAction","selectedElements","isDeleteSelectionAction","isMoveSelectionAction","elementSnapMode","jointSnapMode","createSimulatorReducer","createSimulatorSelector","asEvolverDef","module","default","EvolverDefinitionsByType","evolverTypeFromEvolverId","evolver","evolverDefFromEvolverId","EmptyIdArray","EmptyPinInputs","simInit","evolverIdsSelector","outputValues","initNode","collectNodeTransitions","tickWindow","readonlyState","transitionIds","updatedEvolverIds","tid","valuesByOutputPin","updates","outputEvolverIdsFromEvolverIdSelector","inputSourcesByPin","inputPinsByPinIdFromEvolverIdSelector","inputConn","sourcePinId","collectNodeInputs","applyEvolutionResult","evolutionResult","transition","defaultMerger","transitionMerger","transitionTick","isElementTransition","transitionId","transitionWindowIndex","transitionWindow","tickWindowTransitionIndex","removeTransitionById","removeTransitionsByEvolverId","newTransition","splice","addTransition","applyOutputTransition","evolverIdFromElementIdSelector","ACTION_SIM_START","startSim","isStartSimAction","ACTION_SIM_STEP","stepSim","isStepSimAction","ACTION_SIM_TICK","tickSim","tickCount","ACTION_SIM_STOP","stopSim","isStopSimAction","simState","windowTick","isTickSimAction","performance","now","endTick","saftyCount","shift","simTick","updateTime","createSimulatorControlReducer","createSimulatorControlSelector","ACTION_SIM_PAUSE","pauseSim","isSimActiveSelector","isSimRunningSelector","isSimPausedSelector","ticksPerSecondSelector","isPauseSimAction","runMode","ACTION_TUTORIAL_ANNOTATE","tutorialAnnotate","annotations","createTutorialReducer","createTutorialSelector","isTutorialAnnotateAction","ACTION_TUTORIAL_DISMISS","tutorialDismiss","ACTION_TUTORIAL_START","tutorialStart","isTutorialDismissAction","isTutorialStartAction","createUiLayoutReducer","createUiLayoutSelector","removedWindowIds","ACTION_LAYOUT_REARRANGE","isRearrangeLayoutAction","inserted","replace","doWork","newValue","VIEW_RESET","resetView","isResetViewAction","VIEW_ELEMENT_NAMES","viewElementNames","createUiSettingsReducer","createUiSettingsSelector","isViewElementNamesAction","finalizedList","finalizeReducerList","isImportCircuitAction","circuitIds","existingCircuits","importCircuits","c","importElements","importCircuitsFromSave","isTutorialActiveSelector","tutorialAnnotationsSelector","projectMutateSaga","handleProjectMutateAction","localStorage","setItem","JSON","stringify","projectResetSaga","handleProjectNewAction","removeItem","autosaveSaga","ACTION_PAGE_NAVIGATE","navigatePage","page","ACTION_PROJECT_RESTORE_PREVIOUS","restorePreviousProject","projectNameSelector","projectModifiedSelector","projectLoadStateSelector","pageNavigateEditorSaga","onPageNavigate","displayDialogSaga","showDialog","response","ACTION_PROJECT_EXPORT_LINK","exportProjectLink","projectExportLinkSaga","onExportLink","saveText","encoded","encodedText","urlData","encodeURIComponent","projectLink","ACTION_PROJECT_IMPORT_CIRCUITS","importCircuitFromProject","projectImportCircuitsSaga","handleProjectImportCircuits","file","contents","text","bind","parse","scanCircuitIds","targetCircuitIds","elementCircuitId","elementIcCircuitId","ACTION_PROJECT_IMPORT_LINK","projectImportLinkSaga","onImportLink","dewrapped","decodeURIComponent","deflated","ACTION_PROJECT_LOAD","loadProject","projectLoadSaga","lastIndexOf","warn","projectNewSaga","handleNewProject","projectRestorePreviousSaga","handleProjectRestorePrevious","previous","str","loadAutosave","projectSaveSaga","showSaveFilePicker","saveNativeFileApi","saveLegacy","fileHandle","suggestedName","types","description","getFile","renameProject","writable","createWritable","write","close","blob","Blob","saveAs","saveDataSaga","runModeSaga","handleRunSim","waitNextTick","tps","timeToWait","ceil","endWait","timestamp","animationFrameChannel","listener","active","awaitAnimationFrame","requestAnimationFrame","simulatorSaga","getCircuitEditorHtmlId","getElementHtmlId","getElementPinHtmlId","getWireHtmlId","getWireJointHtmlId","ACTION_TUTORIAL_NEXT","addElementTutorialStep","trayMessage","fieldMessage","placement","waitFilterAction","addedElementType","waitElementConnected","isConnected","connInputPin","connOutputPin","actionType","tutorialNextMessage","additionalSelectors","runBasicsTutorial","gateId","switchId","ledId","getCircuitListItemHtmlId","runCircuitsTutorial","addCircuitAction","inputPinId","outputPinId1","outputPinId2","bufferId","notId","icType","led1Id","led2Id","startTutorial","handleStartTutorial","tutorialSaga","composeEnhancers","sagaMiddleware","store","stackItem","undoReducer","redoReducer","undoState","capturedUndoState","captureUndoStateReducer","useAction","actionCreator","preBind","useClickAction","run","variant","disabled","onNavigateHome","onNewProject","onLoadProject","onLoadPreviousProject","hasPreviousSave","hasAutosave","useSelector","useNativeEvent","options","listenTarget","addEventListener","removeEventListener","layoutSelector","title","noopPopoverChildContext","registerPopoverChild","unregisterPopoverChild","PopoverChildContext","PopoverChildContextProvider","contextRegister","contextUnregister","parent","parentRegister","parentUnregister","providedContext","isOpen","anchorEl","onRequestClose","popoverRef","setPopoverRef","attributes","styles","usePopper","popoverContext","ctxRef","usePopoverChild","popoverChildren","defaultValue","items","setItems","addItem","useArrayState","onOutsideEvent","when","onEvent","contains","document","useOutsideMouseEvent","createPortal","popper","zIndex","MenuCloseContext","useMenuCloseContext","MenuCloseContextProvider","content","open","setOpen","onClose","secondary","requestMenuClose","onItemClick","onSaveProject","onImportProjectCircuits","keyboardIsMac","test","os","keyboardCommandModifier","canUndoSelector","canRedoSelector","canPasteSelector","canUndo","onUndo","canRedo","onRedo","canCopy","onCopy","canPaste","onPaste","elementNameModeSelector","onChange","checked","ElementNamesMenu","onAlwaysVisible","onNamedOnly","onHidden","onResetView","TutorialsMenu","onBasicsTutorial","onCircuitsTutorial","averageMsecsPerTickSelector","isActive","isPaused","avgMsecsPerTick","onPlayClick","onStopClick","onPauseClick","onStepClick","onMuteMouseDown","toFixed","Stop","onMouseDown","Play","Step","Pause","CircuitNodeBreadcrumbRootItem","rootCircuitName","CircuitNodeBreadcrumbItem","MinFieldRect","fieldRectSelector","elementRectsById","jointsById","NEW_ELEMENT_DRAG_OBJECT","newElementDragObject","isNewElementDragObject","viewportContext","zoomFactor","zoom","useViewportContext","ViewportContextProvider","setZoomFactor","delta","nullRef","fieldSvgElementContext","svgRef","scalerRef","ContextProvider","FieldSvgElementProvider","circuitIdForElementIdSelector","circuitWouldRecurseSelector","targetCircuitNodeType","targetContainingCircuitId","circuitEditorContext","useCircuitEditor","CircuitEditorProvider","getFieldCoord","field","ctm","getScreenCTM","createSVGPoint","translated","matrixTransform","inverse","useMouseCoords","NamedElementComponents","elementNamesById","borderPath","onViewCircuit","dominantBaseline","fontSize","textAnchor","onDoubleClick","isSimActive","circuitIdPath","onPress","button","onRelease","onColor","onTextColor","onMouseUp","onMouseLeave","offColor","ErrorComponent","componentName","getNodeVisualElement","elementProps","Component","EmptyState","getMouseCoords","counterScale","dragType","setDragType","setDragPos","dropTargetWouldRecurse","coords","snapDragPos","counterScaledSize","opacity","dragModeSelector","isEditorDraggingSelector","isDraggingSelector","dragStartSelector","dragEndSelector","cachedDragMoveOffset","dragMoveOffsetSelector","dragMoveElementPositionsByIdSelector","dragMoveElementPositionsById","dragMoveJointPositionsByIdSelector","JointPositionsById","dragMoveJointPositionsById","dragMoveGhostLinesSelector","getPinPosition","getJointPosition","getSegmentGhostLine","ghostLines","visitedSegments","ghostLine","isDragging","dragMoveElementPositionsByElementId","dragMoveJointPositionsByJointId","movingElements","movingJoints","ghostLineElements","end","useMouseDragDetector","dragThreshold","onDragStart","isTracking","setTracking","mouseDownRef","onMouseMove","startTracking","getModifiers","ctrlKey","altKey","metaKey","selectionRectSelector","ContextMenu","useContextMenu","ctxPos","setCtxPos","openContextMenu","onCloseContextMenu","renderContextMenu","fieldPosition","onAlignToGrid","onDelete","selectionRect","getCoords","onContextMenu","originalPoint","circuitEditorDragStartSelect","strokeDasharray","gridId","gridSize","xmlns","patternUnits","autoFocus","onBeginEdit","onCommit","onCancel","onBlur","onKeyUp","editValue","setEditValue","onInputChange","onInputKeyUp","onInputBlur","textClassname","inputClassname","label","isEditing","onRequestEdit","inputRef","onSpanDoubleClick","select","onEditableCommit","isRenaming","setIsRenaming","onRename","onRenameCancel","onRenameCommit","renameElement","onOpenCircuitInNewWindow","fontWeight","Element","evolverStateFromCircuitElementIdSelector","isSelected","circuitEditorDragStartElement","NodeName","elementFieldDisplayNameFromElementId","textScale","textYOffset","wireLineCandidatesForSegmentId","candidates","outputElementPinFromLineId","selected","excludeSegment","lineHasOutput","inputElementPinsFromLineId","SetLineIdMenu","highlight","setHighlight","isDragTargetPin","isPinDragWireTarget","stopPropagation","onMouseEnter","pinVisual","useEventMouseCoords","buttons","circuitEditorDragContinue","circuitEditorDragEnd","isMouseGesturePending","insertJointPos","setInsertJointPos","isPowered","isWired","segmentIsWiredSelector","dragTargetWireLength","segmentDragWireTargetOffset","segmentType","dragConnectPos","circuitEditorDragStartWireSegment","selectWireSegments","dotPos","isDragTargetJoint","isJointDragWireTarget","mouseOver","setMouseOver","circuitEditorDragStartWireJoint","newSegmentArc","onMouseOver","shapeRendering","segmentElements","jointElements","focus","isDraggingNewElement","dragRef","tabIndex","FieldMouseLayer","ZoomingCircuitFieldSurface","sizeRef","componentWidth","componentHeight","fieldRect","fieldWidth","fieldHeight","deltaY","passive","onCloseWindow","dragSourceRef","useDrag","Close","KEYMAP_SIM_STEP","KEYMAP_SELECT_ALL","KEYMAP_COPY","KEYMAP_PASTE","KEYMAP_DELETE","KEYMAP_UNDO","KEYMAP_REDO","FillParent","SelectionListItem","onItemSelected","CircuitTreeNodeCircuitLabel","onRequestRename","onCancelRename","newName","renameCircuit","onOpenNewWindow","deleteCircuit","CircuitTreeContextMenu","onNewCircuit","arrowRef","setArrowRef","popperStyles","role","arrow","CategoryNames","logic","TrayCategory","toLowerCase","TrayElement","liRef","setLiRef","showTooltip","setShowTooltip","onShowTooltip","onHideTooltip","elementTrayVisual","TrayComponent","NodeTrayErrorComponent","onMouseOut","WindowsById","elementDefinitions","categories","setSearch","onSearchChanged","placeholder","keyHandlers","createEventDispatcher","onViewActivated","circuitEditorReceiveFocus","HotKeys","keyMap","handlers","onFocus","onCircuitSelected","listItems","rearrangeLayout","classList","importError","setImportError","searchParams","URLSearchParams","get","importProjectLink","exact","dialogTypeSelector","dialogDataSelector","onClickOutside","onEscapeKey","AutoFocusInside","acceptText","cancelText","onAccept","footer","onCloseDialog","dialogData","navigator","writeText","catch","dialogFooter","ImportCircuitCheckbox","onSetSelectedIds","setSelectedIds","onAcceptDialog","DialogComponent","unknownDialog","getDialogComponent","Annotation","setElement","MutationObserver","querySelector","childList","subtree","useQuerySelector","scrollIntoView","actions","actionElements","isTutorialActive","tutorialAnnotations","annotation","css","rootEl","getElementById","DndProvider","backend","history","describeArc","radius","startAngle","endAngle","polarToCartesian","largeArcFlag","centerX","centerY","angleInDegrees","angleInRadians","PI","cos","sin"],"mappings":"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","file":"client.6a7299555ef068f5dc84.bundle.js","sourcesContent":["import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_ELEMENT_INTERACT = \"@element/interact\" as const;\r\nexport const interactElement = (elementIdPath: string[], data?: any) => ({\r\n  type: ACTION_ELEMENT_INTERACT,\r\n  payload: { elementIdPath, data },\r\n});\r\nexport type InteractElementAction = ReturnType<typeof interactElement>;\r\nexport function isInteractElementAction(\r\n  action: AnyAction\r\n): action is InteractElementAction {\r\n  return action.type === ACTION_ELEMENT_INTERACT;\r\n}\r\n","import { ElementDefinition } from \"../../types\";\r\n\r\nconst toggleElementDefinition: ElementDefinition = {\r\n  type: \"interaction-momentary\",\r\n  category: \"input-output\",\r\n  displayName: \"Momentary Switch\",\r\n  elementProduction: \"input-momentary\",\r\n  visual: {\r\n    hitRect: {\r\n      p1: { x: 5, y: 5 },\r\n      p2: { x: 45, y: 45 },\r\n    },\r\n    component: \"interaction-momentary\",\r\n  },\r\n  pins: {\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 50,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\n\r\nexport default toggleElementDefinition;\r\n","import { ElementDefinition } from \"../../types\";\r\n\r\nconst toggleElementDefinition: ElementDefinition = {\r\n  type: \"interaction-toggle\",\r\n  category: \"input-output\",\r\n  displayName: \"Toggle Switch\",\r\n  elementProduction: \"input-toggle\",\r\n  visual: {\r\n    hitRect: {\r\n      p1: { x: 5, y: 5 },\r\n      p2: { x: 45, y: 45 },\r\n    },\r\n    component: \"interaction-toggle\",\r\n  },\r\n  pins: {\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 50,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\n\r\nexport default toggleElementDefinition;\r\n","import * as React from \"react\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { boundsToRect } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\n// Shape path from https://commons.wikimedia.org/wiki/File:AND_ANSI.svg\r\n\r\nconst hitPath = `M30 5V45H50.47619c11.267908 0 20-9.000045 20-20s-8.732091-20-20-20H30z`;\r\n\r\nconst andElementDefinition: ElementDefinition = {\r\n  type: \"logic-and\",\r\n  category: \"logic\",\r\n  displayName: \"AND\",\r\n  elementProduction: \"logic-and\",\r\n  visual: createStaticElementVisual(\r\n    boundsToRect(getBounds(hitPath)),\r\n    <g>\r\n      <path d={hitPath} fill=\"transparent\" stroke=\"none\" />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"#000\"\r\n        strokeWidth=\"2\"\r\n        d=\"M70,25 h30 M31,15 H5 M32,35 H5\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--fill\"\r\n        d=\"M30 5V45H50.47619c11.267908 0 20-9.000045 20-20s-8.732091-20-20-20H30zm2.857143 2.857143H50.47619c9.760663 0 16.666667 7.639955 16.666667 17.142857 0 9.502902-7.382195 17.142857-17.142857 17.142857H32.857143V7.857143z\"\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    A: { direction: \"input\", x: 0, y: 14.5 },\r\n    B: { direction: \"input\", x: 0, y: 35 },\r\n    OUT: { direction: \"output\", x: 100, y: 25 },\r\n  },\r\n};\r\nexport default andElementDefinition;\r\n","import * as React from \"react\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { boundsToRect } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\n// Shape path from https://commons.wikimedia.org/wiki/File:Buffer_ANSI.svg\r\n\r\nconst hitPath = `M 28.96875,2.59375 L 28.96875,5 L 28.96875,45 L 28.96875,47.40625 L 31.125,46.34375 L 72.15625,26.34375 L 75,25 L 72.15625,23.65625 L 31.125,3.65625 L 28.96875,2.59375 z`;\r\n\r\nconst bufferElementDefinition: ElementDefinition = {\r\n  type: \"logic-buffer\",\r\n  category: \"logic\",\r\n  displayName: \"Buffer\",\r\n  elementProduction: \"logic-buffer\",\r\n  visual: createStaticElementVisual(\r\n    boundsToRect(getBounds(hitPath)),\r\n    <g>\r\n      <path d={hitPath} fill=\"transparent\" stroke=\"none\" />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"black\"\r\n        strokeWidth=\"2\"\r\n        d=\"M72,25 L 100,25\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"black\"\r\n        strokeWidth=\"2\"\r\n        d=\"M 29.043478,25 L 5.0434781,25\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--fill\"\r\n        stroke=\"none\"\r\n        fill=\"black\"\r\n        d=\"M 28.96875,2.59375 L 28.96875,5 L 28.96875,45 L 28.96875,47.40625 L 31.125,46.34375 L 72.15625,26.34375 L 75,25 L 72.15625,23.65625 L 31.125,3.65625 L 28.96875,2.59375 z M 31.96875,7.40625 L 68.09375,25 L 31.96875,42.59375 L 31.96875,7.40625 z\"\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    IN: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 25,\r\n    },\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 100,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default bufferElementDefinition;\r\n","import * as React from \"react\";\r\n\r\nimport { Rectangle } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\n// Shape path from https://en.wikipedia.org/wiki/NAND_logic#/media/File:NAND_ANSI_Labelled.svg\r\n\r\nconst hitRect: Rectangle = {\r\n  p1: {\r\n    x: 24,\r\n    y: 5,\r\n  },\r\n  p2: {\r\n    x: 80,\r\n    y: 45,\r\n  },\r\n};\r\n\r\nconst nandElementDefinition: ElementDefinition = {\r\n  type: \"logic-nand\",\r\n  category: \"logic\",\r\n  displayName: \"NAND\",\r\n  elementProduction: \"logic-nand\",\r\n  visual: createStaticElementVisual(\r\n    hitRect,\r\n    <g transform=\"translate(-10,0)\">\r\n      <path\r\n        d=\"M 40,5 L 40,6.4285714 L 40,43.571429 L 40,45 L 41.428571,45 L 60.47619,45 C 71.744098,45 80.47619,35.999955 80.47619,25 C 80.47619,14.000045 71.744099,5.0000002 60.47619,5 C 60.47619,5 60.47619,5 41.428571,5 L 40,5 z\"\r\n        stroke=\"none\"\r\n        fill=\"transparent\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        strokeWidth=\"2\"\r\n        stroke=\"black\"\r\n        fill=\"none\"\r\n        d=\"M 88,25 H110\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        strokeWidth=\"2\"\r\n        stroke=\"black\"\r\n        fill=\"none\"\r\n        d=\"M 41,15 L 15,15\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        strokeWidth=\"2\"\r\n        stroke=\"black\"\r\n        fill=\"none\"\r\n        d=\"M 42,35 L 15,35\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--fill\"\r\n        d=\"M 40,5 L 40,6.4285714 L 40,43.571429 L 40,45 L 41.428571,45 L 60.47619,45 C 71.744098,45 80.47619,35.999955 80.47619,25 C 80.47619,14.000045 71.744099,5.0000002 60.47619,5 C 60.47619,5 60.47619,5 41.428571,5 L 40,5 z M 42.857143,7.8571429 C 50.834264,7.8571429 55.918368,7.8571429 58.095238,7.8571429 C 59.285714,7.8571429 59.880952,7.8571429 60.178571,7.8571429 C 60.327381,7.8571429 60.409227,7.8571429 60.446429,7.8571429 C 60.465029,7.8571429 60.471543,7.8571429 60.47619,7.8571429 C 70.236853,7.857143 77.142857,15.497098 77.142857,25 C 77.142857,34.502902 69.760662,42.142857 60,42.142857 L 42.857143,42.142857 L 42.857143,7.8571429 z\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        strokeWidth=\"2\"\r\n        stroke=\"black\"\r\n        fill=\"none\"\r\n        d=\"M 79,25 A 4,4 0 1 1 71,25 A 4,4 0 1 1 79,25 z\"\r\n        transform=\"translate(9,0)\"\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    A: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 14.5,\r\n    },\r\n    B: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 35,\r\n    },\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 100,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default nandElementDefinition;\r\n","import * as React from \"react\";\r\n\r\nimport { Rectangle } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\n// Shape path from https://commons.wikimedia.org/wiki/File:NOR_ANSI.svg\r\n\r\nconst hitRect: Rectangle = {\r\n  p1: {\r\n    x: 24,\r\n    y: 5,\r\n  },\r\n  p2: {\r\n    x: 80,\r\n    y: 45,\r\n  },\r\n};\r\n\r\nconst norElementDefinition: ElementDefinition = {\r\n  type: \"logic-nor\",\r\n  category: \"logic\",\r\n  displayName: \"NOR\",\r\n  elementProduction: \"logic-nor\",\r\n  visual: createStaticElementVisual(\r\n    hitRect,\r\n    <g>\r\n      <path\r\n        fill=\"transparent\"\r\n        stroke=\"none\"\r\n        d=\"M24.09375 5l2 2.4375S31.75 14.437549 31.75 25s-5.65625 17.5625-5.65625 17.5625l-2 2.4375H41.25c2.408076.000001 7.689699.024514 13.625-2.40625s12.536536-7.343266 17.6875-16.875L71.25 25l1.3125-.71875C62.259387 5.21559 46.006574 5 41.25 5H24.09375z\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"#000\"\r\n        strokeWidth=\"2\"\r\n        d=\"M79,25 h21 M31,15 H5 M32,35 H5\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--fill\"\r\n        fillRule=\"evenodd\"\r\n        d=\"M24.09375 5l2 2.4375S31.75 14.437549 31.75 25s-5.65625 17.5625-5.65625 17.5625l-2 2.4375H41.25c2.408076.000001 7.689699.024514 13.625-2.40625s12.536536-7.343266 17.6875-16.875L71.25 25l1.3125-.71875C62.259387 5.21559 46.006574 5 41.25 5H24.09375zm5.875 3H41.25c4.684173 0 18.28685-.130207 27.96875 17C64.451964 33.429075 58.697469 37.68391 53.5 39.8125 48.139339 42.007924 43.658075 42.000001 41.25 42H30c1.873588-3.108434 4.75-9.04935 4.75-17 0-7.973354-2.908531-13.900185-4.78125-17z\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"#000\"\r\n        strokeWidth=\"2\"\r\n        d=\"M79 25a4 4 0 1 1-8 0 4 4 0 1 1 8 0z\"\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    A: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 14.5,\r\n    },\r\n    B: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 35,\r\n    },\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 100,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default norElementDefinition;\r\n","import * as React from \"react\";\r\n\r\nimport { Rectangle } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\n// Shape path from https://commons.wikimedia.org/wiki/File:NOT_ANSI.svg\r\n\r\nconst hitRect: Rectangle = {\r\n  p1: {\r\n    x: 24,\r\n    y: 5,\r\n  },\r\n  p2: {\r\n    x: 80,\r\n    y: 45,\r\n  },\r\n};\r\n\r\nconst notElementDefinition: ElementDefinition = {\r\n  type: \"logic-not\",\r\n  category: \"logic\",\r\n  displayName: \"NOT\",\r\n  elementProduction: \"logic-not\",\r\n  visual: createStaticElementVisual(\r\n    hitRect,\r\n    <g>\r\n      <path\r\n        fill=\"transparent\"\r\n        stroke=\"none\"\r\n        d=\"M28.96875 2.59375v44.8125l2.15625-1.0625 41.03125-20v-2.6875l-41.03125-20-2.15625-1.0625z\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"#000\"\r\n        strokeWidth=\"2\"\r\n        d=\"M79,25 H100 M29,25 h-24\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--fill\"\r\n        d=\"M28.96875 2.59375v44.8125l2.15625-1.0625 41.03125-20v-2.6875l-41.03125-20-2.15625-1.0625zm3 4.8125L68.09375 25l-36.125 17.59375V7.40625z\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"#000\"\r\n        strokeWidth=\"2\"\r\n        d=\"M79 25a4 4 0 1 1-8 0 4 4 0 1 1 8 0z\"\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    IN: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 25,\r\n    },\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 100,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default notElementDefinition;\r\n","import * as React from \"react\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { boundsToRect } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\n// Shape path from https://commons.wikimedia.org/wiki/File:OR_ANSI.svg\r\n\r\nconst hitPath = `M24.09375 5l2 2.4375S31.75 14.437549 31.75 25s-5.65625 17.5625-5.65625 17.5625l-2 2.4375H41.25c2.408076.000001 7.689699.024514 13.625-2.40625s12.536536-7.343266 17.6875-16.875L71.25 25l1.3125-.71875C62.259387 5.21559 46.006574 5 41.25 5H24.09375z`;\r\n\r\nconst orElementDefinition: ElementDefinition = {\r\n  type: \"logic-or\",\r\n  category: \"logic\",\r\n  displayName: \"OR\",\r\n  elementProduction: \"logic-or\",\r\n  visual: createStaticElementVisual(\r\n    boundsToRect(getBounds(hitPath)),\r\n    <g>\r\n      <path d={hitPath} fill=\"transparent\" stroke=\"none\" />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"#000\"\r\n        strokeWidth=\"2\"\r\n        d=\"M70,25 h30 M31,15 H5 M32,35 H5\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--fill\"\r\n        fillRule=\"evenodd\"\r\n        d=\"M24.09375 5l2 2.4375S31.75 14.437549 31.75 25s-5.65625 17.5625-5.65625 17.5625l-2 2.4375H41.25c2.408076.000001 7.689699.024514 13.625-2.40625s12.536536-7.343266 17.6875-16.875L71.25 25l1.3125-.71875C62.259387 5.21559 46.006574 5 41.25 5H24.09375zm5.875 3H41.25c4.684173 0 18.28685-.130207 27.96875 17C64.451964 33.429075 58.697469 37.68391 53.5 39.8125 48.139339 42.007924 43.658075 42.000001 41.25 42H30c1.873588-3.108434 4.75-9.04935 4.75-17 0-7.973354-2.908531-13.900185-4.78125-17z\"\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    A: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 14.5,\r\n    },\r\n    B: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 35,\r\n    },\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 100,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default orElementDefinition;\r\n","import * as React from \"react\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { boundsToRect } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\n// Shape path from https://commons.wikimedia.org/wiki/File:XOR_ANSI.svg\r\n\r\nconst hitPath = `M24.09375 5l2 2.4375S31.75 14.43755 31.75 25s-5.65625 17.5625-5.65625 17.5625l-2 2.4375H41.25c2.40808 0 7.6897.02451 13.625-2.40625s12.53654-7.34327 17.6875-16.875L71.25 25l1.3125-.71875C62.25939 5.21559 46.00657 5 41.25 5H24.09375z`;\r\n\r\nconst xorElementDefinition: ElementDefinition = {\r\n  type: \"logic-xor\",\r\n  category: \"logic\",\r\n  displayName: \"XOR\",\r\n  elementProduction: \"logic-xor\",\r\n  visual: createStaticElementVisual(\r\n    boundsToRect(getBounds(hitPath)),\r\n    <g>\r\n      <path d={hitPath} fill=\"transparent\" stroke=\"none\" />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        fill=\"none\"\r\n        stroke=\"#000\"\r\n        strokeWidth=\"2\"\r\n        d=\"M70,25 h30 M30,15 H5 M31,35 H5\"\r\n      />\r\n      <g fillRule=\"evenodd\" className=\"element-select-highlight--fill\">\r\n        <path d=\"M24.25 42C22.65263 44.6444 22 45 22 45h-3.65625l2-2.4375S26 35.56245 26 25 20.34375 7.4375 20.34375 7.4375l-2-2.4375H22c.78125.9375 1.42188 1.65625 2.21875 3C26.09147 11.09981 29 17.02665 29 25c0 7.95065-2.8967 13.87942-4.75 17z\" />\r\n        <path d=\"M24.09375 5l2 2.4375S31.75 14.43755 31.75 25s-5.65625 17.5625-5.65625 17.5625l-2 2.4375H41.25c2.40808 0 7.6897.02451 13.625-2.40625s12.53654-7.34327 17.6875-16.875L71.25 25l1.3125-.71875C62.25939 5.21559 46.00657 5 41.25 5H24.09375zm5.875 3H41.25c4.68417 0 18.28685-.1302 27.96875 17C64.45196 33.42907 58.69747 37.68391 53.5 39.8125 48.13934 42.00792 43.65808 42 41.25 42H30c1.87359-3.10843 4.75-9.04935 4.75-17 0-7.97335-2.90853-13.90019-4.78125-17z\" />\r\n      </g>\r\n    </g>\r\n  ),\r\n  pins: {\r\n    A: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 14.5,\r\n    },\r\n    B: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 35,\r\n    },\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 100,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default xorElementDefinition;\r\n","import { LedEvolverState } from \"@/evolvers/definitions/output-led\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createShapePathVisual } from \"../../visuals/ShapePathElementVisual\";\r\n\r\nfunction genCirclePath(cx: number, cy: number, r: number): string {\r\n  return `M ${cx - r}, ${cy}\r\n    a ${r},${r} 0 1,0 ${r * 2},0\r\n    a ${r},${r} 0 1,0 ${-(r * 2)},0`;\r\n}\r\n\r\nconst path = genCirclePath(25, 25, 20);\r\n\r\nconst ledElementDefinition: ElementDefinition = {\r\n  type: \"output-led\",\r\n  category: \"input-output\",\r\n  displayName: \"Indicator Light\",\r\n  elementProduction: \"output-led\",\r\n  visual: createShapePathVisual(path, {\r\n    path,\r\n    stroke: \"black\",\r\n    strokeWidth: 3,\r\n    fill: (state: LedEvolverState) =>\r\n      state.value ? \"lightgreen\" : \"darkgreen\",\r\n  }),\r\n  pins: {\r\n    IN: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default ledElementDefinition;\r\n","import { ElementDefinition } from \"../../types\";\r\nimport {\r\n  createShapePathVisual,\r\n  ShapePathDefinition,\r\n} from \"../../visuals/ShapePathElementVisual\";\r\n\r\n// Shape path from https://commons.wikimedia.org/wiki/File:7-segment_abcdefg.svg\r\n\r\nconst SCALE = 3;\r\nconst OFFSET = [15, 0];\r\n\r\n/**\r\n * Produce a visual path definition of a segment given a series of polygon points.\r\n * The path definition will color itself based on the state key specified by 'name'\r\n * @param name The state key to select color based on.  The key should represent a boolean value.\r\n * @param points An array of [x,y] pairs that make up the polygon.\r\n */\r\nfunction createSeg(\r\n  name: string,\r\n  points: [number, number][]\r\n): ShapePathDefinition {\r\n  const start = points[0];\r\n  let path = `M${start[0] * SCALE + OFFSET[0]},${start[1] * SCALE + OFFSET[1]}`;\r\n  for (const p of points.slice(1)) {\r\n    const [x, y] = p;\r\n    path += `L${x * SCALE + OFFSET[0]},${y * SCALE + OFFSET[1]}`;\r\n  }\r\n  path += \"z\";\r\n  return {\r\n    path,\r\n    fill: (state) => (state[name] ? \"red\" : \"gray\"),\r\n    strokeWidth: 0,\r\n  };\r\n}\r\n\r\nconst seg7ElementDefinition: ElementDefinition = {\r\n  type: \"output-seg7\",\r\n  category: \"input-output\",\r\n  displayName: \"7-Segment Display\",\r\n  elementProduction: \"output-seg7\",\r\n  visual: createShapePathVisual(`M15,0 V63 H45 V0 z`, [\r\n    createSeg(\"A\", [\r\n      [1, 1],\r\n      [2, 0],\r\n      [8, 0],\r\n      [9, 1],\r\n      [8, 2],\r\n      [2, 2],\r\n    ]),\r\n    createSeg(\"B\", [\r\n      [9, 1],\r\n      [10, 2],\r\n      [10, 8],\r\n      [9, 9],\r\n      [8, 8],\r\n      [8, 2],\r\n    ]),\r\n    createSeg(\"C\", [\r\n      [9, 9],\r\n      [10, 10],\r\n      [10, 16],\r\n      [9, 17],\r\n      [8, 16],\r\n      [8, 10],\r\n    ]),\r\n    createSeg(\"D\", [\r\n      [9, 17],\r\n      [8, 18],\r\n      [2, 18],\r\n      [1, 17],\r\n      [2, 16],\r\n      [8, 16],\r\n    ]),\r\n    createSeg(\"E\", [\r\n      [1, 17],\r\n      [0, 16],\r\n      [0, 10],\r\n      [1, 9],\r\n      [2, 10],\r\n      [2, 16],\r\n    ]),\r\n    createSeg(\"F\", [\r\n      [1, 9],\r\n      [0, 8],\r\n      [0, 2],\r\n      [1, 1],\r\n      [2, 2],\r\n      [2, 8],\r\n    ]),\r\n    createSeg(\"G\", [\r\n      [1, 9],\r\n      [2, 8],\r\n      [8, 8],\r\n      [9, 9],\r\n      [8, 10],\r\n      [2, 10],\r\n    ]),\r\n  ]),\r\n  pins: {\r\n    A: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 5,\r\n    },\r\n    B: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 15,\r\n    },\r\n    C: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 25,\r\n    },\r\n    D: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 35,\r\n    },\r\n    E: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 45,\r\n    },\r\n    F: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 55,\r\n    },\r\n    G: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 65,\r\n    },\r\n  },\r\n};\r\nexport default seg7ElementDefinition;\r\n","import * as React from \"react\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { boundsToRect } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\nconst hitPath = `M15,25 a 10,10 0 1,0 20 0 a 10,10 0 1,0 -20,0`;\r\n\r\nconst pinHighElementDefinition: ElementDefinition = {\r\n  type: \"pin-high\",\r\n  category: \"input-output\",\r\n  elementProduction: \"pin-high\",\r\n  displayName: \"High Pin\",\r\n  visual: createStaticElementVisual(\r\n    boundsToRect(getBounds(hitPath)),\r\n    <g>\r\n      <path d={hitPath} fill=\"transparent\" stroke=\"none\" />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        d=\"M15,25 a 10,10 0 1,0 20 0 a 10,10 0 1,0 -20,0 M35,25 h15\"\r\n        stroke=\"black\"\r\n        strokeWidth={2}\r\n        fill=\"none\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        d=\"M25,20 v10 M20,25 h10\"\r\n        fill=\"none\"\r\n        stroke=\"black\"\r\n        strokeWidth={2}\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 50,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default pinHighElementDefinition;\r\n","import * as React from \"react\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { boundsToRect } from \"@/geometry\";\r\nimport { describeArc } from \"@/svg\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\nconst hitPath = `M15,25 a 10,10 0 1,0 20 0 a 10,10 0 1,0 -20,0`;\r\n\r\nconst pinInputElementDefinition: ElementDefinition = {\r\n  type: \"pin-input\",\r\n  category: \"input-output\",\r\n  displayName: \"Input Pin\",\r\n  visual: createStaticElementVisual(\r\n    boundsToRect(getBounds(hitPath)),\r\n    <g>\r\n      <path d={hitPath} fill=\"transparent\" stroke=\"none\" />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        d=\"M15,25 a 10,10 0 1,0 20 0 a 10,10 0 1,0 -20,0 M35,25 h15\"\r\n        stroke=\"black\"\r\n        strokeWidth={2}\r\n        fill=\"none\"\r\n      />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        d={describeArc(25, 25, 3, -45, 225)}\r\n        fill=\"none\"\r\n        stroke=\"black\"\r\n        strokeWidth={2}\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    OUT: {\r\n      direction: \"output\",\r\n      x: 50,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default pinInputElementDefinition;\r\n","import * as React from \"react\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { boundsToRect } from \"@/geometry\";\r\n\r\nimport { ElementDefinition } from \"../../types\";\r\nimport { createStaticElementVisual } from \"../../visuals/static-element-visual\";\r\n\r\nconst hitPath = `M15,25 a 10,10 0 1,0 20 0 a 10,10 0 1,0 -20,0`;\r\n\r\nconst pinOutputElementDefinition: ElementDefinition = {\r\n  type: \"pin-output\",\r\n  category: \"input-output\",\r\n  displayName: \"Output Pin\",\r\n  visual: createStaticElementVisual(\r\n    boundsToRect(getBounds(hitPath)),\r\n    <g>\r\n      <path d={hitPath} fill=\"transparent\" stroke=\"none\" />\r\n      <path\r\n        className=\"element-select-highlight--stroke\"\r\n        d=\"M15,25 a 10,10 0 1,0 20 0 a 10,10 0 1,0 -20,0 M15,25 h-12\"\r\n        stroke=\"black\"\r\n        strokeWidth={2}\r\n        fill=\"none\"\r\n      />\r\n      <circle\r\n        className=\"element-select-highlight--fill\"\r\n        cx={25}\r\n        cy={25}\r\n        r={3}\r\n        fill=\"black\"\r\n        stroke=\"none\"\r\n      />\r\n    </g>\r\n  ),\r\n  pins: {\r\n    IN: {\r\n      direction: \"input\",\r\n      x: 0,\r\n      y: 25,\r\n    },\r\n  },\r\n};\r\nexport default pinOutputElementDefinition;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { boundsToRect, Rectangle } from \"@/geometry\";\r\n\r\nimport { interactElement } from \"@/actions/element-interact\";\r\n\r\nimport { ElementComponentProps, ElementVisualDefinition } from \"../types\";\r\n\r\nexport interface ShapePathDefinition {\r\n  /**\r\n   * The svg path of this visual element.\r\n   */\r\n  path: string;\r\n  /**\r\n   * The fill or fill-producing function for this visual element.\r\n   */\r\n  fill?: string | ((state: any) => string);\r\n  stroke?: string | ((state: any) => string);\r\n  strokeWidth?: number | ((state: any) => number);\r\n}\r\n\r\nexport type ShapePath = string | ShapePathDefinition;\r\n\r\ninterface ShapePathElementVisualProps {\r\n  /**\r\n   * The path or paths that make up the visual component of this element.\r\n   */\r\n  shapePath: ShapePath | ShapePath[];\r\n  hitPath: string;\r\n}\r\n\r\nconst ShapePathElementVisual: React.FC<\r\n  ShapePathElementVisualProps & ElementComponentProps\r\n> = ({ elementId, elementPath, shapePath, hitPath, evolverState }) => {\r\n  const dispatch = useDispatch();\r\n\r\n  const onClick = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (!elementId) {\r\n        return;\r\n      }\r\n\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      e.preventDefault();\r\n\r\n      dispatch(interactElement([...(elementPath || []), elementId]));\r\n    },\r\n    [elementId, dispatch, elementPath]\r\n  );\r\n\r\n  const visuals = normalizeVisuals(shapePath, evolverState);\r\n  const body = visuals.map((v, i) => (\r\n    <path\r\n      key={i}\r\n      d={v.path}\r\n      className=\"element-select-highlight--stroke element-select-highlight--fill\"\r\n      fill={v.fill}\r\n      stroke={v.stroke}\r\n      strokeWidth={v.strokeWidth}\r\n    />\r\n  ));\r\n\r\n  return (\r\n    <g onClick={onClick}>\r\n      <path d={hitPath} fill=\"transparent\" stroke=\"none\" />\r\n      {body}\r\n    </g>\r\n  );\r\n};\r\n\r\ninterface ShapePathElementTrayItemProps {\r\n  shapePath: ShapePath | ShapePath[];\r\n  hitRect: Rectangle;\r\n}\r\nconst TrayShapePadding = 5;\r\nconst ShapePathElementTrayItem: React.FC<ShapePathElementTrayItemProps> = ({\r\n  shapePath,\r\n  hitRect,\r\n}) => {\r\n  const visuals = normalizeVisuals(shapePath, {});\r\n  const body = visuals.map((v, i) => (\r\n    <path\r\n      key={i}\r\n      d={v.path}\r\n      className=\"element-select-highlight--stroke element-select-highlight--fill\"\r\n      fill={v.fill}\r\n      stroke={v.stroke}\r\n      strokeWidth={v.strokeWidth}\r\n    />\r\n  ));\r\n\r\n  return (\r\n    <svg\r\n      width={50}\r\n      height={50}\r\n      viewBox={`${hitRect.p1.x - TrayShapePadding} ${\r\n        hitRect.p1.y - TrayShapePadding\r\n      } ${hitRect.p2.x - hitRect.p1.x + TrayShapePadding * 2} ${\r\n        hitRect.p2.y - hitRect.p1.y + TrayShapePadding * 2\r\n      }`}\r\n    >\r\n      {body}\r\n    </svg>\r\n  );\r\n};\r\n\r\nexport function createShapePathVisual(\r\n  hitPath: string,\r\n  shapePath: ShapePath | ShapePath[]\r\n): ElementVisualDefinition {\r\n  const hitRect = boundsToRect(getBounds(hitPath));\r\n  return {\r\n    trayComponent: () => (\r\n      <ShapePathElementTrayItem shapePath={shapePath} hitRect={hitRect} />\r\n    ),\r\n    component: (props: ElementComponentProps) => (\r\n      <ShapePathElementVisual\r\n        shapePath={shapePath}\r\n        hitPath={hitPath}\r\n        {...props}\r\n      />\r\n    ),\r\n    hitRect,\r\n  };\r\n}\r\n\r\nfunction normalizeVisuals(\r\n  v: ShapePath | ShapePath[],\r\n  state: any\r\n): { path: string; fill?: string; stroke?: string; strokeWidth?: number }[] {\r\n  const asArray = Array.isArray(v) ? v : [v];\r\n\r\n  return asArray.map((x) => {\r\n    if (typeof x === \"string\") {\r\n      return {\r\n        path: x,\r\n        fill: \"black\",\r\n        stroke: \"black\",\r\n        strokeWidth: 2,\r\n      };\r\n    }\r\n    const fill = typeof x.fill === \"function\" ? x.fill(state || {}) : x.fill;\r\n    const stroke =\r\n      typeof x.stroke === \"function\" ? x.stroke(state || {}) : x.stroke;\r\n    const strokeWidth =\r\n      typeof x.strokeWidth === \"function\"\r\n        ? x.strokeWidth(state || {})\r\n        : x.strokeWidth;\r\n    return {\r\n      path: x.path,\r\n      fill,\r\n      stroke,\r\n      strokeWidth,\r\n    };\r\n  });\r\n}\r\n","import * as React from \"react\";\r\n\r\nimport { Rectangle } from \"@/geometry\";\r\n\r\nimport { ElementVisualDefinition } from \"../types\";\r\n\r\nconst TrayComponentPadding = 5;\r\n\r\nexport function createStaticElementVisual(\r\n  hitRect: Rectangle,\r\n  element: JSX.Element\r\n): ElementVisualDefinition {\r\n  return {\r\n    hitRect,\r\n    trayComponent: () => (\r\n      <svg\r\n        width={50}\r\n        height={50}\r\n        viewBox={`${hitRect.p1.x - TrayComponentPadding} ${\r\n          hitRect.p1.y - TrayComponentPadding\r\n        } ${hitRect.p2.x - hitRect.p1.x + TrayComponentPadding * 2} ${\r\n          hitRect.p2.y - hitRect.p1.y + TrayComponentPadding * 2\r\n        }`}\r\n      >\r\n        {element}\r\n      </svg>\r\n    ),\r\n    component: () => element,\r\n  };\r\n}\r\n","export const EVOLVER_RESPONSE_TIME = 4;\r\n","import { EvolutionResult } from \"@/logic\";\r\n\r\nimport { EVOLVER_RESPONSE_TIME } from \"../constants\";\r\nimport { EvolverDefinition } from \"../types\";\r\n\r\nconst inputMomentaryEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [],\r\n  outputPins: [\"OUT\"],\r\n  interact(state: any, data: any): EvolutionResult {\r\n    if (data === undefined) {\r\n      return {\r\n        transitions: [\r\n          {\r\n            tickOffset: 1,\r\n            valuesByPin: { OUT: true },\r\n          },\r\n          {\r\n            tickOffset: 1 + Math.round(EVOLVER_RESPONSE_TIME * 1.5),\r\n            valuesByPin: { OUT: false },\r\n          },\r\n        ],\r\n      };\r\n    } else if (data) {\r\n      return {\r\n        transitions: {\r\n          tickOffset: 1,\r\n          valuesByPin: { OUT: true },\r\n        },\r\n      };\r\n    } else {\r\n      return {\r\n        transitions: {\r\n          tickOffset: 1,\r\n          valuesByPin: { OUT: false },\r\n        },\r\n      };\r\n    }\r\n  },\r\n};\r\nexport default inputMomentaryEvolverDefinition;\r\n","import { EvolverDefinition } from \"../types\";\r\n\r\nexport interface ToggleEvolverState {\r\n  toggleState: boolean;\r\n}\r\nconst defaultToggleState: ToggleEvolverState = {\r\n  toggleState: false,\r\n};\r\n\r\nconst inputToggleEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [],\r\n  outputPins: [\"OUT\"],\r\n  interact(state: ToggleEvolverState = defaultToggleState) {\r\n    const nextState = !state.toggleState;\r\n    return {\r\n      state: Object.assign({}, state, {\r\n        toggleState: nextState,\r\n      }),\r\n      transitions: {\r\n        tickOffset: 1,\r\n        valuesByPin: { OUT: nextState },\r\n      },\r\n    };\r\n  },\r\n  evolve: (state: ToggleEvolverState = defaultToggleState) => {\r\n    return {\r\n      state,\r\n      transitions: {\r\n        tickOffset: 1,\r\n        valuesByPin: { OUT: state.toggleState },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default inputToggleEvolverDefinition;\r\n","import { EVOLVER_RESPONSE_TIME } from \"../constants\";\r\nimport { EvolverDefinition } from \"../types\";\r\n\r\nconst logicAndEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"A\", \"B\"],\r\n  outputPins: [\"OUT\"],\r\n  evolve(_, inputs) {\r\n    return {\r\n      transitions: {\r\n        tickOffset: EVOLVER_RESPONSE_TIME,\r\n        valuesByPin: { OUT: inputs.A && inputs.B },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default logicAndEvolverDefinition;\r\n","import { EVOLVER_RESPONSE_TIME } from \"../constants\";\r\nimport { EvolverDefinition } from \"../types\";\r\n\r\nconst logicBufferEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"IN\"],\r\n  outputPins: [\"OUT\"],\r\n  evolve(_, inputs) {\r\n    return {\r\n      transitions: {\r\n        tickOffset: EVOLVER_RESPONSE_TIME,\r\n        valuesByPin: { OUT: inputs.IN },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default logicBufferEvolverDefinition;\r\n","import { EVOLVER_RESPONSE_TIME } from \"../constants\";\r\nimport { EvolverDefinition } from \"../types\";\r\n\r\nconst logicNandEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"A\", \"B\"],\r\n  outputPins: [\"OUT\"],\r\n  evolve(_, inputs) {\r\n    return {\r\n      transitions: {\r\n        tickOffset: EVOLVER_RESPONSE_TIME,\r\n        valuesByPin: { OUT: !(inputs.A && inputs.B) },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default logicNandEvolverDefinition;\r\n","import { EVOLVER_RESPONSE_TIME } from \"../constants\";\r\nimport { EvolverDefinition } from \"../types\";\r\n\r\nconst logicNorEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"A\", \"B\"],\r\n  outputPins: [\"OUT\"],\r\n  evolve(_, inputs) {\r\n    return {\r\n      transitions: {\r\n        tickOffset: EVOLVER_RESPONSE_TIME,\r\n        valuesByPin: { OUT: !(inputs.A || inputs.B) },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default logicNorEvolverDefinition;\r\n","import { EVOLVER_RESPONSE_TIME } from \"../constants\";\r\nimport { EvolverDefinition } from \"../types\";\r\n\r\nconst logicNotEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"IN\"],\r\n  outputPins: [\"OUT\"],\r\n  evolve(_, inputs) {\r\n    return {\r\n      transitions: {\r\n        tickOffset: EVOLVER_RESPONSE_TIME,\r\n        valuesByPin: { OUT: !inputs.IN },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default logicNotEvolverDefinition;\r\n","import { EVOLVER_RESPONSE_TIME } from \"../constants\";\r\nimport { EvolverDefinition } from \"../types\";\r\n\r\nconst logicOrEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"A\", \"B\"],\r\n  outputPins: [\"OUT\"],\r\n  evolve(_, inputs) {\r\n    return {\r\n      transitions: {\r\n        tickOffset: EVOLVER_RESPONSE_TIME,\r\n        valuesByPin: { OUT: inputs.A || inputs.B },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default logicOrEvolverDefinition;\r\n","import { EVOLVER_RESPONSE_TIME } from \"../constants\";\r\nimport { EvolverDefinition } from \"../types\";\r\n\r\nconst logicXorEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"A\", \"B\"],\r\n  outputPins: [\"OUT\"],\r\n  evolve(_, inputs) {\r\n    return {\r\n      transitions: {\r\n        tickOffset: EVOLVER_RESPONSE_TIME,\r\n        valuesByPin: { OUT: (inputs.A || inputs.B) && inputs.A != inputs.B },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default logicXorEvolverDefinition;\r\n","import { EvolverDefinition } from \"../types\";\r\n\r\nexport interface LedEvolverState {\r\n  value: boolean;\r\n}\r\n\r\nconst outputLedEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"IN\"],\r\n  outputPins: [],\r\n  evolve(_, inputs) {\r\n    return {\r\n      state: {\r\n        value: inputs.IN,\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default outputLedEvolverDefinition;\r\n","import { EvolverDefinition } from \"../types\";\r\n\r\nconst outputSeg7EvolverDefinition: EvolverDefinition = {\r\n  inputPins: [\"A\", \"B\", \"C\", \"D\", \"E\", \"F\", \"G\"],\r\n  outputPins: [],\r\n  evolve(_, inputs) {\r\n    return {\r\n      state: { ...inputs },\r\n    };\r\n  },\r\n};\r\nexport default outputSeg7EvolverDefinition;\r\n","import { EvolverDefinition } from \"../types\";\r\n\r\nconst pinHighEvolverDefinition: EvolverDefinition = {\r\n  inputPins: [],\r\n  outputPins: [\"OUT\"],\r\n  evolve() {\r\n    return {\r\n      transitions: {\r\n        tickOffset: 1,\r\n        valuesByPin: { OUT: true },\r\n      },\r\n    };\r\n  },\r\n};\r\nexport default pinHighEvolverDefinition;\r\n","export interface Point {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\nexport interface Size {\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface Rectangle {\r\n  p1: Point;\r\n  p2: Point;\r\n}\r\n\r\n// Bit silly to have two ways of tracking a rectangular region, but this is inherited from svg-path-bounds\r\nexport type Bounds = [left: number, top: number, right: number, bottom: number];\r\n\r\nexport const ZeroPoint = Object.freeze({ x: 0, y: 0 });\r\nexport const ZeroRect = Object.freeze({ p1: ZeroPoint, p2: ZeroPoint });\r\n\r\nexport function boundsToRect(bounds: Bounds): Rectangle {\r\n  return {\r\n    p1: { x: bounds[0], y: bounds[1] },\r\n    p2: { x: bounds[2], y: bounds[3] },\r\n  };\r\n}\r\n\r\nexport function snapValue(v: number, snap: number) {\r\n  return Math.round(v / snap) * snap;\r\n}\r\nexport function snapPoint(p: Point, snap: number) {\r\n  return {\r\n    x: snapValue(p.x, snap),\r\n    y: snapValue(p.y, snap),\r\n  };\r\n}\r\n\r\nexport function magnitude(v: Point): number {\r\n  return Math.sqrt(v.x * v.x + v.y * v.y);\r\n}\r\nexport function normalize(p: Point): Point {\r\n  const m = magnitude(p);\r\n  return {\r\n    x: p.x / m,\r\n    y: p.y / m,\r\n  };\r\n}\r\n\r\nexport function dotProduct(a: Point, b: Point): number {\r\n  return a.x * b.x + a.y * b.y;\r\n}\r\n\r\nexport function scale(p: Point, scaler: number) {\r\n  return { x: p.x * scaler, y: p.y * scaler };\r\n}\r\n\r\nexport function normalizeRectangle(p1: Point, p2: Point): Rectangle;\r\nexport function normalizeRectangle(r: Rectangle): Rectangle;\r\nexport function normalizeRectangle(...args: any[]): Rectangle {\r\n  let p1: Point;\r\n  let p2: Point;\r\n  if (args.length === 1) {\r\n    const r = args[0] as Rectangle;\r\n    p1 = r.p1;\r\n    p2 = r.p2;\r\n  } else {\r\n    p1 = args[0] as Point;\r\n    p2 = args[1] as Point;\r\n  }\r\n  return {\r\n    p1: {\r\n      x: Math.min(p1.x, p2.x),\r\n      y: Math.min(p1.y, p2.y),\r\n    },\r\n    p2: {\r\n      x: Math.max(p1.x, p2.x),\r\n      y: Math.max(p1.y, p2.y),\r\n    },\r\n  };\r\n}\r\n\r\nexport function offsetRectangle(rect: Rectangle, offset: Point) {\r\n  return {\r\n    p1: pointAdd(rect.p1, offset),\r\n    p2: pointAdd(rect.p2, offset),\r\n  };\r\n}\r\n\r\nexport function pointAdd(p1: Point, p2: Point): Point {\r\n  return {\r\n    x: p1.x + p2.x,\r\n    y: p1.y + p2.y,\r\n  };\r\n}\r\nexport function pointSubtract(p1: Point, p2: Point): Point {\r\n  return {\r\n    x: p1.x - p2.x,\r\n    y: p1.y - p2.y,\r\n  };\r\n}\r\nexport function pointEquals(p1: Point, p2: Point): boolean {\r\n  return p1.x === p2.x && p1.y === p2.y;\r\n}\r\n\r\nexport function pointIntersectsRect(p: Point, r: Rectangle): boolean {\r\n  r = normalizeRectangle(r);\r\n\r\n  if (r.p1.x > p.x || r.p2.x < p.x) {\r\n    return false;\r\n  }\r\n\r\n  if (r.p1.y > p.y || r.p2.y < p.y) {\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\nexport function calcSize(r: Rectangle): Size {\r\n  r = normalizeRectangle(r);\r\n  return {\r\n    width: r.p2.x - r.p1.x,\r\n    height: r.p2.y - r.p1.y,\r\n  };\r\n}\r\n\r\nexport function union(r1: Rectangle, r2: Rectangle): Rectangle {\r\n  r1 = normalizeRectangle(r1);\r\n  r2 = normalizeRectangle(r2);\r\n  return {\r\n    p1: {\r\n      x: Math.min(r1.p1.x, r2.p1.x),\r\n      y: Math.min(r1.p1.y, r2.p1.y),\r\n    },\r\n    p2: {\r\n      x: Math.max(r1.p2.x, r2.p2.x),\r\n      y: Math.max(r1.p2.y, r2.p2.y),\r\n    },\r\n  };\r\n}\r\n\r\nexport function rectIntersectsRect(r1: Rectangle, r2: Rectangle): boolean {\r\n  r1 = normalizeRectangle(r1);\r\n  r2 = normalizeRectangle(r2);\r\n\r\n  // r1 starts after p2's extent, or does not reach r2's start.\r\n  if (r1.p1.x > r2.p2.x || r1.p2.x < r2.p1.x) {\r\n    return false;\r\n  }\r\n\r\n  // r1 starts after p2's extent, or does not reach r2's start.\r\n  if (r1.p1.y > r2.p2.y || r1.p2.y < r2.p1.y) {\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\nexport interface LinePointInterceptOpts {\r\n  threshhold?: number;\r\n  axialGridSnap?: number;\r\n}\r\n\r\nexport interface LinePointInterceptResult {\r\n  interceptPoint: Point;\r\n  interceptLineLengthDistance: number;\r\n  interceptLinePointDistance: number;\r\n}\r\nexport function linePointIntercept(\r\n  lineStart: Point,\r\n  lineEnd: Point,\r\n  point: Point,\r\n  { threshhold = 4, axialGridSnap = 0 }: LinePointInterceptOpts\r\n): LinePointInterceptResult | null {\r\n  const lineSub = pointSubtract(lineEnd, lineStart);\r\n  const lineLength = magnitude(lineSub);\r\n  const lineVector = normalize(lineSub);\r\n\r\n  if (Number.isNaN(lineVector.x) || Number.isNaN(lineVector.y)) {\r\n    return null;\r\n  }\r\n\r\n  const v = pointSubtract(point, lineStart);\r\n  const interceptDistance = dotProduct(v, lineVector);\r\n\r\n  if (interceptDistance < 0 || interceptDistance > lineLength) {\r\n    return null;\r\n  }\r\n\r\n  const interceptPoint = pointAdd(\r\n    lineStart,\r\n    scale(lineVector, interceptDistance)\r\n  );\r\n\r\n  if (axialGridSnap > 0) {\r\n    // If snapping is enabled, snap to the axis the line follows.\r\n    if (Math.abs(lineVector.x) === 1) {\r\n      interceptPoint.x = snapValue(interceptPoint.x, axialGridSnap);\r\n    }\r\n    if (Math.abs(lineVector.y) === 1) {\r\n      interceptPoint.y = snapValue(interceptPoint.y, axialGridSnap);\r\n    }\r\n  }\r\n\r\n  const lineToDotDist = magnitude(pointSubtract(point, interceptPoint));\r\n  if (lineToDotDist > threshhold) {\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    interceptPoint,\r\n    // Point may have snapped, recalculate distance\r\n    interceptLineLengthDistance: magnitude(\r\n      pointSubtract(interceptPoint, lineStart)\r\n    ),\r\n    interceptLinePointDistance: lineToDotDist,\r\n  };\r\n}\r\n","import { createHashHistory } from \"history\";\r\n\r\nconst history = createHashHistory();\r\n\r\nexport default history;\r\n","import { Point } from \"@/geometry\";\r\nimport { ModifierKeys } from \"@/modifier-keys\";\r\nimport { WireConnectTarget } from \"../circuit-graph/types\";\r\n\r\nexport interface CircuitEditorDragNullState {\r\n  dragMode: null;\r\n}\r\n\r\nexport interface CircuitEditorDragActiveState {\r\n  /**\r\n   * The editor this drag operation started in.\r\n   */\r\n  dragStartEditorId: string;\r\n\r\n  /**\r\n   * The start of the drag operation.\r\n   */\r\n  dragStart: Point;\r\n\r\n  /**\r\n   * The editor the drag operation is currently in.\r\n   */\r\n  dragEndEditorId: string | null;\r\n\r\n  /**\r\n   * The current end point for the drag operation.  This does not indicate the final\r\n   * drag position, but the current most up to date position.\r\n   */\r\n  dragEnd: Point | null;\r\n\r\n  /**\r\n   * The modifier keys in play for the drag operation.\r\n   */\r\n  dragModifierKeys: ModifierKeys;\r\n}\r\n\r\nexport interface CircuitEditorDragMoveState\r\n  extends CircuitEditorDragActiveState {\r\n  dragMode: \"move\";\r\n}\r\n\r\nexport interface CircuitEditorDragSelectState\r\n  extends CircuitEditorDragActiveState {\r\n  dragMode: \"select\";\r\n}\r\n\r\nexport interface CircuitEditorDragWireState\r\n  extends CircuitEditorDragActiveState {\r\n  dragMode: \"wire\";\r\n\r\n  /**\r\n   * The wire connection target this drag is starting from.\r\n   */\r\n  dragStartTarget: WireConnectTarget;\r\n}\r\n\r\nexport interface CircuitEditorDragWireSegmentNewJointState\r\n  extends CircuitEditorDragActiveState {\r\n  dragMode: \"wire-segment-new-joint\";\r\n\r\n  /**\r\n   * The id of the wire whose segment is being dragged.\r\n   */\r\n  dragWireId: string;\r\n\r\n  /**\r\n   * The id of the wire segment being dragged.\r\n   */\r\n  dragWireSegmentId: string;\r\n}\r\n\r\nexport type CircuitEditorDragServiceState =\r\n  | CircuitEditorDragNullState\r\n  | CircuitEditorDragMoveState\r\n  | CircuitEditorDragSelectState\r\n  | CircuitEditorDragWireState\r\n  | CircuitEditorDragWireSegmentNewJointState;\r\n\r\nconst _defaultState: CircuitEditorDragServiceState = {\r\n  dragMode: null,\r\n};\r\n\r\nexport const defaultCircuitEditorDragServiceState = Object.freeze(\r\n  _defaultState\r\n);\r\n","export const ROOT_CIRCUIT_ID = \"root\";\r\n","export const DEFAULT_CIRCUIT_EDITOR_ID = \"root-editor\";\r\n","import { ROOT_CIRCUIT_ID } from \"../circuits/constants\";\r\n\r\nimport { DEFAULT_CIRCUIT_EDITOR_ID } from \"./constants\";\r\n\r\nexport interface CircuitEditorState {\r\n  circuitId: string;\r\n  elementIdPath: string[];\r\n}\r\n\r\nexport interface CircuitEditorsServiceState {\r\n  circucitEditorsById: Record<string, CircuitEditorState>;\r\n  activeEditorId: string | null;\r\n}\r\n\r\nconst _defaultState: CircuitEditorsServiceState = {\r\n  circucitEditorsById: {\r\n    [DEFAULT_CIRCUIT_EDITOR_ID]: {\r\n      circuitId: ROOT_CIRCUIT_ID,\r\n      elementIdPath: [],\r\n    },\r\n  },\r\n  activeEditorId: null,\r\n};\r\n\r\nexport const defaultCircuitEditorServiceState = Object.freeze(_defaultState);\r\n","import { Point } from \"@/geometry\";\r\nimport { ROOT_CIRCUIT_ID } from \"../circuits/constants\";\r\n\r\nimport { Element, Wire, WireSegment } from \"./types\";\r\n\r\nexport interface CircuitGraphServiceState {\r\n  /**\r\n   * Arrays of element ids contained in a circuit by the containing circuit id.\r\n   */\r\n  elementIdsByCircuitId: Record<string, string[]>;\r\n\r\n  /**\r\n   * A map of elements by element id.\r\n   */\r\n  elementsById: Record<string, Element>;\r\n\r\n  /**\r\n   * Arrays of wire ids contained in a circuit by the containing circuit id.\r\n   */\r\n  wireIdsByCircuitId: Record<string, string[]>;\r\n\r\n  /**\r\n   * A map of wire data by the wire id.\r\n   */\r\n  wiresByWireId: Record<string, Wire>;\r\n\r\n  /**\r\n   * A map of wire segments by wire segment id.\r\n   */\r\n  wireSegmentsById: Record<string, WireSegment>;\r\n\r\n  // FIXME: It ended up being simplier to track positions in graph...\r\n  // Move all layout to graph, and find a better name for graph.\r\n  /**\r\n   * The positions of wire joints.\r\n   */\r\n  wireJointPositionsByJointId: Record<string, Point>;\r\n}\r\n\r\nconst _defaultState: CircuitGraphServiceState = {\r\n  elementIdsByCircuitId: {\r\n    [ROOT_CIRCUIT_ID]: [],\r\n  },\r\n  elementsById: {},\r\n  wireIdsByCircuitId: {\r\n    [ROOT_CIRCUIT_ID]: [],\r\n  },\r\n  wiresByWireId: {},\r\n  wireSegmentsById: {},\r\n  wireJointPositionsByJointId: {},\r\n};\r\n\r\nexport const defaultCircuitGraphServiceState = Object.freeze(_defaultState);\r\n","import { Point } from \"@/geometry\";\r\n\r\nexport interface CircuitLayoutServiceState {\r\n  elementPositionsById: Record<string, Point>;\r\n}\r\n\r\nconst _defaultState: CircuitLayoutServiceState = {\r\n  elementPositionsById: {},\r\n};\r\n\r\nexport const defaultCircuitLayoutServiceState: Readonly<CircuitLayoutServiceState> = Object.freeze(\r\n  _defaultState\r\n);\r\n","import { ROOT_CIRCUIT_ID } from \"../circuits/constants\";\r\n\r\nexport interface CircuitPropertiesServiceState {\r\n  /**\r\n   * The user-provided names for circuits by circuit id.\r\n   */\r\n  circuitNamesByCircuitId: Record<string, string>;\r\n}\r\n\r\nconst _defaultState: CircuitPropertiesServiceState = {\r\n  circuitNamesByCircuitId: {\r\n    [ROOT_CIRCUIT_ID]: \"Root\",\r\n  },\r\n};\r\n\r\nexport const defaultCircuitPropertiesServiceState = Object.freeze(\r\n  _defaultState\r\n);\r\n","import { Point, ZeroPoint } from \"@/geometry\";\r\n\r\nimport { ClipboardElement } from \"./types\";\r\n\r\nexport interface ClipboardServiceState {\r\n  clipboardElements: ClipboardElement[];\r\n  clipboardPasteOrigin: Point;\r\n}\r\n\r\nexport const defaultClipboardServiceState: Readonly<ClipboardServiceState> = Object.freeze(\r\n  {\r\n    clipboardElements: [],\r\n    clipboardPasteOrigin: ZeroPoint,\r\n  }\r\n);\r\n","// FIXME: There has got to be a better way of typing these, so api and selectors are type safe.\r\n\r\nimport { DialogType } from \"@/dialogs/types\";\r\n\r\nexport interface DialogServiceState {\r\n  dialogType: DialogType | null;\r\n  data: any;\r\n}\r\n\r\nconst _defaultState: DialogServiceState = {\r\n  dialogType: null,\r\n  data: null,\r\n};\r\n\r\nexport const defaultDialogServiceState: Readonly<DialogServiceState> = Object.freeze(\r\n  _defaultState\r\n);\r\n","export interface ProjectServiceState {\r\n  projectLoadState: \"no-project\" | \"loading\" | \"loaded\";\r\n  projectName: string;\r\n  projectModified: boolean;\r\n}\r\n\r\nconst _defaultProps: ProjectServiceState = {\r\n  projectLoadState: \"no-project\",\r\n  projectName: \"New Project\",\r\n  projectModified: false,\r\n};\r\n\r\nexport const defaultProjectServiceState = Object.freeze(_defaultProps);\r\n","export interface SelectionServiceState {\r\n  selectedElementIds: string[];\r\n  selectedWireJointIds: string[];\r\n  selectedWireSegmentIds: string[];\r\n}\r\n\r\nconst _defaultState: SelectionServiceState = {\r\n  selectedElementIds: [],\r\n  selectedWireJointIds: [],\r\n  selectedWireSegmentIds: [],\r\n};\r\n\r\nexport const defaultSelectionServiceState = Object.freeze(_defaultState);\r\n","import { EvolverPinTransition, SimTransitionWindow } from \"./types\";\r\n\r\nexport interface SimulatorServiceState {\r\n  /**\r\n   * Whether the simulator has been initialized.\r\n   */\r\n  initialized: boolean;\r\n\r\n  /**\r\n   * The current tick the simulator is on.\r\n   */\r\n  tick: number;\r\n\r\n  /**\r\n   * The time it took in milliseconds to process the last tick.\r\n   */\r\n  lastTickProcessingTimeMs: number;\r\n\r\n  /**\r\n   * A map of evolver states by evolver id.\r\n   */\r\n  evolverStatesByEvolverId: Record<string, any>;\r\n\r\n  /**\r\n   * A map of output-to-value maps by evolver id.\r\n   */\r\n  evolverOutputValuesByEvolverId: Record<string, Record<string, boolean>>;\r\n\r\n  /**\r\n   * A map of pending transitions by id.\r\n   */\r\n  transitionsById: Record<string, EvolverPinTransition>;\r\n\r\n  /**\r\n   * Transition windows in ascending order of tick.\r\n   */\r\n  transitionWindows: SimTransitionWindow[];\r\n}\r\n\r\nconst _defaultState: SimulatorServiceState = {\r\n  initialized: false,\r\n  tick: 0,\r\n  lastTickProcessingTimeMs: 0,\r\n  evolverStatesByEvolverId: {},\r\n  evolverOutputValuesByEvolverId: {},\r\n  transitionsById: {},\r\n  transitionWindows: [],\r\n};\r\n\r\nexport const defaultSimulatorServiceState = Object.freeze(_defaultState);\r\n","export interface SimulatorControlServiceState {\r\n  /**\r\n   * The overall application mode.\r\n   * Might not belong in simulator state?\r\n   *\r\n   * - edit: User is editing, no simulator is running\r\n   * - step: Sim is paused and only ticks on user command\r\n   * - run: Sim is actively running and ticking forwards on its own.\r\n   */\r\n  mode: \"edit\" | \"pause\" | \"run\";\r\n\r\n  /**\r\n   * Tick speed in ticks per second when running.\r\n   */\r\n  ticksPerSecond: number;\r\n}\r\n\r\nconst _defaultState: SimulatorControlServiceState = {\r\n  mode: \"edit\",\r\n  ticksPerSecond: 1000,\r\n};\r\n\r\nexport const defaultSimulatorControlServiceState = Object.freeze(_defaultState);\r\n","import { AnyAction } from \"redux\";\r\nimport { Options } from \"@popperjs/core\";\r\n\r\nimport { MaybeArray } from \"@/arrays\";\r\nimport { AppState } from \"@/store\";\r\n\r\nexport interface TutorialAction {\r\n  name: string;\r\n  action: AnyAction;\r\n}\r\n\r\nexport interface AnnotatedElement {\r\n  selector: string;\r\n  message?: string;\r\n  placement?: Options[\"placement\"];\r\n  action?: MaybeArray<TutorialAction>;\r\n}\r\n\r\nexport interface TutorialServiceState {\r\n  activeTutorial: string | null;\r\n  annotatedElements: AnnotatedElement[];\r\n  preTutorialState: AppState | null;\r\n}\r\n\r\nconst _defaultState: TutorialServiceState = {\r\n  activeTutorial: null,\r\n  annotatedElements: [],\r\n  preTutorialState: null,\r\n};\r\n\r\nexport const defaultTutorialServiceState = Object.freeze(_defaultState);\r\n","export function cls(...values: (string | false | undefined)[]): string {\r\n  return values.filter((x) => Boolean(x) && x != \"\").join(\" \");\r\n}\r\n\r\nexport function typedKeys<T extends Record<string, unknown>>(\r\n  obj: T\r\n): (keyof T)[] {\r\n  return Object.keys(obj) as (keyof T)[];\r\n}\r\n\r\nexport type ValueSetter<T> = T | ((old: T) => T);\r\n\r\nexport function fpSet<\r\n  Target extends Record<string, any> | any[],\r\n  P1 extends keyof Target,\r\n  T extends Target[P1]\r\n>(target: Target, p1: P1, value: ValueSetter<T>): Target;\r\nexport function fpSet<\r\n  Target extends Record<string, any> | any[],\r\n  P1 extends keyof Target,\r\n  P2 extends keyof Target[P1],\r\n  T extends Target[P1][P2]\r\n>(target: Target, p1: P1, p2: P2, value: ValueSetter<T>): Target;\r\nexport function fpSet<\r\n  Target extends Record<string, any> | any[],\r\n  P1 extends keyof Target,\r\n  P2 extends keyof Target[P1],\r\n  P3 extends keyof Target[P1][P2],\r\n  T extends Target[P1][P2][P3]\r\n>(target: Target, p1: P1, p2: P2, p3: P3, value: ValueSetter<T>): Target;\r\nexport function fpSet(...args: any[]): any {\r\n  const target = args[0];\r\n  const path = args.slice(1, args.length - 1).map(String);\r\n  const value = args[args.length - 1];\r\n  return fpSetByArray(target, path, value);\r\n}\r\n\r\nexport function fpSetByArray<T extends Record<string, any>>(\r\n  target: T,\r\n  path: (string | number)[],\r\n  value: ValueSetter<any>\r\n): T {\r\n  if (path.length === 0) {\r\n    if (typeof value === \"function\") {\r\n      return value(target);\r\n    }\r\n    return value;\r\n  }\r\n\r\n  const firstPaths = path.slice(0, path.length - 1).map(String);\r\n  const lastPath = path[path.length - 1];\r\n\r\n  const newData = clone(target);\r\n\r\n  let rollingTarget: any = newData;\r\n\r\n  for (const seg of firstPaths) {\r\n    rollingTarget[seg] = clone(rollingTarget[seg]);\r\n    rollingTarget = rollingTarget[seg];\r\n  }\r\n\r\n  if (typeof value === \"function\") {\r\n    rollingTarget[lastPath] = value(rollingTarget[lastPath]);\r\n  } else {\r\n    rollingTarget[lastPath] = value;\r\n  }\r\n\r\n  return newData;\r\n}\r\n\r\nfunction clone<T extends Record<string, unknown> | any[]>(obj: T): T {\r\n  if (Array.isArray(obj)) {\r\n    return obj.slice() as T;\r\n  }\r\n  return Object.assign({}, obj);\r\n}\r\n\r\nexport function isTruthy<T>(value: T | null | undefined | false): value is T {\r\n  return Boolean(value);\r\n}\r\n","// extracted by mini-css-extract-plugin\nexport default {\"fill-parent\":\"fill-parent--3pw6U\"};","// extracted by mini-css-extract-plugin\nexport default {\"flex-row\":\"flex-row--sHjOY\",\"flex-column\":\"flex-column--2LT64\",\"flex-space-around\":\"flex-space-around--1tYx1\",\"flex-reverse\":\"flex-reverse--2Vn7L\",\"flexitem-grow\":\"flexitem-grow--7seUA\",\"flexitem-shrink\":\"flexitem-shrink--2U9EV\",\"flexitem-fix\":\"flexitem-fix--1ARxk\"};","import has from \"lodash/has\";\r\n\r\nexport type TesselWindowRenderer = (\r\n  window: TesselWindowItem\r\n) => React.ReactElement | null;\r\n\r\nexport interface TesselWindowItem<P = Record<string, any>> {\r\n  windowId: string;\r\n  windowProps?: P;\r\n}\r\n\r\nexport type TesselDirection = \"row\" | \"column\";\r\n\r\nexport interface TesselPercentDivision {\r\n  firstPercent: number;\r\n}\r\nexport interface TesselFixedDivision {\r\n  firstSize?: number;\r\n  secondSize?: number;\r\n}\r\nexport type TesselDivision = TesselPercentDivision | TesselFixedDivision;\r\nexport type TesselDivisionValue = number | TesselDivision;\r\n\r\nexport interface TesselSplitItem {\r\n  first: TesselValue;\r\n  second: TesselValue;\r\n  direction: TesselDirection;\r\n  division: TesselDivisionValue;\r\n}\r\n\r\nexport type TesselItem = TesselWindowItem | TesselSplitItem;\r\nexport type TesselValue = string | TesselItem;\r\n\r\nexport type TesselDropPosition = \"left\" | \"right\" | \"top\" | \"bottom\";\r\n\r\nexport function normalizeTesselItem(value: TesselValue): TesselItem {\r\n  if (typeof value === \"string\") {\r\n    return {\r\n      windowId: value,\r\n    };\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nexport function isTesselWindow(item: TesselItem): item is TesselWindowItem {\r\n  return has(item, \"windowId\");\r\n}\r\n\r\nexport function isTesselSplit(item: TesselItem): item is TesselSplitItem {\r\n  return has(item, \"first\") && has(item, \"second\") && has(item, \"direction\");\r\n}\r\n\r\nexport function normalizeTesselDivision(\r\n  value: TesselDivisionValue\r\n): TesselDivision {\r\n  if (typeof value === \"number\") {\r\n    return {\r\n      firstPercent: value,\r\n    };\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nexport function isTesselPercentDivision(\r\n  value: TesselDivision\r\n): value is TesselPercentDivision {\r\n  return has(value, \"firstPercent\");\r\n}\r\n\r\nexport function isTesselFixedDivision(\r\n  value: TesselDivision\r\n): value is TesselFixedDivision {\r\n  return has(value, \"firstSize\") || has(value, \"secondSize\");\r\n}\r\n","import * as React from \"react\";\r\n\r\nexport function useRefValue<T>(value: T): React.RefObject<T> {\r\n  const ref = React.useRef(value);\r\n  React.useEffect(() => {\r\n    ref.current = value;\r\n  });\r\n\r\n  return ref;\r\n}\r\n","// extracted by mini-css-extract-plugin\nexport default {\"tessel\":\"tessel--2Q3Xd\",\"tessel-content\":\"tessel-content--3-kEA\",\"tessel-drop-capture\":\"tessel-drop-capture--3TbuI\",\"tessel-drop-capture--dragging\":\"tessel-drop-capture--dragging--Ihwyz\",\"tessel-drop-marker\":\"tessel-drop-marker--1cqr2\",\"drop-left\":\"drop-left--wqP1V\",\"drop-right\":\"drop-right--2MyGz\",\"drop-top\":\"drop-top--1S0co\",\"drop-bottom\":\"drop-bottom--2f330\",\"tessel-split\":\"tessel-split--2gDs5\",\"tessel-split--row\":\"tessel-split--row--2fC6o\",\"tessel-split--column\":\"tessel-split--column--1Hl4C\",\"tessel-window\":\"tessel-window--1qDgp\",\"tessel-window-titlebar\":\"tessel-window-titlebar--uHBdn\",\"tessel-window-title\":\"tessel-window-title--2v0hT\",\"tessel-window-controls\":\"tessel-window-controls--3i3ou\",\"tessel-window-controls-close\":\"tessel-window-controls-close--2O8Zs\",\"tessel-window-content\":\"tessel-window-content--sOnG-\"};","import { cls } from \"@/utils\";\r\nimport * as React from \"react\";\r\nimport throttle from \"lodash/throttle\";\r\n\r\nimport { useRefValue } from \"@/hooks/useRefValue\";\r\n\r\nimport { TesselDirection } from \"./types\";\r\n\r\nimport styles from \"./Tessel.module.css\";\r\n\r\nexport interface TesselSplitProps {\r\n  direction: TesselDirection;\r\n  onChangePercentage(percent: number, position: number): void;\r\n}\r\n\r\nconst ZeroRect: DOMRect = Object.freeze({\r\n  top: 0,\r\n  left: 0,\r\n  bottom: 0,\r\n  right: 0,\r\n  x: 0,\r\n  y: 0,\r\n  height: 0,\r\n  width: 0,\r\n  toJSON: () => ({}),\r\n});\r\n\r\nconst TesselSplit: React.FC<TesselSplitProps> = ({\r\n  direction,\r\n  onChangePercentage,\r\n}) => {\r\n  const ref = React.useRef<HTMLDivElement | null>(null);\r\n\r\n  const pointerCaptureRef = React.useRef<number | null>(null);\r\n\r\n  // Ref these up so we can continue using the same throttle across rerenders.\r\n  const directionRef = useRefValue(direction);\r\n  const onChangePercentageRef = useRefValue(onChangePercentage);\r\n\r\n  const onHandlePointerMove = React.useMemo(\r\n    () =>\r\n      throttle(\r\n        (e: React.PointerEvent<HTMLDivElement>) => {\r\n          if (pointerCaptureRef.current == null || ref.current == null) {\r\n            return;\r\n          }\r\n\r\n          const parentRect =\r\n            ref.current.parentElement?.getBoundingClientRect() ?? ZeroRect;\r\n\r\n          let percentage = 0;\r\n          let position = 0;\r\n          if (directionRef.current === \"row\") {\r\n            position = e.pageX - parentRect.left;\r\n            percentage = position / parentRect.width;\r\n            if (isNaN(percentage)) {\r\n              percentage = 0;\r\n              position = parentRect.left;\r\n            } else if (percentage > 1) {\r\n              percentage = 1;\r\n              position = parentRect.right;\r\n            }\r\n          } else {\r\n            position = e.pageY - parentRect.top;\r\n            percentage = position / parentRect.height;\r\n            if (isNaN(percentage)) {\r\n              percentage = 0;\r\n              position = parentRect.top;\r\n            } else if (percentage > 1) {\r\n              percentage = 1;\r\n              position = parentRect.bottom;\r\n            }\r\n          }\r\n\r\n          onChangePercentageRef.current!(percentage * 100, position);\r\n        },\r\n        1000 / 60,\r\n        { leading: true }\r\n      ),\r\n    [directionRef, onChangePercentageRef]\r\n  );\r\n\r\n  const onPointerMove = React.useCallback(\r\n    (e: React.PointerEvent<HTMLDivElement>) => {\r\n      e.persist();\r\n      onHandlePointerMove(e);\r\n    },\r\n    [onHandlePointerMove]\r\n  );\r\n\r\n  const onPointerDown = React.useCallback(\r\n    (e: React.PointerEvent<HTMLDivElement>) => {\r\n      if (e.defaultPrevented || !ref.current) {\r\n        return;\r\n      }\r\n\r\n      if (pointerCaptureRef.current) {\r\n        return;\r\n      }\r\n\r\n      e.preventDefault();\r\n\r\n      ref.current.setPointerCapture(e.pointerId);\r\n      pointerCaptureRef.current = e.pointerId;\r\n    },\r\n    []\r\n  );\r\n\r\n  const onPointerUp = React.useCallback(() => {\r\n    if (ref.current && pointerCaptureRef.current) {\r\n      ref.current.releasePointerCapture(pointerCaptureRef.current);\r\n      pointerCaptureRef.current = null;\r\n    }\r\n  }, []);\r\n\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      className={cls(\r\n        \"tessel-split\",\r\n        styles[\"tessel-split\"],\r\n        styles[\r\n          direction === \"row\" ? \"tessel-split--row\" : \"tessel-split--column\"\r\n        ]\r\n      )}\r\n      onPointerDown={onPointerDown}\r\n      onPointerMove={onPointerMove}\r\n      onPointerUp={onPointerUp}\r\n    />\r\n  );\r\n};\r\n\r\nexport default TesselSplit;\r\n","import * as React from \"react\";\r\nimport { TesselDropPosition } from \"./types\";\r\n\r\nconst tesselPathContext = React.createContext<string[]>([]);\r\nexport function useTesselPath() {\r\n  return React.useContext(tesselPathContext);\r\n}\r\nexport interface TesselContextProviderProps {\r\n  pathKey: string;\r\n}\r\nexport const TesselPathProvider: React.FC<TesselContextProviderProps> = ({\r\n  pathKey,\r\n  children,\r\n}) => {\r\n  const path = useTesselPath();\r\n\r\n  const newPath = React.useMemo<string[]>(() => [...path, pathKey], [\r\n    path,\r\n    pathKey,\r\n  ]);\r\n\r\n  return (\r\n    <tesselPathContext.Provider value={newPath}>\r\n      {children}\r\n    </tesselPathContext.Provider>\r\n  );\r\n};\r\n\r\nexport interface TesselInteractionContext {\r\n  moveWindow(from: string[], to: string[], position: TesselDropPosition): void;\r\n  closeWindow(path: string[]): void;\r\n}\r\nfunction noop() {\r\n  /* no op */\r\n}\r\nconst tesselInteractionContext = React.createContext<TesselInteractionContext>({\r\n  moveWindow: noop,\r\n  closeWindow: noop,\r\n});\r\nexport function useTesselInteraction() {\r\n  return React.useContext(tesselInteractionContext);\r\n}\r\n\r\nexport type TesselInteractionProviderProps = TesselInteractionContext;\r\nexport const TesselInteractionProvider: React.FC<TesselInteractionProviderProps> = ({\r\n  moveWindow,\r\n  closeWindow,\r\n  children,\r\n}) => {\r\n  const context = React.useMemo<TesselInteractionContext>(\r\n    () => ({\r\n      moveWindow,\r\n      closeWindow,\r\n    }),\r\n    [moveWindow, closeWindow]\r\n  );\r\n\r\n  return (\r\n    <tesselInteractionContext.Provider value={context}>\r\n      {children}\r\n    </tesselInteractionContext.Provider>\r\n  );\r\n};\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport sizing from \"@/styles/sizing.module.css\";\r\nimport flex from \"@/styles/flex.module.css\";\r\n\r\nimport {\r\n  isTesselFixedDivision,\r\n  isTesselPercentDivision,\r\n  normalizeTesselDivision,\r\n  TesselDivision,\r\n  TesselItem,\r\n  TesselSplitItem,\r\n  TesselValue,\r\n  TesselWindowRenderer,\r\n} from \"./types\";\r\n\r\nimport TesselSplit from \"./TesselSplit\";\r\nimport TesselFrame from \"./TesselFrame\";\r\nimport { TesselPathProvider } from \"./TesselContext\";\r\n\r\nexport interface TesselSplitFrameProps {\r\n  item: TesselSplitItem;\r\n  renderWindow: TesselWindowRenderer;\r\n  onLayoutChange(relativeRoot: TesselItem): void;\r\n}\r\n\r\nconst TesselSplitFrame: React.FC<TesselSplitFrameProps> = ({\r\n  item,\r\n  renderWindow,\r\n  onLayoutChange,\r\n}) => {\r\n  const { direction, first, second, division: divisionValue } = item;\r\n  const sizeDirection = direction === \"row\" ? \"width\" : \"height\";\r\n\r\n  const onChangePercentage = React.useCallback(\r\n    (percentage: number, absolute: number) => {\r\n      const division = normalizeTesselDivision(item.division);\r\n      onLayoutChange({\r\n        ...item,\r\n        division: applyDivisionChange(division, percentage, absolute),\r\n      });\r\n    },\r\n    [item, onLayoutChange]\r\n  );\r\n\r\n  const onFirstLayoutChange = React.useCallback(\r\n    (value: TesselValue) => {\r\n      onLayoutChange({\r\n        ...item,\r\n        first: value,\r\n      });\r\n    },\r\n    [item, onLayoutChange]\r\n  );\r\n\r\n  const onSecondLayoutChange = React.useCallback(\r\n    (value: TesselValue) => {\r\n      onLayoutChange({\r\n        ...item,\r\n        second: value,\r\n      });\r\n    },\r\n    [item, onLayoutChange]\r\n  );\r\n\r\n  const division = normalizeTesselDivision(divisionValue);\r\n  let firstSize = \"50%\";\r\n  let secondSize = \"50%\";\r\n  let firstFix = false;\r\n  let secondFix = false;\r\n  if (isTesselPercentDivision(division)) {\r\n    const { firstPercent } = division;\r\n    firstSize = `${firstPercent}%`;\r\n    secondSize = `${100 - firstPercent}%`;\r\n  } else if (isTesselFixedDivision(division)) {\r\n    const { firstSize: firstSizeDiv, secondSize: secondSizeDiv } = division;\r\n    // Only support one of firstSize or secondSize\r\n    if (firstSizeDiv) {\r\n      firstSize = `${firstSizeDiv}px`;\r\n      firstFix = true;\r\n      secondSize = \"100%\";\r\n    } else {\r\n      firstSize = \"100%\";\r\n      secondSize = `${secondSizeDiv}px`;\r\n      secondFix = true;\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className={cls(\r\n        sizing[\"fill-parent\"],\r\n        flex[direction === \"row\" ? \"flex-row\" : \"flex-column\"]\r\n      )}\r\n    >\r\n      <div\r\n        className={cls(\r\n          firstFix ? flex[\"flexitem-fix\"] : flex[\"flexitem-shrink\"]\r\n        )}\r\n        style={{ [sizeDirection]: firstSize }}\r\n      >\r\n        <TesselPathProvider pathKey=\"first\">\r\n          <TesselFrame\r\n            value={first}\r\n            renderWindow={renderWindow}\r\n            onLayoutChange={onFirstLayoutChange}\r\n          />\r\n        </TesselPathProvider>\r\n      </div>\r\n      <TesselSplit\r\n        direction={direction}\r\n        onChangePercentage={onChangePercentage}\r\n      />\r\n      <div\r\n        className={cls(\r\n          secondFix ? flex[\"flexitem-fix\"] : flex[\"flexitem-shrink\"]\r\n        )}\r\n        style={{ [sizeDirection]: secondSize }}\r\n      >\r\n        <TesselPathProvider pathKey=\"second\">\r\n          <TesselFrame\r\n            value={second}\r\n            renderWindow={renderWindow}\r\n            onLayoutChange={onSecondLayoutChange}\r\n          />\r\n        </TesselPathProvider>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nfunction applyDivisionChange(\r\n  division: TesselDivision,\r\n  percent: number,\r\n  absolute: number\r\n): TesselDivision {\r\n  if (isTesselPercentDivision(division)) {\r\n    return {\r\n      firstPercent: percent,\r\n    };\r\n  } else if (isTesselFixedDivision(division)) {\r\n    if (typeof division.secondSize === \"number\") {\r\n      return {\r\n        secondSize: absolute,\r\n      };\r\n    }\r\n\r\n    return {\r\n      firstSize: absolute,\r\n    };\r\n  }\r\n\r\n  return division;\r\n}\r\n\r\nexport default TesselSplitFrame;\r\n","import * as React from \"react\";\r\nimport TesselSplitFrame from \"./TesselSplitFrame\";\r\n\r\nimport {\r\n  isTesselSplit,\r\n  isTesselWindow,\r\n  normalizeTesselItem,\r\n  TesselValue,\r\n  TesselWindowRenderer,\r\n} from \"./types\";\r\n\r\nexport interface TesselFrameProps {\r\n  value: TesselValue;\r\n  renderWindow: TesselWindowRenderer;\r\n  onLayoutChange(value: TesselValue): void;\r\n}\r\n\r\nconst TesselFrame: React.FC<TesselFrameProps> = ({\r\n  value,\r\n  renderWindow,\r\n  onLayoutChange,\r\n}) => {\r\n  const item = normalizeTesselItem(value);\r\n  if (isTesselWindow(item)) {\r\n    return renderWindow(item);\r\n  } else if (isTesselSplit(item)) {\r\n    return (\r\n      <TesselSplitFrame\r\n        item={item}\r\n        renderWindow={renderWindow}\r\n        onLayoutChange={onLayoutChange}\r\n      />\r\n    );\r\n  } else {\r\n    return null;\r\n  }\r\n};\r\n\r\nexport default TesselFrame;\r\n","export type MaybeArray<T> = T | T[];\r\nexport function asArray<T>(value: MaybeArray<T>): T[] {\r\n  return Array.isArray(value) ? value : [value];\r\n}\r\n\r\nexport function arrayEquals<T extends any[]>(a: T, b: T) {\r\n  if (a === b) {\r\n    return true;\r\n  }\r\n\r\n  if (a.length !== b.length) {\r\n    return false;\r\n  }\r\n\r\n  return a.every((v, i) => b[i] === v);\r\n}\r\n\r\nconst EmptyArray: ReadonlyArray<unknown> = Object.freeze([]);\r\n// Would be simpler to just use EmptyArray, but we cannot type that to what the usage wants.\r\n// Shame the type `[]` is invalid.\r\nexport function immutableEmptyArray<T>(): T[] {\r\n  return EmptyArray as any;\r\n}\r\n\r\nexport function dropIndexFp<T>(array: T[], index: number) {\r\n  const newArray = array.slice(0, index);\r\n  for (let i = index + 1; i < array.length; i++) {\r\n    newArray.push(array[i]);\r\n  }\r\n  return newArray;\r\n}\r\n","import * as React from \"react\";\r\nimport ResizeObserver from \"resize-observer-polyfill\";\r\n\r\ninterface UseComponentBounds {\r\n  left: number;\r\n  top: number;\r\n  right: number;\r\n  bottom: number;\r\n  width: number;\r\n  height: number;\r\n}\r\nexport function useComponentBounds(ref: React.RefObject<HTMLElement | null>) {\r\n  const [size, setSize] = React.useState<UseComponentBounds>({\r\n    left: 0,\r\n    top: 0,\r\n    right: 0,\r\n    bottom: 0,\r\n    width: 0,\r\n    height: 0,\r\n  });\r\n\r\n  React.useLayoutEffect(() => {\r\n    if (!ref.current) {\r\n      return;\r\n    }\r\n\r\n    const observer = new ResizeObserver(() => {\r\n      const el = ref.current;\r\n      if (!el) {\r\n        return;\r\n      }\r\n      const b = el.getBoundingClientRect();\r\n      setSize({\r\n        top: b.top,\r\n        left: b.left,\r\n        right: b.right,\r\n        bottom: b.bottom,\r\n        width: b.width,\r\n        height: b.height,\r\n      });\r\n    });\r\n\r\n    observer.observe(ref.current);\r\n\r\n    return () => {\r\n      observer.disconnect();\r\n    };\r\n  }, [ref]);\r\n\r\n  return size;\r\n}\r\n","import { DragObjectWithType } from \"react-dnd\";\r\n\r\nexport const TESSEL_WINDOW_DRAG_OBJECT = \"@tessel/window\" as const;\r\nexport const tesselWindowDragObject = (path: string[]) => ({\r\n  type: TESSEL_WINDOW_DRAG_OBJECT,\r\n  payload: { path },\r\n});\r\nexport type TesselWindowDragObject = ReturnType<typeof tesselWindowDragObject>;\r\nexport function isTesselWindowDragObject(\r\n  item: DragObjectWithType\r\n): item is TesselWindowDragObject {\r\n  return item.type === TESSEL_WINDOW_DRAG_OBJECT;\r\n}\r\n","import { arrayEquals } from \"@/arrays\";\r\nimport { useComponentBounds } from \"@/hooks/useComponentBounds\";\r\nimport { cls } from \"@/utils\";\r\nimport * as React from \"react\";\r\nimport { DropTargetMonitor, DragObjectWithType, useDrop } from \"react-dnd\";\r\n\r\nimport {\r\n  isTesselWindowDragObject,\r\n  TESSEL_WINDOW_DRAG_OBJECT,\r\n} from \"./drag-items/tessel-window\";\r\n\r\nimport styles from \"./Tessel.module.css\";\r\nimport { useTesselInteraction, useTesselPath } from \"./TesselContext\";\r\nimport { TesselDropPosition } from \"./types\";\r\n\r\nexport interface TesselDropCaptureProps {\r\n  className?: string;\r\n  id?: string;\r\n  children?: React.ReactNode;\r\n}\r\nconst TesselDropCapture = React.forwardRef<\r\n  HTMLDivElement,\r\n  TesselDropCaptureProps\r\n>(({ className, id, children }, forwardRef) => {\r\n  const tesselPath = useTesselPath();\r\n  const { moveWindow } = useTesselInteraction();\r\n\r\n  const ref = React.useRef<HTMLDivElement | null>(null);\r\n  const { top, left, right, bottom } = useComponentBounds(ref);\r\n\r\n  const [dropPos, setDropPos] = React.useState<TesselDropPosition | null>(null);\r\n\r\n  const onHover = React.useCallback(\r\n    (item: DragObjectWithType, monitor: DropTargetMonitor) => {\r\n      if (!monitor.isOver({ shallow: true })) {\r\n        setDropPos(null);\r\n        return;\r\n      }\r\n\r\n      const pos = monitor.getClientOffset();\r\n      if (item == null || pos == null || !isTesselWindowDragObject(item)) {\r\n        setDropPos(null);\r\n        return;\r\n      }\r\n\r\n      if (pos.x < left || pos.x > right) {\r\n        setDropPos(null);\r\n        return;\r\n      }\r\n\r\n      if (pos.y < top || pos.y > bottom) {\r\n        setDropPos(null);\r\n        return;\r\n      }\r\n\r\n      const relX = pos.x - left;\r\n      const xPercent = relX / (right - left);\r\n      if (xPercent <= 0.3) {\r\n        setDropPos(\"left\");\r\n        return;\r\n      }\r\n      if (xPercent >= 0.6) {\r\n        setDropPos(\"right\");\r\n        return;\r\n      }\r\n\r\n      const relY = pos.y - top;\r\n      const yPercent = relY / (bottom - top);\r\n      if (yPercent <= 0.3) {\r\n        setDropPos(\"top\");\r\n        return;\r\n      }\r\n      if (yPercent >= 0.6) {\r\n        setDropPos(\"bottom\");\r\n        return;\r\n      }\r\n\r\n      setDropPos(null);\r\n    },\r\n    [top, left, right, bottom]\r\n  );\r\n\r\n  const onDrop = React.useCallback(\r\n    (item: DragObjectWithType, monitor: DropTargetMonitor) => {\r\n      if (!monitor.isOver({ shallow: true })) {\r\n        return;\r\n      }\r\n\r\n      if (!isTesselWindowDragObject(item)) {\r\n        return;\r\n      }\r\n      const { path: draggingPath } = item.payload;\r\n\r\n      if (arrayEquals(draggingPath, tesselPath)) {\r\n        return;\r\n      }\r\n\r\n      if (dropPos == null) {\r\n        return;\r\n      }\r\n\r\n      moveWindow(draggingPath, tesselPath, dropPos);\r\n    },\r\n    [tesselPath, dropPos, moveWindow]\r\n  );\r\n\r\n  const [{ draggingSelf }, dropRef] = useDrop(\r\n    {\r\n      accept: TESSEL_WINDOW_DRAG_OBJECT,\r\n      collect: (monitor) => {\r\n        // This is here as hover is not called on hover exit.\r\n        // We need something to capture the exit event.\r\n        if (!monitor.isOver({ shallow: true })) {\r\n          setDropPos(null);\r\n        }\r\n\r\n        const item = monitor.getItem();\r\n        if (!item || !isTesselWindowDragObject(item)) {\r\n          return {};\r\n        }\r\n\r\n        return {\r\n          draggingSelf: arrayEquals(item.payload.path, tesselPath),\r\n        };\r\n      },\r\n      hover: onHover,\r\n      drop: onDrop,\r\n    },\r\n    [onHover, onDrop]\r\n  );\r\n\r\n  let dropMarkerClassname = styles[\"tessel-drop-marker\"] + \" \";\r\n  if (dropPos != null && !draggingSelf) {\r\n    switch (dropPos) {\r\n      case \"bottom\":\r\n        dropMarkerClassname += styles[\"drop-bottom\"];\r\n        break;\r\n      case \"top\":\r\n        dropMarkerClassname += styles[\"drop-top\"];\r\n        break;\r\n      case \"left\":\r\n        dropMarkerClassname += styles[\"drop-left\"];\r\n        break;\r\n      case \"right\":\r\n        dropMarkerClassname += styles[\"drop-right\"];\r\n        break;\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div\r\n      id={id}\r\n      ref={(divRef) => {\r\n        ref.current = divRef;\r\n        dropRef(divRef);\r\n        if (typeof forwardRef === \"function\") {\r\n          forwardRef(divRef);\r\n        } else if (forwardRef) {\r\n          forwardRef.current = divRef;\r\n        }\r\n      }}\r\n      className={cls(\r\n        styles[\"tessel-drop-capture\"],\r\n        draggingSelf && styles[\"tessel-drop-capture--dragging\"],\r\n        className\r\n      )}\r\n    >\r\n      {children}\r\n      <div className={dropMarkerClassname} />\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default TesselDropCapture;\r\n","import { isTesselSplit, normalizeTesselItem, TesselValue } from \"./types\";\r\n\r\nexport function walkTesselValues(\r\n  value: TesselValue,\r\n  walk: (value: TesselValue, path: string[]) => boolean | undefined\r\n) {\r\n  function doWork(value: TesselValue, path: string[]): boolean {\r\n    if (walk(value, []) === false) {\r\n      return false;\r\n    }\r\n\r\n    const normalized = normalizeTesselItem(value);\r\n    if (isTesselSplit(normalized)) {\r\n      if (!doWork(normalized.first, [...path, \"first\"])) {\r\n        return false;\r\n      }\r\n      if (!doWork(normalized.second, [...path, \"second\"])) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  doWork(value, []);\r\n}\r\n\r\nexport function filterTesselValues(\r\n  value: TesselValue,\r\n  filter: (value: TesselValue) => boolean\r\n): TesselValue | null {\r\n  if (!filter(value)) {\r\n    return null;\r\n  }\r\n\r\n  const normalized = normalizeTesselItem(value);\r\n\r\n  if (isTesselSplit(normalized)) {\r\n    const first = filterTesselValues(normalized.first, filter);\r\n    const second = filterTesselValues(normalized.second, filter);\r\n\r\n    if (first && second) {\r\n      return value;\r\n    }\r\n\r\n    return first ?? second ?? null;\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nexport function findAndReplaceTesselValue(\r\n  value: TesselValue,\r\n  replace: (value: TesselValue) => TesselValue | null\r\n): TesselValue {\r\n  function doWork(value: TesselValue): TesselValue | null {\r\n    const newValue = replace(value);\r\n    if (newValue) {\r\n      return newValue;\r\n    }\r\n\r\n    const normalized = normalizeTesselItem(value);\r\n    if (isTesselSplit(normalized)) {\r\n      const first = doWork(normalized.first);\r\n      if (first) {\r\n        return {\r\n          ...normalized,\r\n          first,\r\n        };\r\n      }\r\n\r\n      const second = doWork(normalized.second);\r\n      if (second) {\r\n        return {\r\n          ...normalized,\r\n          second,\r\n        };\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n  return doWork(value) ?? value;\r\n}\r\n\r\nexport function pruneEmptyTesselValues(value: TesselValue): TesselValue {\r\n  if (typeof value === \"string\") {\r\n    return value;\r\n  }\r\n\r\n  if (isTesselSplit(value)) {\r\n    if (value.first == null) {\r\n      return pruneEmptyTesselValues(value.second);\r\n    }\r\n    if (value.second == null) {\r\n      return pruneEmptyTesselValues(value.first);\r\n    }\r\n    return {\r\n      ...value,\r\n      first: pruneEmptyTesselValues(value.first),\r\n      second: pruneEmptyTesselValues(value.second),\r\n    };\r\n  }\r\n\r\n  return value;\r\n}\r\n","import * as React from \"react\";\r\nimport get from \"lodash/get\";\r\n\r\nimport { cls, fpSetByArray } from \"@/utils\";\r\n\r\nimport {\r\n  TesselDropPosition,\r\n  TesselItem,\r\n  TesselValue,\r\n  TesselWindowRenderer,\r\n} from \"./types\";\r\n\r\nimport TesselFrame from \"./TesselFrame\";\r\nimport TesselDropCapture from \"./TesselDropCapture\";\r\n\r\nimport styles from \"./Tessel.module.css\";\r\n\r\nimport { TesselInteractionProvider } from \"./TesselContext\";\r\nimport { pruneEmptyTesselValues } from \"./utils\";\r\n\r\nexport interface TesselProps {\r\n  className?: string;\r\n  rootItem: TesselValue | null;\r\n  renderWindow: TesselWindowRenderer;\r\n  onLayoutChange(rootItem: TesselValue | null): void;\r\n}\r\n\r\nconst Tessel: React.FC<TesselProps> = ({\r\n  className,\r\n  rootItem,\r\n  renderWindow,\r\n  onLayoutChange,\r\n}) => {\r\n  const moveWindow = React.useCallback(\r\n    (from: string[], to: string[], position: TesselDropPosition) => {\r\n      if (from.length === 0) {\r\n        // If we have a window at the root, there is no place to drag it to.\r\n        return;\r\n      }\r\n\r\n      let newRoot = rootItem;\r\n      const movingElement = get(newRoot, from);\r\n      // If rootItem is a string (implicit window), than there is no way we can find our\r\n      // from target inside of it (given that from is not the root).\r\n      // This would be covered by movingElement being undefined, but we add\r\n      // the extra check to inform typescript of this condition.\r\n      if (!newRoot || typeof newRoot === \"string\" || !movingElement) {\r\n        return;\r\n      }\r\n\r\n      // Target must exist, or be the root.\r\n      if (to.length > 0 && !get(newRoot, to)) {\r\n        return;\r\n      }\r\n\r\n      // First, null out the from path.\r\n      // We cannot clean up the stack at this point as that might remove path\r\n      // elements that we are moving to.  Cleanup will be done later.\r\n      newRoot = fpSetByArray(newRoot, from, null);\r\n\r\n      // Now, insert the window at the new location\r\n      newRoot = fpSetByArray(newRoot, to, (item: TesselValue) => {\r\n        let newItem: TesselItem;\r\n        if (position === \"left\" || position === \"right\") {\r\n          newItem = {\r\n            direction: \"row\",\r\n            division: 50,\r\n            first: position === \"left\" ? movingElement : item,\r\n            second: position === \"right\" ? movingElement : item,\r\n          };\r\n        } else if (position === \"top\" || position === \"bottom\") {\r\n          newItem = {\r\n            direction: \"column\",\r\n            division: 50,\r\n            first: position === \"top\" ? movingElement : item,\r\n            second: position === \"bottom\" ? movingElement : item,\r\n          };\r\n        } else {\r\n          // Unknown position\r\n          throw new Error(`Unknown tessel position: ${position}`);\r\n        }\r\n        return newItem;\r\n      });\r\n\r\n      // Remove the empty entry from the removal of the from element.\r\n      newRoot = pruneEmptyTesselValues(newRoot);\r\n\r\n      onLayoutChange(newRoot);\r\n    },\r\n    [rootItem, onLayoutChange]\r\n  );\r\n\r\n  const closeWindow = React.useCallback(\r\n    (path: string[]) => {\r\n      let newRoot = rootItem;\r\n      if (!newRoot) {\r\n        return;\r\n      }\r\n      if (typeof newRoot === \"string\") {\r\n        if (path.length === 0) {\r\n          onLayoutChange(null);\r\n        }\r\n        return;\r\n      }\r\n\r\n      // First, null out the from path.\r\n      // We cannot clean up the stack at this point as that might remove path\r\n      // elements that we are moving to.  Cleanup will be done later.\r\n      newRoot = fpSetByArray(newRoot, path, null);\r\n      // Remove the empty entry from the removal of the from element.\r\n      newRoot = pruneEmptyTesselValues(newRoot);\r\n\r\n      onLayoutChange(newRoot);\r\n    },\r\n    [onLayoutChange, rootItem]\r\n  );\r\n\r\n  return (\r\n    <div className={cls(\"tessel\", styles[\"tessel\"], className)}>\r\n      <TesselInteractionProvider\r\n        moveWindow={moveWindow}\r\n        closeWindow={closeWindow}\r\n      >\r\n        <TesselDropCapture>\r\n          <div className={styles[\"tessel-content\"]}>\r\n            {rootItem && (\r\n              <TesselFrame\r\n                value={rootItem}\r\n                renderWindow={renderWindow}\r\n                onLayoutChange={onLayoutChange}\r\n              />\r\n            )}\r\n          </div>\r\n        </TesselDropCapture>\r\n      </TesselInteractionProvider>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Tessel;\r\n","export * from \"./Tessel\";\r\nexport * from \"./types\";\r\n\r\nimport Tessel from \"./Tessel\";\r\nexport default Tessel;\r\nexport { Tessel };\r\n","import {\r\n  isTesselWindow,\r\n  TesselValue,\r\n  TesselWindowItem,\r\n} from \"@/components/Tessel\";\r\n\r\nimport { CircuitEditorWindowProps } from \"./CircuitEditorWindow\";\r\n\r\nexport const CIRCUIT_FIELD_WINDOW_ID = \"circuit-field\" as const;\r\n\r\nexport const circuitEditorTesselWindow = (\r\n  circuitEditorId: string\r\n): TesselWindowItem<CircuitEditorWindowProps> => ({\r\n  windowId: CIRCUIT_FIELD_WINDOW_ID,\r\n  windowProps: {\r\n    editorId: circuitEditorId,\r\n  },\r\n});\r\n\r\nexport function isCircuitEditorTesselWindow(\r\n  x: TesselValue\r\n): x is Required<TesselWindowItem<CircuitEditorWindowProps>> {\r\n  if (typeof x === \"string\") {\r\n    // We must have props to be a proper circuit field.\r\n    return false;\r\n  }\r\n  if (!isTesselWindow(x)) {\r\n    return false;\r\n  }\r\n  return x.windowId === CIRCUIT_FIELD_WINDOW_ID;\r\n}\r\n","import { TesselValue } from \"@/components/Tessel\";\r\n\r\nimport { circuitEditorTesselWindow } from \"@/pages/ProjectEditorPage/windows/CircuitEditorWindow/tessel-window\";\r\n\r\nimport { DEFAULT_CIRCUIT_EDITOR_ID } from \"@/services/circuit-editors/constants\";\r\n\r\nexport interface UiLayoutServiceState {\r\n  /**\r\n   * The tessel layout.\r\n   */\r\n  layout: TesselValue | null;\r\n}\r\n\r\nconst _defaultState: UiLayoutServiceState = {\r\n  layout: {\r\n    direction: \"row\",\r\n    division: {\r\n      firstSize: 200,\r\n    },\r\n    first: {\r\n      direction: \"column\",\r\n      division: 30,\r\n      first: \"circuits-list\",\r\n      second: \"element-tray\",\r\n    },\r\n    second: circuitEditorTesselWindow(DEFAULT_CIRCUIT_EDITOR_ID),\r\n  },\r\n};\r\n\r\nexport const defaultUiLayoutServiceState = Object.freeze(_defaultState);\r\n","export interface UiSettingsState {\r\n  elementNameMode: \"all\" | \"named-only\" | \"none\";\r\n}\r\n\r\nconst _defaultState: UiSettingsState = {\r\n  elementNameMode: \"named-only\",\r\n};\r\n\r\nexport const defaultUiSettingsState = Object.freeze(_defaultState);\r\n","import {\r\n  CircuitEditorDragServiceState,\r\n  defaultCircuitEditorDragServiceState,\r\n} from \"./circuit-editor-drag/state\";\r\nimport {\r\n  CircuitEditorsServiceState,\r\n  defaultCircuitEditorServiceState,\r\n} from \"./circuit-editors/state\";\r\nimport {\r\n  CircuitGraphServiceState,\r\n  defaultCircuitGraphServiceState,\r\n} from \"./circuit-graph/state\";\r\nimport {\r\n  CircuitLayoutServiceState,\r\n  defaultCircuitLayoutServiceState,\r\n} from \"./circuit-layout/state\";\r\nimport {\r\n  CircuitPropertiesServiceState,\r\n  defaultCircuitPropertiesServiceState,\r\n} from \"./circuit-properties/state\";\r\nimport {\r\n  ClipboardServiceState,\r\n  defaultClipboardServiceState,\r\n} from \"./clipboard/state\";\r\nimport { DialogServiceState, defaultDialogServiceState } from \"./dialog/state\";\r\nimport {\r\n  ProjectServiceState,\r\n  defaultProjectServiceState,\r\n} from \"./project/state\";\r\nimport {\r\n  SelectionServiceState,\r\n  defaultSelectionServiceState,\r\n} from \"./selection/state\";\r\nimport {\r\n  SimulatorServiceState,\r\n  defaultSimulatorServiceState,\r\n} from \"./simulator/state\";\r\nimport {\r\n  SimulatorControlServiceState,\r\n  defaultSimulatorControlServiceState,\r\n} from \"./simulator-control/state\";\r\nimport {\r\n  TutorialServiceState,\r\n  defaultTutorialServiceState,\r\n} from \"./tutorial/state\";\r\nimport {\r\n  UiLayoutServiceState,\r\n  defaultUiLayoutServiceState,\r\n} from \"./ui-layout/state\";\r\nimport { UiSettingsState, defaultUiSettingsState } from \"./ui-settings/state\";\r\n\r\nexport interface AppServicesState {\r\n  circuitEditorDrag: CircuitEditorDragServiceState;\r\n  circuitEditors: CircuitEditorsServiceState;\r\n  clipboard: ClipboardServiceState;\r\n  dialog: DialogServiceState;\r\n  circuitGraph: CircuitGraphServiceState;\r\n  circuitLayout: CircuitLayoutServiceState;\r\n  circuitProperties: CircuitPropertiesServiceState;\r\n  project: ProjectServiceState;\r\n  selection: SelectionServiceState;\r\n  simulator: SimulatorServiceState;\r\n  simulatorControl: SimulatorControlServiceState;\r\n  tutorial: TutorialServiceState;\r\n  uiLayout: UiLayoutServiceState;\r\n  uiSettings: UiSettingsState;\r\n}\r\n\r\nconst _defaultServiceState: AppServicesState = {\r\n  circuitEditorDrag: defaultCircuitEditorDragServiceState,\r\n  circuitEditors: defaultCircuitEditorServiceState,\r\n  circuitGraph: defaultCircuitGraphServiceState,\r\n  circuitLayout: defaultCircuitLayoutServiceState,\r\n  circuitProperties: defaultCircuitPropertiesServiceState,\r\n  clipboard: defaultClipboardServiceState,\r\n  dialog: defaultDialogServiceState,\r\n  project: defaultProjectServiceState,\r\n  selection: defaultSelectionServiceState,\r\n  simulator: defaultSimulatorServiceState,\r\n  simulatorControl: defaultSimulatorControlServiceState,\r\n  tutorial: defaultTutorialServiceState,\r\n  uiLayout: defaultUiLayoutServiceState,\r\n  uiSettings: defaultUiSettingsState,\r\n};\r\n\r\nexport const defaultServicesState = Object.freeze(_defaultServiceState);\r\n","import { AppServicesState } from \"@/services/state\";\r\n\r\nexport const UndoServicesStateKeys = [\r\n  \"circuitProperties\",\r\n  \"circuitGraph\",\r\n  \"circuitLayout\",\r\n] as const;\r\nexport type UndoServicesStates = Pick<\r\n  AppServicesState,\r\n  \"circuitProperties\" | \"circuitGraph\" | \"circuitLayout\"\r\n>;\r\n\r\nexport interface UndoStackState {\r\n  serviceStates: UndoServicesStates;\r\n  viewCircuitId: string | null;\r\n}\r\n\r\nexport interface UndoState {\r\n  undoStack: UndoStackState[];\r\n  redoStack: UndoStackState[];\r\n}\r\n\r\nconst _defaultState: UndoState = {\r\n  undoStack: [],\r\n  redoStack: [],\r\n};\r\n\r\nexport const defaultUndoState = Object.freeze(_defaultState);\r\n","import { AppServicesState, defaultServicesState } from \"@/services/state\";\r\nimport { defaultUndoState, UndoState } from \"@/undo/state\";\r\n\r\nexport interface AppState {\r\n  services: AppServicesState;\r\n  undo: UndoState;\r\n}\r\n\r\nconst _defaultAppState: AppState = {\r\n  services: defaultServicesState,\r\n  undo: defaultUndoState,\r\n};\r\n\r\nexport const defaultAppState = Object.freeze(_defaultAppState);\r\n","export const isDev = process.env.NODE_ENV === \"development\";\r\n\r\nconst rootUrlBuilder = new URL(window.location.origin);\r\nrootUrlBuilder.pathname = __webpack_public_path__;\r\nexport const rootUrl = rootUrlBuilder.toString();\r\n\r\nexport const appVersion = DISCRELOG_VERSION;\r\n","import { AnyAction } from \"redux\";\r\nimport { v4 as uuidV4 } from \"uuid\";\r\n\r\nexport const ACTION_CIRCUIT_ADD = \"@circuit/add\" as const;\r\nexport interface NewCircuitOpts {\r\n  circuitName?: string;\r\n  circuitId?: string;\r\n  edit?: boolean;\r\n}\r\nexport const addCircuit = ({\r\n  circuitName,\r\n  circuitId,\r\n  edit,\r\n}: NewCircuitOpts = {}) => ({\r\n  type: ACTION_CIRCUIT_ADD,\r\n  payload: { circuitId: circuitId ?? uuidV4(), circuitName, edit },\r\n});\r\nexport type AddCircuitAction = ReturnType<typeof addCircuit>;\r\nexport function isAddCircuitAction(\r\n  action: AnyAction\r\n): action is AddCircuitAction {\r\n  return action.type === ACTION_CIRCUIT_ADD;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_CIRCUIT_DELETE = \"@circuit/delete\" as const;\r\nexport const deleteCircuit = (circuitId: string) => ({\r\n  type: ACTION_CIRCUIT_DELETE,\r\n  payload: { circuitId },\r\n});\r\nexport type DeleteCircuitAction = ReturnType<typeof deleteCircuit>;\r\nexport function isDeleteCircuitAction(\r\n  action: AnyAction\r\n): action is DeleteCircuitAction {\r\n  return action.type === ACTION_CIRCUIT_DELETE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_CIRCUIT_RENAME = \"@circuit/rename\" as const;\r\nexport const renameCircuit = (circuitId: string, circuitName: string) => ({\r\n  type: ACTION_CIRCUIT_RENAME,\r\n  payload: { circuitId, circuitName },\r\n});\r\nexport type RenameCircuitAction = ReturnType<typeof renameCircuit>;\r\nexport function isRenameCircuitAction(\r\n  action: AnyAction\r\n): action is RenameCircuitAction {\r\n  return action.type === ACTION_CIRCUIT_RENAME;\r\n}\r\n","import { v4 as uuidV4 } from \"uuid\";\r\nimport { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\n\r\nexport interface AddElementOptions {\r\n  elementId?: string;\r\n  elementName?: string;\r\n}\r\nexport const ACTION_ELEMENT_ADD = \"@element/add\" as const;\r\nexport const addElement = (\r\n  elementType: string,\r\n  circuitId: string,\r\n  position: Point,\r\n  opts?: AddElementOptions\r\n) => ({\r\n  type: ACTION_ELEMENT_ADD,\r\n  payload: {\r\n    elementId: uuidV4(),\r\n    elementType,\r\n    circuitId,\r\n    position,\r\n    ...(opts || {}),\r\n  },\r\n});\r\nexport type AddElementAction = ReturnType<typeof addElement>;\r\nexport function isAddElementAction(\r\n  action: AnyAction\r\n): action is AddElementAction {\r\n  return action.type === ACTION_ELEMENT_ADD;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { asArray, MaybeArray } from \"@/arrays\";\r\n\r\nexport const ACTION_ELEMENT_DELETE = \"@element/delete\" as const;\r\nexport const deleteElement = (elementId: MaybeArray<string>) => ({\r\n  type: ACTION_ELEMENT_DELETE,\r\n  payload: { elementIds: asArray(elementId) },\r\n});\r\nexport type DeleteElementAction = ReturnType<typeof deleteElement>;\r\nexport function isDeleteElementAction(\r\n  action: AnyAction\r\n): action is DeleteElementAction {\r\n  return action.type === ACTION_ELEMENT_DELETE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_ELEMENT_RENAME = \"@element/rename\" as const;\r\nexport const renameElement = (elementId: string, elementName: string) => ({\r\n  type: ACTION_ELEMENT_RENAME,\r\n  payload: { elementId, elementName },\r\n});\r\nexport type RenameElementAction = ReturnType<typeof renameElement>;\r\nexport function isRenameElementAction(\r\n  action: AnyAction\r\n): action is RenameElementAction {\r\n  return action.type === ACTION_ELEMENT_RENAME;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SELECTION_ALIGN_TO_GRID = \"@selection/align-to-grid\" as const;\r\nexport const selectionAlignToGrid = () => ({\r\n  type: ACTION_SELECTION_ALIGN_TO_GRID,\r\n});\r\nexport function isSelectionAlignToGridAction(action: AnyAction): boolean {\r\n  return action.type === ACTION_SELECTION_ALIGN_TO_GRID;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SELECTION_DELETE = \"@selection/delete\" as const;\r\nexport const deleteSelection = () => ({\r\n  type: ACTION_SELECTION_DELETE,\r\n});\r\nexport type DeleteSelectionAction = ReturnType<typeof deleteSelection>;\r\nexport function isDeleteSelectionAction(\r\n  action: AnyAction\r\n): action is DeleteSelectionAction {\r\n  return action.type === ACTION_SELECTION_DELETE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport interface MoveSelectionOpts {\r\n  snapMode?: \"none\" | \"element\" | \"by-type\";\r\n}\r\nexport const ACTION_SELECTION_MOVE = \"@selection/move\" as const;\r\nexport const moveSelection = (\r\n  offsetX: number,\r\n  offsetY: number,\r\n  opts: MoveSelectionOpts = {}\r\n) => ({\r\n  type: ACTION_SELECTION_MOVE,\r\n  payload: { offsetX, offsetY, snapMode: opts.snapMode ?? \"none\" },\r\n});\r\nexport type MoveSelectionAction = ReturnType<typeof moveSelection>;\r\nexport function isMoveSelectionAction(\r\n  action: AnyAction\r\n): action is MoveSelectionAction {\r\n  return action.type === ACTION_SELECTION_MOVE;\r\n}\r\n","import { Point } from \"@/geometry\";\r\nimport { AnyAction } from \"redux\";\r\n\r\nexport interface PasteOpts {\r\n  pastePosition?: Point;\r\n}\r\nexport const ACTION_PASTE = \"@clipboard/paste\" as const;\r\nexport const paste = (opts: PasteOpts = {}) => ({\r\n  type: ACTION_PASTE,\r\n  payload: { ...opts },\r\n});\r\nexport type PasteAction = ReturnType<typeof paste>;\r\nexport function isPasteAction(action: AnyAction): action is PasteAction {\r\n  return action.type === ACTION_PASTE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\nimport { ModifierKeys } from \"@/modifier-keys\";\r\n\r\nexport const ACTION_CIRCUIT_EDITOR_DRAG_END = \"@circuit-editor/drag/end\" as const;\r\nexport const circuitEditorDragEnd = (\r\n  point: Point,\r\n  modifierKeys: ModifierKeys,\r\n  editorId: string\r\n) => ({\r\n  type: ACTION_CIRCUIT_EDITOR_DRAG_END,\r\n  payload: { ...point, modifierKeys, editorId },\r\n});\r\nexport type CircuitEditorDragEndAction = ReturnType<\r\n  typeof circuitEditorDragEnd\r\n>;\r\nexport function isCircuitEditorDragEndAction(\r\n  action: AnyAction\r\n): action is CircuitEditorDragEndAction {\r\n  return action.type === ACTION_CIRCUIT_EDITOR_DRAG_END;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_UNDO = \"@undo/undo\" as const;\r\nexport const undo = () => ({\r\n  type: ACTION_UNDO,\r\n});\r\nexport function isUndoAction(action: AnyAction) {\r\n  return action.type === ACTION_UNDO;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_REDO = \"@undo/redo\" as const;\r\nexport const redo = () => ({\r\n  type: ACTION_REDO,\r\n});\r\nexport function isRedoAction(action: AnyAction) {\r\n  return action.type === ACTION_REDO;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_PROJECT_NEW = \"@project/new\" as const;\r\nexport const newProject = () => ({\r\n  type: ACTION_PROJECT_NEW,\r\n});\r\nexport type NewProjectAction = ReturnType<typeof newProject>;\r\nexport function isNewProjectAction(\r\n  action: AnyAction\r\n): action is NewProjectAction {\r\n  return action.type === ACTION_PROJECT_NEW;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { SaveData } from \"@/services/savedata/types\";\r\n\r\nexport const ACTION_PROJECT_RECEIVE = \"@project/receive\" as const;\r\nexport const receiveProject = (fileName: string, saveData: SaveData) => ({\r\n  type: ACTION_PROJECT_RECEIVE,\r\n  payload: { fileName, saveData },\r\n});\r\nexport type ReceiveProjectAction = ReturnType<typeof receiveProject>;\r\nexport function isReceiveProjectAction(\r\n  action: AnyAction\r\n): action is ReceiveProjectAction {\r\n  return action.type === ACTION_PROJECT_RECEIVE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { WireConnectTarget } from \"@/services/circuit-graph/types\";\r\n\r\nexport const ACTION_WIRE_CONNECT = \"@wire/connect\" as const;\r\nexport const wireConnect = (\r\n  circuitId: string,\r\n  from: WireConnectTarget,\r\n  to: WireConnectTarget\r\n) => ({\r\n  type: ACTION_WIRE_CONNECT,\r\n  payload: { circuitId, from, to },\r\n});\r\nexport type WireConnectAction = ReturnType<typeof wireConnect>;\r\nexport function isWireConnectAction(\r\n  action: AnyAction\r\n): action is WireConnectAction {\r\n  return action.type === ACTION_WIRE_CONNECT;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\n\r\nimport { WireSegment } from \"@/services/circuit-graph/types\";\r\n\r\nexport const ACTION_WIRE_HYDRATE = \"@wire/hydrate\" as const;\r\nexport interface HydrateWireSettings {\r\n  wireId: string;\r\n  circuitId: string;\r\n  wireSegments: (WireSegment & { wireSegmentId: string })[];\r\n  wireJoints: (Point & { jointId: string })[];\r\n}\r\nexport const hydrateWire = (settings: HydrateWireSettings) => ({\r\n  type: ACTION_WIRE_HYDRATE,\r\n  payload: settings,\r\n});\r\nexport type HydrateWireAction = ReturnType<typeof hydrateWire>;\r\nexport function isHydrateWireAction(\r\n  action: AnyAction\r\n): action is HydrateWireAction {\r\n  return action.type === ACTION_WIRE_HYDRATE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\nimport { asArray, MaybeArray } from \"@/arrays\";\r\n\r\nexport const ACTION_WIRE_JOINT_MOVE = \"@wire/joint/move\" as const;\r\nexport interface JointMoveOpts {\r\n  relative?: boolean;\r\n  snapMode?: \"none\" | \"element\" | \"joint\";\r\n}\r\nexport const moveWireJoint = (\r\n  jointId: MaybeArray<string>,\r\n  p: Point,\r\n  { relative = false, snapMode = \"none\" }: JointMoveOpts = {}\r\n) => ({\r\n  type: ACTION_WIRE_JOINT_MOVE,\r\n  payload: { jointIds: asArray(jointId), position: p, relative, snapMode },\r\n});\r\nexport type WireJointMoveAction = ReturnType<typeof moveWireJoint>;\r\nexport function isWireJointMoveAction(\r\n  action: AnyAction\r\n): action is WireJointMoveAction {\r\n  return action.type === ACTION_WIRE_JOINT_MOVE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { asArray, MaybeArray } from \"@/arrays\";\r\n\r\nexport const ACTION_WIRE_JOINT_DELETE = \"@wire/joint/delete\" as const;\r\nexport const deleteWireJoint = (jointId: MaybeArray<string>) => ({\r\n  type: ACTION_WIRE_JOINT_DELETE,\r\n  payload: { jointIds: asArray(jointId) },\r\n});\r\nexport type WireJointDeleteAction = ReturnType<typeof deleteWireJoint>;\r\nexport function isWireJointDeleteAction(\r\n  action: AnyAction\r\n): action is WireJointDeleteAction {\r\n  return action.type === ACTION_WIRE_JOINT_DELETE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\n\r\nexport const ACTION_WIRE_SEGMENT_INSERT_JOINT = \"@wire/segment/insert-joint\" as const;\r\nexport const wireSegmentInsertJoint = (\r\n  wireId: string,\r\n  wireSegmentId: string,\r\n  jointPos: Point\r\n) => ({\r\n  type: ACTION_WIRE_SEGMENT_INSERT_JOINT,\r\n  payload: { wireId, wireSegmentId, jointPos },\r\n});\r\nexport type WireSegmentInsertJointAction = ReturnType<\r\n  typeof wireSegmentInsertJoint\r\n>;\r\nexport function isWireSegmentInsertJointAction(\r\n  action: AnyAction\r\n): action is WireSegmentInsertJointAction {\r\n  return action.type === ACTION_WIRE_SEGMENT_INSERT_JOINT;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_WIRE_SEGMENT_SET_LINE = \"@wire/segment/set-line\" as const;\r\nexport const wireSegmentSetLine = (wireSegmentId: string, lineId: string) => ({\r\n  type: ACTION_WIRE_SEGMENT_SET_LINE,\r\n  payload: { wireSegmentId, lineId },\r\n});\r\nexport type WireSegmentSetLineAction = ReturnType<typeof wireSegmentSetLine>;\r\nexport function isWireSegmentSetLineAction(\r\n  action: AnyAction\r\n): action is WireSegmentSetLineAction {\r\n  return action.type === ACTION_WIRE_SEGMENT_SET_LINE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { ACTION_CIRCUIT_ADD } from \"@/actions/circuit-add\";\r\nimport { ACTION_CIRCUIT_DELETE } from \"@/actions/circuit-delete\";\r\nimport { ACTION_CIRCUIT_RENAME } from \"@/actions/circuit-rename\";\r\n\r\nimport { ACTION_ELEMENT_ADD } from \"@/actions/element-add\";\r\nimport { ACTION_ELEMENT_DELETE } from \"@/actions/element-delete\";\r\nimport { ACTION_ELEMENT_RENAME } from \"@/actions/element-rename\";\r\n\r\nimport { ACTION_SELECTION_ALIGN_TO_GRID } from \"@/actions/selection-align-to-grid\";\r\nimport { ACTION_SELECTION_DELETE } from \"@/actions/selection-delete\";\r\nimport { ACTION_SELECTION_MOVE } from \"@/actions/selection-move\";\r\n\r\nimport { ACTION_PASTE } from \"@/actions/clipboard-paste\";\r\nimport { ACTION_CIRCUIT_EDITOR_DRAG_END } from \"@/actions/circuit-editor-drag-end\";\r\n\r\nimport { ACTION_UNDO } from \"@/actions/undo\";\r\nimport { ACTION_REDO } from \"@/actions/redo\";\r\n\r\nimport { ACTION_PROJECT_NEW } from \"@/actions/project-new\";\r\nimport { ACTION_PROJECT_RECEIVE } from \"@/actions/project-receive\";\r\n\r\nimport { ACTION_WIRE_CONNECT } from \"@/actions/wire-connect\";\r\nimport { ACTION_WIRE_HYDRATE } from \"@/actions/wire-hydrate\";\r\nimport { ACTION_WIRE_JOINT_MOVE } from \"@/actions/wire-joint-move\";\r\nimport { ACTION_WIRE_JOINT_DELETE } from \"@/actions/wire-joint-delete\";\r\nimport { ACTION_WIRE_SEGMENT_INSERT_JOINT } from \"@/actions/wire-segment-insert-joint\";\r\nimport { ACTION_WIRE_SEGMENT_SET_LINE } from \"@/actions/wire-segment-set-line\";\r\n\r\nexport const PROJECT_MUTATION_ACTIONS = [\r\n  ACTION_CIRCUIT_ADD,\r\n  ACTION_CIRCUIT_DELETE,\r\n  ACTION_CIRCUIT_RENAME,\r\n\r\n  ACTION_ELEMENT_ADD,\r\n  ACTION_ELEMENT_DELETE,\r\n  ACTION_ELEMENT_RENAME,\r\n\r\n  ACTION_SELECTION_ALIGN_TO_GRID,\r\n  ACTION_SELECTION_DELETE,\r\n  ACTION_SELECTION_MOVE,\r\n\r\n  ACTION_UNDO,\r\n  ACTION_REDO,\r\n\r\n  ACTION_WIRE_CONNECT,\r\n  ACTION_WIRE_HYDRATE,\r\n  ACTION_WIRE_JOINT_MOVE,\r\n  ACTION_WIRE_JOINT_DELETE,\r\n  ACTION_WIRE_SEGMENT_INSERT_JOINT,\r\n  ACTION_WIRE_SEGMENT_SET_LINE,\r\n\r\n  // These actions typically fire off other actions in this list,\r\n  // and are redundant for services that take part in the core reducer.\r\n  // However, undo/redo is outside of the core reducer and does not see the\r\n  // reentrant actions in order to produce a single undo stack entry for\r\n  // the entire paste operation.\r\n  ACTION_PASTE,\r\n  ACTION_CIRCUIT_EDITOR_DRAG_END,\r\n];\r\n\r\nexport function isProjectMutationAction(action: AnyAction) {\r\n  return PROJECT_MUTATION_ACTIONS.indexOf(action.type) !== -1;\r\n}\r\n\r\nexport const PROJECT_RESET_ACTIONS = [\r\n  ACTION_PROJECT_NEW,\r\n  ACTION_PROJECT_RECEIVE,\r\n];\r\n\r\nexport function isProjectResetAction(action: AnyAction) {\r\n  return PROJECT_RESET_ACTIONS.indexOf(action.type) !== -1;\r\n}\r\n","import { AnyAction, Reducer } from \"redux\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport { fpSet } from \"@/utils\";\r\n\r\nexport type ServiceKey = keyof AppState[\"services\"];\r\nexport type ServiceState<\r\n  TServiceKey extends ServiceKey\r\n> = AppState[\"services\"][TServiceKey];\r\n\r\nexport interface ServiceReducer<TServiceState> {\r\n  (\r\n    state: Readonly<TServiceState>,\r\n    action: AnyAction,\r\n    appState: AppState\r\n  ): TServiceState;\r\n}\r\n\r\nexport function createServiceReducerCreator<TServiceKey extends ServiceKey>(\r\n  service: TServiceKey\r\n): (\r\n  reducer: ServiceReducer<AppState[\"services\"][TServiceKey]>\r\n) => Reducer<AppState, AnyAction> {\r\n  return (reducer: ServiceReducer<AppState[\"services\"][TServiceKey]>) => {\r\n    return (state: AppState = defaultAppState, action: AnyAction) => {\r\n      const newState = reducer(state.services[service], action, state);\r\n      if (state.services[service] != newState) {\r\n        return fpSet(state, \"services\", service, newState);\r\n      }\r\n      return state;\r\n    };\r\n  };\r\n}\r\n\r\nexport interface ServiceSelectorA0<TServiceKey extends ServiceKey, TReturn> {\r\n  (s: AppState): TReturn;\r\n  local(s: ServiceState<TServiceKey>): TReturn;\r\n}\r\n\r\nexport interface ServiceSelectorA1<\r\n  TServiceKey extends ServiceKey,\r\n  TA1,\r\n  TReturn\r\n> {\r\n  (s: AppState, a1: TA1): TReturn;\r\n  local(s: ServiceState<TServiceKey>, a1: TA1): TReturn;\r\n}\r\n\r\nexport interface ServiceSelectorA2<\r\n  TServiceKey extends ServiceKey,\r\n  TA1,\r\n  TA2,\r\n  TReturn\r\n> {\r\n  (s: AppState, a1: TA1, a2: TA2): TReturn;\r\n  local(s: ServiceState<TServiceKey>, a1: TA1, a2: TA2): TReturn;\r\n}\r\n\r\nexport interface ServiceSelectorCreator<TServiceKey extends ServiceKey> {\r\n  <TReturn>(\r\n    selector: (s: ServiceState<TServiceKey>) => TReturn\r\n  ): ServiceSelectorA0<TServiceKey, TReturn>;\r\n  <TA1, TReturn>(\r\n    selector: (s: ServiceState<TServiceKey>, a1: TA1) => TReturn\r\n  ): ServiceSelectorA1<TServiceKey, TA1, TReturn>;\r\n  <TA1, TA2, TReturn>(\r\n    selector: (s: ServiceState<TServiceKey>, a1: TA1, a2: TA2) => TReturn\r\n  ): ServiceSelectorA2<TServiceKey, TA1, TA2, TReturn>;\r\n}\r\n\r\nexport function createServiceSelectorCreator<TServiceKey extends ServiceKey>(\r\n  service: TServiceKey\r\n): ServiceSelectorCreator<TServiceKey> {\r\n  return <TArgs, TReturn>(\r\n    selector: (s: ServiceState<TServiceKey>, ...args: TArgs[]) => TReturn\r\n  ) => {\r\n    const appSelector: any = (s: AppState, ...args: TArgs[]) =>\r\n      selector(s.services[service], ...args);\r\n    appSelector.local = selector;\r\n    return appSelector;\r\n  };\r\n}\r\n","import first from \"lodash/first\";\r\n\r\nimport {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\nimport { CircuitEditorsServiceState } from \"./state\";\r\n\r\nexport const createCircuitEditorsReducer = createServiceReducerCreator(\r\n  \"circuitEditors\"\r\n);\r\nexport const createCircuitEditorsSelector = createServiceSelectorCreator(\r\n  \"circuitEditors\"\r\n);\r\n\r\nexport function findActiveEditorId(\r\n  state: CircuitEditorsServiceState\r\n): string | null {\r\n  if (state.activeEditorId) {\r\n    return state.activeEditorId;\r\n  }\r\n  return first(Object.keys(state.circucitEditorsById)) ?? null;\r\n}\r\n","import { AppState } from \"@/store\";\r\n\r\nimport { CircuitEditorsServiceState } from \"../state\";\r\nimport { createCircuitEditorsSelector } from \"../utils\";\r\n\r\nexport const circuitEditorStateFromIdSelector = createCircuitEditorsSelector(\r\n  (s: CircuitEditorsServiceState, editorId: string) =>\r\n    s.circucitEditorsById[editorId]\r\n);\r\n\r\nexport const circuitIdForEditorIdSelector = (\r\n  state: AppState,\r\n  editorId: string\r\n) => {\r\n  const editorState = circuitEditorStateFromIdSelector(state, editorId);\r\n  if (!editorState) {\r\n    return null;\r\n  }\r\n\r\n  return editorState.circuitId;\r\n};\r\n\r\nexport const activeCircuitEditorIdSelector = createCircuitEditorsSelector(\r\n  (s) => {\r\n    if (s.activeEditorId) {\r\n      return s.activeEditorId;\r\n    }\r\n\r\n    const keys = Object.keys(s.circucitEditorsById);\r\n    if (keys.length > 0) {\r\n      return keys[0];\r\n    }\r\n\r\n    return null;\r\n  }\r\n);\r\n\r\nexport const activeCircuitEditorStateSelector = createCircuitEditorsSelector(\r\n  (s) => (s.activeEditorId ? s.circucitEditorsById[s.activeEditorId] : null)\r\n);\r\n\r\nexport const activeCircuitIdSelector = createCircuitEditorsSelector((s) => {\r\n  if (!s.activeEditorId) {\r\n    return null;\r\n  }\r\n  const editorState = s.circucitEditorsById[s.activeEditorId];\r\n  if (!editorState) {\r\n    return null;\r\n  }\r\n\r\n  return editorState.circuitId;\r\n});\r\n\r\nexport const editorIdsFromCircuitIdSelector = createCircuitEditorsSelector(\r\n  (s: CircuitEditorsServiceState, circuitId: string) => {\r\n    return Object.keys(s.circucitEditorsById).filter(\r\n      (id) => s.circucitEditorsById[id].circuitId === circuitId\r\n    );\r\n  }\r\n);\r\n","import pick from \"lodash/pick\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { activeCircuitEditorStateSelector } from \"@/services/circuit-editors/selectors/editor\";\r\n\r\nimport { UndoStackState, UndoServicesStateKeys } from \"./state\";\r\n\r\n// TODO: Consider using a difference engine to store the minimal difference between the states.\r\n//  This should let us store far more undo operations as the project gets larger.\r\n// Could use https://www.npmjs.com/package/deep-diff\r\n// Problem with this is it takes up time capturing the undo, which slows down all operations.\r\nexport function captureUndoState(state: AppState): UndoStackState {\r\n  let viewCircuitId: string | null = null;\r\n\r\n  const activeEditor = activeCircuitEditorStateSelector(state);\r\n  if (activeEditor) {\r\n    viewCircuitId = activeEditor.circuitId;\r\n  }\r\n\r\n  return {\r\n    serviceStates: pick(state.services, UndoServicesStateKeys),\r\n    viewCircuitId,\r\n  };\r\n}\r\n","import { AnyAction } from \"redux\";\r\nimport sortBy from \"lodash/sortBy\";\r\n\r\nimport { MaybeArray } from \"@/arrays\";\r\n\r\nimport { AppState, defaultAppState } from \"./state\";\r\nimport { AppReducer } from \"./types\";\r\n\r\nexport function concatReducers(\r\n  ...reducers: MaybeArray<AppReducer>[]\r\n): AppReducer[] {\r\n  // Previously, this was reduceReducers and generated a reducer\r\n  //  that invokes each child reducer.\r\n  // However, we need to be able to order reducers across services,\r\n  //  so we must now aggregate a list of reducers and do a final ordering\r\n  //  step after all are collected.\r\n  return ([] as AppReducer[]).concat(...reducers);\r\n}\r\n\r\nexport function finalizeReducerList(reducers: AppReducer[]): AppReducer {\r\n  // Order the list by weight ascending.\r\n  const finalizedList = sortBy(reducers, (x: AppReducer) => x.weight || 0);\r\n\r\n  return (state: AppState = defaultAppState, action: AnyAction) => {\r\n    return finalizedList.reduce(\r\n      (state, reducer) => reducer(state, action),\r\n      state\r\n    );\r\n  };\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_CIRCUIT_EDITOR_DRAG_ABORT = \"@circuit-editor/drag/abort\" as const;\r\nexport const circuitEditorDragAbort = () => ({\r\n  type: ACTION_CIRCUIT_EDITOR_DRAG_ABORT,\r\n});\r\nexport type CircuitEditorDragAbortAction = ReturnType<\r\n  typeof circuitEditorDragAbort\r\n>;\r\nexport function isCircuitEditorDragAbortAction(\r\n  action: AnyAction\r\n): action is CircuitEditorDragAbortAction {\r\n  return action.type === ACTION_CIRCUIT_EDITOR_DRAG_ABORT;\r\n}\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createCircuitEditorDragReducer = createServiceReducerCreator(\r\n  \"circuitEditorDrag\"\r\n);\r\nexport const createCircuitEditorDragSelector = createServiceSelectorCreator(\r\n  \"circuitEditorDrag\"\r\n);\r\n","import { isCircuitEditorDragAbortAction } from \"@/actions/circuit-editor-drag-abort\";\r\nimport { defaultCircuitEditorDragServiceState } from \"../state\";\r\nimport { createCircuitEditorDragReducer } from \"../utils\";\r\n\r\nexport default createCircuitEditorDragReducer((state, action) => {\r\n  if (!isCircuitEditorDragAbortAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultCircuitEditorDragServiceState;\r\n});\r\n","import { AnyAction } from \"redux\";\r\nimport { Point } from \"@/geometry\";\r\nimport { ModifierKeys } from \"@/modifier-keys\";\r\n\r\nexport const ACTION_CIRCUIT_EDITOR_DRAG_CONTINUE = \"@circuit-editor/drag/continue\" as const;\r\nexport const circuitEditorDragContinue = (\r\n  p: Point,\r\n  modifierKeys: ModifierKeys,\r\n  editorId: string\r\n) => ({\r\n  type: ACTION_CIRCUIT_EDITOR_DRAG_CONTINUE,\r\n  payload: { dragPos: p, modifierKeys, editorId },\r\n});\r\nexport type CircuitEditorDragContinueAction = ReturnType<\r\n  typeof circuitEditorDragContinue\r\n>;\r\nexport function isCircuitEditorDragContinueAction(\r\n  action: AnyAction\r\n): action is CircuitEditorDragContinueAction {\r\n  return action.type === ACTION_CIRCUIT_EDITOR_DRAG_CONTINUE;\r\n}\r\n","import { isCircuitEditorDragContinueAction } from \"@/actions/circuit-editor-drag-continue\";\r\n\r\nimport { createCircuitEditorDragReducer } from \"../utils\";\r\n\r\nexport default createCircuitEditorDragReducer((state, action) => {\r\n  if (!isCircuitEditorDragContinueAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { dragPos, modifierKeys, editorId } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    dragEnd: dragPos,\r\n    dragEndEditorId: editorId,\r\n    dragModifierKeys: modifierKeys,\r\n  };\r\n});\r\n","import union from \"lodash/union\";\r\nimport difference from \"lodash/difference\";\r\n\r\nimport { ModifierKeys } from \"./modifier-keys\";\r\n\r\nexport type SelectionMode =\r\n  | \"set\"\r\n  | \"append\"\r\n  | \"remove\"\r\n  | \"toggle\"\r\n  | \"set-if-unselected\";\r\n\r\nexport function getSelectMode(\r\n  modifiers: ModifierKeys,\r\n  defaultMode: SelectionMode = \"set\"\r\n): SelectionMode {\r\n  if (modifiers.shiftKey && modifiers.ctrlMetaKey) {\r\n    return \"remove\";\r\n  }\r\n  if (modifiers.shiftKey) {\r\n    return \"append\";\r\n  }\r\n  if (modifiers.ctrlMetaKey) {\r\n    return \"toggle\";\r\n  }\r\n  return defaultMode;\r\n}\r\n\r\nexport function combineSelection(\r\n  selectedIds: string[],\r\n  chosenIds: string[],\r\n  mode: SelectionMode\r\n) {\r\n  switch (mode) {\r\n    case \"set\":\r\n      return chosenIds;\r\n    case \"set-if-unselected\": {\r\n      if (chosenIds.every((chosen) => selectedIds.indexOf(chosen) !== -1)) {\r\n        // All were selected.\r\n        return selectedIds;\r\n      }\r\n\r\n      // One wasn't selected, set it\r\n      return chosenIds;\r\n    }\r\n    case \"append\":\r\n      return union(selectedIds, chosenIds);\r\n    case \"remove\":\r\n      return difference(selectedIds, chosenIds);\r\n    case \"toggle\": {\r\n      return difference(selectedIds, chosenIds).concat(\r\n        difference(chosenIds, selectedIds)\r\n      );\r\n    }\r\n  }\r\n\r\n  return chosenIds;\r\n}\r\n\r\nexport function combineExtraniousSelection(\r\n  selectedIds: string[],\r\n  mode: SelectionMode\r\n) {\r\n  switch (mode) {\r\n    case \"append\":\r\n    case \"remove\":\r\n      return selectedIds;\r\n  }\r\n\r\n  return [];\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Rectangle } from \"@/geometry\";\r\nimport { SelectionMode } from \"@/selection-mode\";\r\n\r\nexport const ACTION_SELECT_REGION = \"@select/region\" as const;\r\nexport const selectRegion = (\r\n  region: Rectangle,\r\n  circuitId: string,\r\n  mode: SelectionMode = \"set\"\r\n) => ({\r\n  type: ACTION_SELECT_REGION,\r\n  payload: {\r\n    region,\r\n    circuitId,\r\n    mode,\r\n  },\r\n});\r\nexport type SelectRegionAction = ReturnType<typeof selectRegion>;\r\nexport function isSelectRegionAction(\r\n  action: AnyAction\r\n): action is SelectRegionAction {\r\n  return action.type === ACTION_SELECT_REGION;\r\n}\r\n","import { Point, snapPoint } from \"@/geometry\";\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { createCircuitEditorDragSelector } from \"../utils\";\r\n\r\nexport const gridElementSnapSelector = createCircuitEditorDragSelector(\r\n  () => 50\r\n);\r\n\r\nexport const gridJointSnapSelector = createCircuitEditorDragSelector(() => 5);\r\n\r\nexport const applyGridElementSnapSelector = (s: AppState, p: Point) => {\r\n  const snap = gridElementSnapSelector(s);\r\n  return snapPoint(p, snap);\r\n};\r\n\r\nexport const applyGridJointSnapSelector = (s: AppState, p: Point) => {\r\n  const snap = gridJointSnapSelector(s);\r\n  return snapPoint(p, snap);\r\n};\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nimport { CircuitGraphServiceState } from \"./state\";\r\nimport { WireSegment } from \"./types\";\r\n\r\nexport const createCircuitGraphReducer = createServiceReducerCreator(\r\n  \"circuitGraph\"\r\n);\r\nexport const createCircuitGraphSelector = createServiceSelectorCreator(\r\n  \"circuitGraph\"\r\n);\r\n\r\nexport function getSegmentIdsFromJoint(\r\n  state: CircuitGraphServiceState,\r\n  wireId: string,\r\n  jointId: string\r\n): string[] {\r\n  const wire = state.wiresByWireId[wireId];\r\n\r\n  const jointedSegmentIds = new Set<string>();\r\n  for (const segmentId of wire.wireSegmentIds) {\r\n    const segment = state.wireSegmentsById[segmentId];\r\n    switch (segment.type) {\r\n      case \"input\":\r\n      case \"output\":\r\n        if (segment.jointId === jointId) jointedSegmentIds.add(segmentId);\r\n        break;\r\n      case \"bridge\":\r\n        if (segment.jointAId === jointId || segment.jointBId === jointId)\r\n          jointedSegmentIds.add(segmentId);\r\n        break;\r\n    }\r\n  }\r\n\r\n  return Array.from(jointedSegmentIds);\r\n}\r\n\r\nexport function getJointIdsFromSegment(segment: WireSegment): string[] {\r\n  switch (segment.type) {\r\n    case \"bridge\":\r\n      return [segment.jointAId, segment.jointBId];\r\n    case \"input\":\r\n    case \"output\":\r\n      return [segment.jointId];\r\n    default:\r\n      return [];\r\n  }\r\n}\r\n\r\nexport function collectWireLineIds(\r\n  state: CircuitGraphServiceState,\r\n  wireId: string\r\n): [inputLineIds: string[], outputLineIds: string[]] {\r\n  const wire = state.wiresByWireId[wireId];\r\n  if (!wire) {\r\n    return [[], []];\r\n  }\r\n\r\n  const inputLineIds = new Set<string>();\r\n  const outputLineIds = new Set<string>();\r\n  for (const segId of wire.wireSegmentIds) {\r\n    const seg = state.wireSegmentsById[segId];\r\n    if (seg.type === \"input\") {\r\n      inputLineIds.add(seg.lineId);\r\n    } else if (seg.type === \"output\") {\r\n      outputLineIds.add(seg.lineId);\r\n    }\r\n  }\r\n\r\n  return [Array.from(inputLineIds), Array.from(outputLineIds)];\r\n}\r\n","import { createSelector } from \"reselect\";\r\nimport mapValues from \"lodash/mapValues\";\r\n\r\nimport { createCircuitGraphSelector } from \"../utils\";\r\nimport { CircuitGraphServiceState } from \"../state\";\r\nimport { Element } from \"../types\";\r\n\r\nexport const elementsByElementIdSelector = createCircuitGraphSelector(\r\n  (s) => s.elementsById\r\n);\r\n\r\nexport const elementIdsSelector = createCircuitGraphSelector(\r\n  createSelector(\r\n    elementsByElementIdSelector.local,\r\n    (elementsById: Record<string, Element>) => Object.keys(elementsById)\r\n  )\r\n);\r\n\r\nexport const elementTypesByElementIdSelector = createCircuitGraphSelector(\r\n  createSelector(\r\n    elementsByElementIdSelector.local,\r\n    (elementsById: Record<string, Element>) =>\r\n      mapValues(elementsById, (x) => x.elementType)\r\n  )\r\n);\r\n\r\nexport const elementFromElementIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, elementId: string) =>\r\n    s.elementsById[elementId] || null\r\n);\r\n\r\nexport const elementIdsFromTypeSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, desiredType: string) => {\r\n    const elementIds: string[] = [];\r\n    for (const elementId of Object.keys(s.elementsById)) {\r\n      const { elementType } = s.elementsById[elementId];\r\n      if (elementType === desiredType) {\r\n        elementIds.push(elementId);\r\n      }\r\n    }\r\n    return elementIds;\r\n  }\r\n);\r\n\r\nexport const elementTypeFromElementIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, elementId: string) => {\r\n    const element = elementFromElementIdSelector.local(s, elementId);\r\n    if (!element) {\r\n      return null;\r\n    }\r\n    return element.elementType;\r\n  }\r\n);\r\n\r\nexport const elementIdsByCircuitIdSelector = createCircuitGraphSelector(\r\n  (state) => state.elementIdsByCircuitId\r\n);\r\n\r\nconst EmptyElementIds = Object.freeze([] as string[]);\r\nexport const elementIdsFromCircuitIdSelector = createCircuitGraphSelector<\r\n  string,\r\n  string[]\r\n>(\r\n  (state, circuitId: string) =>\r\n    state.elementIdsByCircuitId[circuitId] ?? EmptyElementIds\r\n);\r\n\r\nexport const circuitIdFromElementIdSelector = createCircuitGraphSelector<\r\n  string,\r\n  string | null\r\n>((state, elementId) => {\r\n  for (const circuitId of Object.keys(state.elementIdsByCircuitId)) {\r\n    const elementIds = state.elementIdsByCircuitId[circuitId];\r\n    if (elementIds.indexOf(elementId) !== -1) {\r\n      return circuitId;\r\n    }\r\n  }\r\n  return null;\r\n});\r\n\r\nexport const elementNamesByElementIdSelector = createCircuitGraphSelector(\r\n  createSelector(\r\n    (state) => state.elementsById,\r\n    (elementsById) => {\r\n      return mapValues(elementsById, (element) => element.elementName);\r\n    }\r\n  )\r\n);\r\n\r\nexport const elementNameOrDefaultFromElementIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, elementId: string) => {\r\n    const element = elementFromElementIdSelector.local(s, elementId);\r\n    if (!element) {\r\n      return null;\r\n    }\r\n\r\n    return element.elementName ?? elementId.substr(0, 4);\r\n  }\r\n);\r\n\r\nexport const elementNameFromElementIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, elementId: string) => {\r\n    const element = elementFromElementIdSelector.local(s, elementId);\r\n    if (!element) {\r\n      return null;\r\n    }\r\n\r\n    return element.elementName;\r\n  }\r\n);\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createCircuitLayoutReducer = createServiceReducerCreator(\r\n  \"circuitLayout\"\r\n);\r\nexport const createCircuitLayoutSelector = createServiceSelectorCreator(\r\n  \"circuitLayout\"\r\n);\r\n","import { ZeroPoint } from \"@/geometry\";\r\n\r\nimport { createCircuitLayoutSelector } from \"../utils\";\r\nimport { CircuitLayoutServiceState } from \"../state\";\r\n\r\nexport const elementPositionsByElementIdSelector = createCircuitLayoutSelector(\r\n  (state) => state.elementPositionsById\r\n);\r\n\r\nexport const elementPositionFromElementIdSelector = createCircuitLayoutSelector(\r\n  (state: CircuitLayoutServiceState, elementId: string) =>\r\n    state.elementPositionsById[elementId] ?? ZeroPoint\r\n);\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createCircuitPropertiesReducer = createServiceReducerCreator(\r\n  \"circuitProperties\"\r\n);\r\nexport const createCircuitPropertiesSelector = createServiceSelectorCreator(\r\n  \"circuitProperties\"\r\n);\r\n","import { CircuitPropertiesServiceState } from \"../state\";\r\nimport { createCircuitPropertiesSelector } from \"../utils\";\r\n\r\nexport const circuitIdsSelector = createCircuitPropertiesSelector((state) =>\r\n  Object.keys(state.circuitNamesByCircuitId)\r\n);\r\n\r\nexport const circuitNamesByIdSelector = createCircuitPropertiesSelector(\r\n  (state) => state.circuitNamesByCircuitId\r\n);\r\n\r\nexport const circuitNameFromIdSelector = createCircuitPropertiesSelector(\r\n  (state: CircuitPropertiesServiceState, circuitId: string) =>\r\n    state.circuitNamesByCircuitId[circuitId]\r\n);\r\n","export function circuitIdToElementType(circuitId: string) {\r\n  return `ic-${circuitId}`;\r\n}\r\n\r\nexport function elementTypeToCircuitId(\r\n  elementType: string | null\r\n): string | null {\r\n  if (!elementType || !elementType.startsWith(\"ic-\")) {\r\n    return null;\r\n  }\r\n  return elementType.substr(3);\r\n}\r\n\r\nexport function getICBorderPath(inputPinCount: number, outputPinCount: number) {\r\n  const height = Math.max(inputPinCount, outputPinCount, 1) * 50 - 20;\r\n  return `M10,10 h80 v${height} h-80 z`;\r\n}\r\n","import * as React from \"react\";\r\n\r\nimport { createSelector } from \"reselect\";\r\nimport sortBy from \"lodash/sortBy\";\r\nimport getBounds from \"svg-path-bounds\";\r\n\r\nimport { PinDirection } from \"@/logic\";\r\nimport { boundsToRect, Point } from \"@/geometry\";\r\n\r\nimport { IntegratedCircuitElementVisualProps } from \"@/elements/visuals/IntegratedCircuitElementVisual\";\r\n\r\nimport { elementIdsByCircuitIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { ROOT_CIRCUIT_ID } from \"@/services/circuits/constants\";\r\nimport { elementTypesByElementIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { elementPositionsByElementIdSelector } from \"@/services/circuit-layout/selectors/element-positions\";\r\nimport { circuitNamesByIdSelector } from \"@/services/circuit-properties/selectors/circuits\";\r\n\r\nimport {\r\n  ElementDefinition,\r\n  ElementDefinitionSource,\r\n  ElementPinDefinition,\r\n} from \"../../types\";\r\n\r\nimport { circuitIdToElementType, getICBorderPath } from \"./utils\";\r\n\r\nconst IntegratedCircuitDefinitionSource: ElementDefinitionSource = createSelector(\r\n  (state) => elementIdsByCircuitIdSelector.local(state.circuitGraph),\r\n  (state) => elementTypesByElementIdSelector.local(state.circuitGraph),\r\n  (state) => elementPositionsByElementIdSelector.local(state.circuitLayout),\r\n  (state) => circuitNamesByIdSelector.local(state.circuitProperties),\r\n  (\r\n    elementIdsByCircuitId,\r\n    elementTypesByElementId,\r\n    elementPositionsByElementId,\r\n    circuitNamesById\r\n  ) => {\r\n    return Object.keys(elementIdsByCircuitId)\r\n      .filter((x) => x !== ROOT_CIRCUIT_ID)\r\n      .map((circuitId) => {\r\n        const elementIds = elementIdsByCircuitId[circuitId] ?? [];\r\n        const circuitName =\r\n          circuitNamesById[circuitId] ?? circuitId.substr(0, 5);\r\n\r\n        // Sort by y axis position to get consistent pin locations.\r\n        let pinElementIds = elementIds.filter((elementId) =>\r\n          elementTypesByElementId[elementId].startsWith(\"pin-\")\r\n        );\r\n        pinElementIds = sortBy(\r\n          pinElementIds,\r\n          (elementId) => elementPositionsByElementId[elementId].y,\r\n          (elementId) => elementPositionsByElementId[elementId].x\r\n        );\r\n\r\n        const pins: Record<string, ElementPinDefinition> = {};\r\n        const inputPinIds: string[] = [];\r\n        const outputPinIds: string[] = [];\r\n        for (const pinElementId of pinElementIds) {\r\n          const type = elementTypesByElementId[pinElementId];\r\n          if (type === \"pin-input\") {\r\n            pins[pinElementId] = {\r\n              direction: \"input\",\r\n              ...circuitPinPosition(inputPinIds.length, \"input\"),\r\n            };\r\n            inputPinIds.push(pinElementId);\r\n          } else if (type === \"pin-output\") {\r\n            pins[pinElementId] = {\r\n              direction: \"output\",\r\n              ...circuitPinPosition(outputPinIds.length, \"output\"),\r\n            };\r\n            outputPinIds.push(pinElementId);\r\n          }\r\n        }\r\n\r\n        const componentProps: IntegratedCircuitElementVisualProps = {\r\n          circuitId,\r\n          inputPinIds,\r\n          outputPinIds,\r\n        };\r\n\r\n        const def: ElementDefinition = {\r\n          type: circuitIdToElementType(circuitId),\r\n          category: \"integrated-circuit\",\r\n          displayName: circuitName,\r\n          elementProduction: {\r\n            type: \"circuit\",\r\n            circuitId,\r\n          },\r\n          visual: {\r\n            hitRect: boundsToRect(\r\n              getBounds(\r\n                getICBorderPath(inputPinIds.length, outputPinIds.length)\r\n              )\r\n            ),\r\n            trayComponent: () => (\r\n              <g stroke=\"black\" strokeWidth={1}>\r\n                <rect x={10} y={10} width={30} height={30} fill=\"none\" />\r\n\r\n                <line x1={10} y1={15} x2={5} y2={15} />\r\n                <line x1={40} y1={15} x2={45} y2={15} />\r\n\r\n                <line x1={10} y1={35} x2={5} y2={35} />\r\n                <line x1={40} y1={35} x2={45} y2={35} />\r\n              </g>\r\n            ),\r\n            component: \"integrated-circuit\",\r\n            componentProps,\r\n          },\r\n          pins,\r\n        };\r\n        return def;\r\n      });\r\n  }\r\n);\r\n\r\nexport default [IntegratedCircuitDefinitionSource];\r\n\r\nfunction circuitPinPosition(pinIndex: number, direction: PinDirection): Point {\r\n  return {\r\n    x: direction === \"input\" ? 0 : 100,\r\n    y: pinIndex * 50 + 25,\r\n  };\r\n}\r\n","import { ElementDefinitionSource } from \"../../types\";\r\n\r\nconst InteractionDefinitionSources: ElementDefinitionSource[] = [\r\n  require(\"./momentary\").default,\r\n  require(\"./toggle\").default,\r\n];\r\n\r\nexport default InteractionDefinitionSources;\r\n","import { ElementDefinitionSource } from \"../types\";\r\n\r\nimport IntegratedCircuitDefinitionSources from \"./integrated-circuits\";\r\nimport InteractionDefinitionSources from \"./interaction\";\r\nimport LogicDefinitionSources from \"./logic\";\r\nimport OutputDefinitionSources from \"./output\";\r\nimport PinDefinitionSources from \"./pins\";\r\n\r\nconst elementDefinitionSources: ElementDefinitionSource[] = [\r\n  ...IntegratedCircuitDefinitionSources,\r\n  ...InteractionDefinitionSources,\r\n  ...LogicDefinitionSources,\r\n  ...OutputDefinitionSources,\r\n  ...PinDefinitionSources,\r\n];\r\n\r\nexport default elementDefinitionSources;\r\n","import { ElementDefinitionSource } from \"../../types\";\r\n\r\nconst LogicElementDefinitionSources: ElementDefinitionSource[] = [\r\n  require(\"./and\").default,\r\n  require(\"./buffer\").default,\r\n  require(\"./nand\").default,\r\n  require(\"./nor\").default,\r\n  require(\"./not\").default,\r\n  require(\"./or\").default,\r\n  require(\"./xor\").default,\r\n];\r\n\r\nexport default LogicElementDefinitionSources;\r\n","import { ElementDefinitionSource } from \"../../types\";\r\n\r\nconst OutputElementDefinitionSources: ElementDefinitionSource[] = [\r\n  require(\"./led\").default,\r\n  require(\"./seg7\").default,\r\n];\r\n\r\nexport default OutputElementDefinitionSources;\r\n","import { ElementDefinitionSource } from \"../../types\";\r\n\r\nconst PinElementDefinitionSources: ElementDefinitionSource[] = [\r\n  require(\"./high\").default,\r\n  require(\"./input\").default,\r\n  require(\"./output\").default,\r\n];\r\n\r\nexport default PinElementDefinitionSources;\r\n","import flatMap from \"lodash/flatMap\";\r\nimport find from \"lodash/find\";\r\nimport { createSelector } from \"reselect\";\r\n\r\nimport { asArray, MaybeArray } from \"@/arrays\";\r\nimport { AppState } from \"@/store\";\r\n\r\nimport elementDefinitionSources from \"@/elements/definitions\";\r\n\r\nimport {\r\n  ElementDefinition,\r\n  ElementDefinitionDerivedState,\r\n  ElementDefinitionSource,\r\n} from \"@/elements/types\";\r\n\r\nconst elementDefinitionsDerivedStateSelector = createSelector(\r\n  (state: AppState) => state.services.circuitGraph,\r\n  (state: AppState) => state.services.circuitLayout,\r\n  (state: AppState) => state.services.circuitProperties,\r\n  (circuitGraph, circuitLayout, circuitProperties) => ({\r\n    circuitGraph,\r\n    circuitLayout,\r\n    circuitProperties,\r\n  })\r\n);\r\n\r\n/**\r\n * Gets an array of element definitions from the current state.\r\n */\r\nexport const elementDefinitionsSelector = createSelector(\r\n  elementDefinitionsDerivedStateSelector,\r\n  (derivedState) => {\r\n    const definitions = flatMap(elementDefinitionSources, (source) =>\r\n      resolveSources(source, derivedState)\r\n    );\r\n\r\n    return definitions;\r\n  }\r\n);\r\n\r\nexport const elementDefinitionsByTypeSelector = createSelector(\r\n  elementDefinitionsSelector,\r\n  (defs) => {\r\n    const defsByType: Record<string, ElementDefinition> = {};\r\n    for (const def of defs) {\r\n      defsByType[def.type] = def;\r\n    }\r\n    return defsByType;\r\n  }\r\n);\r\n\r\nexport const elementDefinitionFromTypeSelector = (\r\n  state: AppState,\r\n  elementType: string\r\n) => {\r\n  const definitions = elementDefinitionsSelector(state);\r\n  return find(definitions, (x) => x.type === elementType) ?? null;\r\n};\r\n\r\nfunction resolveSources(\r\n  source: ElementDefinitionSource,\r\n  state: ElementDefinitionDerivedState\r\n): ElementDefinition[] {\r\n  let resolved: MaybeArray<ElementDefinition>;\r\n  if (typeof source === \"function\") {\r\n    resolved = source(state);\r\n  } else {\r\n    resolved = source;\r\n  }\r\n\r\n  return asArray(resolved);\r\n}\r\n","import { createSelector } from \"reselect\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { Point, pointAdd, ZeroPoint } from \"@/geometry\";\r\n\r\nimport { elementTypesByElementIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { elementDefinitionsByTypeSelector } from \"@/services/element-types/selectors/element-types\";\r\n\r\nimport { elementPositionsByElementIdSelector } from \"./element-positions\";\r\n\r\nexport const elementPinPositionsByPinIdByElementIdSelector = createSelector(\r\n  elementDefinitionsByTypeSelector,\r\n  elementPositionsByElementIdSelector,\r\n  elementTypesByElementIdSelector,\r\n  (elementDefsByType, elementPositionsByElementId, elementTypesByElementId) => {\r\n    const elementPinPositionsByPinIdByElementId: Record<\r\n      string,\r\n      Record<string, Point>\r\n    > = {};\r\n\r\n    const elementIds = Object.keys(elementTypesByElementId);\r\n    for (const elementId of elementIds) {\r\n      const elementPinPositionsByPinId: Record<string, Point> = {};\r\n      elementPinPositionsByPinIdByElementId[\r\n        elementId\r\n      ] = elementPinPositionsByPinId;\r\n\r\n      const elementPosition =\r\n        elementPositionsByElementId[elementId] ?? ZeroPoint;\r\n\r\n      const elementType = elementTypesByElementId[elementId];\r\n      if (!elementType) {\r\n        continue;\r\n      }\r\n      const def = elementDefsByType[elementType];\r\n      if (!def) {\r\n        continue;\r\n      }\r\n\r\n      const pinIds = Object.keys(def.pins);\r\n      for (const pinId of pinIds) {\r\n        const relPinPosition = def.pins[pinId];\r\n        const pinPosition = pointAdd(elementPosition, relPinPosition);\r\n        elementPinPositionsByPinId[pinId] = pinPosition;\r\n      }\r\n    }\r\n\r\n    return elementPinPositionsByPinIdByElementId;\r\n  }\r\n);\r\n\r\nexport const elementPinPositionFromElementPinSelector = (\r\n  state: AppState,\r\n  elementId: string,\r\n  pinId: string\r\n) => {\r\n  const positonsByPinIdByElementId = elementPinPositionsByPinIdByElementIdSelector(\r\n    state\r\n  );\r\n  const elementPinPositions = positonsByPinIdByElementId[elementId];\r\n  if (!elementPinPositions) {\r\n    return ZeroPoint;\r\n  }\r\n  return elementPinPositions[pinId] ?? ZeroPoint;\r\n};\r\n","import flatMap from \"lodash/flatMap\";\r\nimport get from \"lodash/get\";\r\n\r\nimport { EvolverIdMappingTreeItem, EvolverIdToElementIdMap } from \"./types\";\r\n\r\nexport function walkSimulatorElementIdToCircuitElementIdMap(\r\n  map: EvolverIdToElementIdMap,\r\n  visit: (elementIdPath: string[], evolverId: string) => void,\r\n  elementIdPath: string[] = []\r\n) {\r\n  const elementIds = Object.keys(map);\r\n  for (const elementId of elementIds) {\r\n    const { evolverId, subElementIds: subCircuitIds } = map[elementId];\r\n    const currentPath = [...elementIdPath, elementId];\r\n    if (evolverId) {\r\n      visit(currentPath, evolverId);\r\n    }\r\n    walkSimulatorElementIdToCircuitElementIdMap(\r\n      subCircuitIds,\r\n      visit,\r\n      currentPath\r\n    );\r\n  }\r\n}\r\n\r\nexport function getEvolverIdFromElementIdPath(\r\n  map: EvolverIdToElementIdMap,\r\n  elementIdPath: string[]\r\n): string | null {\r\n  // Look up the path through the ic element to reach this element.\r\n  const evolverIdPath = flatMap(elementIdPath, (icElementId) => [\r\n    icElementId,\r\n    \"subElementIds\",\r\n  ]);\r\n\r\n  // Remove the last subCircuitIds\r\n  evolverIdPath.pop();\r\n\r\n  const evolverIdItem: EvolverIdMappingTreeItem = get(map, evolverIdPath);\r\n\r\n  if (!evolverIdItem) {\r\n    return null;\r\n  }\r\n\r\n  const { evolverId: evolverId } = evolverIdItem;\r\n  return evolverId ?? null;\r\n}\r\n","import { Point } from \"@/geometry\";\r\n\r\nexport interface Element {\r\n  /**\r\n   * The type of this element.\r\n   */\r\n  elementType: string;\r\n\r\n  /**\r\n   * The user provided name of this element.\r\n   */\r\n  elementName: string | null;\r\n}\r\n\r\n/**\r\n * Identifies a pin on a specific element.\r\n */\r\nexport interface ElementPin {\r\n  elementId: string;\r\n  pinId: string;\r\n}\r\n\r\nexport function elementPinEquals(a: ElementPin, b: ElementPin) {\r\n  return a.elementId === b.elementId && a.pinId === b.pinId;\r\n}\r\n\r\n/**\r\n * A connection from an element output to an element input.\r\n */\r\nexport interface ElementConnection {\r\n  /**\r\n   * The output pin on an element, sending a value outwards.\r\n   */\r\n  outputPin: ElementPin;\r\n\r\n  /**\r\n   * The input pin on an element to receive the value.\r\n   */\r\n  inputPin: ElementPin;\r\n}\r\n\r\nexport interface Wire {\r\n  wireSegmentIds: string[];\r\n  wireJointIds: string[];\r\n}\r\n\r\n/**\r\n * Defines a segment that passes a value into an element from the wire.\r\n */\r\nexport interface InputWireSegment {\r\n  type: \"input\";\r\n\r\n  /**\r\n   * The input pin we supply a value to.\r\n   */\r\n  inputPin: ElementPin;\r\n\r\n  /**\r\n   * The joint id on the non-pin side of this segment.\r\n   */\r\n  jointId: string;\r\n\r\n  /**\r\n   * The id of the line in the wire, used to match against the source output.\r\n   */\r\n  lineId: string;\r\n}\r\n\r\n/**\r\n * Defines a wire segment that pulls a value into the wire.\r\n */\r\nexport interface OutputWireSegment {\r\n  type: \"output\";\r\n\r\n  /**\r\n   * The output pin we take our value from.\r\n   */\r\n  outputPin: ElementPin;\r\n\r\n  /**\r\n   * The joint id of the non-pin side of this segment.\r\n   */\r\n  jointId: string;\r\n\r\n  /**\r\n   * The id of the line in the wire, used to match against inputs.\r\n   */\r\n  lineId: string;\r\n}\r\n\r\n/**\r\n * Defines a wire segment that directly connects an input to an output.\r\n *\r\n * This is a special case where a wire goes directly between two elements with no\r\n * additional inputs or outputs.\r\n */\r\nexport interface InputOutputWireSegment {\r\n  type: \"input-output\";\r\n  /**\r\n   * The output pin supplying the value.\r\n   */\r\n  outputPin: ElementPin;\r\n  /**\r\n   * The input pin where the value is supplied.\r\n   */\r\n  inputPin: ElementPin;\r\n}\r\n\r\n/**\r\n * Defines a wire segment that bridges two other segments.\r\n */\r\nexport interface BridgeWireSegment {\r\n  type: \"bridge\";\r\n  /**\r\n   * The first joint in the bridge.\r\n   */\r\n  jointAId: string;\r\n\r\n  /**\r\n   * The second joint in the bridge.\r\n   */\r\n  jointBId: string;\r\n}\r\n\r\nexport type WireSegment =\r\n  | InputWireSegment\r\n  | OutputWireSegment\r\n  | InputOutputWireSegment\r\n  | BridgeWireSegment;\r\n\r\nexport function isOutputWireSegment(\r\n  segment: WireSegment\r\n): segment is OutputWireSegment {\r\n  return segment.type === \"output\";\r\n}\r\n\r\nexport function isInputWireSegment(\r\n  segment: WireSegment\r\n): segment is InputWireSegment {\r\n  return segment.type === \"input\";\r\n}\r\n\r\nexport function isInputOutputWireSegment(\r\n  segment: WireSegment\r\n): segment is InputOutputWireSegment {\r\n  return segment.type === \"input-output\";\r\n}\r\n\r\nexport function wireSegmentHasInput(\r\n  segment: WireSegment\r\n): segment is InputWireSegment | InputOutputWireSegment {\r\n  return segment.type === \"input\" || segment.type === \"input-output\";\r\n}\r\n\r\n/**\r\n * Signifies a joint as a connection target.\r\n */\r\nexport interface JointWireConnectTarget {\r\n  type: \"joint\";\r\n\r\n  /**\r\n   * The id of the joint being connected to.\r\n   */\r\n  jointId: string;\r\n}\r\n\r\n/**\r\n * Signifies a wire segment as a connection target.\r\n */\r\nexport interface SegmentWireConnectTarget {\r\n  type: \"segment\";\r\n\r\n  /**\r\n   * The id of the segment being connected to.\r\n   */\r\n  segmentId: string;\r\n\r\n  /**\r\n   * The length along the segment the connection is connecting to.\r\n   */\r\n  segmentInsertLength: number;\r\n}\r\n\r\n/**\r\n * Signifies an element pin as a connection target.\r\n */\r\nexport interface PinWireConnectTarget {\r\n  type: \"pin\";\r\n\r\n  /**\r\n   * The pin being connected to.\r\n   */\r\n  pin: ElementPin;\r\n}\r\n\r\n/**\r\n * Signifies a loose connection floating on the field as a connection target.\r\n */\r\nexport interface FloatingWireConnectTarget {\r\n  type: \"floating\";\r\n\r\n  /**\r\n   * The point where the wire will float at.\r\n   */\r\n  point: Point;\r\n}\r\n\r\nexport type WireConnectTarget =\r\n  | JointWireConnectTarget\r\n  | SegmentWireConnectTarget\r\n  | PinWireConnectTarget\r\n  | FloatingWireConnectTarget;\r\n","import { createSelector } from \"reselect\";\r\n\r\nimport { CircuitGraphServiceState } from \"../state\";\r\nimport { createCircuitGraphSelector } from \"../utils\";\r\nimport {\r\n  ElementConnection,\r\n  isInputOutputWireSegment,\r\n  isInputWireSegment,\r\n  isOutputWireSegment,\r\n} from \"../types\";\r\n\r\nexport const connectionsSelector = createCircuitGraphSelector(\r\n  createSelector(\r\n    (state: CircuitGraphServiceState) => state.wiresByWireId,\r\n    (state: CircuitGraphServiceState) => state.wireSegmentsById,\r\n    (wiresById, segmentsById) => {\r\n      const connections: ElementConnection[] = [];\r\n\r\n      const wireIds = Object.keys(wiresById);\r\n      for (const wireId of wireIds) {\r\n        const { wireSegmentIds } = wiresById[wireId];\r\n        const segments = wireSegmentIds.map((id) => segmentsById[id]);\r\n        for (const segment of segments) {\r\n          if (isInputOutputWireSegment(segment)) {\r\n            connections.push({\r\n              inputPin: segment.inputPin,\r\n              outputPin: segment.outputPin,\r\n            });\r\n          } else if (isOutputWireSegment(segment)) {\r\n            const inputs = segments\r\n              .filter(isInputWireSegment)\r\n              .filter(({ lineId }) => lineId === segment.lineId);\r\n            for (const input of inputs) {\r\n              connections.push({\r\n                outputPin: segment.outputPin,\r\n                inputPin: input.inputPin,\r\n              });\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      return connections;\r\n    }\r\n  )\r\n);\r\n","import get from \"lodash/get\";\r\nimport merge from \"lodash/merge\";\r\nimport { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport {\r\n  CircuitSimProduction,\r\n  ElementSimProduction,\r\n  normalizeSimProduction,\r\n} from \"../../elements/types/element-production\";\r\n\r\nimport {\r\n  SimulatorGraph,\r\n  SimulatorGraphDependencies,\r\n  SimulatorEvolver,\r\n  EvolverIdMappingTreeItem,\r\n  EvolverPin,\r\n} from \"./types\";\r\n\r\ntype CircuitProductionResult = SimulatorGraph & {\r\n  inputElementPinsByCircuitPinId: Record<string, EvolverPin[]>;\r\n  outputElementPinsByCircuitPinId: Record<string, EvolverPin>;\r\n};\r\n\r\nconst EMPTY_PRODUCTION = Object.freeze<CircuitProductionResult>({\r\n  evolversById: {},\r\n  evolverIdsByElementId: {},\r\n  inputElementPinsByCircuitPinId: {},\r\n  outputElementPinsByCircuitPinId: {},\r\n});\r\n\r\nexport function produceCircuitGraph(\r\n  circuitId: string,\r\n  dependencies: SimulatorGraphDependencies,\r\n  path: string[] = []\r\n): CircuitProductionResult {\r\n  if (path.indexOf(circuitId) !== -1) {\r\n    throw new Error(\r\n      `Circuit graph encountered loop on ${path.join(\r\n        \" => \"\r\n      )} while trying to add circuit ${circuitId}`\r\n    );\r\n  }\r\n\r\n  path = [...path, circuitId];\r\n\r\n  const evolversById: Record<string, SimulatorEvolver> = {};\r\n  const evolverIdsByElementId: Record<string, EvolverIdMappingTreeItem> = {};\r\n  const inputElementPinsByCircuitPinId: Record<string, EvolverPin[]> = {};\r\n  const outputElementPinsByCircuitPinId: Record<string, EvolverPin> = {};\r\n\r\n  const inputElementIds: string[] = [];\r\n  const outputElementIds: string[] = [];\r\n\r\n  // 1. Create new elements\r\n  // 2. Connect elements amongst themselves.\r\n  // 3. Pass input and output mapping to parent.\r\n\r\n  const elementInputPinsByPinIdByElementId: Record<\r\n    string,\r\n    Record<string, EvolverPin[]>\r\n  > = {};\r\n  const elementOutputPinsByPinIdByElementId: Record<\r\n    string,\r\n    Record<string, EvolverPin>\r\n  > = {};\r\n\r\n  const elementIds = dependencies.elementIdsByCircuitId[circuitId] ?? [];\r\n  for (const elementId of elementIds) {\r\n    const elementType = dependencies.elementTypesByElementId[elementId];\r\n    if (!elementType) {\r\n      continue;\r\n    }\r\n\r\n    // If this element is a pin, remember it to calculate circuit inputs and outputs.\r\n    if (elementType === \"pin-input\") {\r\n      inputElementIds.push(elementId);\r\n      inputElementPinsByCircuitPinId[elementId] = [];\r\n      continue;\r\n    } else if (elementType === \"pin-output\") {\r\n      outputElementIds.push(elementId);\r\n      continue;\r\n    }\r\n\r\n    const productionResult = produceEvolver(elementId, dependencies, path);\r\n\r\n    // Merge the produced simulator elements.\r\n    merge(evolversById, productionResult.evolversById);\r\n\r\n    // Merge the mapping from circuit element to evolver.\r\n    merge(evolverIdsByElementId, productionResult.evolverIdsByElementId);\r\n\r\n    // Remember what these element pins translate to.\r\n    elementInputPinsByPinIdByElementId[elementId] =\r\n      productionResult.inputElementPinsByCircuitPinId;\r\n    elementOutputPinsByPinIdByElementId[elementId] =\r\n      productionResult.outputElementPinsByCircuitPinId;\r\n  }\r\n\r\n  for (const { inputPin, outputPin } of dependencies.connections) {\r\n    // We are only interested in connections within this circuit.\r\n    // There should not be any cross-circuit connections.\r\n    // It might be ok to skip this step, and rely on not finding the element mapping.\r\n\r\n    if (\r\n      elementIds.indexOf(inputPin.elementId) === -1 ||\r\n      elementIds.indexOf(outputPin.elementId) === -1\r\n    ) {\r\n      continue;\r\n    }\r\n\r\n    // We need to find the one output, and connect it to all inputs that match.\r\n    // There might be more than one input if the input was on an IC / circuit production.\r\n    const outputSimPin = get(elementOutputPinsByPinIdByElementId, [\r\n      outputPin.elementId,\r\n      outputPin.pinId,\r\n    ]);\r\n    const inputSimPins = get(elementInputPinsByPinIdByElementId, [\r\n      inputPin.elementId,\r\n      inputPin.pinId,\r\n    ]);\r\n\r\n    // If the output is one of our input elements, then the inputs\r\n    //  need to be saved for our circuit inputs\r\n    if (inputElementIds.indexOf(outputPin.elementId) !== -1 && inputSimPins) {\r\n      // pin id is the pin-input elementId\r\n      inputElementPinsByCircuitPinId[outputPin.elementId].push(...inputSimPins);\r\n      continue;\r\n    } else if (\r\n      outputElementIds.indexOf(inputPin.elementId) !== -1 &&\r\n      outputSimPin\r\n    ) {\r\n      outputElementPinsByCircuitPinId[inputPin.elementId] = outputSimPin;\r\n      continue;\r\n    }\r\n\r\n    if (!outputSimPin || !inputSimPins) {\r\n      continue;\r\n    }\r\n\r\n    const outputEvolver = evolversById[outputSimPin.evolverId];\r\n    let outputsByOutputPin = outputEvolver.outputsByPin[outputSimPin.pinId];\r\n    if (outputsByOutputPin == null) {\r\n      outputEvolver.outputsByPin[outputSimPin.pinId] = outputsByOutputPin = [];\r\n    }\r\n\r\n    // Connect up the output to all of the inputs\r\n    for (const inputSimPin of inputSimPins) {\r\n      outputsByOutputPin.push({\r\n        evolverId: inputSimPin.evolverId,\r\n        pinId: inputSimPin.pinId,\r\n      });\r\n\r\n      const inputNode = evolversById[inputSimPin.evolverId];\r\n      inputNode.inputsByPin[inputSimPin.pinId] = {\r\n        evolverId: outputSimPin.evolverId,\r\n        pinId: outputSimPin.pinId,\r\n      };\r\n    }\r\n  }\r\n\r\n  return {\r\n    evolversById,\r\n    evolverIdsByElementId: evolverIdsByElementId,\r\n    inputElementPinsByCircuitPinId,\r\n    outputElementPinsByCircuitPinId,\r\n  };\r\n}\r\n\r\nfunction produceEvolver(\r\n  elementId: string,\r\n  dependencies: SimulatorGraphDependencies,\r\n  path: string[]\r\n): CircuitProductionResult {\r\n  const elementType = dependencies.elementTypesByElementId[elementId];\r\n  if (!elementType) {\r\n    return EMPTY_PRODUCTION;\r\n  }\r\n\r\n  const def = dependencies.elementDefsByElementType[elementType];\r\n  if (!def || !def.elementProduction) {\r\n    return EMPTY_PRODUCTION;\r\n  }\r\n\r\n  const production = normalizeSimProduction(def.elementProduction);\r\n  switch (production.type) {\r\n    case \"element\":\r\n      return produceElementNode(elementId, production, dependencies);\r\n    case \"circuit\":\r\n      return produceCircuitNode(elementId, production, dependencies, path);\r\n    default:\r\n      throw new Error(\r\n        \"Unsupported production type \" + (production as any).type\r\n      );\r\n  }\r\n}\r\n\r\nfunction produceElementNode(\r\n  elementId: string,\r\n  production: ElementSimProduction,\r\n  {\r\n    elementTypesByElementId,\r\n    elementDefsByElementType,\r\n  }: SimulatorGraphDependencies\r\n): CircuitProductionResult {\r\n  const elementType = elementTypesByElementId[elementId];\r\n  const def = elementDefsByElementType[elementType];\r\n  if (!def) {\r\n    return EMPTY_PRODUCTION;\r\n  }\r\n\r\n  const evolversById: Record<string, SimulatorEvolver> = {};\r\n  const evolverIdsByElementId: Record<string, EvolverIdMappingTreeItem> = {};\r\n\r\n  const evolverId = uuidV4();\r\n  evolversById[evolverId] = {\r\n    evolverType: production.evolverType,\r\n    // We do not have any internal pins.\r\n    // These will be connected by produceCircuit as\r\n    // it completes is cross-circuit connections.\r\n    inputsByPin: {},\r\n    outputsByPin: {},\r\n  };\r\n\r\n  evolverIdsByElementId[elementId] = {\r\n    evolverId,\r\n    subElementIds: {},\r\n  };\r\n\r\n  const inputElementPinsByCircuitPinId: Record<string, EvolverPin[]> = {};\r\n  const outputElementPinsByCircuitPinId: Record<string, EvolverPin> = {};\r\n\r\n  // We have a one to one pin mapping between element and evolver\r\n  for (const pinId of Object.keys(def.pins)) {\r\n    const { direction } = def.pins[pinId];\r\n    if (direction === \"input\") {\r\n      inputElementPinsByCircuitPinId[pinId] = [\r\n        {\r\n          pinId,\r\n          evolverId: evolverId,\r\n        },\r\n      ];\r\n    } else if (direction === \"output\") {\r\n      outputElementPinsByCircuitPinId[pinId] = {\r\n        pinId,\r\n        evolverId: evolverId,\r\n      };\r\n    }\r\n  }\r\n\r\n  return {\r\n    evolversById,\r\n    evolverIdsByElementId: evolverIdsByElementId,\r\n    inputElementPinsByCircuitPinId,\r\n    outputElementPinsByCircuitPinId,\r\n  };\r\n}\r\n\r\nfunction produceCircuitNode(\r\n  elementId: string,\r\n  production: CircuitSimProduction,\r\n  dependencies: SimulatorGraphDependencies,\r\n  path: string[]\r\n): CircuitProductionResult {\r\n  const circuitProuction = produceCircuitGraph(\r\n    production.circuitId,\r\n    dependencies,\r\n    path\r\n  );\r\n\r\n  return {\r\n    ...circuitProuction,\r\n    evolverIdsByElementId: {\r\n      [elementId]: {\r\n        evolverId: null,\r\n        subElementIds: circuitProuction.evolverIdsByElementId,\r\n      },\r\n    },\r\n  };\r\n}\r\n","import { EvolverType } from \"@/evolvers\";\r\n\r\nexport interface ElementSimProduction {\r\n  type: \"element\";\r\n  evolverType: EvolverType;\r\n}\r\n\r\nexport interface CircuitSimProduction {\r\n  type: \"circuit\";\r\n  circuitId: string;\r\n}\r\n\r\nexport type SimProductionObject = ElementSimProduction | CircuitSimProduction;\r\n\r\nexport type SimProduction = EvolverType | SimProductionObject;\r\n\r\nexport function normalizeSimProduction(\r\n  simProduction: SimProduction\r\n): SimProductionObject {\r\n  if (typeof simProduction === \"string\") {\r\n    return {\r\n      type: \"element\",\r\n      evolverType: simProduction,\r\n    };\r\n  }\r\n\r\n  return simProduction;\r\n}\r\n","import { EvolverType } from \"@/evolvers\";\r\nimport { ElementDefinition } from \"@/elements/types\";\r\n\r\nimport { ElementConnection } from \"../circuit-graph/types\";\r\n\r\nexport interface EvolverPin {\r\n  evolverId: string;\r\n  pinId: string;\r\n}\r\n\r\nexport interface SimulatorEvolver {\r\n  /**\r\n   * The type of this evolver.\r\n   */\r\n  evolverType: EvolverType;\r\n\r\n  /**\r\n   * Input source pins by input pin id.\r\n   *\r\n   * This is redundant with the opposing evolver's outputsByPin,\r\n   * to increase lookup speed.\r\n   */\r\n  inputsByPin: Record<string, EvolverPin>;\r\n\r\n  /**\r\n   * Output source pins by output pin id.\r\n   *\r\n   * This is redundant with the opposing evolver's inputsByPin,\r\n   * to increase lookup speed.\r\n   */\r\n  outputsByPin: Record<string, EvolverPin[]>;\r\n}\r\n\r\nexport interface EvolverIdMappingTreeItem {\r\n  evolverId: string | null;\r\n  subElementIds: EvolverIdToElementIdMap;\r\n}\r\n\r\nexport type EvolverIdToElementIdMap = Record<string, EvolverIdMappingTreeItem>;\r\n\r\nexport interface SimulatorGraphDependencies {\r\n  elementIdsByCircuitId: Readonly<Record<string, string[]>>;\r\n  elementTypesByElementId: Readonly<Record<string, string>>;\r\n  connections: Readonly<ElementConnection[]>;\r\n  elementDefsByElementType: Readonly<Record<string, ElementDefinition>>;\r\n}\r\n\r\nexport interface SimulatorGraph {\r\n  /**\r\n   * A map of all evolvers by their id.\r\n   */\r\n  evolversById: Record<string, SimulatorEvolver>;\r\n\r\n  /**\r\n   * A map of evolver ids by the element id that generated them.\r\n   */\r\n  evolverIdsByElementId: EvolverIdToElementIdMap;\r\n}\r\n\r\nexport const EmptySimulatorGraph: SimulatorGraph = Object.freeze({\r\n  evolversById: {},\r\n  evolverIdsByElementId: {},\r\n});\r\n","import { createSelector } from \"reselect\";\r\n\r\nimport { elementIdsByCircuitIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { elementTypesByElementIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { connectionsSelector } from \"@/services/circuit-graph/selectors/connections\";\r\nimport { elementDefinitionsByTypeSelector } from \"@/services/element-types/selectors/element-types\";\r\nimport { ROOT_CIRCUIT_ID } from \"@/services/circuits/constants\";\r\n\r\nimport { produceCircuitGraph } from \"../graph-production\";\r\nimport { EmptySimulatorGraph } from \"../types\";\r\n\r\nexport const rootCircuitGraphSelector = createSelector(\r\n  elementIdsByCircuitIdSelector,\r\n  elementTypesByElementIdSelector,\r\n  connectionsSelector,\r\n  elementDefinitionsByTypeSelector,\r\n  (\r\n    elementIdsByCircuitId,\r\n    elementTypesByElementId,\r\n    connections,\r\n    elementDefsByElementType\r\n  ) => {\r\n    try {\r\n      return produceCircuitGraph(ROOT_CIRCUIT_ID, {\r\n        elementIdsByCircuitId,\r\n        elementTypesByElementId,\r\n        connections,\r\n        elementDefsByElementType,\r\n      });\r\n    } catch (e) {\r\n      // FIXME: Display this error to the user.\r\n      console.error(e);\r\n      return EmptySimulatorGraph;\r\n    }\r\n  }\r\n);\r\n","import { AppState } from \"@/store\";\r\n\r\nimport { getEvolverIdFromElementIdPath } from \"@/services/simulator-graph/utils\";\r\nimport { rootCircuitGraphSelector } from \"@/services/simulator-graph/selectors/graph\";\r\n\r\nexport const evolverStateFromCircuitElementIdSelector = (\r\n  state: AppState,\r\n  elementIdPath: string[]\r\n) => {\r\n  const { evolverIdsByElementId } = rootCircuitGraphSelector(state);\r\n  const evolverStatesByEvolverId =\r\n    state.services.simulator.evolverStatesByEvolverId;\r\n\r\n  const evolverId = getEvolverIdFromElementIdPath(\r\n    evolverIdsByElementId,\r\n    elementIdPath\r\n  );\r\n  if (!evolverId) {\r\n    return undefined;\r\n  }\r\n\r\n  return evolverStatesByEvolverId[evolverId];\r\n};\r\n\r\nexport const elementOutputsFromCircuitElementIdSelector = (\r\n  state: AppState,\r\n  elementIdPath: string[]\r\n) => {\r\n  const { evolverIdsByElementId } = rootCircuitGraphSelector(state);\r\n  const elementOutputsBySimulatorElementId =\r\n    state.services.simulator.evolverOutputValuesByEvolverId;\r\n\r\n  const evolverId = getEvolverIdFromElementIdPath(\r\n    evolverIdsByElementId,\r\n    elementIdPath\r\n  );\r\n  if (!evolverId) {\r\n    return undefined;\r\n  }\r\n\r\n  return elementOutputsBySimulatorElementId[evolverId];\r\n};\r\n\r\nexport const elementOutputFromCircuitElementPinSelector = (\r\n  state: AppState,\r\n  elementIdPath: string[],\r\n  pin: string\r\n) => {\r\n  const outputs = elementOutputsFromCircuitElementIdSelector(\r\n    state,\r\n    elementIdPath\r\n  );\r\n  if (!outputs) {\r\n    return false;\r\n  }\r\n  return outputs[pin] ?? false;\r\n};\r\n","import { createSelector } from \"reselect\";\r\nimport first from \"lodash/first\";\r\nimport values from \"lodash/values\";\r\nimport flatMap from \"lodash/flatMap\";\r\nimport uniq from \"lodash/uniq\";\r\nimport find from \"lodash/find\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { immutableEmptyArray } from \"@/arrays\";\r\n\r\nimport { elementOutputFromCircuitElementPinSelector } from \"@/services/simulator/selectors/elements\";\r\n\r\nimport { CircuitGraphServiceState } from \"../state\";\r\nimport {\r\n  createCircuitGraphSelector,\r\n  getJointIdsFromSegment,\r\n  getSegmentIdsFromJoint,\r\n} from \"../utils\";\r\nimport {\r\n  ElementPin,\r\n  elementPinEquals,\r\n  isInputOutputWireSegment,\r\n  isInputWireSegment,\r\n  isOutputWireSegment,\r\n  OutputWireSegment,\r\n  wireSegmentHasInput,\r\n} from \"../types\";\r\nimport { elementTypeFromElementIdSelector } from \"./elements\";\r\nimport { elementTypeToCircuitId } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nexport const wiresByWireIdSelector = createCircuitGraphSelector(\r\n  (state) => state.wiresByWireId\r\n);\r\nexport const wireIdsSelector = createSelector(\r\n  wiresByWireIdSelector,\r\n  (wiresByWireId) => Object.keys(wiresByWireId)\r\n);\r\n\r\nexport const wireSegmentsByWireSegmentIdSelector = createCircuitGraphSelector(\r\n  (state) => state.wireSegmentsById\r\n);\r\n\r\nexport const wireSegmentsSelector = createCircuitGraphSelector(\r\n  createSelector(\r\n    wireSegmentsByWireSegmentIdSelector.local,\r\n    (segmentsBySegmentId) => values(segmentsBySegmentId)\r\n  )\r\n);\r\n\r\nexport const wireSegmentIdsFromWireIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, wireId: string) => {\r\n    const wire = s.wiresByWireId[wireId];\r\n    if (!wire) {\r\n      return immutableEmptyArray<string>();\r\n    }\r\n    return wire.wireSegmentIds;\r\n  }\r\n);\r\n\r\nexport const wireIdFromWireSegmentIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, segmentId: string) => {\r\n    for (const wireId of Object.keys(s.wiresByWireId)) {\r\n      const { wireSegmentIds } = s.wiresByWireId[wireId];\r\n      if (wireSegmentIds.indexOf(segmentId) !== -1) {\r\n        return wireId;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n);\r\n\r\nexport const wireJointIdsFromWireIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, wireId: string) => {\r\n    const wire = s.wiresByWireId[wireId];\r\n    if (!wire) {\r\n      return immutableEmptyArray<string>();\r\n    }\r\n\r\n    return wire.wireJointIds;\r\n  }\r\n);\r\n\r\nexport const circuitIdFromWireJointIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, jointId: string) => {\r\n    const wireId = wireIdFromWireJointIdSelector.local(s, jointId);\r\n    if (!wireId) {\r\n      return null;\r\n    }\r\n\r\n    for (const circuitId of Object.keys(s.wireIdsByCircuitId)) {\r\n      if (s.wireIdsByCircuitId[circuitId].indexOf(wireId) !== -1) {\r\n        return circuitId;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n);\r\n\r\nexport const wireIdFromWireJointIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, jointId: string) => {\r\n    for (const wireId of Object.keys(s.wiresByWireId)) {\r\n      const { wireJointIds } = s.wiresByWireId[wireId];\r\n      if (wireJointIds.indexOf(jointId) !== -1) {\r\n        return wireId;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n);\r\n\r\nexport const wireSegmentTypeFromSegmentIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, segmentId: string) => {\r\n    const segment = s.wireSegmentsById[segmentId];\r\n    if (!segment) {\r\n      return null;\r\n    }\r\n    return segment.type;\r\n  }\r\n);\r\n\r\nexport const wireJointIdsByWireIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, wireId: string) => {\r\n    const segmentIds = wireSegmentIdsFromWireIdSelector.local(s, wireId);\r\n    const jointIds = flatMap(segmentIds, (segmentId) => {\r\n      const segment = wireSegmentByWireSegmentIdSelector.local(s, segmentId);\r\n      return getJointIdsFromSegment(segment);\r\n    });\r\n\r\n    return uniq(jointIds);\r\n  }\r\n);\r\n\r\nexport const wireSegmentByWireSegmentIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, wireSegmentId: string) => {\r\n    return s.wireSegmentsById[wireSegmentId] ?? null;\r\n  }\r\n);\r\n\r\nexport const wireSegmentIdFromElementPinSelector = createCircuitGraphSelector(\r\n  (state: CircuitGraphServiceState, elementId: string, pinId: string) => {\r\n    const wireIds = Object.keys(state.wiresByWireId);\r\n\r\n    for (const wireId of wireIds) {\r\n      const wire = state.wiresByWireId[wireId];\r\n      for (const segmentId of wire.wireSegmentIds) {\r\n        const segment = state.wireSegmentsById[segmentId];\r\n        if (\r\n          wireSegmentHasInput(segment) &&\r\n          elementPinEquals(segment.inputPin, { elementId, pinId })\r\n        ) {\r\n          return segmentId;\r\n        }\r\n        if (\r\n          isOutputWireSegment(segment) &&\r\n          elementPinEquals(segment.outputPin, { elementId, pinId })\r\n        ) {\r\n          return segmentId;\r\n        }\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n);\r\n\r\nexport const inputPinIsWiredSelector = createCircuitGraphSelector(\r\n  (state: CircuitGraphServiceState, elementId: string, pinId: string) => {\r\n    const segmentId = wireSegmentIdFromElementPinSelector.local(\r\n      state,\r\n      elementId,\r\n      pinId\r\n    );\r\n    if (!segmentId) {\r\n      return false;\r\n    }\r\n\r\n    const segment = state.wireSegmentsById[segmentId];\r\n    return wireSegmentHasInput(segment);\r\n  }\r\n);\r\n\r\nexport const wireIdsFromCircuitIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, circuitId: string) => {\r\n    return s.wireIdsByCircuitId[circuitId] ?? immutableEmptyArray<string>();\r\n  }\r\n);\r\n\r\nexport const circuitIdForWireIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, wireId: string) => {\r\n    for (const circuitId of Object.keys(s.wireIdsByCircuitId)) {\r\n      if (s.wireIdsByCircuitId[circuitId].indexOf(wireId) !== -1) {\r\n        return circuitId;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n);\r\n\r\n/**\r\n * Gets a list of wire joint ids in a given circuit.\r\n * WARN: Not react safe.\r\n */\r\nexport const wireJointIdsFromCircuitIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, circuitId: string) => {\r\n    const wireIds = s.wireIdsByCircuitId[circuitId];\r\n    const jointIds = flatMap(\r\n      wireIds,\r\n      (wireId) => s.wiresByWireId[wireId].wireJointIds\r\n    );\r\n    return jointIds;\r\n  }\r\n);\r\n\r\n/**\r\n * Gets a list of wire segment ids in a given circuit.\r\n * WARN: Not react safe.\r\n */\r\nexport const wireSegmentIdsFromCircuitIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, circuitId: string) => {\r\n    const wireIds = s.wireIdsByCircuitId[circuitId];\r\n    const jointIds = flatMap(\r\n      wireIds,\r\n      (wireId) => s.wiresByWireId[wireId].wireSegmentIds\r\n    );\r\n    return jointIds;\r\n  }\r\n);\r\n\r\nexport const segmentIdsForJointIdSelector = createCircuitGraphSelector(\r\n  (s: CircuitGraphServiceState, jointId: string) => {\r\n    const wireId = wireIdFromWireJointIdSelector.local(s, jointId);\r\n    if (!wireId) {\r\n      return immutableEmptyArray<string>();\r\n    }\r\n    const wire = s.wiresByWireId[wireId];\r\n\r\n    const segmentIds: string[] = [];\r\n    for (const segmentId of wire.wireSegmentIds) {\r\n      const jointIds = getJointIdsFromSegment(s.wireSegmentsById[segmentId]);\r\n      if (jointIds.indexOf(jointId) !== -1) {\r\n        segmentIds.push(segmentId);\r\n      }\r\n    }\r\n    return segmentIds;\r\n  }\r\n);\r\n\r\n/**\r\n * A map of all element pins supplying power to a segment by the segment id.\r\n * TODO: This cache could be made more aggressive.  We can only generate it on sim start,\r\n * or only invalidate specific wire networks when modified.  This would speed up editing.\r\n */\r\nconst wireSegmentSourcesBySegmentIdSelector = createSelector(\r\n  (state: AppState) => state.services.circuitGraph,\r\n  (circuitGraph) => {\r\n    const sources: Record<string, ElementPin[]> = {};\r\n    for (const wireId of Object.keys(circuitGraph.wiresByWireId)) {\r\n      collectSegmentSources(wireId, sources, circuitGraph);\r\n    }\r\n    return sources;\r\n  }\r\n);\r\n\r\nexport const segmentIsWiredSelector = (state: AppState, segmentId: string) => {\r\n  const segmentSourcesBySegmentId = wireSegmentSourcesBySegmentIdSelector(\r\n    state\r\n  );\r\n  const source = segmentSourcesBySegmentId[segmentId];\r\n  return source && source.length > 0;\r\n};\r\n\r\nfunction collectSegmentSources(\r\n  wireId: string,\r\n  segmentSources: Record<string, ElementPin[]>,\r\n  circuitGraph: CircuitGraphServiceState\r\n): void {\r\n  const wire = circuitGraph.wiresByWireId[wireId];\r\n  if (!wire) {\r\n    return;\r\n  }\r\n\r\n  for (const segmentId of wire.wireSegmentIds) {\r\n    const segment = circuitGraph.wireSegmentsById[segmentId];\r\n    if (isInputOutputWireSegment(segment)) {\r\n      addSegmentSource(segmentSources, segmentId, segment.outputPin);\r\n      continue;\r\n    }\r\n\r\n    if (isOutputWireSegment(segment)) {\r\n      traceSegmentToInput(\r\n        wireId,\r\n        segmentId,\r\n        null,\r\n        segment,\r\n        segmentSources,\r\n        circuitGraph\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nfunction traceSegmentToInput(\r\n  wireId: string,\r\n  segmentId: string,\r\n  entryJointId: string | null,\r\n  outputSegment: OutputWireSegment,\r\n  segmentSources: Record<string, ElementPin[]>,\r\n  circuitGraph: CircuitGraphServiceState\r\n): boolean {\r\n  const segment = circuitGraph.wireSegmentsById[segmentId];\r\n\r\n  if (isInputWireSegment(segment)) {\r\n    if (segment.lineId !== outputSegment.lineId) {\r\n      return false;\r\n    }\r\n\r\n    addSegmentSource(segmentSources, segmentId, outputSegment.outputPin);\r\n    return true;\r\n  }\r\n\r\n  // Max of 2 joints.  We always start on an output, and follow other joints.\r\n  // This will have at most 1 joint.\r\n  const jointId = first(\r\n    getJointIdsFromSegment(segment).filter((x) => x !== entryJointId)\r\n  );\r\n  if (!jointId) {\r\n    return false;\r\n  }\r\n\r\n  const connectedSegmentIds = getSegmentIdsFromJoint(\r\n    circuitGraph,\r\n    wireId,\r\n    jointId\r\n  ).filter((x) => x !== segmentId);\r\n\r\n  let hasAtLeastOneInput = false;\r\n  for (const connectedSegmentId of connectedSegmentIds) {\r\n    const hasInput = traceSegmentToInput(\r\n      wireId,\r\n      connectedSegmentId,\r\n      jointId,\r\n      outputSegment,\r\n      segmentSources,\r\n      circuitGraph\r\n    );\r\n    if (hasInput) {\r\n      // A connection passes through us, mark it.\r\n      hasAtLeastOneInput = true;\r\n    }\r\n  }\r\n\r\n  if (hasAtLeastOneInput) {\r\n    addSegmentSource(segmentSources, segmentId, outputSegment.outputPin);\r\n  }\r\n\r\n  return hasAtLeastOneInput;\r\n}\r\n\r\nfunction addSegmentSource(\r\n  segmentSources: Record<string, ElementPin[]>,\r\n  segmentId: string,\r\n  source: ElementPin\r\n) {\r\n  if (!segmentSources[segmentId]) {\r\n    segmentSources[segmentId] = [];\r\n  }\r\n  // TODO: We can probably resolve this pin across ics, but that would need to involve\r\n  // calculating a delta of into our out of ics which still works when approached from different\r\n  // paths.\r\n  segmentSources[segmentId].push(source);\r\n}\r\n\r\nexport const wireSegmentPoweredSelector = (\r\n  state: AppState,\r\n  elementIdPath: string[],\r\n  wireSegmentId: string\r\n) => {\r\n  const sourcesById = wireSegmentSourcesBySegmentIdSelector(state);\r\n  const segmentSources = sourcesById[wireSegmentId];\r\n  if (!segmentSources) {\r\n    return false;\r\n  }\r\n\r\n  return segmentSources.some((sourcePin) =>\r\n    getPoweredStateFromOutputPin(state, elementIdPath, sourcePin)\r\n  );\r\n};\r\n\r\nfunction getPoweredStateFromOutputPin(\r\n  state: AppState,\r\n  elementIdPath: string[],\r\n  elementPin: ElementPin\r\n): boolean {\r\n  const resolved = resolveOutputPin(state, elementIdPath, elementPin);\r\n  if (!resolved) {\r\n    return false;\r\n  }\r\n  return elementOutputFromCircuitElementPinSelector(\r\n    state,\r\n    [...resolved.elementIdPath, resolved.elementPin.elementId],\r\n    resolved.elementPin.pinId\r\n  );\r\n}\r\n\r\nfunction resolveOutputPin(\r\n  state: AppState,\r\n  elementIdPath: string[],\r\n  elementPin: ElementPin\r\n): { elementIdPath: string[]; elementPin: ElementPin } | null {\r\n  // TODO: If target is a pin, keep chasing through the pins until we find the real element\r\n  // the pin is sourcing from.\r\n  const elementType = elementTypeFromElementIdSelector(\r\n    state,\r\n    elementPin.elementId\r\n  );\r\n\r\n  if (elementType === \"pin-input\") {\r\n    // We are wired to an input pin inside an ic, track down the element outside the ic that powers us.\r\n    const icId = elementIdPath[elementIdPath.length - 1];\r\n    const icPath = elementIdPath.slice(0, elementIdPath.length - 1);\r\n    // ic pin is the same id as the pin element.\r\n    const outputPin = getOutputPinForInputPin(state, {\r\n      elementId: icId,\r\n      pinId: elementPin.elementId,\r\n    });\r\n    if (!outputPin) {\r\n      return null;\r\n    }\r\n    return resolveOutputPin(state, icPath, outputPin);\r\n  }\r\n\r\n  const icCircuit = elementTypeToCircuitId(elementType);\r\n  if (icCircuit != null) {\r\n    // We are wired to an IC, enter the ic and track the output.\r\n    const icPath = [...elementIdPath, elementPin.elementId];\r\n    const inputPin: ElementPin = {\r\n      // element id of the pin element will be the pin id of the ic.\r\n      elementId: elementPin.pinId,\r\n      pinId: \"IN\",\r\n    };\r\n    const outputPin = getOutputPinForInputPin(state, inputPin);\r\n    if (!outputPin) {\r\n      return null;\r\n    }\r\n    return resolveOutputPin(state, icPath, outputPin);\r\n  }\r\n\r\n  return { elementIdPath, elementPin };\r\n}\r\n\r\n// TODO: This takes lots of time in firefox.\r\n// This should be cachable (map by input pin), except for that we need the element defs\r\n// to figure out all input pins to map by, and getting that requires the root state.\r\n// The def selector needs to be modified to only take a subset of the state so that we can\r\n// keep it cached as the simulator service data changes.\r\nfunction getOutputPinForInputPin(\r\n  state: AppState,\r\n  elementPin: ElementPin\r\n): ElementPin | null {\r\n  const { wiresByWireId, wireSegmentsById } = state.services.circuitGraph;\r\n  const wireIds = Object.keys(wiresByWireId);\r\n  for (const wireId of wireIds) {\r\n    const wire = wiresByWireId[wireId];\r\n    for (const segmentId of wire.wireSegmentIds) {\r\n      const segment = wireSegmentsById[segmentId];\r\n      if (!wireSegmentHasInput(segment)) {\r\n        continue;\r\n      }\r\n      if (elementPinEquals(segment.inputPin, elementPin)) {\r\n        if (segment.type === \"input-output\") {\r\n          return segment.outputPin;\r\n        } else {\r\n          const outputSegment = find(\r\n            wire.wireSegmentIds\r\n              .map((id) => wireSegmentsById[id])\r\n              .filter(isOutputWireSegment),\r\n            (search) => segment.lineId === search.lineId\r\n          );\r\n          if (!outputSegment) {\r\n            return null;\r\n          }\r\n          return outputSegment.outputPin;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n","import { ZeroPoint } from \"@/geometry\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { elementPinPositionFromElementPinSelector } from \"@/services/circuit-layout/selectors/element-pin-positions\";\r\n\r\nimport { CircuitGraphServiceState } from \"../state\";\r\nimport { createCircuitGraphSelector } from \"../utils\";\r\n\r\nimport { wireSegmentByWireSegmentIdSelector } from \"./wires\";\r\n\r\nexport const wireJointPositionByJointIdSelector = createCircuitGraphSelector(\r\n  (s) => s.wireJointPositionsByJointId\r\n);\r\n\r\nexport const wireJointPositionFromJointIdSelector = createCircuitGraphSelector(\r\n  (state: CircuitGraphServiceState, jointId: string) =>\r\n    state.wireJointPositionsByJointId[jointId] ?? ZeroPoint\r\n);\r\n\r\nexport const startPositionForWireSegmentId = (\r\n  state: AppState,\r\n  wireSegmentId: string\r\n) => {\r\n  const segment = wireSegmentByWireSegmentIdSelector(state, wireSegmentId);\r\n  switch (segment.type) {\r\n    case \"output\":\r\n    case \"input-output\": {\r\n      // Outputs start at the output and end at the joint.\r\n      const { outputPin } = segment;\r\n      return elementPinPositionFromElementPinSelector(\r\n        state,\r\n        outputPin.elementId,\r\n        outputPin.pinId\r\n      );\r\n    }\r\n    case \"input\": {\r\n      // Inputs start at joint and end at input.\r\n      const { jointId } = segment;\r\n      return wireJointPositionFromJointIdSelector(state, jointId);\r\n    }\r\n    case \"bridge\": {\r\n      const { jointAId } = segment;\r\n      return wireJointPositionFromJointIdSelector(state, jointAId);\r\n    }\r\n  }\r\n};\r\n\r\nexport const endPositionForWireSegmentId = (\r\n  state: AppState,\r\n  wireSegmentId: string\r\n) => {\r\n  const segment = wireSegmentByWireSegmentIdSelector(state, wireSegmentId);\r\n  switch (segment.type) {\r\n    case \"output\": {\r\n      // Outputs start at the output and end at the joint.\r\n      const { jointId } = segment;\r\n      return wireJointPositionFromJointIdSelector(state, jointId);\r\n    }\r\n    case \"input\":\r\n    case \"input-output\": {\r\n      // Inputs start at joint and end at input.\r\n      const { inputPin } = segment;\r\n      return elementPinPositionFromElementPinSelector(\r\n        state,\r\n        inputPin.elementId,\r\n        inputPin.pinId\r\n      );\r\n    }\r\n    case \"bridge\": {\r\n      const { jointBId } = segment;\r\n      return wireJointPositionFromJointIdSelector(state, jointBId);\r\n    }\r\n  }\r\n};\r\n","import { createSelector } from \"reselect\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport {\r\n  linePointIntercept,\r\n  magnitude,\r\n  normalize,\r\n  Point,\r\n  pointAdd,\r\n  pointEquals,\r\n  pointSubtract,\r\n  scale,\r\n  snapValue,\r\n  ZeroPoint,\r\n} from \"@/geometry\";\r\nimport { immutableEmptyArray } from \"@/arrays\";\r\n\r\nimport {\r\n  elementPinPositionFromElementPinSelector,\r\n  elementPinPositionsByPinIdByElementIdSelector,\r\n} from \"@/services/circuit-layout/selectors/element-pin-positions\";\r\nimport { circuitIdForEditorIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\nimport { elementIdsFromCircuitIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport {\r\n  ElementPin,\r\n  JointWireConnectTarget,\r\n  SegmentWireConnectTarget,\r\n  WireConnectTarget,\r\n} from \"@/services/circuit-graph/types\";\r\nimport {\r\n  endPositionForWireSegmentId,\r\n  startPositionForWireSegmentId,\r\n  wireJointPositionFromJointIdSelector,\r\n} from \"@/services/circuit-graph/selectors/wire-positions\";\r\nimport {\r\n  wireIdsFromCircuitIdSelector,\r\n  wireJointIdsFromWireIdSelector,\r\n  wireSegmentIdsFromWireIdSelector,\r\n} from \"@/services/circuit-graph/selectors/wires\";\r\n\r\nimport { applyGridJointSnapSelector, gridJointSnapSelector } from \"./snap\";\r\n\r\nfunction elementPinFromPoint(\r\n  state: AppState,\r\n  circuitId: string,\r\n  point: Point\r\n): ElementPin | null {\r\n  const pinPositionsByPinIdByElementId = elementPinPositionsByPinIdByElementIdSelector(\r\n    state\r\n  );\r\n  const elementIds = elementIdsFromCircuitIdSelector(state, circuitId);\r\n  if (!elementIds) {\r\n    return null;\r\n  }\r\n\r\n  for (const elementId of elementIds) {\r\n    const pinPositionsByPinId =\r\n      pinPositionsByPinIdByElementId[elementId] ?? ZeroPoint;\r\n    const pinIds = Object.keys(pinPositionsByPinId);\r\n    for (const pinId of pinIds) {\r\n      const pinPosition = pinPositionsByPinId[pinId];\r\n      const offset = pointSubtract(point, pinPosition);\r\n      const length = magnitude(offset);\r\n      if (length > 6) {\r\n        continue;\r\n      }\r\n\r\n      return { elementId, pinId };\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\nfunction wireJointFromPoint(\r\n  state: AppState,\r\n  circuitId: string,\r\n  p: Point\r\n): JointWireConnectTarget | null {\r\n  const wireIds = wireIdsFromCircuitIdSelector(state, circuitId);\r\n  for (const wireId of wireIds) {\r\n    const jointIds = wireJointIdsFromWireIdSelector(state, wireId);\r\n    for (const jointId of jointIds) {\r\n      const jointPos = wireJointPositionFromJointIdSelector(state, jointId);\r\n      if (magnitude(pointSubtract(p, jointPos)) > 4) {\r\n        continue;\r\n      }\r\n\r\n      return {\r\n        type: \"joint\",\r\n        jointId,\r\n      };\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction wireSegmentFromPoint(\r\n  state: AppState,\r\n  circuitId: string,\r\n  p: Point,\r\n  snapToGrid: boolean\r\n): SegmentWireConnectTarget | null {\r\n  const snap = gridJointSnapSelector(state);\r\n  const wireIds = wireIdsFromCircuitIdSelector(state, circuitId);\r\n  for (const wireId of wireIds) {\r\n    const segmentIds = wireSegmentIdsFromWireIdSelector(state, wireId);\r\n    for (const segmentId of segmentIds) {\r\n      const startPos = startPositionForWireSegmentId(state, segmentId);\r\n      const endPos = endPositionForWireSegmentId(state, segmentId);\r\n\r\n      const intercept = linePointIntercept(startPos, endPos, p, {\r\n        axialGridSnap: snapToGrid ? snap : undefined,\r\n      });\r\n      if (!intercept) {\r\n        continue;\r\n      }\r\n\r\n      return {\r\n        type: \"segment\",\r\n        segmentId,\r\n        segmentInsertLength: intercept.interceptLineLengthDistance,\r\n      };\r\n    }\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction getDragTargetPoint(\r\n  state: AppState,\r\n  target: WireConnectTarget\r\n): Point | null {\r\n  switch (target.type) {\r\n    case \"floating\":\r\n      return target.point;\r\n    case \"pin\":\r\n      return elementPinPositionFromElementPinSelector(\r\n        state,\r\n        target.pin.elementId,\r\n        target.pin.pinId\r\n      );\r\n    case \"segment\": {\r\n      const { segmentId, segmentInsertLength } = target;\r\n      const startPos = startPositionForWireSegmentId(state, segmentId);\r\n      const endPos = endPositionForWireSegmentId(state, segmentId);\r\n      const lineVector = normalize(pointSubtract(endPos, startPos));\r\n      const fracPos = pointAdd(\r\n        startPos,\r\n        scale(lineVector, segmentInsertLength)\r\n      );\r\n      return fracPos;\r\n    }\r\n    case \"joint\":\r\n      return wireJointPositionFromJointIdSelector(state, target.jointId);\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\n/**\r\n * Gets the drag target at the given point.\r\n *\r\n * WARN: Not react safe.\r\n */\r\nexport const dragWireEndTargetByPointSelector = (\r\n  state: AppState,\r\n  p: Point\r\n): WireConnectTarget | null => {\r\n  const dragService = state.services.circuitEditorDrag;\r\n  if (dragService.dragMode !== \"wire\") {\r\n    return null;\r\n  }\r\n\r\n  const { dragStartEditorId, dragModifierKeys } = dragService;\r\n  const snapToGrid = !dragModifierKeys.ctrlMetaKey;\r\n  const circuitId = circuitIdForEditorIdSelector(state, dragStartEditorId);\r\n  if (!circuitId) {\r\n    return null;\r\n  }\r\n\r\n  const targetPin = elementPinFromPoint(state, circuitId, p);\r\n  if (targetPin) {\r\n    return {\r\n      type: \"pin\",\r\n      pin: targetPin,\r\n    };\r\n  }\r\n\r\n  const jointTarget = wireJointFromPoint(state, circuitId, p);\r\n  if (jointTarget) {\r\n    return jointTarget;\r\n  }\r\n\r\n  const segmentTarget = wireSegmentFromPoint(state, circuitId, p, snapToGrid);\r\n  if (segmentTarget) {\r\n    return segmentTarget;\r\n  }\r\n\r\n  const snap = gridJointSnapSelector(state);\r\n  if (!dragModifierKeys.shiftKey) {\r\n    // Restrict to ordinals\r\n    const startPos = dragWireSegmentStartPositionSelector(state);\r\n    if (startPos) {\r\n      const lineVector = normalize(pointSubtract(p, startPos));\r\n      if (Math.abs(lineVector.x) >= 0.5) {\r\n        p = {\r\n          x: snapToGrid ? snapValue(p.x, snap) : p.x,\r\n          y: startPos.y,\r\n        };\r\n      } else {\r\n        p = {\r\n          x: startPos.x,\r\n          y: snapToGrid ? snapValue(p.y, snap) : p.y,\r\n        };\r\n      }\r\n    }\r\n  } else if (snapToGrid) {\r\n    p = applyGridJointSnapSelector(state, p);\r\n  }\r\n\r\n  return {\r\n    type: \"floating\",\r\n    point: p,\r\n  };\r\n};\r\n\r\n// This is called many times in a single render pass, so we cache it by root state.\r\n// We need the root state, as lots of data is involved in finding the target point.  This is mainly\r\n// due to needing to calculate pin positions, which requires element definitions.\r\n// This could be more aggressively cached, but it is only heavy to calculate when dragging a wire,\r\n// and it invalidates every mouse move.\r\nexport const dragWireEndTargetSelector = createSelector(\r\n  (state: AppState) => state,\r\n  (state: AppState): WireConnectTarget | null => {\r\n    const dragService = state.services.circuitEditorDrag;\r\n    if (dragService.dragMode !== \"wire\") {\r\n      return null;\r\n    }\r\n\r\n    const { dragEnd } = dragService;\r\n    if (!dragEnd) {\r\n      return null;\r\n    }\r\n\r\n    return dragWireEndTargetByPointSelector(state, dragEnd);\r\n  }\r\n);\r\n\r\nlet dragWireSegmentStartPositionCache: Point = ZeroPoint;\r\nexport const dragWireSegmentStartPositionSelector = (state: AppState) => {\r\n  const dragService = state.services.circuitEditorDrag;\r\n  if (dragService.dragMode !== \"wire\") {\r\n    return null;\r\n  }\r\n\r\n  const pt = getDragTargetPoint(state, dragService.dragStartTarget);\r\n  if (!pt) {\r\n    return null;\r\n  }\r\n\r\n  if (!pointEquals(pt, dragWireSegmentStartPositionCache)) {\r\n    dragWireSegmentStartPositionCache = pt;\r\n  }\r\n\r\n  return dragWireSegmentStartPositionCache;\r\n};\r\n\r\nlet dragWireSegmentEndPositionCache: Point = ZeroPoint;\r\nexport const dragWireSegmentEndPositionSelector = (state: AppState) => {\r\n  const endTarget = dragWireEndTargetSelector(state);\r\n  if (!endTarget) {\r\n    return null;\r\n  }\r\n\r\n  const pt = getDragTargetPoint(state, endTarget);\r\n  if (!pt) {\r\n    return null;\r\n  }\r\n\r\n  if (!pointEquals(pt, dragWireSegmentEndPositionCache)) {\r\n    dragWireSegmentEndPositionCache = pt;\r\n  }\r\n\r\n  return dragWireSegmentEndPositionCache;\r\n};\r\n\r\nexport const isPinDragWireTarget = (\r\n  state: AppState,\r\n  elementId: string,\r\n  pinId: string\r\n) => {\r\n  const endTarget = dragWireEndTargetSelector(state);\r\n  if (!endTarget) {\r\n    return false;\r\n  }\r\n\r\n  return (\r\n    endTarget.type === \"pin\" &&\r\n    endTarget.pin.elementId === elementId &&\r\n    endTarget.pin.pinId === pinId\r\n  );\r\n};\r\n\r\nexport const isJointDragWireTarget = (state: AppState, jointId: string) => {\r\n  const endTarget = dragWireEndTargetSelector(state);\r\n  if (!endTarget) {\r\n    return false;\r\n  }\r\n\r\n  return endTarget.type === \"joint\" && endTarget.jointId === jointId;\r\n};\r\n\r\nexport const segmentDragWireTargetOffset = (\r\n  state: AppState,\r\n  segmentId: string\r\n): number | null => {\r\n  const endTarget = dragWireEndTargetSelector(state);\r\n  if (!endTarget) {\r\n    return null;\r\n  }\r\n\r\n  if (endTarget.type !== \"segment\" || endTarget.segmentId !== segmentId) {\r\n    return null;\r\n  }\r\n\r\n  return endTarget.segmentInsertLength;\r\n};\r\n\r\nexport const dragWireJointPositionSelector = (state: AppState) => {\r\n  const dragService = state.services.circuitEditorDrag;\r\n  if (dragService.dragMode !== \"wire-segment-new-joint\") {\r\n    return null;\r\n  }\r\n\r\n  let dragEnd = dragService.dragEnd;\r\n  if (!dragEnd) {\r\n    return null;\r\n  }\r\n\r\n  if (!dragService.dragModifierKeys.ctrlMetaKey) {\r\n    dragEnd = applyGridJointSnapSelector(state, dragEnd);\r\n  }\r\n\r\n  return dragEnd;\r\n};\r\n\r\nexport const dragJointGhostLinesSelector = (\r\n  state: AppState\r\n): [start: Point, end: Point][] => {\r\n  const dragService = state.services.circuitEditorDrag;\r\n  if (dragService.dragMode !== \"wire-segment-new-joint\") {\r\n    return immutableEmptyArray<[Point, Point]>();\r\n  }\r\n\r\n  const { dragWireSegmentId } = dragService;\r\n  const jointPosition = dragWireJointPositionSelector(state);\r\n  if (!dragWireSegmentId || !jointPosition) {\r\n    return immutableEmptyArray<[Point, Point]>();\r\n  }\r\n\r\n  const startPos = startPositionForWireSegmentId(state, dragWireSegmentId);\r\n  const endPos = endPositionForWireSegmentId(state, dragWireSegmentId);\r\n  if (!startPos || !endPos) {\r\n    return immutableEmptyArray<[Point, Point]>();\r\n  }\r\n\r\n  return [\r\n    [startPos, jointPosition],\r\n    [jointPosition, endPos],\r\n  ];\r\n};\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\nimport { ModifierKeys } from \"@/modifier-keys\";\r\n\r\nexport const ACTION_CIRCUIT_EDITOR_DRAG_START_ELEMENT = \"@field/drag/start/element\" as const;\r\nexport const circuitEditorDragStartElement = (\r\n  elementId: string,\r\n  p: Point,\r\n  modifierKeys: ModifierKeys,\r\n  editorId: string\r\n) => ({\r\n  type: ACTION_CIRCUIT_EDITOR_DRAG_START_ELEMENT,\r\n  payload: {\r\n    ...p,\r\n    elementId,\r\n    modifierKeys,\r\n    editorId,\r\n  },\r\n});\r\nexport type CircuitEditorDragStartElementAction = ReturnType<\r\n  typeof circuitEditorDragStartElement\r\n>;\r\nexport function isCircuitEditorDragStartElementAction(\r\n  action: AnyAction\r\n): action is CircuitEditorDragStartElementAction {\r\n  return action.type === ACTION_CIRCUIT_EDITOR_DRAG_START_ELEMENT;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { SelectionMode } from \"@/selection-mode\";\r\n\r\nexport const ACTION_SELECT_ELEMENTS = \"@select/elements\" as const;\r\nexport const selectElements = (\r\n  elementId: string | string[],\r\n  mode: SelectionMode = \"set\"\r\n) => ({\r\n  type: ACTION_SELECT_ELEMENTS,\r\n  payload: {\r\n    elementIds: Array.isArray(elementId) ? elementId : [elementId],\r\n    mode,\r\n  },\r\n});\r\nexport type SelectElementsAction = ReturnType<typeof selectElements>;\r\nexport function isSelectElementsAction(\r\n  action: AnyAction\r\n): action is SelectElementsAction {\r\n  return action.type === ACTION_SELECT_ELEMENTS;\r\n}\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createSelectionReducer = createServiceReducerCreator(\"selection\");\r\nexport const createSelectionSelector = createServiceSelectorCreator(\r\n  \"selection\"\r\n);\r\n","import { createSelector } from \"reselect\";\r\n\r\nimport pick from \"lodash/pick\";\r\n\r\nimport { elementsByElementIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\n\r\nimport { createSelectionSelector } from \"../utils\";\r\nimport { SelectionServiceState } from \"../state\";\r\n\r\nexport const selectedElementIdsSelector = createSelectionSelector(\r\n  (state) => state.selectedElementIds\r\n);\r\n\r\nexport const selectedJointIdsSelector = createSelectionSelector(\r\n  (state) => state.selectedWireJointIds\r\n);\r\n\r\nexport const isElementSelectedFromElementIdSelector = createSelectionSelector(\r\n  (s: SelectionServiceState, elementId: string) =>\r\n    s.selectedElementIds.indexOf(elementId) !== -1\r\n);\r\n\r\nexport const isJointSelectedFromJointIdSelector = createSelectionSelector(\r\n  (s: SelectionServiceState, jointId: string) =>\r\n    s.selectedWireJointIds.indexOf(jointId) !== -1\r\n);\r\n\r\nexport const isSegmentSelectedFromSegmentIdSelector = createSelectionSelector(\r\n  (s: SelectionServiceState, wireSegmentId: string) =>\r\n    s.selectedWireSegmentIds.indexOf(wireSegmentId) !== -1\r\n);\r\n\r\nexport const selectedElementsByIdSelector = createSelector(\r\n  elementsByElementIdSelector,\r\n  selectedElementIdsSelector,\r\n  (elementsById, selectedElementIds) => pick(elementsById, selectedElementIds)\r\n);\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\nimport { ModifierKeys } from \"@/modifier-keys\";\r\n\r\nexport const ACTION_CIRCUIT_EDITOR_DRAG_START_SELECT = \"@circuit-editor/drag/start/select\" as const;\r\nexport const circuitEditorDragStartSelect = (\r\n  p: Point,\r\n  modifierKeys: ModifierKeys,\r\n  editorId: string\r\n) => ({\r\n  type: ACTION_CIRCUIT_EDITOR_DRAG_START_SELECT,\r\n  payload: {\r\n    ...p,\r\n    modifierKeys,\r\n    editorId,\r\n  },\r\n});\r\nexport type CircuitEditorDragStartSelectAction = ReturnType<\r\n  typeof circuitEditorDragStartSelect\r\n>;\r\nexport function isCircuitEditorDragStartSelectAction(\r\n  action: AnyAction\r\n): action is CircuitEditorDragStartSelectAction {\r\n  return action.type === ACTION_CIRCUIT_EDITOR_DRAG_START_SELECT;\r\n}\r\n","import { isCircuitEditorDragStartSelectAction } from \"@/actions/circuit-editor-drag-start-select\";\r\n\r\nimport { createCircuitEditorDragReducer } from \"../utils\";\r\n\r\nexport default createCircuitEditorDragReducer((state, action) => {\r\n  if (!isCircuitEditorDragStartSelectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { x, y, modifierKeys, editorId } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    dragMode: \"select\",\r\n    dragStart: {\r\n      x,\r\n      y,\r\n    },\r\n    dragStartEditorId: editorId,\r\n    dragModifierKeys: modifierKeys,\r\n    dragEnd: null,\r\n    dragEndEditorId: null,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\nimport { ModifierKeys } from \"@/modifier-keys\";\r\n\r\nexport const ACTION_CIRCUIT_EDITOR_DRAG_START_WIRE_JOINT = \"@circuit-editor/drag/start/wire-joint\" as const;\r\nexport const circuitEditorDragStartWireJoint = (\r\n  p: Point,\r\n  wireId: string,\r\n  jointId: string,\r\n  modifierKeys: ModifierKeys,\r\n  editorId: string\r\n) => ({\r\n  type: ACTION_CIRCUIT_EDITOR_DRAG_START_WIRE_JOINT,\r\n  payload: {\r\n    ...p,\r\n    wireId,\r\n    jointId,\r\n    modifierKeys,\r\n    editorId,\r\n  },\r\n});\r\nexport type CircuitEditorDragStartWireJointAction = ReturnType<\r\n  typeof circuitEditorDragStartWireJoint\r\n>;\r\nexport function isCircuitEditorDragStartWireJointAction(\r\n  action: AnyAction\r\n): action is CircuitEditorDragStartWireJointAction {\r\n  return action.type === ACTION_CIRCUIT_EDITOR_DRAG_START_WIRE_JOINT;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { SelectionMode } from \"@/selection-mode\";\r\n\r\nexport const ACTION_SELECT_WIRE_JOINTS = \"@select/wire-joints\" as const;\r\nexport const selectWireJoints = (\r\n  jointId: string | string[],\r\n  mode: SelectionMode = \"set\"\r\n) => ({\r\n  type: ACTION_SELECT_WIRE_JOINTS,\r\n  payload: {\r\n    jointIds: Array.isArray(jointId) ? jointId : [jointId],\r\n    mode,\r\n  },\r\n});\r\nexport type SelectWireJointsAction = ReturnType<typeof selectWireJoints>;\r\nexport function isSelectWireJointsAction(\r\n  action: AnyAction\r\n): action is SelectWireJointsAction {\r\n  return action.type === ACTION_SELECT_WIRE_JOINTS;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\nimport { ModifierKeys } from \"@/modifier-keys\";\r\n\r\nexport const CIRCUIT_EDITOR_DRAG_START_WIRE_SEGMENT_ACTION = \"@circuit-editor/drag/start/wire-segment\" as const;\r\nexport const circuitEditorDragStartWireSegment = (\r\n  p: Point,\r\n  wireId: string,\r\n  wireSegmentId: string,\r\n  modifierKeys: ModifierKeys,\r\n  editorId: string\r\n) => ({\r\n  type: CIRCUIT_EDITOR_DRAG_START_WIRE_SEGMENT_ACTION,\r\n  payload: {\r\n    ...p,\r\n    wireId,\r\n    wireSegmentId,\r\n    modifierKeys,\r\n    editorId,\r\n  },\r\n});\r\nexport type CircuitEditorDragStartWireSegmentAction = ReturnType<\r\n  typeof circuitEditorDragStartWireSegment\r\n>;\r\nexport function isCircuitEditorDragStartWireSegmentAction(\r\n  action: AnyAction\r\n): action is CircuitEditorDragStartWireSegmentAction {\r\n  return action.type === CIRCUIT_EDITOR_DRAG_START_WIRE_SEGMENT_ACTION;\r\n}\r\n","import { dotProduct, normalize, pointSubtract } from \"@/geometry\";\r\n\r\nimport { isCircuitEditorDragStartWireSegmentAction } from \"@/actions/circuit-editor-drag-start-wire-segment\";\r\n\r\nimport {\r\n  endPositionForWireSegmentId,\r\n  startPositionForWireSegmentId,\r\n} from \"@/services/circuit-graph/selectors/wire-positions\";\r\n\r\nimport { createCircuitEditorDragReducer } from \"../utils\";\r\nimport { applyGridJointSnapSelector } from \"../selectors/snap\";\r\n\r\nexport default createCircuitEditorDragReducer((state, action, rootState) => {\r\n  if (!isCircuitEditorDragStartWireSegmentAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const {\r\n    x,\r\n    y,\r\n    editorId,\r\n    modifierKeys,\r\n    wireId,\r\n    wireSegmentId,\r\n  } = action.payload;\r\n\r\n  const dragStart = applyGridJointSnapSelector(rootState, { x, y });\r\n\r\n  if (modifierKeys.ctrlMetaKey) {\r\n    const startPos = startPositionForWireSegmentId(rootState, wireSegmentId);\r\n    const endPos = endPositionForWireSegmentId(rootState, wireSegmentId);\r\n    const lineVector = normalize(pointSubtract(endPos, startPos));\r\n    const v = pointSubtract(dragStart, startPos);\r\n    const segmentInsertLength = dotProduct(v, lineVector);\r\n\r\n    return {\r\n      dragMode: \"wire\",\r\n      dragStart,\r\n      dragStartEditorId: editorId,\r\n      dragModifierKeys: modifierKeys,\r\n      dragStartTarget: {\r\n        type: \"segment\",\r\n        segmentId: wireSegmentId,\r\n        segmentInsertLength,\r\n      },\r\n      dragEnd: null,\r\n      dragEndEditorId: null,\r\n    };\r\n  }\r\n\r\n  return {\r\n    dragMode: \"wire-segment-new-joint\",\r\n    dragStart,\r\n    dragStartEditorId: editorId,\r\n    dragModifierKeys: modifierKeys,\r\n    dragWireId: wireId,\r\n    dragWireSegmentId: wireSegmentId,\r\n    dragEnd: null,\r\n    dragEndEditorId: null,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\nimport { ModifierKeys } from \"@/modifier-keys\";\r\nimport { WireConnectTarget } from \"@/services/circuit-graph/types\";\r\n\r\nexport const CIRCUIT_EDITOR_DRAG_START_WIRE_ACTION = \"@circuit-editor/drag/start/wire\" as const;\r\nexport const circuitEditorDragStartWire = (\r\n  p: Point,\r\n  target: WireConnectTarget,\r\n  modifierKeys: ModifierKeys,\r\n  editorId: string\r\n) => ({\r\n  type: CIRCUIT_EDITOR_DRAG_START_WIRE_ACTION,\r\n  payload: {\r\n    ...p,\r\n    target,\r\n    modifierKeys,\r\n    editorId,\r\n  },\r\n});\r\nexport type CircuitEditorDragStartWireAction = ReturnType<\r\n  typeof circuitEditorDragStartWire\r\n>;\r\nexport function isCircuitEditorDragStartWireAction(\r\n  action: AnyAction\r\n): action is CircuitEditorDragStartWireAction {\r\n  return action.type === CIRCUIT_EDITOR_DRAG_START_WIRE_ACTION;\r\n}\r\n","import { isCircuitEditorDragStartWireAction } from \"@/actions/circuit-editor-drag-start-wire\";\r\n\r\nimport { createCircuitEditorDragReducer } from \"../utils\";\r\n\r\nexport default createCircuitEditorDragReducer((state, action) => {\r\n  if (!isCircuitEditorDragStartWireAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { x, y, target, editorId, modifierKeys } = action.payload;\r\n\r\n  return {\r\n    dragMode: \"wire\",\r\n    dragStartEditorId: editorId,\r\n    dragStart: { x, y },\r\n    dragStartTarget: target,\r\n    dragModifierKeys: modifierKeys,\r\n    dragEndEditorId: null,\r\n    dragEnd: null,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_CIRCUIT_EDITOR_MOUSE_LEAVE = \"@circuit-editor/mouse/leave\" as const;\r\nexport const circuitEditorMouseLeave = () => ({\r\n  type: ACTION_CIRCUIT_EDITOR_MOUSE_LEAVE,\r\n});\r\nexport type CircuitEditorMouseLeaveAction = ReturnType<\r\n  typeof circuitEditorMouseLeave\r\n>;\r\nexport function isCircuitEditorMouseLeaveAction(\r\n  action: AnyAction\r\n): action is CircuitEditorMouseLeaveAction {\r\n  return action.type === ACTION_CIRCUIT_EDITOR_MOUSE_LEAVE;\r\n}\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport dragAbortReducer from \"./drag-abort\";\r\nimport dragContinueReducer from \"./drag-continue\";\r\nimport dragEndReducer from \"./drag-end\";\r\nimport dragStartElementReducer from \"./drag-start-element\";\r\nimport dragStartSelectReducer from \"./drag-start-select\";\r\nimport dragStartWireJointReducer from \"./drag-start-wire-joint\";\r\nimport dragStartWireSegmentReducer from \"./drag-start-wire-segment\";\r\nimport dragStartWireReducer from \"./drag-start-wire\";\r\nimport mouseLeaveReducer from \"./mouse-leave\";\r\n\r\nexport default concatReducers(\r\n  dragAbortReducer,\r\n  dragContinueReducer,\r\n  dragEndReducer,\r\n  dragStartElementReducer,\r\n  dragStartSelectReducer,\r\n  dragStartWireJointReducer,\r\n  dragStartWireSegmentReducer,\r\n  dragStartWireReducer,\r\n  mouseLeaveReducer\r\n);\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { normalizeRectangle, pointSubtract } from \"@/geometry\";\r\nimport { fpSet } from \"@/utils\";\r\nimport { getSelectMode } from \"@/selection-mode\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport {\r\n  CircuitEditorDragEndAction,\r\n  isCircuitEditorDragEndAction,\r\n} from \"@/actions/circuit-editor-drag-end\";\r\nimport { selectRegion } from \"@/actions/select-region\";\r\nimport { moveSelection } from \"@/actions/selection-move\";\r\nimport { wireSegmentInsertJoint } from \"@/actions/wire-segment-insert-joint\";\r\nimport { wireConnect } from \"@/actions/wire-connect\";\r\n\r\nimport { circuitIdForEditorIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\n\r\nimport { defaultCircuitEditorDragServiceState } from \"../state\";\r\n\r\nimport {\r\n  applyGridJointSnapSelector,\r\n  applyGridElementSnapSelector,\r\n} from \"../selectors/snap\";\r\nimport { dragWireEndTargetByPointSelector } from \"../selectors/drag-wire\";\r\n\r\nexport default function dragEndReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n) {\r\n  if (!isCircuitEditorDragEndAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  state = executeDragMode(state, action);\r\n\r\n  state = fpSet(\r\n    state,\r\n    \"services\",\r\n    \"circuitEditorDrag\",\r\n    defaultCircuitEditorDragServiceState\r\n  );\r\n\r\n  return state;\r\n}\r\n\r\nfunction executeDragMode(\r\n  state: AppState,\r\n  action: CircuitEditorDragEndAction\r\n): AppState {\r\n  const { dragMode } = state.services.circuitEditorDrag;\r\n\r\n  switch (dragMode) {\r\n    case \"select\":\r\n      return executeSelectDrag(state, action);\r\n    case \"move\":\r\n      return executeMoveDrag(state, action);\r\n    case \"wire\":\r\n      return executeWireDrag(state, action);\r\n    case \"wire-segment-new-joint\":\r\n      return executeWireNewJointDrag(state, action);\r\n  }\r\n\r\n  return state;\r\n}\r\n\r\nfunction executeSelectDrag(\r\n  state: AppState,\r\n  action: CircuitEditorDragEndAction\r\n): AppState {\r\n  const dragState = state.services.circuitEditorDrag;\r\n  if (dragState.dragMode !== \"select\") {\r\n    return state;\r\n  }\r\n\r\n  const { dragStartEditorId, dragEndEditorId } = dragState;\r\n  if (dragStartEditorId != dragEndEditorId) {\r\n    return state;\r\n  }\r\n\r\n  const { dragModifierKeys, dragStart } = dragState;\r\n  const { x, y } = action.payload;\r\n\r\n  const circuitId = circuitIdForEditorIdSelector(state, dragStartEditorId);\r\n  if (!circuitId) {\r\n    return state;\r\n  }\r\n\r\n  const selectionMode = getSelectMode(dragModifierKeys);\r\n  const rect = normalizeRectangle(dragStart, { x, y });\r\n  return rootReducer(state, selectRegion(rect, circuitId, selectionMode));\r\n}\r\n\r\nfunction executeMoveDrag(\r\n  state: AppState,\r\n  action: CircuitEditorDragEndAction\r\n): AppState {\r\n  const dragState = state.services.circuitEditorDrag;\r\n  if (dragState.dragMode !== \"move\") {\r\n    return state;\r\n  }\r\n\r\n  const { dragStartEditorId, dragEndEditorId } = dragState;\r\n  if (dragStartEditorId != dragEndEditorId) {\r\n    return state;\r\n  }\r\n\r\n  const { dragStart, dragModifierKeys } = dragState;\r\n  const { x, y } = action.payload;\r\n\r\n  let moveBy = pointSubtract({ x, y }, dragStart);\r\n  const hasElements = state.services.selection.selectedElementIds.length > 0;\r\n\r\n  if (!dragModifierKeys.ctrlMetaKey) {\r\n    // We apply the snap here because we want to snap the offset, not the resulting positions.\r\n    // Applying the snap in moveSelection can result in different objects moving different distances\r\n    // depending on their snap.\r\n    if (hasElements) {\r\n      moveBy = applyGridElementSnapSelector(state, moveBy);\r\n    } else {\r\n      moveBy = applyGridJointSnapSelector(state, moveBy);\r\n    }\r\n  }\r\n\r\n  return rootReducer(state, moveSelection(moveBy.x, moveBy.y));\r\n}\r\n\r\nfunction executeWireDrag(\r\n  state: AppState,\r\n  action: CircuitEditorDragEndAction\r\n): AppState {\r\n  const dragState = state.services.circuitEditorDrag;\r\n  if (dragState.dragMode !== \"wire\") {\r\n    return state;\r\n  }\r\n\r\n  const { dragStartEditorId, dragEndEditorId } = dragState;\r\n  if (dragStartEditorId != dragEndEditorId) {\r\n    return state;\r\n  }\r\n\r\n  const circuitId = circuitIdForEditorIdSelector(state, dragStartEditorId);\r\n  if (!circuitId) {\r\n    return state;\r\n  }\r\n\r\n  const { dragStartTarget } = dragState;\r\n  const { x, y } = action.payload;\r\n  const dragEndTarget = dragWireEndTargetByPointSelector(state, { x, y });\r\n  if (!dragEndTarget) {\r\n    return state;\r\n  }\r\n\r\n  return rootReducer(\r\n    state,\r\n    wireConnect(circuitId, dragStartTarget, dragEndTarget)\r\n  );\r\n}\r\n\r\nfunction executeWireNewJointDrag(\r\n  state: AppState,\r\n  action: CircuitEditorDragEndAction\r\n): AppState {\r\n  const dragState = state.services.circuitEditorDrag;\r\n  if (dragState.dragMode !== \"wire-segment-new-joint\") {\r\n    return state;\r\n  }\r\n\r\n  const { dragStartEditorId, dragEndEditorId } = dragState;\r\n  if (dragStartEditorId != dragEndEditorId) {\r\n    return state;\r\n  }\r\n\r\n  const { dragWireId, dragWireSegmentId } = dragState;\r\n  const { x, y } = action.payload;\r\n\r\n  return rootReducer(\r\n    state,\r\n    wireSegmentInsertJoint(dragWireId, dragWireSegmentId, { x, y })\r\n  );\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { fpSet } from \"@/utils\";\r\nimport { getSelectMode } from \"@/selection-mode\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { isCircuitEditorDragStartElementAction } from \"@/actions/circuit-editor-drag-start-element\";\r\nimport { selectElements } from \"@/actions/select-elements\";\r\n\r\nimport { isElementSelectedFromElementIdSelector } from \"@/services/selection/selectors/selection\";\r\n\r\nexport default function dragStartNodeReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n) {\r\n  if (!isCircuitEditorDragStartElementAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { elementId, x, y, modifierKeys, editorId } = action.payload;\r\n\r\n  state = fpSet(state, \"services\", \"circuitEditorDrag\", () => ({\r\n    dragMode: \"move\" as const,\r\n    dragStart: {\r\n      x,\r\n      y,\r\n    },\r\n    dragStartEditorId: editorId,\r\n    dragModifierKeys: modifierKeys,\r\n    dragEnd: null,\r\n    dragEndEditorId: null,\r\n  }));\r\n\r\n  if (!isElementSelectedFromElementIdSelector(state, elementId)) {\r\n    const selectionMode = getSelectMode(modifierKeys);\r\n    // Dragging an element that was not previously selected.  Perform a selection on the element.\r\n    state = rootReducer(state, selectElements(elementId, selectionMode));\r\n  }\r\n\r\n  return state;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { getSelectMode } from \"@/selection-mode\";\r\nimport { fpSet } from \"@/utils\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { isJointSelectedFromJointIdSelector } from \"@/services/selection/selectors/selection\";\r\n\r\nimport { isCircuitEditorDragStartWireJointAction } from \"@/actions/circuit-editor-drag-start-wire-joint\";\r\nimport { selectWireJoints } from \"@/actions/select-wire-joints\";\r\n\r\nexport default (state: AppState = defaultAppState, action: AnyAction) => {\r\n  if (!isCircuitEditorDragStartWireJointAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { x, y, editorId, wireId, jointId, modifierKeys } = action.payload;\r\n\r\n  if (modifierKeys.ctrlMetaKey) {\r\n    state = fpSet(state, \"services\", \"circuitEditorDrag\", () => ({\r\n      dragMode: \"wire\" as const,\r\n      dragStart: { x, y },\r\n      dragStartEditorId: editorId,\r\n      dragStartTarget: {\r\n        type: \"joint\" as const,\r\n        wireId,\r\n        jointId,\r\n      },\r\n      dragModifierKeys: modifierKeys,\r\n      dragEnd: null,\r\n      dragEndEditorId: null,\r\n    }));\r\n  } else {\r\n    state = fpSet(state, \"services\", \"circuitEditorDrag\", () => ({\r\n      dragMode: \"move\" as const,\r\n      dragStart: { x, y },\r\n      dragStartEditorId: editorId,\r\n      dragModifierKeys: modifierKeys,\r\n      dragEnd: null,\r\n      dragEndEditorId: null,\r\n    }));\r\n\r\n    if (!isJointSelectedFromJointIdSelector(state, jointId)) {\r\n      const selectionMode = getSelectMode(modifierKeys);\r\n      // Dragging an element that was not previously selected.  Perform a selection on the element.\r\n      state = rootReducer(state, selectWireJoints(jointId, selectionMode));\r\n    }\r\n  }\r\n\r\n  return state;\r\n};\r\n","import { isCircuitEditorMouseLeaveAction } from \"@/actions/circuit-editor-mouse-leave\";\r\n\r\nimport { createCircuitEditorDragReducer } from \"../utils\";\r\n\r\nexport default createCircuitEditorDragReducer((state, action) => {\r\n  if (!isCircuitEditorMouseLeaveAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  if (state.dragMode == null) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    dragEnd: null,\r\n  };\r\n});\r\n","import pick from \"lodash/pick\";\r\n\r\nimport { isDeleteCircuitAction } from \"@/actions/circuit-delete\";\r\n\r\nimport { createCircuitEditorsReducer } from \"../utils\";\r\n\r\nexport default createCircuitEditorsReducer((state, action) => {\r\n  if (!isDeleteCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { circuitId } = action.payload;\r\n\r\n  const keepIds = Object.keys(state.circucitEditorsById).filter(\r\n    (id) => state.circucitEditorsById[id].circuitId !== circuitId\r\n  );\r\n\r\n  let activeEditorId = state.activeEditorId;\r\n  if (!activeEditorId || keepIds.indexOf(activeEditorId) === -1) {\r\n    activeEditorId = null;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    circucitEditorsById: pick(state.circucitEditorsById, keepIds),\r\n    activeEditorId,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_CIRCUIT_EDITOR_RECEIVE_FOCUS = \"@circuit-editor/receive-focus\" as const;\r\nexport const circuitEditorReceiveFocus = (editorId: string) => ({\r\n  type: ACTION_CIRCUIT_EDITOR_RECEIVE_FOCUS,\r\n  payload: { editorId },\r\n});\r\nexport type CircuitEditorFocusAction = ReturnType<\r\n  typeof circuitEditorReceiveFocus\r\n>;\r\nexport function isCircuitEditorReceiveFocusAction(\r\n  action: AnyAction\r\n): action is CircuitEditorFocusAction {\r\n  return action.type === ACTION_CIRCUIT_EDITOR_RECEIVE_FOCUS;\r\n}\r\n","import { isCircuitEditorReceiveFocusAction } from \"@/actions/circuit-editor-receive-focus\";\r\n\r\nimport { createCircuitEditorsReducer } from \"../utils\";\r\n\r\nexport default createCircuitEditorsReducer((state, action) => {\r\n  if (!isCircuitEditorReceiveFocusAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { editorId } = action.payload;\r\n\r\n  if (Object.keys(state.circucitEditorsById).indexOf(editorId) === -1) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    activeEditorId: editorId,\r\n  };\r\n});\r\n","import { isNewProjectAction } from \"@/actions/project-new\";\r\n\r\nimport { createCircuitEditorsReducer } from \"../utils\";\r\nimport { defaultCircuitEditorServiceState } from \"../state\";\r\n\r\nexport default createCircuitEditorsReducer((state, action) => {\r\n  if (!isNewProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultCircuitEditorServiceState;\r\n});\r\n","import { AnyAction } from \"redux\";\r\nimport { v4 as uuidV4 } from \"uuid\";\r\n\r\ninterface ViewCircuitOpts {\r\n  newWindow?: boolean;\r\n}\r\nexport const ACTION_VIEW_CIRCUIT = \"@view/circuit\" as const;\r\nexport const viewCircuit = (\r\n  circuitId: string,\r\n  elementIdPath: string[] | null = null,\r\n  opts: ViewCircuitOpts = {}\r\n) => ({\r\n  type: ACTION_VIEW_CIRCUIT,\r\n  payload: {\r\n    circuitId,\r\n    elementIdPath,\r\n    newWindowId: opts.newWindow ? uuidV4() : null,\r\n  },\r\n});\r\nexport type ViewCircuitAction = ReturnType<typeof viewCircuit>;\r\nexport function isViewCircuitAction(\r\n  action: AnyAction\r\n): action is ViewCircuitAction {\r\n  return action.type === ACTION_VIEW_CIRCUIT;\r\n}\r\n","import { circuitIdsSelector } from \"@/services/circuit-properties/selectors/circuits\";\r\n\r\nimport { isViewCircuitAction } from \"@/actions/view-circuit\";\r\n\r\nimport { createCircuitEditorsReducer, findActiveEditorId } from \"../utils\";\r\n\r\nexport default createCircuitEditorsReducer((state, action, appState) => {\r\n  if (!isViewCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { circuitId, elementIdPath, newWindowId } = action.payload;\r\n\r\n  if (circuitIdsSelector(appState).indexOf(circuitId) === -1) {\r\n    return state;\r\n  }\r\n\r\n  let targetWindowId = newWindowId;\r\n  if (!targetWindowId) {\r\n    targetWindowId = findActiveEditorId(state);\r\n  }\r\n\r\n  if (!targetWindowId) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    circucitEditorsById: {\r\n      ...state.circucitEditorsById,\r\n      [targetWindowId]: {\r\n        circuitId,\r\n        elementIdPath: elementIdPath ?? [],\r\n      },\r\n    },\r\n    activeEditorId: targetWindowId,\r\n  };\r\n});\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport circuitDeleteReducer from \"./circuit-delete\";\r\nimport editorFocusReducer from \"./editor-focus\";\r\nimport projectNewReducer from \"./project-new\";\r\nimport viewCircuitReducer from \"./view-circuit\";\r\n\r\nexport default concatReducers(\r\n  circuitDeleteReducer,\r\n  editorFocusReducer,\r\n  projectNewReducer,\r\n  viewCircuitReducer\r\n);\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_COPY_ELEMENTS = \"@clipboard/copy-elements\" as const;\r\nexport const copyElements = (elementId: string | string[]) => ({\r\n  type: ACTION_COPY_ELEMENTS,\r\n  payload: {\r\n    elementIds: Array.isArray(elementId) ? elementId : [elementId],\r\n  },\r\n});\r\nexport type CopyElementsAction = ReturnType<typeof copyElements>;\r\nexport function isCopyElementsAction(\r\n  action: AnyAction\r\n): action is CopyElementsAction {\r\n  return action.type === ACTION_COPY_ELEMENTS;\r\n}\r\n","import { AppState } from \"@/store\";\r\n\r\nimport { elementDefinitionFromTypeSelector } from \"@/services/element-types/selectors/element-types\";\r\n\r\nexport const elementDefinitionFromElementIdSelector = (\r\n  state: AppState,\r\n  elementId: string\r\n) => {\r\n  // Not using the selector here to avoid circular dependencies in imports.\r\n  const elementType =\r\n    state.services.circuitGraph.elementsById[elementId]?.elementType;\r\n  if (!elementType) {\r\n    return null;\r\n  }\r\n\r\n  const def = elementDefinitionFromTypeSelector(state, elementType);\r\n\r\n  return def;\r\n};\r\n","import { AppState } from \"@/store\";\r\n\r\nimport {\r\n  circuitIdFromElementIdSelector,\r\n  elementNameOrDefaultFromElementIdSelector,\r\n} from \"@/services/circuit-graph/selectors/elements\";\r\nimport {\r\n  circuitIdToElementType,\r\n  elementTypeToCircuitId,\r\n} from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nimport { ElementPin } from \"../types\";\r\n\r\nimport { connectionsSelector } from \"./connections\";\r\nimport { elementDefinitionFromElementIdSelector } from \"./element-def\";\r\nimport {\r\n  elementIdsFromTypeSelector,\r\n  elementTypeFromElementIdSelector,\r\n} from \"./elements\";\r\nimport { createCircuitGraphSelector } from \"../utils\";\r\nimport { CircuitGraphServiceState } from \"../state\";\r\n\r\nexport const pinDirectionFromElementPinSelector = (\r\n  state: AppState,\r\n  elementId: string,\r\n  pinId: string\r\n) => {\r\n  const def = elementDefinitionFromElementIdSelector(state, elementId);\r\n  if (!def) {\r\n    return null;\r\n  }\r\n\r\n  const pinDef = def.pins[pinId];\r\n  if (!pinDef) {\r\n    return null;\r\n  }\r\n  return pinDef.direction;\r\n};\r\n\r\n/**\r\n * Gets a map of element input pins to their output sources given an element id.\r\n *\r\n * WARN: Not react safe.  For reducer use only\r\n */\r\nexport const elementOutputSourcesByPinIdFromElementIdSelector = (\r\n  state: AppState,\r\n  elementId: string\r\n) => {\r\n  const connections = connectionsSelector(state);\r\n  const def = elementDefinitionFromElementIdSelector(state, elementId);\r\n\r\n  if (!def) {\r\n    return {};\r\n  }\r\n\r\n  let outputPins: string[] = [];\r\n  outputPins = Object.keys(def.pins).filter(\r\n    (x) => def.pins[x].direction === \"output\"\r\n  );\r\n\r\n  const outputConnections = connections.filter(\r\n    (x) => x.outputPin.elementId === elementId\r\n  );\r\n\r\n  const result: Record<string, ElementPin[]> = {};\r\n  for (const pin of outputPins) {\r\n    result[pin] = [];\r\n  }\r\n\r\n  for (const connection of outputConnections) {\r\n    const { outputPin, inputPin } = connection;\r\n    result[outputPin.pinId].push(inputPin);\r\n  }\r\n\r\n  return result;\r\n};\r\n\r\nexport const elementPinsFromPinElementSelector = (\r\n  state: AppState,\r\n  elementId: string\r\n): ElementPin[] => {\r\n  const elementType = elementTypeFromElementIdSelector(state, elementId);\r\n  if (elementType !== \"pin-input\" && elementType !== \"pin-output\") {\r\n    return [];\r\n  }\r\n\r\n  const circuitId = circuitIdFromElementIdSelector(state, elementId);\r\n  if (!circuitId) {\r\n    return [];\r\n  }\r\n\r\n  const icElementType = circuitIdToElementType(circuitId);\r\n  const icElementIds = elementIdsFromTypeSelector(state, icElementType);\r\n\r\n  return icElementIds.map((icElementId) => ({\r\n    elementId: icElementId,\r\n    pinId: elementId,\r\n  }));\r\n};\r\n\r\nexport const pinNameFromElementPinSelector = createCircuitGraphSelector(\r\n  (state: CircuitGraphServiceState, elementId: string, pinId: string) => {\r\n    const elementType = elementTypeFromElementIdSelector.local(\r\n      state,\r\n      elementId\r\n    );\r\n    const circuitId = elementTypeToCircuitId(elementType);\r\n    if (circuitId) {\r\n      // Pin id is the element id of the pin, look up it's name.\r\n      return elementNameOrDefaultFromElementIdSelector.local(state, pinId);\r\n    }\r\n\r\n    return pinId;\r\n  }\r\n);\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createClipboardReducer = createServiceReducerCreator(\"clipboard\");\r\nexport const createClipboardSelector = createServiceSelectorCreator(\r\n  \"clipboard\"\r\n);\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport clipboardCopyReducer from \"./clipboard-copy\";\r\nimport clipboardPasteReducer from \"./clipboard-paste\";\r\n\r\nconst clipboardReducer = concatReducers(\r\n  clipboardCopyReducer,\r\n  clipboardPasteReducer\r\n);\r\n\r\nexport default clipboardReducer;\r\n","import { v4 as uuidV4 } from \"uuid\";\r\nimport map from \"lodash/map\";\r\nimport mapValues from \"lodash/mapValues\";\r\nimport findIndex from \"lodash/findIndex\";\r\nimport zipObject from \"lodash/zipObject\";\r\n\r\nimport { pointSubtract } from \"@/geometry\";\r\n\r\nimport { isCopyElementsAction } from \"@/actions/clipboard-copy-elements\";\r\n\r\nimport { elementFromElementIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { elementOutputSourcesByPinIdFromElementIdSelector } from \"@/services/circuit-graph/selectors/pins\";\r\nimport { elementPositionsByElementIdSelector } from \"@/services/circuit-layout/selectors/element-positions\";\r\n\r\nimport { ClipboardElement } from \"../types\";\r\nimport { createClipboardReducer } from \"../utils\";\r\n\r\nexport default createClipboardReducer((state, action, appState) => {\r\n  if (!isCopyElementsAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { elementIds } = action.payload;\r\n  if (elementIds.length === 0) {\r\n    return state;\r\n  }\r\n\r\n  const elementPositionsById = elementPositionsByElementIdSelector(appState);\r\n\r\n  const copyIds = zipObject(\r\n    elementIds,\r\n    map(elementIds, () => uuidV4())\r\n  );\r\n\r\n  function elementIsSelected(id: string): boolean {\r\n    return findIndex(elementIds, (x) => x === id) !== -1;\r\n  }\r\n\r\n  const rootPosition = elementPositionsById[elementIds[0]];\r\n\r\n  const copyElements: ClipboardElement[] = elementIds.map((elementId) => {\r\n    const element = elementFromElementIdSelector(appState, elementId);\r\n    const outputs = elementOutputSourcesByPinIdFromElementIdSelector(\r\n      appState,\r\n      elementId\r\n    );\r\n    const copyElement: ClipboardElement = {\r\n      id: copyIds[elementId],\r\n      elementType: element.elementType,\r\n      offset: pointSubtract(elementPositionsById[elementId], rootPosition),\r\n      outputs: mapValues(outputs, (pins) =>\r\n        pins\r\n          .filter((x) => elementIsSelected(x.elementId))\r\n          .map((pin) => {\r\n            return {\r\n              pin: {\r\n                elementId: copyIds[pin.elementId],\r\n                pinId: pin.pinId,\r\n              },\r\n            };\r\n          })\r\n      ),\r\n    };\r\n    return copyElement;\r\n  });\r\n\r\n  return {\r\n    ...state,\r\n    clipboardElements: copyElements,\r\n    clipboardPasteOrigin: rootPosition,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\nimport zipObject from \"lodash/zipObject\";\r\nimport map from \"lodash/map\";\r\nimport values from \"lodash/values\";\r\nimport { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport { pointAdd, snapPoint } from \"@/geometry\";\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport { fpSet } from \"@/utils\";\r\n\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { addElement } from \"@/actions/element-add\";\r\nimport { isPasteAction } from \"@/actions/clipboard-paste\";\r\nimport { wireConnect } from \"@/actions/wire-connect\";\r\nimport { selectElements } from \"@/actions/select-elements\";\r\n\r\nimport { gridElementSnapSelector } from \"@/services/circuit-editor-drag/selectors/snap\";\r\nimport { activeCircuitIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\n\r\nexport default function clipboardPasteReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isPasteAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const circuitId = activeCircuitIdSelector(state);\r\n  if (!circuitId) {\r\n    return state;\r\n  }\r\n\r\n  const { clipboardElements, clipboardPasteOrigin } = state.services.clipboard;\r\n\r\n  if (!clipboardElements.length) {\r\n    return state;\r\n  }\r\n\r\n  let { pastePosition } = action.payload;\r\n\r\n  const gridSnap = gridElementSnapSelector(state);\r\n  if (!pastePosition) {\r\n    pastePosition = pointAdd(clipboardPasteOrigin, {\r\n      x: gridSnap,\r\n      y: gridSnap,\r\n    });\r\n  } else {\r\n    pastePosition = snapPoint(pastePosition, gridSnap);\r\n  }\r\n\r\n  const pasteIds = zipObject(\r\n    clipboardElements.map((x) => x.id),\r\n    map(clipboardElements, () => uuidV4())\r\n  );\r\n\r\n  // Two passes: Create and Connect.\r\n\r\n  // Create the elements.\r\n  for (const element of clipboardElements) {\r\n    const { id, elementType: elementType, offset } = element;\r\n    const p = pointAdd(pastePosition, offset);\r\n    state = rootReducer(\r\n      state,\r\n      addElement(elementType, circuitId, p, { elementId: pasteIds[id] })\r\n    );\r\n  }\r\n\r\n  // Connect the elements\r\n  for (const element of clipboardElements) {\r\n    const { id, outputs } = element;\r\n    const sourceId = pasteIds[id];\r\n    for (const outputPin of Object.keys(outputs)) {\r\n      for (const output of outputs[outputPin]) {\r\n        const {\r\n          pin: { elementId: targetCopyId, pinId: targetPin },\r\n        } = output;\r\n        const targetId = pasteIds[targetCopyId];\r\n        state = rootReducer(\r\n          state,\r\n          wireConnect(\r\n            circuitId,\r\n            {\r\n              type: \"pin\",\r\n              pin: { elementId: sourceId, pinId: outputPin },\r\n            },\r\n            {\r\n              type: \"pin\",\r\n              pin: { elementId: targetId, pinId: targetPin },\r\n            }\r\n          )\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  state = fpSet(\r\n    state,\r\n    \"services\",\r\n    \"clipboard\",\r\n    \"clipboardPasteOrigin\",\r\n    pastePosition\r\n  );\r\n  state = rootReducer(state, selectElements(values(pasteIds)));\r\n\r\n  return state;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_DIALOG_RESPONSE_ACCEPT = \"@dialog/response/accept\" as const;\r\nexport const acceptDialog = (result: any) => ({\r\n  type: ACTION_DIALOG_RESPONSE_ACCEPT,\r\n  payload: { result },\r\n});\r\nexport type AcceptDialogAction = ReturnType<typeof acceptDialog>;\r\nexport function isAcceptDialogAction(\r\n  action: AnyAction\r\n): action is AcceptDialogAction {\r\n  return action.type === ACTION_DIALOG_RESPONSE_ACCEPT;\r\n}\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createDialogReducer = createServiceReducerCreator(\"dialog\");\r\nexport const createDialogSelector = createServiceSelectorCreator(\"dialog\");\r\n","import { isAcceptDialogAction } from \"@/actions/dialog-response-accept\";\r\n\r\nimport { defaultDialogServiceState } from \"../state\";\r\nimport { createDialogReducer } from \"../utils\";\r\n\r\nexport default createDialogReducer((state, action) => {\r\n  if (!isAcceptDialogAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultDialogServiceState;\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_DIALOG_RESPONSE_CANCEL = \"@dialog/response/cancel\" as const;\r\nexport const cancelDialog = () => ({\r\n  type: ACTION_DIALOG_RESPONSE_CANCEL,\r\n});\r\nexport type CancelDialogAction = ReturnType<typeof cancelDialog>;\r\nexport function isCancelDialogAction(\r\n  action: AnyAction\r\n): action is CancelDialogAction {\r\n  return action.type === ACTION_DIALOG_RESPONSE_CANCEL;\r\n}\r\n","import { isCancelDialogAction } from \"@/actions/dialog-response-cancel\";\r\n\r\nimport { defaultDialogServiceState } from \"../state\";\r\nimport { createDialogReducer } from \"../utils\";\r\n\r\nexport default createDialogReducer((state, action) => {\r\n  if (!isCancelDialogAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultDialogServiceState;\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { DialogType } from \"@/dialogs/types\";\r\n\r\nexport const ACTION_DIALOG_SHOW = \"@dialog/show\" as const;\r\nexport const showDialog = (dialogType: DialogType, data: any) => ({\r\n  type: ACTION_DIALOG_SHOW,\r\n  payload: { dialogType, data },\r\n});\r\nexport type ShowDialogAction = ReturnType<typeof showDialog>;\r\nexport function isShowDialogAction(\r\n  action: AnyAction\r\n): action is ShowDialogAction {\r\n  return action.type === ACTION_DIALOG_SHOW;\r\n}\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport dialogResponseAcceptReducer from \"./dialog-response-accept\";\r\nimport dialogResponseCancelReducer from \"./dialog-response-cancel\";\r\nimport dialogShowReducer from \"./dialog-show\";\r\n\r\nexport default concatReducers(\r\n  dialogResponseAcceptReducer,\r\n  dialogResponseCancelReducer,\r\n  dialogShowReducer\r\n);\r\n","import { isShowDialogAction } from \"@/actions/dialog-show\";\r\nimport { createDialogReducer } from \"../utils\";\r\n\r\nexport default createDialogReducer((state, action) => {\r\n  if (!isShowDialogAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { dialogType, data } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    dialogType,\r\n    data,\r\n  };\r\n});\r\n","import { isAddCircuitAction } from \"@/actions/circuit-add\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nexport default createCircuitGraphReducer((state, action) => {\r\n  if (!isAddCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { circuitId } = action.payload;\r\n  return {\r\n    ...state,\r\n    elementIdsByCircuitId: {\r\n      ...state.elementIdsByCircuitId,\r\n      [circuitId]: [],\r\n    },\r\n    wireIdsByCircuitId: {\r\n      ...state.wireIdsByCircuitId,\r\n      [circuitId]: [],\r\n    },\r\n  };\r\n});\r\n","import mapValues from \"lodash/mapValues\";\r\nimport pick from \"lodash/pick\";\r\nimport difference from \"lodash/difference\";\r\n\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\n\r\nexport function wireRemove(\r\n  state: CircuitGraphServiceState,\r\n  wireId: string\r\n): CircuitGraphServiceState {\r\n  const wire = state.wiresByWireId[wireId];\r\n  if (!wire) {\r\n    return state;\r\n  }\r\n\r\n  const { wireSegmentIds, wireJointIds } = wire;\r\n\r\n  return {\r\n    ...state,\r\n    wireIdsByCircuitId: mapValues(state.wireIdsByCircuitId, (wiresInCircuit) =>\r\n      wiresInCircuit.filter((x) => x !== wireId)\r\n    ),\r\n    wireSegmentsById: pick(\r\n      state.wireSegmentsById,\r\n      difference(Object.keys(state.wireSegmentsById), wireSegmentIds)\r\n    ),\r\n    wiresByWireId: pick(\r\n      state.wiresByWireId,\r\n      Object.keys(state.wiresByWireId).filter((x) => x !== wireId)\r\n    ),\r\n    wireJointPositionsByJointId: pick(\r\n      state.wireJointPositionsByJointId,\r\n      difference(Object.keys(state.wireJointPositionsByJointId), wireJointIds)\r\n    ),\r\n  };\r\n}\r\n","export class WireOperationError extends Error {\r\n  constructor(message: string) {\r\n    super(message);\r\n    this.message = message;\r\n    Object.setPrototypeOf(this, new.target.prototype);\r\n  }\r\n}\r\n","import { CircuitGraphServiceState } from \"../../state\";\r\nimport { Wire } from \"../../types\";\r\n\r\nexport function wireCreate(\r\n  state: CircuitGraphServiceState,\r\n  circuitId: string,\r\n  wireId: string,\r\n  wire?: Wire\r\n): CircuitGraphServiceState {\r\n  return {\r\n    ...state,\r\n    wireIdsByCircuitId: {\r\n      ...state.wireIdsByCircuitId,\r\n      [circuitId]: [...state.wireIdsByCircuitId[circuitId], wireId],\r\n    },\r\n    wiresByWireId: {\r\n      ...state.wiresByWireId,\r\n      [wireId]: wire ?? {\r\n        wireSegmentIds: [],\r\n        wireJointIds: [],\r\n      },\r\n    },\r\n  };\r\n}\r\n","import pick from \"lodash/pick\";\r\n\r\nimport { wireIdFromWireJointIdSelector } from \"../../selectors/wires\";\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\n\r\nimport { WireOperationError } from \"../errors/WireOperationError\";\r\n\r\nexport function wireJointRemove(\r\n  state: CircuitGraphServiceState,\r\n  jointId: string\r\n): CircuitGraphServiceState {\r\n  const wireId = wireIdFromWireJointIdSelector.local(state, jointId);\r\n  if (!wireId) {\r\n    throw new WireOperationError(\"Wire for joint id not found.\");\r\n  }\r\n\r\n  const wire = state.wiresByWireId[wireId];\r\n\r\n  const wiresByWireId: typeof state.wiresByWireId = {\r\n    ...state.wiresByWireId,\r\n    [wireId]: {\r\n      ...wire,\r\n      wireJointIds: [...wire.wireJointIds.filter((x) => x !== jointId)],\r\n    },\r\n  };\r\n\r\n  const wireJointPositionsByJointId = pick(\r\n    state.wireJointPositionsByJointId,\r\n    Object.keys(state.wireJointPositionsByJointId).filter((x) => x !== jointId)\r\n  );\r\n\r\n  return {\r\n    ...state,\r\n    wiresByWireId,\r\n    wireJointPositionsByJointId,\r\n  };\r\n}\r\n","import pick from \"lodash/pick\";\r\n\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\nimport { getJointIdsFromSegment } from \"../../utils\";\r\n\r\nimport { wireIdFromWireSegmentIdSelector } from \"../../selectors/wires\";\r\n\r\nimport { WireOperationError } from \"../errors/WireOperationError\";\r\nimport { wireRemove } from \"./wire-remove\";\r\nimport { wireJointRemove } from \"./wire-joint-remove\";\r\n\r\nexport interface WireSegmentRemoveOpts {\r\n  deleteWireIfLastSegment?: boolean;\r\n  removeOrphanJoints?: boolean;\r\n}\r\nexport function wireSegmentRemove(\r\n  state: CircuitGraphServiceState,\r\n  segmentId: string,\r\n  {\r\n    deleteWireIfLastSegment = true,\r\n    removeOrphanJoints = true,\r\n  }: WireSegmentRemoveOpts = {}\r\n): CircuitGraphServiceState {\r\n  const wireId = wireIdFromWireSegmentIdSelector.local(state, segmentId);\r\n  if (!wireId) {\r\n    throw new WireOperationError(\"Wire for segment not found.\");\r\n  }\r\n\r\n  const segment = state.wireSegmentsById[segmentId];\r\n  if (!segment) {\r\n    throw new WireOperationError(\"Segment not found\");\r\n  }\r\n\r\n  const remainingSegmentIds = state.wiresByWireId[wireId].wireSegmentIds.filter(\r\n    (x) => x !== segmentId\r\n  );\r\n\r\n  if (deleteWireIfLastSegment && remainingSegmentIds.length === 0) {\r\n    return wireRemove(state, wireId);\r\n  }\r\n\r\n  if (removeOrphanJoints) {\r\n    const joints = getJointIdsFromSegment(segment);\r\n    for (const jointId of joints) {\r\n      if (\r\n        remainingSegmentIds.every(\r\n          (remainingSegmentId) =>\r\n            getJointIdsFromSegment(\r\n              state.wireSegmentsById[remainingSegmentId]\r\n            ).indexOf(jointId) === -1\r\n        )\r\n      ) {\r\n        // No other segment uses this joint.\r\n        state = wireJointRemove(state, jointId);\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    wiresByWireId: {\r\n      ...state.wiresByWireId,\r\n      [wireId]: {\r\n        // Re-obtain wire ref as wireRemoveJoint will have changed it.\r\n        ...state.wiresByWireId[wireId],\r\n        wireSegmentIds: remainingSegmentIds,\r\n      },\r\n    },\r\n    wireSegmentsById: pick(\r\n      state.wireSegmentsById,\r\n      Object.keys(state.wireSegmentsById).filter((x) => x !== segmentId)\r\n    ),\r\n  };\r\n}\r\n","import { CircuitGraphServiceState } from \"../../state\";\r\n\r\nimport { wireIdFromWireSegmentIdSelector } from \"../../selectors/wires\";\r\n\r\nimport { wireRemove } from \"../primitives/wire-remove\";\r\nimport { wireSplit } from \"../primitives/wire-split\";\r\nimport { wireSegmentRemove } from \"../primitives/wire-segment-remove\";\r\n\r\nexport default function wireSegmentDelete(\r\n  state: CircuitGraphServiceState,\r\n  wireSegmentId: string\r\n): CircuitGraphServiceState {\r\n  const wireId = wireIdFromWireSegmentIdSelector.local(state, wireSegmentId);\r\n  if (!wireId) {\r\n    return state;\r\n  }\r\n\r\n  const wire = state.wiresByWireId[wireId];\r\n  if (wire.wireSegmentIds.indexOf(wireSegmentId) === -1) {\r\n    return state;\r\n  }\r\n\r\n  const removedSegment = state.wireSegmentsById[wireSegmentId];\r\n  if (!removedSegment) {\r\n    return state;\r\n  }\r\n\r\n  if (\r\n    removedSegment.type === \"input-output\" ||\r\n    wire.wireSegmentIds.length === 1\r\n  ) {\r\n    // Removing this segment will remove the entire wire.\r\n    return wireRemove(state, wireId);\r\n  }\r\n\r\n  if (removedSegment.type === \"bridge\") {\r\n    // Remove the bridge.\r\n    // Make sure to remove the orpahned joints, we will detect their\r\n    // remaining presense as an indicator if the network was split.\r\n    state = wireSegmentRemove(state, wireSegmentId, {\r\n      removeOrphanJoints: true,\r\n    });\r\n\r\n    // Check if we cut the wire into two networks.\r\n    // We can tell because removeSegment will delete orphaned joints, and\r\n    // if both joints werent removed then other parts of the wire network still exist\r\n    // at both ends.\r\n    // We need to re-obtain the wire, as removeSegment made a new instance for it with new data.\r\n    const wire = state.wiresByWireId[wireId];\r\n    const { jointAId, jointBId } = removedSegment;\r\n    if (\r\n      wire &&\r\n      wire.wireJointIds.indexOf(jointAId) !== -1 &&\r\n      wire.wireJointIds.indexOf(jointBId) !== -1\r\n    ) {\r\n      state = wireSplit(state, removedSegment.jointAId);\r\n    }\r\n\r\n    return state;\r\n  }\r\n\r\n  // At this point, the segment is a connection from an element pin to the rest of the wire.\r\n  // There are no joints to delete, as the single joint will be used by the other wire segment.\r\n  return wireSegmentRemove(state, wireSegmentId);\r\n}\r\n","import difference from \"lodash/difference\";\r\nimport mapValues from \"lodash/mapValues\";\r\nimport { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport {\r\n  circuitIdForWireIdSelector,\r\n  wireIdFromWireJointIdSelector,\r\n} from \"../../selectors/wires\";\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\nimport { isInputWireSegment, isOutputWireSegment } from \"../../types\";\r\nimport { getJointIdsFromSegment, getSegmentIdsFromJoint } from \"../../utils\";\r\nimport { WireOperationError } from \"../errors/WireOperationError\";\r\n\r\nimport { wireCreate } from \"./wire-create\";\r\n\r\n/**\r\n * Scans through a wire network given a joint id and moves all connected segments and joints to a new network.\r\n */\r\nexport function wireSplit(\r\n  state: CircuitGraphServiceState,\r\n  jointId: string\r\n): CircuitGraphServiceState {\r\n  const oldWireId = wireIdFromWireJointIdSelector.local(state, jointId);\r\n  if (!oldWireId) {\r\n    throw new WireOperationError(\"Wire id for joint not found.\");\r\n  }\r\n\r\n  const circuitId = circuitIdForWireIdSelector.local(state, oldWireId);\r\n  if (!circuitId) {\r\n    throw new WireOperationError(\"Circuit id for joint not found.\");\r\n  }\r\n\r\n  // Collect all connected segments and joints\r\n  const { jointIds, segmentIds } = collectWireNetwork(\r\n    state,\r\n    oldWireId,\r\n    jointId\r\n  );\r\n\r\n  // New wire won't have any content.\r\n  if (jointIds.length === 0 || segmentIds.length === 0) {\r\n    return state;\r\n  }\r\n\r\n  // Strip values from existing wire network\r\n  const oldWire = state.wiresByWireId[oldWireId];\r\n  const remainingWireSegmentIds = difference(\r\n    oldWire.wireSegmentIds,\r\n    segmentIds\r\n  );\r\n  const remainingWireJointIds = difference(oldWire.wireJointIds, jointIds);\r\n  if (\r\n    remainingWireJointIds.length === 0 ||\r\n    remainingWireSegmentIds.length === 0\r\n  ) {\r\n    // Old wire won't have any content.\r\n    return state;\r\n  }\r\n\r\n  state = {\r\n    ...state,\r\n    wiresByWireId: {\r\n      ...state.wiresByWireId,\r\n      [oldWireId]: {\r\n        ...oldWire,\r\n        wireSegmentIds: remainingWireSegmentIds,\r\n        wireJointIds: remainingWireJointIds,\r\n      },\r\n    },\r\n  };\r\n\r\n  // Change the line ids.\r\n  // This is so in the future if the wire networks are joined, we won't get conflicting inputs.\r\n  const lineIdMap: Record<string, string> = {};\r\n  function mapLineId(lineId: string): string {\r\n    if (!lineIdMap[lineId]) {\r\n      lineIdMap[lineId] = uuidV4();\r\n    }\r\n\r\n    return lineIdMap[lineId];\r\n  }\r\n\r\n  state = {\r\n    ...state,\r\n    wireSegmentsById: mapValues(\r\n      state.wireSegmentsById,\r\n      (segment, segmentId) => {\r\n        if (segmentIds.indexOf(segmentId) === -1) {\r\n          return segment;\r\n        }\r\n\r\n        if (!isOutputWireSegment(segment) && !isInputWireSegment(segment)) {\r\n          return segment;\r\n        }\r\n\r\n        return {\r\n          ...segment,\r\n          lineId: mapLineId(segment.lineId),\r\n        };\r\n      }\r\n    ),\r\n  };\r\n\r\n  // Create a new wire to store the values\r\n  const newWireId = uuidV4();\r\n  state = wireCreate(state, circuitId, newWireId, {\r\n    wireJointIds: jointIds,\r\n    wireSegmentIds: segmentIds,\r\n  });\r\n\r\n  return state;\r\n}\r\n\r\nfunction collectWireNetwork(\r\n  state: CircuitGraphServiceState,\r\n  wireId: string,\r\n  jointId: string\r\n): { jointIds: string[]; segmentIds: string[] } {\r\n  const jointIds = new Set<string>();\r\n  const segmentIds = new Set<string>();\r\n\r\n  function collectSegment(segmentId: string) {\r\n    if (segmentIds.has(segmentId)) {\r\n      return;\r\n    }\r\n\r\n    const segment = state.wireSegmentsById[segmentId];\r\n    if (!segment) {\r\n      return;\r\n    }\r\n\r\n    segmentIds.add(segmentId);\r\n    const jointIds = getJointIdsFromSegment(segment);\r\n    jointIds.forEach(collectJoint);\r\n  }\r\n\r\n  function collectJoint(jointId: string) {\r\n    if (jointIds.has(jointId)) {\r\n      return;\r\n    }\r\n\r\n    jointIds.add(jointId);\r\n    const segmentIds = getSegmentIdsFromJoint(state, wireId, jointId);\r\n    segmentIds.forEach(collectSegment);\r\n  }\r\n\r\n  collectJoint(jointId);\r\n\r\n  return {\r\n    jointIds: Array.from(jointIds),\r\n    segmentIds: Array.from(segmentIds),\r\n  };\r\n}\r\n","import pick from \"lodash/pick\";\r\nimport difference from \"lodash/difference\";\r\nimport includes from \"lodash/includes\";\r\nimport find from \"lodash/find\";\r\nimport flatMap from \"lodash/flatMap\";\r\nimport mapValues from \"lodash/mapValues\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\nimport { elementPinEquals, WireSegment } from \"../../types\";\r\n\r\nimport { elementPinsFromPinElementSelector } from \"../../selectors/pins\";\r\n\r\nimport wireSegmentDelete from \"./wire-segment-delete\";\r\n\r\nexport default function elementDelete(\r\n  state: CircuitGraphServiceState,\r\n  removedElementIds: string[],\r\n  rootState: AppState\r\n): CircuitGraphServiceState {\r\n  const remainingElementIds = difference(\r\n    Object.keys(state.elementsById),\r\n    removedElementIds\r\n  );\r\n\r\n  const elementIdsByCircuitId = mapValues(\r\n    state.elementIdsByCircuitId,\r\n    (circuitElementIds) => difference(circuitElementIds, removedElementIds)\r\n  );\r\n\r\n  state = {\r\n    ...state,\r\n    elementsById: pick(state.elementsById, remainingElementIds),\r\n    elementIdsByCircuitId,\r\n  };\r\n\r\n  // Remove wires targeting these elements.\r\n  const removedIcPins = flatMap(removedElementIds, (elementId) =>\r\n    elementPinsFromPinElementSelector(rootState, elementId)\r\n  );\r\n\r\n  function isSegmentForRemovedElement(segment: WireSegment) {\r\n    switch (segment.type) {\r\n      case \"input-output\":\r\n        return (\r\n          includes(removedElementIds, segment.inputPin.elementId) ||\r\n          includes(removedElementIds, segment.outputPin.elementId)\r\n        );\r\n      case \"input\":\r\n        return includes(removedElementIds, segment.inputPin.elementId);\r\n      case \"output\":\r\n        return includes(removedElementIds, segment.outputPin.elementId);\r\n    }\r\n    return false;\r\n  }\r\n\r\n  function isSegmentForRemovedPin(segment: WireSegment) {\r\n    switch (segment.type) {\r\n      case \"input-output\":\r\n        return Boolean(\r\n          find(removedIcPins, (removedPin) =>\r\n            elementPinEquals(removedPin, segment.inputPin)\r\n          ) ||\r\n            find(removedIcPins, (removedPin) =>\r\n              elementPinEquals(removedPin, segment.outputPin)\r\n            )\r\n        );\r\n      case \"input\":\r\n        return Boolean(\r\n          find(removedIcPins, (removedPin) =>\r\n            elementPinEquals(removedPin, segment.inputPin)\r\n          )\r\n        );\r\n      case \"output\":\r\n        return Boolean(\r\n          find(removedIcPins, (removedPin) =>\r\n            elementPinEquals(removedPin, segment.outputPin)\r\n          )\r\n        );\r\n    }\r\n    return false;\r\n  }\r\n\r\n  const removedSegmentIds = Object.keys(state.wireSegmentsById).filter(\r\n    (segmentId) => {\r\n      const segment = state.wireSegmentsById[segmentId];\r\n      return (\r\n        isSegmentForRemovedElement(segment) || isSegmentForRemovedPin(segment)\r\n      );\r\n    }\r\n  );\r\n\r\n  state = removedSegmentIds.reduce((state, segmentId) => {\r\n    return wireSegmentDelete(state, segmentId);\r\n  }, state);\r\n\r\n  return state;\r\n}\r\n","import pick from \"lodash/pick\";\r\nimport { isDeleteCircuitAction } from \"@/actions/circuit-delete\";\r\n\r\nimport { circuitIdToElementType } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nimport elementDelete from \"./operations/element-delete\";\r\n\r\nexport default createCircuitGraphReducer((state, action, rootState) => {\r\n  if (!isDeleteCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { circuitId } = action.payload;\r\n  const remainingCircuitIds = Object.keys(state.elementIdsByCircuitId).filter(\r\n    (x) => x !== circuitId\r\n  );\r\n\r\n  const elementIdsForCircuit = state.elementIdsByCircuitId[circuitId] ?? [];\r\n\r\n  const circuitElementType = circuitIdToElementType(circuitId);\r\n  const elementIdsOfCircuit = Object.keys(state.elementsById).filter(\r\n    (id) => state.elementsById[id].elementType === circuitElementType\r\n  );\r\n\r\n  const removedElementIds = [...elementIdsForCircuit, ...elementIdsOfCircuit];\r\n\r\n  state = elementDelete(state, removedElementIds, rootState);\r\n\r\n  return {\r\n    ...state,\r\n    elementIdsByCircuitId: pick(\r\n      state.elementIdsByCircuitId,\r\n      remainingCircuitIds\r\n    ),\r\n    wireIdsByCircuitId: pick(state.wireIdsByCircuitId, remainingCircuitIds),\r\n  };\r\n});\r\n","import { AppReducer } from \"./types\";\r\n\r\nexport const PRIORITY_PRE = -10;\r\nexport const PRIORITY_POST = 10;\r\nexport const PRIORITY_SAVE = 50;\r\n\r\nexport function reducerPriority(\r\n  priority: number,\r\n  reducer: AppReducer\r\n): AppReducer {\r\n  reducer.weight = priority;\r\n  return reducer;\r\n}\r\n\r\nexport function priorityBefore(reducer: AppReducer) {\r\n  return (reducer.weight ?? 0) - 1;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { reducerPriority, PRIORITY_PRE } from \"@/store/priorities\";\r\n\r\nimport { isAddElementAction } from \"@/actions/element-add\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nexport default reducerPriority(\r\n  PRIORITY_PRE,\r\n  createCircuitGraphReducer((state, action: AnyAction) => {\r\n    if (!isAddElementAction(action)) {\r\n      return state;\r\n    }\r\n\r\n    const { elementId, elementType, elementName, circuitId } = action.payload;\r\n    return {\r\n      ...state,\r\n      elementsById: {\r\n        ...state.elementsById,\r\n        [elementId]: {\r\n          elementType,\r\n          elementName: elementName ?? null,\r\n        },\r\n      },\r\n      elementIdsByCircuitId: {\r\n        ...state.elementIdsByCircuitId,\r\n        [circuitId]: [...state.elementIdsByCircuitId[circuitId], elementId],\r\n      },\r\n    };\r\n  })\r\n);\r\n","import { isDeleteElementAction } from \"@/actions/element-delete\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nimport elementDelete from \"./operations/element-delete\";\r\n\r\nexport default createCircuitGraphReducer((state, action, rootState) => {\r\n  if (!isDeleteElementAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { elementIds } = action.payload;\r\n\r\n  return elementDelete(state, elementIds, rootState);\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { isRenameElementAction } from \"@/actions/element-rename\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nexport default createCircuitGraphReducer((state, action: AnyAction) => {\r\n  if (!isRenameElementAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { elementId } = action.payload;\r\n  if (!state.elementsById[elementId]) {\r\n    return state;\r\n  }\r\n\r\n  let elementName: string | null = action.payload.elementName;\r\n  if (!elementName && elementName.trim() === \"\") {\r\n    elementName = null;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    elementsById: {\r\n      ...state.elementsById,\r\n      [elementId]: {\r\n        ...state.elementsById[elementId],\r\n        elementName: elementName,\r\n      },\r\n    },\r\n  };\r\n});\r\n","import { isNewProjectAction } from \"@/actions/project-new\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\nimport { defaultCircuitGraphServiceState } from \"../state\";\r\n\r\nexport default createCircuitGraphReducer((state, action) => {\r\n  if (!isNewProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultCircuitGraphServiceState;\r\n});\r\n","import { CircuitGraphServiceState } from \"../../state\";\r\nimport { WireSegment } from \"../../types\";\r\n\r\nexport function wireSegmentInsert(\r\n  state: CircuitGraphServiceState,\r\n  wireId: string,\r\n  segmentId: string,\r\n  segment: WireSegment\r\n): CircuitGraphServiceState {\r\n  return {\r\n    ...state,\r\n    wiresByWireId: {\r\n      ...state.wiresByWireId,\r\n      [wireId]: {\r\n        ...state.wiresByWireId[wireId],\r\n        wireSegmentIds: [\r\n          ...state.wiresByWireId[wireId].wireSegmentIds,\r\n          segmentId,\r\n        ],\r\n      },\r\n    },\r\n    wireSegmentsById: {\r\n      ...state.wireSegmentsById,\r\n      [segmentId]: segment,\r\n    },\r\n  };\r\n}\r\n","import { Point } from \"@/geometry\";\r\n\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\n\r\nexport function wireJointInsert(\r\n  state: CircuitGraphServiceState,\r\n  wireId: string,\r\n  jointId: string,\r\n  point: Point\r\n): CircuitGraphServiceState {\r\n  state = {\r\n    ...state,\r\n    wiresByWireId: {\r\n      ...state.wiresByWireId,\r\n      [wireId]: {\r\n        ...state.wiresByWireId[wireId],\r\n        wireJointIds: [...state.wiresByWireId[wireId].wireJointIds, jointId],\r\n      },\r\n    },\r\n    wireJointPositionsByJointId: {\r\n      ...state.wireJointPositionsByJointId,\r\n      [jointId]: point,\r\n    },\r\n  };\r\n\r\n  return state;\r\n}\r\n","import { v4 as uuidV4 } from \"uuid\";\r\nimport pick from \"lodash/pick\";\r\n\r\nimport { circuitIdForWireIdSelector } from \"../../selectors/wires\";\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\nimport { collectWireLineIds } from \"../../utils\";\r\n\r\nexport function wireMerge(\r\n  state: CircuitGraphServiceState,\r\n  targetWireId: string,\r\n  subjectWireId: string\r\n): CircuitGraphServiceState {\r\n  const targetCircuitId = circuitIdForWireIdSelector.local(state, targetWireId);\r\n  const subjectCircuitId = circuitIdForWireIdSelector.local(\r\n    state,\r\n    subjectWireId\r\n  );\r\n  if (!targetCircuitId || !subjectCircuitId) {\r\n    throw new Error(\"Unable to determine circuit id for wire.\");\r\n  }\r\n\r\n  if (targetCircuitId !== subjectCircuitId) {\r\n    throw new Error(\"Unable to merge wires in different circuits.\");\r\n  }\r\n\r\n  const targetWire = state.wiresByWireId[targetWireId];\r\n  const subjectWire = state.wiresByWireId[subjectWireId];\r\n  if (!targetWire || !subjectWire) {\r\n    throw new Error(\"Wire not found.\");\r\n  }\r\n\r\n  const [targetInputs, targetOutputs] = collectWireLineIds(state, targetWireId);\r\n  const [subjectInputs, subjectOutputs] = collectWireLineIds(\r\n    state,\r\n    subjectWireId\r\n  );\r\n\r\n  if (\r\n    targetOutputs.length + subjectOutputs.length <= 1 &&\r\n    targetInputs.length <= 1 &&\r\n    subjectInputs.length <= 1\r\n  ) {\r\n    // At most one output between them, and each has at most one input.  combine the lines.\r\n    const sourceLineId = uuidV4();\r\n    state = setWireLineIds(state, targetWireId, sourceLineId);\r\n    state = setWireLineIds(state, subjectWireId, sourceLineId);\r\n  }\r\n\r\n  const remainingWireIds = Object.keys(state.wiresByWireId).filter(\r\n    (x) => x !== subjectWireId\r\n  );\r\n\r\n  return {\r\n    ...state,\r\n    wireIdsByCircuitId: {\r\n      ...state.wireIdsByCircuitId,\r\n      [targetCircuitId]: state.wireIdsByCircuitId[targetCircuitId].filter(\r\n        (x) => x !== subjectWireId\r\n      ),\r\n    },\r\n    wiresByWireId: {\r\n      ...pick(state.wiresByWireId, remainingWireIds),\r\n      [targetWireId]: {\r\n        ...targetWire,\r\n        wireSegmentIds: [\r\n          ...targetWire.wireSegmentIds,\r\n          ...subjectWire.wireSegmentIds,\r\n        ],\r\n        wireJointIds: [...targetWire.wireJointIds, ...subjectWire.wireJointIds],\r\n      },\r\n    },\r\n  };\r\n}\r\n\r\nfunction setWireLineIds(\r\n  state: CircuitGraphServiceState,\r\n  wireId: string,\r\n  lineId: string\r\n): CircuitGraphServiceState {\r\n  const wire = state.wiresByWireId[wireId];\r\n  if (!wire) {\r\n    return state;\r\n  }\r\n\r\n  const wireSegmentsById: typeof state.wireSegmentsById = {\r\n    ...state.wireSegmentsById,\r\n  };\r\n\r\n  for (const segId of wire.wireSegmentIds) {\r\n    const seg = state.wireSegmentsById[segId];\r\n    if (seg.type === \"input\" || seg.type === \"output\") {\r\n      wireSegmentsById[segId] = {\r\n        ...seg,\r\n        lineId,\r\n      };\r\n    }\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    wireSegmentsById,\r\n  };\r\n}\r\n","import { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { isWireConnectAction } from \"@/actions/wire-connect\";\r\n\r\nimport { ElementPin, WireConnectTarget, WireSegment } from \"../types\";\r\nimport { createCircuitGraphReducer, collectWireLineIds } from \"../utils\";\r\nimport { CircuitGraphServiceState } from \"../state\";\r\n\r\nimport { circuitIdFromElementIdSelector } from \"../selectors/elements\";\r\nimport {\r\n  circuitIdFromWireJointIdSelector,\r\n  inputPinIsWiredSelector,\r\n  wireIdFromWireJointIdSelector,\r\n} from \"../selectors/wires\";\r\nimport { pinDirectionFromElementPinSelector } from \"../selectors/pins\";\r\n\r\nimport { wireCreate } from \"./primitives/wire-create\";\r\nimport { wireSegmentInsert } from \"./primitives/wire-segment-insert\";\r\nimport { wireJointInsert } from \"./primitives/wire-joint-insert\";\r\nimport wireSegmentAddJoint from \"./primitives/wire-segment-add-joint\";\r\nimport { wireMerge } from \"./primitives/wire-merge\";\r\n\r\nimport { WireOperationError } from \"./errors/WireOperationError\";\r\n\r\nexport default createCircuitGraphReducer((state, action, rootState) => {\r\n  if (!isWireConnectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const unchangedState = state;\r\n\r\n  const { circuitId, from, to } = action.payload;\r\n\r\n  const {\r\n    state: fromState,\r\n    jointId: fromJointId,\r\n    pin: fromPin,\r\n    circuitId: fromCircuitId,\r\n  } = targetToParts(state, circuitId, from, rootState);\r\n  state = fromState;\r\n\r\n  const {\r\n    state: toState,\r\n    jointId: toJointId,\r\n    pin: toPin,\r\n    circuitId: toCircuitId,\r\n  } = targetToParts(state, circuitId, to, rootState);\r\n  state = toState;\r\n\r\n  if (!fromCircuitId || !toCircuitId || fromCircuitId !== toCircuitId) {\r\n    return unchangedState;\r\n  }\r\n\r\n  // Pin to pin is a new wire with an input-output segment.\r\n  if (fromPin && toPin) {\r\n    const newState = wirePins(state, fromPin, toPin, fromCircuitId, rootState);\r\n    return newState ?? unchangedState;\r\n  }\r\n\r\n  // Joint to joint potentially bridges two wires.\r\n  if (fromJointId && toJointId) {\r\n    const newState = wireJoints(state, fromJointId, toJointId);\r\n    return newState ?? unchangedState;\r\n  }\r\n\r\n  // At this point, we are going from a joint to a pin.\r\n  const jointId = fromJointId ?? toJointId;\r\n  const pin = fromPin ?? toPin;\r\n  if (jointId && pin) {\r\n    const newState = wireJointToPin(state, jointId, pin, rootState);\r\n    return newState ?? unchangedState;\r\n  }\r\n\r\n  return unchangedState;\r\n});\r\n\r\nfunction wirePins(\r\n  state: CircuitGraphServiceState,\r\n  fromPin: ElementPin,\r\n  toPin: ElementPin,\r\n  circuitId: string,\r\n  rootState: AppState\r\n): CircuitGraphServiceState | null {\r\n  const fromDirection = pinDirectionFromElementPinSelector(\r\n    rootState,\r\n    fromPin.elementId,\r\n    fromPin.pinId\r\n  );\r\n  const toDirection = pinDirectionFromElementPinSelector(\r\n    rootState,\r\n    toPin.elementId,\r\n    toPin.pinId\r\n  );\r\n\r\n  if (!fromDirection || !toDirection || fromDirection === toDirection) {\r\n    return null;\r\n  }\r\n\r\n  const inputPin = fromDirection === \"input\" ? fromPin : toPin;\r\n  const outputPin = fromDirection === \"input\" ? toPin : fromPin;\r\n\r\n  // Input pins can only have one wire.\r\n  if (inputPinIsWiredSelector(rootState, inputPin.elementId, inputPin.pinId)) {\r\n    return null;\r\n  }\r\n\r\n  // Pin to pin, create a new wire.\r\n  const wireId = uuidV4();\r\n  state = wireCreate(state, circuitId, wireId);\r\n  state = wireSegmentInsert(state, wireId, uuidV4(), {\r\n    type: \"input-output\",\r\n    inputPin,\r\n    outputPin,\r\n  });\r\n  return state;\r\n}\r\n\r\nfunction wireJoints(\r\n  state: CircuitGraphServiceState,\r\n  fromJointId: string,\r\n  toJointId: string\r\n): CircuitGraphServiceState | null {\r\n  const fromWireId = wireIdFromWireJointIdSelector.local(state, fromJointId);\r\n  const toWireId = wireIdFromWireJointIdSelector.local(state, toJointId);\r\n  if (!fromWireId || !toWireId) {\r\n    return null;\r\n  }\r\n\r\n  if (fromWireId !== toWireId) {\r\n    const mergedState = wireMerge(state, fromWireId, toWireId);\r\n    if (!mergedState) {\r\n      return null;\r\n    }\r\n    state = mergedState;\r\n  }\r\n\r\n  state = wireSegmentInsert(state, fromWireId, uuidV4(), {\r\n    type: \"bridge\",\r\n    jointAId: fromJointId,\r\n    jointBId: toJointId,\r\n  });\r\n  return state;\r\n}\r\n\r\nfunction wireJointToPin(\r\n  state: CircuitGraphServiceState,\r\n  jointId: string,\r\n  pin: ElementPin,\r\n  rootState: AppState\r\n): CircuitGraphServiceState | null {\r\n  const wireId = wireIdFromWireJointIdSelector.local(state, jointId);\r\n  if (!wireId) {\r\n    return null;\r\n  }\r\n\r\n  const direction = pinDirectionFromElementPinSelector(\r\n    rootState,\r\n    pin.elementId,\r\n    pin.pinId\r\n  );\r\n  if (!direction) {\r\n    return null;\r\n  }\r\n\r\n  const lineId = defaultLineIdFromWiredPin(state, wireId, pin, rootState);\r\n\r\n  let segment: WireSegment;\r\n  if (direction === \"input\") {\r\n    if (inputPinIsWiredSelector(rootState, pin.elementId, pin.pinId)) {\r\n      return null;\r\n    }\r\n\r\n    segment = {\r\n      type: \"input\",\r\n      inputPin: pin,\r\n      jointId,\r\n      lineId,\r\n    };\r\n  } else if (direction === \"output\") {\r\n    segment = {\r\n      type: \"output\",\r\n      outputPin: pin,\r\n      jointId,\r\n      lineId,\r\n    };\r\n  } else {\r\n    throw new WireOperationError(\"Unknown pin direction\");\r\n  }\r\n\r\n  state = wireSegmentInsert(state, wireId, uuidV4(), segment);\r\n  return state;\r\n}\r\n\r\nfunction defaultLineIdFromWiredPin(\r\n  state: CircuitGraphServiceState,\r\n  wireId: string,\r\n  pin: ElementPin,\r\n  rootState: AppState\r\n): string {\r\n  const direction = pinDirectionFromElementPinSelector(\r\n    rootState,\r\n    pin.elementId,\r\n    pin.pinId\r\n  );\r\n\r\n  const [inputLineIds, outputLineIds] = collectWireLineIds(state, wireId);\r\n\r\n  if (direction === \"output\" && outputLineIds.length > 0) {\r\n    // Already have an output connected, create a new line for this one.\r\n    return uuidV4();\r\n  } else if (\r\n    (inputLineIds.length === 1 && outputLineIds.length === 0) ||\r\n    (inputLineIds.length === 0 && outputLineIds.length === 1) ||\r\n    (inputLineIds.length === 1 &&\r\n      outputLineIds.length === 1 &&\r\n      inputLineIds[0] === outputLineIds[0])\r\n  ) {\r\n    // If we only have one input or output, use that.\r\n    return inputLineIds[0] ?? outputLineIds[0];\r\n  }\r\n\r\n  // Multiple outputs are available.\r\n  // Make a new line\r\n  return uuidV4();\r\n}\r\n\r\nfunction targetToParts(\r\n  state: CircuitGraphServiceState,\r\n  circuitId: string,\r\n  target: WireConnectTarget,\r\n  rootState: AppState\r\n): {\r\n  state: CircuitGraphServiceState;\r\n  jointId: string | null;\r\n  pin: ElementPin | null;\r\n  circuitId: string | null;\r\n} {\r\n  switch (target.type) {\r\n    case \"pin\":\r\n      return {\r\n        state,\r\n        jointId: null,\r\n        pin: target.pin,\r\n        circuitId: circuitIdFromElementIdSelector.local(\r\n          state,\r\n          target.pin.elementId\r\n        ),\r\n      };\r\n    case \"joint\":\r\n      return {\r\n        state,\r\n        jointId: target.jointId,\r\n        pin: null,\r\n        circuitId: circuitIdFromWireJointIdSelector.local(\r\n          state,\r\n          target.jointId\r\n        ),\r\n      };\r\n    case \"floating\": {\r\n      // Create a new wire to hold the point.\r\n      // If this is to a pin, the wire will stand.\r\n      // If this is to another wire, the wire will merge.\r\n      const wireId = uuidV4();\r\n      state = wireCreate(state, circuitId, wireId);\r\n      const jointId = uuidV4();\r\n      state = wireJointInsert(state, wireId, jointId, target.point);\r\n      return { state, jointId, pin: null, circuitId };\r\n    }\r\n    case \"segment\": {\r\n      const jointId = uuidV4();\r\n      state = wireSegmentAddJoint(\r\n        state,\r\n        target.segmentId,\r\n        target.segmentInsertLength,\r\n        jointId,\r\n        rootState\r\n      );\r\n      return { state, jointId, pin: null, circuitId };\r\n    }\r\n  }\r\n\r\n  throw new WireOperationError(\"Unknown wire connect target\");\r\n}\r\n","import { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport { normalize, pointAdd, pointSubtract, scale } from \"@/geometry\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport {\r\n  endPositionForWireSegmentId,\r\n  startPositionForWireSegmentId,\r\n} from \"../../selectors/wire-positions\";\r\n\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\nimport { WireSegment } from \"../../types\";\r\nimport { wireIdFromWireSegmentIdSelector } from \"../../selectors/wires\";\r\nimport { wireJointInsert } from \"./wire-joint-insert\";\r\nimport { wireSegmentRemove } from \"./wire-segment-remove\";\r\nimport { wireSegmentInsert } from \"./wire-segment-insert\";\r\nimport { WireOperationError } from \"../errors/WireOperationError\";\r\n\r\nexport default function wireSegmentAddJoint(\r\n  state: CircuitGraphServiceState,\r\n  wireSegmentId: string,\r\n  segmentSplitLength: number,\r\n  splitJointId: string,\r\n  rootState: AppState\r\n): CircuitGraphServiceState {\r\n  const wireId = wireIdFromWireSegmentIdSelector.local(state, wireSegmentId);\r\n  if (!wireId) {\r\n    throw new WireOperationError(\"Wire segment parent wire not found.\");\r\n  }\r\n\r\n  const targetSegment = state.wireSegmentsById[wireSegmentId];\r\n  if (!targetSegment) {\r\n    throw new WireOperationError(\"Wire segment not found.\");\r\n  }\r\n\r\n  const startPos = startPositionForWireSegmentId(rootState, wireSegmentId);\r\n  const endPos = endPositionForWireSegmentId(rootState, wireSegmentId);\r\n  const lineVector = normalize(pointSubtract(endPos, startPos));\r\n  const segmentJointPos = pointAdd(\r\n    startPos,\r\n    scale(lineVector, segmentSplitLength)\r\n  );\r\n\r\n  state = wireJointInsert(state, wireId, splitJointId, segmentJointPos);\r\n\r\n  const firstSegmentId = uuidV4();\r\n  const secondSegmentId = uuidV4();\r\n  let firstSegment: WireSegment;\r\n  let secondSegment: WireSegment;\r\n  switch (targetSegment.type) {\r\n    case \"bridge\":\r\n      {\r\n        firstSegment = {\r\n          type: \"bridge\",\r\n          jointAId: targetSegment.jointAId,\r\n          jointBId: splitJointId,\r\n        };\r\n        secondSegment = {\r\n          type: \"bridge\",\r\n          jointAId: splitJointId,\r\n          jointBId: targetSegment.jointBId,\r\n        };\r\n      }\r\n      break;\r\n    case \"input\":\r\n    case \"output\":\r\n      {\r\n        firstSegment = {\r\n          ...targetSegment,\r\n          jointId: splitJointId,\r\n        };\r\n        secondSegment = {\r\n          type: \"bridge\",\r\n          jointAId: splitJointId,\r\n          jointBId: targetSegment.jointId,\r\n        };\r\n      }\r\n      break;\r\n    case \"input-output\":\r\n      {\r\n        const lineId = uuidV4();\r\n        firstSegment = {\r\n          type: \"output\",\r\n          outputPin: targetSegment.outputPin,\r\n          jointId: splitJointId,\r\n          lineId,\r\n        };\r\n        secondSegment = {\r\n          type: \"input\",\r\n          inputPin: targetSegment.inputPin,\r\n          jointId: splitJointId,\r\n          lineId,\r\n        };\r\n      }\r\n      break;\r\n    default:\r\n      throw new WireOperationError(\"Unknown segment type.\");\r\n  }\r\n\r\n  // Remove the modified segment, it is to be replaced with the two new segments.\r\n  state = wireSegmentRemove(state, wireSegmentId, {\r\n    deleteWireIfLastSegment: false,\r\n    removeOrphanJoints: false,\r\n  });\r\n\r\n  // Add the new segments.\r\n  state = wireSegmentInsert(state, wireId, firstSegmentId, firstSegment);\r\n  state = wireSegmentInsert(state, wireId, secondSegmentId, secondSegment);\r\n\r\n  return state;\r\n}\r\n","import { Point } from \"@/geometry\";\r\n\r\nimport { isHydrateWireAction } from \"@/actions/wire-hydrate\";\r\n\r\nimport { WireSegment } from \"../types\";\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nexport default createCircuitGraphReducer((state, action) => {\r\n  if (!isHydrateWireAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { wireId, circuitId, wireSegments, wireJoints } = action.payload;\r\n\r\n  const newSegments: Record<string, WireSegment> = {};\r\n  for (const segment of wireSegments) {\r\n    const { wireSegmentId, ...wireSegment } = segment;\r\n    newSegments[wireSegmentId] = wireSegment;\r\n  }\r\n\r\n  const newJoints: Record<string, Point> = {};\r\n  for (const joint of wireJoints) {\r\n    const { jointId, ...point } = joint;\r\n    newJoints[jointId] = point;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    wireIdsByCircuitId: {\r\n      ...state.wireIdsByCircuitId,\r\n      [circuitId]: [...state.wireIdsByCircuitId[circuitId], wireId],\r\n    },\r\n    wiresByWireId: {\r\n      ...state.wiresByWireId,\r\n      [wireId]: {\r\n        wireSegmentIds: Object.keys(newSegments),\r\n        wireJointIds: Object.keys(newJoints),\r\n      },\r\n    },\r\n    wireSegmentsById: {\r\n      ...state.wireSegmentsById,\r\n      ...newSegments,\r\n    },\r\n    wireJointPositionsByJointId: {\r\n      ...state.wireJointPositionsByJointId,\r\n      ...newJoints,\r\n    },\r\n  };\r\n});\r\n","import { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport { isWireSegmentInsertJointAction } from \"@/actions/wire-segment-insert-joint\";\r\n\r\nimport { WireSegment } from \"../types\";\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nimport { wireJointInsert } from \"./primitives/wire-joint-insert\";\r\nimport { wireSegmentRemove } from \"./primitives/wire-segment-remove\";\r\nimport { wireSegmentInsert } from \"./primitives/wire-segment-insert\";\r\n\r\nexport default createCircuitGraphReducer((state, action) => {\r\n  if (!isWireSegmentInsertJointAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { wireId, wireSegmentId, jointPos } = action.payload;\r\n\r\n  const targetWire = state.wiresByWireId[wireId];\r\n  if (!targetWire) {\r\n    return state;\r\n  }\r\n\r\n  const targetSegment = state.wireSegmentsById[wireSegmentId];\r\n  if (!targetSegment) {\r\n    return state;\r\n  }\r\n\r\n  const newJointId = uuidV4();\r\n\r\n  let firstSegment: WireSegment;\r\n  let secondSegment: WireSegment;\r\n  switch (targetSegment.type) {\r\n    case \"bridge\":\r\n      {\r\n        firstSegment = {\r\n          type: \"bridge\",\r\n          jointAId: targetSegment.jointAId,\r\n          jointBId: newJointId,\r\n        };\r\n        secondSegment = {\r\n          type: \"bridge\",\r\n          jointAId: newJointId,\r\n          jointBId: targetSegment.jointBId,\r\n        };\r\n      }\r\n      break;\r\n    case \"input\":\r\n    case \"output\":\r\n      {\r\n        firstSegment = {\r\n          ...targetSegment,\r\n          jointId: newJointId,\r\n        };\r\n        secondSegment = {\r\n          type: \"bridge\",\r\n          jointAId: newJointId,\r\n          jointBId: targetSegment.jointId,\r\n        };\r\n      }\r\n      break;\r\n    case \"input-output\":\r\n      {\r\n        const lineId = uuidV4();\r\n        firstSegment = {\r\n          type: \"output\",\r\n          outputPin: targetSegment.outputPin,\r\n          jointId: newJointId,\r\n          lineId,\r\n        };\r\n        secondSegment = {\r\n          type: \"input\",\r\n          inputPin: targetSegment.inputPin,\r\n          jointId: newJointId,\r\n          lineId,\r\n        };\r\n      }\r\n      break;\r\n    default:\r\n      return state;\r\n  }\r\n\r\n  state = wireJointInsert(state, wireId, newJointId, jointPos);\r\n  state = wireSegmentRemove(state, wireSegmentId, {\r\n    deleteWireIfLastSegment: false,\r\n    removeOrphanJoints: false,\r\n  });\r\n  state = wireSegmentInsert(state, wireId, uuidV4(), firstSegment);\r\n  state = wireSegmentInsert(state, wireId, uuidV4(), secondSegment);\r\n\r\n  return state;\r\n});\r\n","import { isWireJointDeleteAction } from \"@/actions/wire-joint-delete\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\nimport { WireOperationError } from \"./errors/WireOperationError\";\r\n\r\nimport { wireJointMergeOrDelete } from \"./operations/wire-joint-merge-or-delete\";\r\n\r\nexport default createCircuitGraphReducer((state, action) => {\r\n  if (!isWireJointDeleteAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { jointIds } = action.payload;\r\n\r\n  state = jointIds.reduce((state, jointId) => {\r\n    try {\r\n      return wireJointMergeOrDelete(state, jointId);\r\n    } catch (e) {\r\n      if (e instanceof WireOperationError === false) {\r\n        throw e;\r\n      }\r\n      return state;\r\n    }\r\n  }, state);\r\n\r\n  return state;\r\n});\r\n","import { CircuitGraphServiceState } from \"../../state\";\r\nimport { getSegmentIdsFromJoint } from \"../../utils\";\r\n\r\nimport { wireIdFromWireJointIdSelector } from \"../../selectors/wires\";\r\n\r\nimport { WireOperationError } from \"../errors/WireOperationError\";\r\n\r\nimport { wireSegmentMerge } from \"../primitives/wire-segment-merge\";\r\n\r\nimport wireSegmentDelete from \"./wire-segment-delete\";\r\n\r\nexport function wireJointMergeOrDelete(\r\n  state: CircuitGraphServiceState,\r\n  jointId: string\r\n): CircuitGraphServiceState {\r\n  const wireId = wireIdFromWireJointIdSelector.local(state, jointId);\r\n  if (!wireId) {\r\n    throw new WireOperationError(\"Wire for joint not found\");\r\n  }\r\n\r\n  const jointedSegmentIds = getSegmentIdsFromJoint(state, wireId, jointId);\r\n\r\n  if (jointedSegmentIds.length === 2) {\r\n    try {\r\n      return wireSegmentMerge(\r\n        state,\r\n        jointedSegmentIds[0],\r\n        jointedSegmentIds[1],\r\n        jointId\r\n      );\r\n    } catch (e) {\r\n      if (e instanceof WireOperationError === false) {\r\n        throw e;\r\n      }\r\n    }\r\n  }\r\n\r\n  state = jointedSegmentIds.reduce(\r\n    (state, segmentId) => wireSegmentDelete(state, segmentId),\r\n    state\r\n  );\r\n\r\n  return state;\r\n}\r\n","import { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport { wireIdFromWireSegmentIdSelector } from \"../../selectors/wires\";\r\nimport { CircuitGraphServiceState } from \"../../state\";\r\nimport { InputWireSegment, OutputWireSegment } from \"../../types\";\r\nimport { getJointIdsFromSegment } from \"../../utils\";\r\n\r\nimport { WireOperationError } from \"../errors/WireOperationError\";\r\n\r\nimport { wireJointRemove } from \"./wire-joint-remove\";\r\nimport { wireSegmentRemove } from \"./wire-segment-remove\";\r\nimport { wireSegmentInsert } from \"./wire-segment-insert\";\r\n\r\nexport function wireSegmentMerge(\r\n  state: CircuitGraphServiceState,\r\n  segmentId1: string,\r\n  segmentId2: string,\r\n  jointId: string\r\n): CircuitGraphServiceState {\r\n  const wireId1 = wireIdFromWireSegmentIdSelector.local(state, segmentId1);\r\n  const wireId2 = wireIdFromWireSegmentIdSelector.local(state, segmentId2);\r\n\r\n  if (!wireId1 || !wireId2) {\r\n    throw new WireOperationError(\"Wire for segment not found.\");\r\n  }\r\n\r\n  if (wireId1 !== wireId2) {\r\n    throw new WireOperationError(\r\n      \"Merging segments from different wires is not supported.\"\r\n    );\r\n  }\r\n\r\n  const seg1 = state.wireSegmentsById[segmentId1];\r\n  const seg2 = state.wireSegmentsById[segmentId2];\r\n  if (!seg1 || !seg2) {\r\n    throw new WireOperationError(\"Wire segment not found.\");\r\n  }\r\n\r\n  if (seg1.type === \"input-output\" || seg2.type === \"input-output\") {\r\n    // Impossible to merge.  Impossible for a wire to have more than one segment if one is input-output anyway.\r\n    throw new WireOperationError(\"Cannot merge input-output segments.\");\r\n  }\r\n\r\n  // If we have inputs and outputs, try turning them into an input-output.\r\n  if (\r\n    (seg1.type === \"input\" || seg1.type === \"output\") &&\r\n    (seg2.type === \"input\" || seg2.type === \"output\")\r\n  ) {\r\n    // Cannot merge two like-types.\r\n    if (seg1.type === seg2.type) {\r\n      throw new WireOperationError(\"Cannot merge two inputs or two outputs.\");\r\n    }\r\n\r\n    // Segments dont share this joint.\r\n    if (seg1.jointId !== jointId || seg2.jointId !== jointId) {\r\n      throw new WireOperationError(\"Segments do not share the given joint.\");\r\n    }\r\n\r\n    const inputSegment =\r\n      seg1.type === \"input\" ? seg1 : (seg2 as InputWireSegment);\r\n    const outputSegment =\r\n      seg1.type === \"output\" ? seg1 : (seg2 as OutputWireSegment);\r\n    state = wireJointRemove(state, jointId);\r\n    state = wireSegmentRemove(state, segmentId1, {\r\n      deleteWireIfLastSegment: false,\r\n      removeOrphanJoints: false,\r\n    });\r\n    state = wireSegmentRemove(state, segmentId2, {\r\n      deleteWireIfLastSegment: false,\r\n      removeOrphanJoints: false,\r\n    });\r\n    state = wireSegmentInsert(state, wireId1, uuidV4(), {\r\n      type: \"input-output\",\r\n      inputPin: inputSegment.inputPin,\r\n      outputPin: outputSegment.outputPin,\r\n    });\r\n    return state;\r\n  }\r\n\r\n  // At this point, at least one segment is a bridge, and the other is an input, output, or bridge.\r\n  const bridge =\r\n    seg1.type === \"bridge\" ? seg1 : seg2.type === \"bridge\" ? seg2 : null;\r\n  if (!bridge) {\r\n    throw new WireOperationError(\"Cannot merge segment configuration.\");\r\n  }\r\n\r\n  // Alt can be an input, output, or bridge.\r\n  const alt = seg1 === bridge ? seg2 : seg1;\r\n\r\n  // This is the joint that will remain once we combine the segments, and will be part of the new segment.\r\n  const bridgeRemainderJoint = getJointIdsFromSegment(bridge)\r\n    .filter((x) => x !== jointId)\r\n    .pop();\r\n  if (!bridgeRemainderJoint) {\r\n    throw new WireOperationError(\"Cannot merge segment configuration.\");\r\n  }\r\n\r\n  state = wireJointRemove(state, jointId);\r\n  // Keep the joints, we will reuse them.\r\n  state = wireSegmentRemove(state, segmentId1, {\r\n    removeOrphanJoints: false,\r\n    deleteWireIfLastSegment: false,\r\n  });\r\n  state = wireSegmentRemove(state, segmentId2, {\r\n    removeOrphanJoints: false,\r\n    deleteWireIfLastSegment: false,\r\n  });\r\n\r\n  switch (alt.type) {\r\n    case \"bridge\": {\r\n      const altRemainderJoint =\r\n        alt.jointAId === jointId\r\n          ? alt.jointBId\r\n          : alt.jointBId === jointId\r\n          ? alt.jointAId\r\n          : null;\r\n      if (!altRemainderJoint) {\r\n        throw new WireOperationError(\"Segments do not share the given joint.\");\r\n      }\r\n      state = wireSegmentInsert(state, wireId1, uuidV4(), {\r\n        type: \"bridge\",\r\n        jointAId: bridgeRemainderJoint,\r\n        jointBId: altRemainderJoint,\r\n      });\r\n      return state;\r\n    }\r\n    case \"input\":\r\n    case \"output\": {\r\n      if (alt.jointId !== jointId) {\r\n        throw new WireOperationError(\"Segments do not share the given joint.\");\r\n      }\r\n      // If we combine an input or output with a bridge, we just extend the input or output\r\n      // to the far joint of the bridge.\r\n      state = wireSegmentInsert(state, wireId1, uuidV4(), {\r\n        ...alt,\r\n        jointId: bridgeRemainderJoint,\r\n      });\r\n      return state;\r\n    }\r\n  }\r\n\r\n  throw new WireOperationError(\"Cannot merge segment configuration.\");\r\n}\r\n","import mapValues from \"lodash/mapValues\";\r\nimport pick from \"lodash/pick\";\r\n\r\nimport { isWireJointMoveAction } from \"@/actions/wire-joint-move\";\r\n\r\nimport {\r\n  applyGridElementSnapSelector,\r\n  applyGridJointSnapSelector,\r\n} from \"@/services/circuit-editor-drag/selectors/snap\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nexport default createCircuitGraphReducer((state, action, appState) => {\r\n  if (!isWireJointMoveAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { jointIds, position, relative, snapMode } = action.payload;\r\n\r\n  const movedJointPositions = mapValues(\r\n    pick(state.wireJointPositionsByJointId, jointIds),\r\n    (p) => {\r\n      let movedP = {\r\n        x: relative ? p.x + position.x : position.x,\r\n        y: relative ? p.y + position.y : position.y,\r\n      };\r\n      switch (snapMode) {\r\n        case \"element\":\r\n          movedP = applyGridElementSnapSelector(appState, movedP);\r\n          break;\r\n        case \"joint\":\r\n          movedP = applyGridJointSnapSelector(appState, movedP);\r\n          break;\r\n      }\r\n      return movedP;\r\n    }\r\n  );\r\n\r\n  return {\r\n    ...state,\r\n    wireJointPositionsByJointId: {\r\n      ...state.wireJointPositionsByJointId,\r\n      ...movedJointPositions,\r\n    },\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { asArray, MaybeArray } from \"@/arrays\";\r\n\r\nexport const ACTION_WIRE_SEGMENT_DELETE = \"@wire/segment/delete\" as const;\r\nexport const deleteWireSegment = (segmentId: MaybeArray<string>) => ({\r\n  type: ACTION_WIRE_SEGMENT_DELETE,\r\n  payload: { segmentIds: asArray(segmentId) },\r\n});\r\nexport type WireSegmentDeleteAction = ReturnType<typeof deleteWireSegment>;\r\nexport function isWireSegmentDeleteAction(\r\n  action: AnyAction\r\n): action is WireSegmentDeleteAction {\r\n  return action.type === ACTION_WIRE_SEGMENT_DELETE;\r\n}\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport circuitAddReducer from \"./circuit-add\";\r\nimport circuitDeleteReducer from \"./circuit-delete\";\r\nimport elementAddReducer from \"./element-add\";\r\nimport elementDeleteReducer from \"./element-delete\";\r\nimport elementRenameReducer from \"./element-rename\";\r\nimport projectNewReducer from \"./project-new\";\r\nimport wireConnectReducer from \"./wire-connect\";\r\nimport wireHydrateReducer from \"./wire-hydrate\";\r\nimport wireInsertJointReducer from \"./wire-insert-joint\";\r\nimport wireJointDeleteReducer from \"./wire-joint-delete\";\r\nimport wireJointMoveReducer from \"./wire-joint-move\";\r\nimport wireSegmentDeleteReducer from \"./wire-segment-delete\";\r\nimport wireSegmentSetLine from \"./wire-segment-set-line\";\r\n\r\nconst graphReducer = concatReducers(\r\n  circuitAddReducer,\r\n  circuitDeleteReducer,\r\n  elementAddReducer,\r\n  elementDeleteReducer,\r\n  elementRenameReducer,\r\n  projectNewReducer,\r\n  wireConnectReducer,\r\n  wireHydrateReducer,\r\n  wireInsertJointReducer,\r\n  wireJointDeleteReducer,\r\n  wireJointMoveReducer,\r\n  wireSegmentDeleteReducer,\r\n  wireSegmentSetLine\r\n);\r\n\r\nexport default graphReducer;\r\n","import { isWireSegmentDeleteAction } from \"@/actions/wire-segment-delete\";\r\n\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nimport wireSegmentDelete from \"./operations/wire-segment-delete\";\r\n\r\nexport default createCircuitGraphReducer((state, action) => {\r\n  if (!isWireSegmentDeleteAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { segmentIds } = action.payload;\r\n\r\n  state = segmentIds.reduce(\r\n    (state, segmentId) => wireSegmentDelete(state, segmentId),\r\n    state\r\n  );\r\n\r\n  return state;\r\n});\r\n","import { isWireSegmentSetLineAction } from \"@/actions/wire-segment-set-line\";\r\nimport { isInputWireSegment, isOutputWireSegment } from \"../types\";\r\nimport { createCircuitGraphReducer } from \"../utils\";\r\n\r\nexport default createCircuitGraphReducer((state, action) => {\r\n  if (!isWireSegmentSetLineAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { wireSegmentId, lineId } = action.payload;\r\n\r\n  const segment = state.wireSegmentsById[wireSegmentId];\r\n  if (!segment) {\r\n    return state;\r\n  }\r\n\r\n  if (!isInputWireSegment(segment) && !isOutputWireSegment(segment)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    wireSegmentsById: {\r\n      ...state.wireSegmentsById,\r\n      [wireSegmentId]: {\r\n        ...segment,\r\n        lineId,\r\n      },\r\n    },\r\n  };\r\n});\r\n","import { fpSet } from \"@/utils\";\r\n\r\nimport { ZeroPoint } from \"@/geometry\";\r\nimport { isAddElementAction } from \"@/actions/element-add\";\r\n\r\nimport { createCircuitLayoutReducer } from \"../utils\";\r\n\r\nexport default createCircuitLayoutReducer((state, action) => {\r\n  if (!isAddElementAction(action)) {\r\n    return state;\r\n  }\r\n  const { elementId, position = ZeroPoint } = action.payload;\r\n\r\n  return fpSet(state, \"elementPositionsById\", elementId, position);\r\n});\r\n","import difference from \"lodash/difference\";\r\nimport pick from \"lodash/pick\";\r\n\r\nimport { priorityBefore, reducerPriority } from \"@/store/priorities\";\r\n\r\nimport { isDeleteElementAction } from \"@/actions/element-delete\";\r\n\r\nimport circuitGraphElementDeleteReducer from \"@/services/circuit-graph/reducer/element-delete\";\r\n\r\nimport { createCircuitLayoutReducer } from \"../utils\";\r\n\r\n// We need to run this reducer before graph runs, as we want to check what connections are on the element being deleted.\r\nexport default reducerPriority(\r\n  priorityBefore(circuitGraphElementDeleteReducer),\r\n  createCircuitLayoutReducer((state, action) => {\r\n    if (!isDeleteElementAction(action)) {\r\n      return state;\r\n    }\r\n\r\n    const { elementIds } = action.payload;\r\n\r\n    const remainingElementIds = difference(\r\n      Object.keys(state.elementPositionsById),\r\n      elementIds\r\n    );\r\n\r\n    return {\r\n      ...state,\r\n      elementPositionsById: pick(\r\n        state.elementPositionsById,\r\n        remainingElementIds\r\n      ),\r\n    };\r\n  })\r\n);\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { asArray, MaybeArray } from \"@/arrays\";\r\nimport { Point } from \"@/geometry\";\r\n\r\nexport interface ElementMoveOpts {\r\n  relative?: boolean;\r\n  snapMode?: \"none\" | \"element\";\r\n}\r\nexport const ACTION_ELEMENT_MOVE = \"@element/move\" as const;\r\nexport const moveElement = (\r\n  elementId: MaybeArray<string>,\r\n  position: Point,\r\n  opts: ElementMoveOpts = {}\r\n) => ({\r\n  type: ACTION_ELEMENT_MOVE,\r\n  payload: {\r\n    elementIds: asArray(elementId),\r\n    position,\r\n    relative: opts.relative ?? false,\r\n    snapMode: opts.snapMode ?? \"none\",\r\n  },\r\n});\r\nexport type MoveElementAction = ReturnType<typeof moveElement>;\r\nexport function isMoveElementAction(\r\n  action: AnyAction\r\n): action is MoveElementAction {\r\n  return action.type === ACTION_ELEMENT_MOVE;\r\n}\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport elementAddReducer from \"./element-add\";\r\nimport elementDeleteReducer from \"./element-delete\";\r\nimport elementMoveReducer from \"./element-move\";\r\nimport projectNewReducer from \"./project-new\";\r\n\r\nconst fieldReducer = concatReducers(\r\n  elementAddReducer,\r\n  elementDeleteReducer,\r\n  elementMoveReducer,\r\n  projectNewReducer\r\n);\r\n\r\nexport default fieldReducer;\r\n","import mapValues from \"lodash/mapValues\";\r\nimport pick from \"lodash/pick\";\r\n\r\nimport { isMoveElementAction } from \"@/actions/element-move\";\r\n\r\nimport { applyGridElementSnapSelector } from \"@/services/circuit-editor-drag/selectors/snap\";\r\n\r\nimport { createCircuitLayoutReducer } from \"../utils\";\r\n\r\nexport default createCircuitLayoutReducer((state, action, appState) => {\r\n  if (!isMoveElementAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { elementIds, position, relative, snapMode } = action.payload;\r\n\r\n  const movedElementPositions = mapValues(\r\n    pick(state.elementPositionsById, elementIds),\r\n    (p) => {\r\n      let movedP = {\r\n        x: relative ? p.x + position.x : position.x,\r\n        y: relative ? p.y + position.y : position.y,\r\n      };\r\n      if (snapMode === \"element\") {\r\n        movedP = applyGridElementSnapSelector(appState, movedP);\r\n      }\r\n      return movedP;\r\n    }\r\n  );\r\n\r\n  return {\r\n    ...state,\r\n    elementPositionsById: {\r\n      ...state.elementPositionsById,\r\n      ...movedElementPositions,\r\n    },\r\n  };\r\n});\r\n","import { isNewProjectAction } from \"@/actions/project-new\";\r\n\r\nimport { createCircuitLayoutReducer } from \"../utils\";\r\nimport { defaultCircuitLayoutServiceState } from \"../state\";\r\n\r\nexport default createCircuitLayoutReducer((state, action) => {\r\n  if (!isNewProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultCircuitLayoutServiceState;\r\n});\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport circuitAddReducer from \"./circuit-add\";\r\nimport circuitDeleteReducer from \"./circuit-delete\";\r\nimport circuitRenameReducer from \"./circuit-rename\";\r\nimport projectNewReducer from \"./project-new\";\r\n\r\nexport default concatReducers(\r\n  circuitAddReducer,\r\n  circuitDeleteReducer,\r\n  circuitRenameReducer,\r\n  projectNewReducer\r\n);\r\n","import { isAddCircuitAction } from \"@/actions/circuit-add\";\r\nimport { createCircuitPropertiesReducer } from \"../utils\";\r\n\r\nexport default createCircuitPropertiesReducer((state, action) => {\r\n  if (!isAddCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { circuitId } = action.payload;\r\n  let circuitName = action.payload.circuitName;\r\n\r\n  if (!circuitName) {\r\n    circuitName = `Circuit ${\r\n      Object.keys(state.circuitNamesByCircuitId).length + 1\r\n    }`;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    circuitNamesByCircuitId: {\r\n      ...state.circuitNamesByCircuitId,\r\n      [circuitId]: circuitName,\r\n    },\r\n  };\r\n});\r\n","import pick from \"lodash/pick\";\r\n\r\nimport { isDeleteCircuitAction } from \"@/actions/circuit-delete\";\r\n\r\nimport { createCircuitPropertiesReducer } from \"../utils\";\r\n\r\nexport default createCircuitPropertiesReducer((state, action) => {\r\n  if (!isDeleteCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { circuitId } = action.payload;\r\n\r\n  const remainingCircuitIds = Object.keys(state.circuitNamesByCircuitId).filter(\r\n    (x) => x !== circuitId\r\n  );\r\n\r\n  return {\r\n    ...state,\r\n    circuitNamesByCircuitId: pick(\r\n      state.circuitNamesByCircuitId,\r\n      remainingCircuitIds\r\n    ),\r\n  };\r\n});\r\n","import { isRenameCircuitAction } from \"@/actions/circuit-rename\";\r\nimport { createCircuitPropertiesReducer } from \"../utils\";\r\n\r\nexport default createCircuitPropertiesReducer((state, action) => {\r\n  if (!isRenameCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { circuitId, circuitName } = action.payload;\r\n\r\n  const trimmedName = circuitName.trim();\r\n\r\n  if (trimmedName === \"\") {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    circuitNamesByCircuitId: {\r\n      ...state.circuitNamesByCircuitId,\r\n      [circuitId]: trimmedName,\r\n    },\r\n  };\r\n});\r\n","import { isNewProjectAction } from \"@/actions/project-new\";\r\n\r\nimport { ROOT_CIRCUIT_ID } from \"../../circuits/constants\";\r\nimport { createCircuitPropertiesReducer } from \"../utils\";\r\n\r\nexport default createCircuitPropertiesReducer((state, action) => {\r\n  if (!isNewProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    circuitNamesByCircuitId: {\r\n      [ROOT_CIRCUIT_ID]: \"Root\",\r\n    },\r\n    elementIdsByCircuitId: {\r\n      [ROOT_CIRCUIT_ID]: [],\r\n    },\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { asArray, MaybeArray } from \"@/arrays\";\r\n\r\nimport { SaveData } from \"@/services/savedata/types\";\r\n\r\nexport const ACTION_CIRCUIT_IMPORT = \"@circuit/import\" as const;\r\nexport const importCircuits = (\r\n  circuitId: MaybeArray<string>,\r\n  saveData: SaveData\r\n) => ({\r\n  type: ACTION_CIRCUIT_IMPORT,\r\n  payload: { circuitIds: asArray(circuitId), saveData },\r\n});\r\nexport type ImportCircuitAction = ReturnType<typeof importCircuits>;\r\nexport function isImportCircuitAction(\r\n  action: AnyAction\r\n): action is ImportCircuitAction {\r\n  return action.type === ACTION_CIRCUIT_IMPORT;\r\n}\r\n","export class SaveFormatError extends Error {\r\n  code: string;\r\n\r\n  constructor(message: string) {\r\n    super(message);\r\n    this.message = message;\r\n    this.code = \"SAVE_FORMAT_ERROR\";\r\n  }\r\n}\r\n","import { isTruthy } from \"@/utils\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { addElement } from \"@/actions/element-add\";\r\nimport { addCircuit } from \"@/actions/circuit-add\";\r\nimport { hydrateWire } from \"@/actions/wire-hydrate\";\r\n\r\nimport { circuitIdFromElementIdSelector } from \"../circuit-graph/selectors/elements\";\r\nimport {\r\n  elementIdsSelector,\r\n  elementFromElementIdSelector,\r\n} from \"../circuit-graph/selectors/elements\";\r\nimport { wireSegmentHasInput } from \"../circuit-graph/types\";\r\nimport {\r\n  circuitIdForWireIdSelector,\r\n  wireIdsSelector,\r\n  wireJointIdsByWireIdSelector,\r\n  wireSegmentByWireSegmentIdSelector,\r\n  wireSegmentIdsFromWireIdSelector,\r\n} from \"../circuit-graph/selectors/wires\";\r\nimport { elementPositionFromElementIdSelector } from \"../circuit-layout/selectors/element-positions\";\r\nimport { wireJointPositionByJointIdSelector } from \"../circuit-graph/selectors/wire-positions\";\r\nimport {\r\n  circuitIdsSelector,\r\n  circuitNameFromIdSelector,\r\n} from \"../circuit-properties/selectors/circuits\";\r\nimport { ROOT_CIRCUIT_ID } from \"../circuits/constants\";\r\n\r\nimport {\r\n  SaveCircuit,\r\n  SaveData,\r\n  SaveElement,\r\n  SaveWire,\r\n  SaveWireSegment,\r\n  validateSaveData,\r\n} from \"./types\";\r\n\r\nimport { SaveFormatError } from \"./errors\";\r\n\r\nexport function createSave(state: AppState): SaveData {\r\n  const jointPositionsByJointId = wireJointPositionByJointIdSelector(state);\r\n  return {\r\n    circuits: circuitIdsSelector(state).map((circuitId) => {\r\n      const circuitName = circuitNameFromIdSelector(state, circuitId);\r\n      const saveCircuit: SaveCircuit = {\r\n        circuitId,\r\n        circuitName,\r\n      };\r\n      return saveCircuit;\r\n    }),\r\n    elements: elementIdsSelector(state).map((elementId) => {\r\n      const element = elementFromElementIdSelector(state, elementId);\r\n      const position = elementPositionFromElementIdSelector(state, elementId);\r\n      const circuitId = circuitIdFromElementIdSelector(state, elementId);\r\n      const saveElement: SaveElement = {\r\n        elementId: elementId,\r\n        elementType: element.elementType,\r\n        elementName: element.elementName,\r\n        circuitId: circuitId ?? ROOT_CIRCUIT_ID,\r\n        x: position.x,\r\n        y: position.y,\r\n      };\r\n      return saveElement;\r\n    }),\r\n    wires: wireIdsSelector(state)\r\n      .map((wireId) => {\r\n        const jointIds = wireJointIdsByWireIdSelector(state, wireId);\r\n        const circuitId = circuitIdForWireIdSelector(state, wireId);\r\n        if (!circuitId) {\r\n          return null;\r\n        }\r\n        const saveWire: SaveWire = {\r\n          wireId,\r\n          circuitId,\r\n          wireSegments: wireSegmentIdsFromWireIdSelector(state, wireId).map(\r\n            (wireSegmentId) => {\r\n              const segment = wireSegmentByWireSegmentIdSelector(\r\n                state,\r\n                wireSegmentId\r\n              )!;\r\n              const saveWireSegment: SaveWireSegment = {\r\n                wireSegmentId,\r\n                ...segment,\r\n              };\r\n              return saveWireSegment;\r\n            }\r\n          ),\r\n          wireJoints: jointIds.map((jointId) => ({\r\n            jointId,\r\n            ...jointPositionsByJointId[jointId],\r\n          })),\r\n        };\r\n        return saveWire;\r\n      })\r\n      .filter(isTruthy),\r\n  };\r\n}\r\n\r\nexport function loadSave(state: AppState, save: SaveData): AppState {\r\n  try {\r\n    validateSaveData(save);\r\n  } catch (e) {\r\n    throw new SaveFormatError(e.message);\r\n  }\r\n\r\n  // TODO: There may be some services that want to persist data across projects.\r\n  state = defaultAppState;\r\n\r\n  try {\r\n    state = (save.circuits ?? []).reduce(\r\n      (state, { circuitId, circuitName }) =>\r\n        rootReducer(state, addCircuit({ circuitId, circuitName })),\r\n      state\r\n    );\r\n\r\n    state = (save.elements ?? []).reduce(\r\n      (state, element) =>\r\n        rootReducer(\r\n          state,\r\n          addElement(\r\n            element.elementType,\r\n            element.circuitId,\r\n            { x: element.x, y: element.y },\r\n            {\r\n              elementId: element.elementId,\r\n              elementName: element.elementName ?? undefined,\r\n            }\r\n          )\r\n        ),\r\n      state\r\n    );\r\n\r\n    state = (save.wires ?? []).reduce(\r\n      (state, wire) => rootReducer(state, hydrateWire(wire)),\r\n      state\r\n    );\r\n  } catch (e) {\r\n    console.error(\"Failed to rehydrate SaveData:\", e);\r\n    throw new SaveFormatError(\"Failed to load project.\");\r\n  }\r\n\r\n  return state;\r\n}\r\n\r\nexport function importCircuitsFromSave(\r\n  state: AppState,\r\n  circuitIds: string[],\r\n  save: SaveData\r\n): AppState {\r\n  try {\r\n    validateSaveData(save);\r\n  } catch (e) {\r\n    throw new SaveFormatError(e.message);\r\n  }\r\n\r\n  const existingCircuits = Object.keys(\r\n    state.services.circuitProperties.circuitNamesByCircuitId\r\n  );\r\n  const importCircuits = save.circuits.filter(\r\n    (c) =>\r\n      circuitIds.indexOf(c.circuitId) !== -1 &&\r\n      existingCircuits.indexOf(c.circuitId) === -1\r\n  );\r\n  if (importCircuits.length === 0) {\r\n    return state;\r\n  }\r\n\r\n  try {\r\n    state = importCircuits.reduce(\r\n      (state, { circuitId, circuitName }) =>\r\n        rootReducer(state, addCircuit({ circuitId, circuitName })),\r\n      state\r\n    );\r\n\r\n    const importElements = (save.elements ?? []).filter((x) =>\r\n      importCircuits.some(({ circuitId }) => circuitId === x.circuitId)\r\n    );\r\n    state = importElements.reduce(\r\n      (state, element) =>\r\n        rootReducer(\r\n          state,\r\n          addElement(\r\n            element.elementType,\r\n            element.circuitId,\r\n            { x: element.x, y: element.y },\r\n            {\r\n              elementId: element.elementId,\r\n              elementName: element.elementName ?? undefined,\r\n            }\r\n          )\r\n        ),\r\n      state\r\n    );\r\n\r\n    function isImportableWire(wire: SaveWire) {\r\n      return wire.wireSegments.some((segment) => {\r\n        if (!wireSegmentHasInput(segment)) {\r\n          return;\r\n        }\r\n        const { inputPin } = segment;\r\n        return importElements.some(\r\n          (element) => element.elementId === inputPin.elementId\r\n        );\r\n      });\r\n    }\r\n\r\n    const importWires = (save.wires ?? []).filter(isImportableWire);\r\n    state = importWires.reduce(\r\n      (state, wire) => rootReducer(state, hydrateWire(wire)),\r\n      state\r\n    );\r\n  } catch (e) {\r\n    console.error(\"Failed to import circuit from SaveData:\", e);\r\n    throw new SaveFormatError(\"Failed to import circuit.\");\r\n  }\r\n\r\n  return state;\r\n}\r\n","import circuitImportReducer from \"./circuit-import\";\r\n\r\nexport default circuitImportReducer;\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createProjectReducer = createServiceReducerCreator(\"project\");\r\nexport const createProjectSelector = createServiceSelectorCreator(\"project\");\r\n","import { isProjectMutationAction } from \"@/project-mutation-actions\";\r\nimport { createProjectReducer } from \"../utils\";\r\n\r\nexport default createProjectReducer((state, action) => {\r\n  if (!isProjectMutationAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    projectModified: true,\r\n  };\r\n});\r\n","import { isNewProjectAction } from \"@/actions/project-new\";\r\n\r\nimport { createProjectReducer } from \"../utils\";\r\n\r\nexport default createProjectReducer((state, action) => {\r\n  if (!isNewProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    projectName: \"New Project\",\r\n    projectModified: false,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_PROJECT_RENAME = \"@project/rename\" as const;\r\nexport const renameProject = (projectName: string) => ({\r\n  type: ACTION_PROJECT_RENAME,\r\n  payload: { projectName },\r\n});\r\nexport type RenameProjectAction = ReturnType<typeof renameProject>;\r\nexport function isRenameProjectAction(\r\n  action: AnyAction\r\n): action is RenameProjectAction {\r\n  return action.type === ACTION_PROJECT_RENAME;\r\n}\r\n","import { isRenameProjectAction } from \"@/actions/project-rename\";\r\n\r\nimport { createProjectReducer } from \"../utils\";\r\n\r\nexport default createProjectReducer((state, action) => {\r\n  if (!isRenameProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  let { projectName } = action.payload;\r\n  projectName = projectName.trim();\r\n\r\n  if (projectName === \"\") {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    projectName,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_PROJECT_SAVE = \"@project/save\" as const;\r\nexport const saveProject = () => ({\r\n  type: ACTION_PROJECT_SAVE,\r\n});\r\nexport type SaveProjectAction = ReturnType<typeof saveProject>;\r\nexport function isSaveProjectAction(\r\n  action: AnyAction\r\n): action is SaveProjectAction {\r\n  return action.type === ACTION_PROJECT_SAVE;\r\n}\r\n\r\nexport const ACTION_PROJECT_SAVE_SUCCESS = \"@project/save:success\" as const;\r\nexport const saveProjectSuccess = () => ({\r\n  type: ACTION_PROJECT_SAVE_SUCCESS,\r\n});\r\nexport type SaveProjectSuccessAction = ReturnType<typeof saveProjectSuccess>;\r\nexport function isSaveProjectSuccessAction(\r\n  action: AnyAction\r\n): action is SaveProjectSuccessAction {\r\n  return action.type === ACTION_PROJECT_SAVE_SUCCESS;\r\n}\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport projectModifiedReducer from \"./project-modified\";\r\nimport projectNewReducer from \"./project-new\";\r\nimport projectReceiveReducer from \"./project-receive\";\r\nimport projectRenameReducer from \"./project-rename\";\r\nimport projectSaveSuccessReducer from \"./project-save-success\";\r\n\r\nexport default concatReducers(\r\n  projectModifiedReducer,\r\n  projectNewReducer,\r\n  projectReceiveReducer,\r\n  projectRenameReducer,\r\n  projectSaveSuccessReducer\r\n);\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport { fpSet } from \"@/utils\";\r\n\r\nimport { isReceiveProjectAction } from \"@/actions/project-receive\";\r\n\r\nimport { loadSave } from \"@/services/savedata/api\";\r\n\r\nexport default function projectReceiveReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isReceiveProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { fileName, saveData } = action.payload;\r\n\r\n  try {\r\n    state = fpSet(state, \"services\", \"project\", \"projectLoadState\", \"loading\");\r\n    state = loadSave(state, saveData);\r\n    state = fpSet(state, \"services\", \"project\", (state) => ({\r\n      ...state,\r\n      projectLoadState: \"loaded\" as const,\r\n      projectName: fileName,\r\n      projectModified: false,\r\n    }));\r\n  } catch (e) {\r\n    // TODO: display error\r\n    console.error(\"Failed to load save\", e);\r\n    state = fpSet(state, \"services\", \"project\", (state) => ({\r\n      ...state,\r\n      projectLoadState: \"no-project\" as const,\r\n      projectName: \"\",\r\n      projectModified: false,\r\n    }));\r\n  }\r\n\r\n  return state;\r\n}\r\n","import { isSaveProjectSuccessAction } from \"@/actions/project-save\";\r\nimport { createProjectReducer } from \"../utils\";\r\n\r\nexport default createProjectReducer((state, action) => {\r\n  if (!isSaveProjectSuccessAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    projectModified: false,\r\n  };\r\n});\r\n","import difference from \"lodash/difference\";\r\n\r\nimport { isDeleteElementAction } from \"@/actions/element-delete\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\n\r\nexport default createSelectionReducer((state, action) => {\r\n  if (!isDeleteElementAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { elementIds } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    selectedElementIds: difference(state.selectedElementIds, elementIds),\r\n    selectedConnectionIds: [], // Might be removing an element attached to a selected connection\r\n  };\r\n});\r\n","import { isNewProjectAction } from \"@/actions/project-new\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\nimport { defaultSelectionServiceState } from \"../state\";\r\n\r\nexport default createSelectionReducer((state, action) => {\r\n  if (!isNewProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultSelectionServiceState;\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SELECT_CLEAR = \"@select/all\" as const;\r\nexport const selectAll = () => ({\r\n  type: ACTION_SELECT_CLEAR,\r\n});\r\nexport type SelectAllAction = ReturnType<typeof selectAll>;\r\nexport function isSelectAllAction(\r\n  action: AnyAction\r\n): action is SelectAllAction {\r\n  return action.type === ACTION_SELECT_CLEAR;\r\n}\r\n","import { isSelectAllAction } from \"@/actions/select-all\";\r\n\r\nimport { elementIdsFromCircuitIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { activeCircuitIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\nimport {\r\n  wireJointIdsFromCircuitIdSelector,\r\n  wireSegmentIdsFromCircuitIdSelector,\r\n} from \"@/services/circuit-graph/selectors/wires\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\n\r\nexport default createSelectionReducer((state, action, appState) => {\r\n  if (!isSelectAllAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const circuitId = activeCircuitIdSelector(appState);\r\n  if (!circuitId) {\r\n    return state;\r\n  }\r\n\r\n  const elementIds = elementIdsFromCircuitIdSelector(appState, circuitId);\r\n  const jointIds = wireJointIdsFromCircuitIdSelector(appState, circuitId);\r\n  const segmentIds = wireSegmentIdsFromCircuitIdSelector(appState, circuitId);\r\n\r\n  return {\r\n    ...state,\r\n    selectedElementIds: elementIds,\r\n    selectedWireJointIds: jointIds,\r\n    selectedWireSegmentIds: segmentIds,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SELECT_CLEAR = \"@select/clear\" as const;\r\nexport const clearSelection = () => ({\r\n  type: ACTION_SELECT_CLEAR,\r\n});\r\nexport type ClearSelectionAction = ReturnType<typeof clearSelection>;\r\nexport function isClearSelectionAction(\r\n  action: AnyAction\r\n): action is ClearSelectionAction {\r\n  return action.type === ACTION_SELECT_CLEAR;\r\n}\r\n","import { isClearSelectionAction } from \"@/actions/select-clear\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\n\r\nexport default createSelectionReducer((state, action) => {\r\n  if (!isClearSelectionAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    selectedElementIds: [],\r\n    selectedWireJointIds: [],\r\n    selectedWireSegmentIds: [],\r\n  };\r\n});\r\n","import { combineExtraniousSelection, combineSelection } from \"@/selection-mode\";\r\n\r\nimport { isSelectElementsAction } from \"@/actions/select-elements\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\n\r\nexport default createSelectionReducer((state, action) => {\r\n  if (!isSelectElementsAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { elementIds, mode } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    selectedElementIds: combineSelection(\r\n      state.selectedElementIds,\r\n      elementIds,\r\n      mode\r\n    ),\r\n    selectedWireJointIds: combineExtraniousSelection(\r\n      state.selectedWireJointIds,\r\n      mode\r\n    ),\r\n    selectedWireSegmentIds: combineExtraniousSelection(\r\n      state.selectedWireSegmentIds,\r\n      mode\r\n    ),\r\n  };\r\n});\r\n","import { createSelector } from \"reselect\";\r\n\r\nimport mapValues from \"lodash/mapValues\";\r\n\r\nimport { offsetRectangle, ZeroRect } from \"@/geometry\";\r\n\r\nimport { elementTypesByElementIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { elementDefinitionsByTypeSelector } from \"@/services/element-types/selectors/element-types\";\r\n\r\nimport { elementPositionsByElementIdSelector } from \"./element-positions\";\r\n\r\nexport const elementRectsByIdSelector = createSelector(\r\n  elementPositionsByElementIdSelector,\r\n  elementDefinitionsByTypeSelector,\r\n  elementTypesByElementIdSelector,\r\n  (positionsById, elementDefsByType, elementTypesById) =>\r\n    mapValues(positionsById, (position, id) => {\r\n      const type = elementTypesById[id];\r\n      if (!type) {\r\n        return ZeroRect;\r\n      }\r\n      const def = elementDefsByType[type];\r\n      if (!def) {\r\n        return ZeroRect;\r\n      }\r\n\r\n      return offsetRectangle(def.visual.hitRect, position);\r\n    })\r\n);\r\n","import forOwn from \"lodash/forOwn\";\r\nimport pick from \"lodash/pick\";\r\n\r\nimport { rectIntersectsRect, pointIntersectsRect } from \"@/geometry\";\r\nimport { combineSelection } from \"@/selection-mode\";\r\n\r\nimport { isSelectRegionAction } from \"@/actions/select-region\";\r\n\r\nimport { elementIdsFromCircuitIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { elementRectsByIdSelector } from \"@/services/circuit-layout/selectors/element-bounds\";\r\nimport { wireJointPositionByJointIdSelector } from \"@/services/circuit-graph/selectors/wire-positions\";\r\nimport { wireJointIdsFromCircuitIdSelector } from \"@/services/circuit-graph/selectors/wires\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\n\r\nexport default createSelectionReducer((state, action, appState) => {\r\n  if (!isSelectRegionAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { region, circuitId, mode } = action.payload;\r\n\r\n  const elementIds = elementIdsFromCircuitIdSelector(appState, circuitId);\r\n  const rects = pick(elementRectsByIdSelector(appState), elementIds);\r\n\r\n  const chosenElementIds: string[] = [];\r\n  forOwn(rects, (rect, elementId) => {\r\n    if (rectIntersectsRect(rect, region)) {\r\n      chosenElementIds.push(elementId);\r\n    }\r\n  });\r\n\r\n  const jointIds = wireJointIdsFromCircuitIdSelector(appState, circuitId);\r\n  const jointPositions = pick(\r\n    wireJointPositionByJointIdSelector(appState),\r\n    jointIds\r\n  );\r\n  const chosenJointIds: string[] = [];\r\n  forOwn(jointPositions, (p, jointId) => {\r\n    if (pointIntersectsRect(p, region)) {\r\n      chosenJointIds.push(jointId);\r\n    }\r\n  });\r\n\r\n  return {\r\n    ...state,\r\n    selectedElementIds: combineSelection(\r\n      state.selectedElementIds,\r\n      chosenElementIds,\r\n      mode\r\n    ),\r\n    selectedWireJointIds: combineSelection(\r\n      state.selectedWireJointIds,\r\n      chosenJointIds,\r\n      mode\r\n    ),\r\n  };\r\n});\r\n","import { combineExtraniousSelection, combineSelection } from \"@/selection-mode\";\r\n\r\nimport { isSelectWireJointsAction } from \"@/actions/select-wire-joints\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\n\r\nexport default createSelectionReducer((state, action) => {\r\n  if (!isSelectWireJointsAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { jointIds, mode } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    selectedElementIds: combineExtraniousSelection(\r\n      state.selectedElementIds,\r\n      mode\r\n    ),\r\n    selectedWireJointIds: combineSelection(\r\n      state.selectedWireJointIds,\r\n      jointIds,\r\n      mode\r\n    ),\r\n    selectedWireSegmentIds: combineExtraniousSelection(\r\n      state.selectedWireSegmentIds,\r\n      mode\r\n    ),\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { SelectionMode } from \"@/selection-mode\";\r\n\r\nexport const ACTION_SELECT_WIRE_SEGMENTS = \"@select/wire-segments\" as const;\r\nexport const selectWireSegments = (\r\n  segmentId: string | string[],\r\n  mode: SelectionMode = \"set\"\r\n) => ({\r\n  type: ACTION_SELECT_WIRE_SEGMENTS,\r\n  payload: {\r\n    segmentIds: Array.isArray(segmentId) ? segmentId : [segmentId],\r\n    mode,\r\n  },\r\n});\r\nexport type SelectWireSegmentsAction = ReturnType<typeof selectWireSegments>;\r\nexport function isSelectWireSegmentsAction(\r\n  action: AnyAction\r\n): action is SelectWireSegmentsAction {\r\n  return action.type === ACTION_SELECT_WIRE_SEGMENTS;\r\n}\r\n","import { combineExtraniousSelection, combineSelection } from \"@/selection-mode\";\r\n\r\nimport { isSelectWireSegmentsAction } from \"@/actions/select-wire-segments\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\n\r\nexport default createSelectionReducer((state, action) => {\r\n  if (!isSelectWireSegmentsAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { segmentIds, mode } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    selectedElementIds: combineExtraniousSelection(\r\n      state.selectedElementIds,\r\n      mode\r\n    ),\r\n    selectedWireJointIds: combineExtraniousSelection(\r\n      state.selectedWireJointIds,\r\n      mode\r\n    ),\r\n    selectedWireSegmentIds: combineSelection(\r\n      state.selectedWireSegmentIds,\r\n      segmentIds,\r\n      mode\r\n    ),\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SELECTION_COPY = \"@selection/copy\" as const;\r\nexport const copySelection = () => ({\r\n  type: ACTION_SELECTION_COPY,\r\n});\r\nexport type CopySelectionAction = ReturnType<typeof copySelection>;\r\nexport function isCopySelectionAction(\r\n  action: AnyAction\r\n): action is CopySelectionAction {\r\n  return action.type === ACTION_SELECTION_COPY;\r\n}\r\n","import intersection from \"lodash/intersection\";\r\n\r\nimport { isWireJointDeleteAction } from \"@/actions/wire-joint-delete\";\r\n\r\nimport { createSelectionReducer } from \"../utils\";\r\nimport { PRIORITY_POST, reducerPriority } from \"@/store/priorities\";\r\n\r\nexport default reducerPriority(\r\n  PRIORITY_POST,\r\n  createSelectionReducer((state, action, rootState) => {\r\n    if (!isWireJointDeleteAction(action)) {\r\n      return state;\r\n    }\r\n\r\n    const {\r\n      wireJointPositionsByJointId,\r\n      wireSegmentsById,\r\n    } = rootState.services.circuitGraph;\r\n\r\n    return {\r\n      ...state,\r\n      selectedWireJointIds: intersection(\r\n        state.selectedWireJointIds,\r\n        Object.keys(wireJointPositionsByJointId)\r\n      ),\r\n      selectedWireSegmentIds: intersection(\r\n        state.selectedWireSegmentIds,\r\n        Object.keys(wireSegmentsById)\r\n      ),\r\n    };\r\n  })\r\n);\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport elementDeleteReducer from \"./element-delete\";\r\nimport projectNewReducer from \"./project-new\";\r\nimport selectAllReducer from \"./select-all\";\r\nimport selectClearReducer from \"./select-clear\";\r\nimport selectElementsReducer from \"./select-elements\";\r\nimport selectRegionReducer from \"./select-region\";\r\nimport selectWireJointsReducer from \"./select-wire-joints\";\r\nimport selectWireSegmentsReducer from \"./select-wire-segments\";\r\nimport selectionAlignToGrid from \"./selection-align-to-grid\";\r\nimport selectionCopyReducer from \"./selection-copy\";\r\nimport selectionDeleteReducer from \"./selection-delete\";\r\nimport selectionMoveReducer from \"./selection-move\";\r\nimport wireJointDeleteReducer from \"./wire-joint-delete\";\r\n\r\nconst selectionReducer = concatReducers(\r\n  projectNewReducer,\r\n  elementDeleteReducer,\r\n  selectAllReducer,\r\n  selectClearReducer,\r\n  selectElementsReducer,\r\n  selectRegionReducer,\r\n  selectWireJointsReducer,\r\n  selectWireSegmentsReducer,\r\n  selectionAlignToGrid,\r\n  selectionCopyReducer,\r\n  selectionDeleteReducer,\r\n  selectionMoveReducer,\r\n  wireJointDeleteReducer\r\n);\r\n\r\nexport default selectionReducer;\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\nimport { pointEquals } from \"@/geometry\";\r\n\r\nimport { isSelectionAlignToGridAction } from \"@/actions/selection-align-to-grid\";\r\nimport { moveElement } from \"@/actions/element-move\";\r\nimport { moveWireJoint } from \"@/actions/wire-joint-move\";\r\n\r\nimport { elementPositionsByElementIdSelector } from \"@/services/circuit-layout/selectors/element-positions\";\r\nimport {\r\n  applyGridElementSnapSelector,\r\n  applyGridJointSnapSelector,\r\n} from \"@/services/circuit-editor-drag/selectors/snap\";\r\nimport { wireJointPositionByJointIdSelector } from \"@/services/circuit-graph/selectors/wire-positions\";\r\n\r\nexport default function selectionAlignToGridReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isSelectionAlignToGridAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const {\r\n    selectedElementIds,\r\n    selectedWireJointIds: selectedJointIds,\r\n  } = state.services.selection;\r\n\r\n  // Align elements.\r\n  const elementPositions = elementPositionsByElementIdSelector(state);\r\n  for (const elementId of selectedElementIds) {\r\n    const elementPos = elementPositions[elementId];\r\n    if (!elementPos) {\r\n      continue;\r\n    }\r\n\r\n    const snappedPos = applyGridElementSnapSelector(state, elementPos);\r\n    if (!pointEquals(elementPos, snappedPos)) {\r\n      state = rootReducer(state, moveElement(elementId, snappedPos));\r\n    }\r\n  }\r\n\r\n  // Align joints\r\n  const jointPositions = wireJointPositionByJointIdSelector(state);\r\n  for (const jointId of selectedJointIds) {\r\n    const jointPos = jointPositions[jointId];\r\n    if (!jointPos) {\r\n      continue;\r\n    }\r\n\r\n    const snappedPos = applyGridJointSnapSelector(state, jointPos);\r\n    if (!pointEquals(jointPos, snappedPos)) {\r\n      state = rootReducer(state, moveWireJoint(jointId, snappedPos));\r\n    }\r\n  }\r\n\r\n  return state;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { isCopySelectionAction } from \"@/actions/selection-copy\";\r\nimport { copyElements } from \"@/actions/clipboard-copy-elements\";\r\n\r\nimport { selectedElementIdsSelector } from \"@/services/selection/selectors/selection\";\r\n\r\nexport default function selectionCopyReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isCopySelectionAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const selectedElements = selectedElementIdsSelector(state);\r\n  if (selectedElements.length === 0) {\r\n    return state;\r\n  }\r\n\r\n  return rootReducer(state, copyElements(selectedElements));\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { isDeleteSelectionAction } from \"@/actions/selection-delete\";\r\nimport { deleteElement } from \"@/actions/element-delete\";\r\nimport { deleteWireJoint } from \"@/actions/wire-joint-delete\";\r\nimport { deleteWireSegment } from \"@/actions/wire-segment-delete\";\r\n\r\nexport default function selectionDeleteReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isDeleteSelectionAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const {\r\n    selectedElementIds,\r\n    selectedWireJointIds,\r\n    selectedWireSegmentIds,\r\n  } = state.services.selection;\r\n\r\n  if (selectedElementIds.length > 0) {\r\n    state = rootReducer(state, deleteElement(selectedElementIds));\r\n  }\r\n\r\n  if (selectedWireJointIds.length > 0) {\r\n    state = rootReducer(state, deleteWireJoint(selectedWireJointIds));\r\n  }\r\n\r\n  if (selectedWireSegmentIds.length > 0) {\r\n    state = rootReducer(state, deleteWireSegment(selectedWireSegmentIds));\r\n  }\r\n\r\n  return state;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { isMoveSelectionAction } from \"@/actions/selection-move\";\r\nimport { moveElement, ElementMoveOpts } from \"@/actions/element-move\";\r\nimport { moveWireJoint, JointMoveOpts } from \"@/actions/wire-joint-move\";\r\n\r\nimport {\r\n  selectedElementIdsSelector,\r\n  selectedJointIdsSelector,\r\n} from \"@/services/selection/selectors/selection\";\r\n\r\nexport default function selectionMoveReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n) {\r\n  if (!isMoveSelectionAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { offsetX, offsetY, snapMode } = action.payload;\r\n\r\n  const elementIds = selectedElementIdsSelector(state);\r\n  const jointIds = selectedJointIdsSelector(state);\r\n\r\n  const offset: Point = {\r\n    x: offsetX,\r\n    y: offsetY,\r\n  };\r\n\r\n  let elementSnapMode: ElementMoveOpts[\"snapMode\"] = \"none\";\r\n  if (snapMode === \"element\" || snapMode === \"by-type\") {\r\n    elementSnapMode = \"element\";\r\n  }\r\n\r\n  let jointSnapMode: JointMoveOpts[\"snapMode\"] = \"none\";\r\n  if (snapMode === \"by-type\") {\r\n    jointSnapMode = \"joint\";\r\n  } else {\r\n    jointSnapMode = snapMode;\r\n  }\r\n\r\n  state = rootReducer(\r\n    state,\r\n    moveElement(elementIds, offset, {\r\n      relative: true,\r\n      snapMode: elementSnapMode,\r\n    })\r\n  );\r\n\r\n  state = rootReducer(\r\n    state,\r\n    moveWireJoint(jointIds, offset, {\r\n      relative: true,\r\n      snapMode: jointSnapMode,\r\n    })\r\n  );\r\n\r\n  return state;\r\n}\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createSimulatorReducer = createServiceReducerCreator(\"simulator\");\r\nexport const createSimulatorSelector = createServiceSelectorCreator(\r\n  \"simulator\"\r\n);\r\n","import { isProjectMutationAction } from \"@/project-mutation-actions\";\r\n\r\nimport { defaultSimulatorServiceState } from \"../state\";\r\nimport { createSimulatorReducer } from \"../utils\";\r\n\r\nexport default createSimulatorReducer((state, action) => {\r\n  if (!isProjectMutationAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultSimulatorServiceState;\r\n});\r\n","import { EvolverDefinition } from \"../types\";\r\n\r\nfunction asEvolverDef(module: any): EvolverDefinition {\r\n  return module.default as EvolverDefinition;\r\n}\r\n\r\nexport const EvolverDefinitionsByType = {\r\n  \"input-momentary\": asEvolverDef(require(\"./input-momentary\")),\r\n  \"input-toggle\": asEvolverDef(require(\"./input-toggle\")),\r\n\r\n  \"logic-and\": asEvolverDef(require(\"./logic-and\")),\r\n  \"logic-buffer\": asEvolverDef(require(\"./logic-buffer\")),\r\n  \"logic-nand\": asEvolverDef(require(\"./logic-nand\")),\r\n  \"logic-nor\": asEvolverDef(require(\"./logic-nor\")),\r\n  \"logic-not\": asEvolverDef(require(\"./logic-not\")),\r\n  \"logic-or\": asEvolverDef(require(\"./logic-or\")),\r\n  \"logic-xor\": asEvolverDef(require(\"./logic-xor\")),\r\n\r\n  \"output-led\": asEvolverDef(require(\"./output-led\")),\r\n  \"output-seg7\": asEvolverDef(require(\"./output-seg7\")),\r\n\r\n  \"pin-high\": asEvolverDef(require(\"./pin-high\")),\r\n};\r\nexport type EvolverType = keyof typeof EvolverDefinitionsByType;\r\n","import { AppState } from \"@/store\";\r\nimport { EvolverDefinitionsByType } from \"@/evolvers\";\r\n\r\nimport { getEvolverIdFromElementIdPath } from \"../utils\";\r\n\r\nimport { rootCircuitGraphSelector } from \"./graph\";\r\n\r\nexport const evolverIdsByElementIdSelector = (state: AppState) =>\r\n  rootCircuitGraphSelector(state).evolverIdsByElementId;\r\n\r\n/**\r\n * Gets the evolver id for a given element id.\r\n */\r\nexport const evolverIdFromElementIdSelector = (\r\n  state: AppState,\r\n  elementIdPath: string[]\r\n) => {\r\n  const { evolverIdsByElementId } = rootCircuitGraphSelector(state);\r\n  return getEvolverIdFromElementIdPath(evolverIdsByElementId, elementIdPath);\r\n};\r\n\r\n/**\r\n * Get all evolver ids.\r\n *\r\n * WARN: Not react safe.\r\n */\r\nexport const evolverIdsSelector = (state: AppState) => {\r\n  const { evolversById } = rootCircuitGraphSelector(state);\r\n  return Object.keys(evolversById);\r\n};\r\n\r\nexport const evolverTypeFromEvolverId = (\r\n  state: AppState,\r\n  evolverId: string\r\n) => {\r\n  const { evolversById } = rootCircuitGraphSelector(state);\r\n  const evolver = evolversById[evolverId];\r\n  if (!evolver) {\r\n    return null;\r\n  }\r\n\r\n  return evolver.evolverType;\r\n};\r\n\r\nexport const evolverDefFromEvolverId = (state: AppState, evolverId: string) => {\r\n  const type = evolverTypeFromEvolverId(state, evolverId);\r\n  if (!type) {\r\n    return null;\r\n  }\r\n\r\n  return EvolverDefinitionsByType[type] ?? null;\r\n};\r\n","import values from \"lodash/values\";\r\nimport flatMap from \"lodash/flatMap\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { rootCircuitGraphSelector } from \"./graph\";\r\nimport { EvolverPin } from \"../types\";\r\n\r\nconst EmptyIdArray = Object.freeze([] as string[]);\r\nconst EmptyPinInputs = Object.freeze({} as Record<string, EvolverPin>);\r\n\r\n/**\r\n * Gets an array of evolver ids connected to the outputs of the given element id.\r\n * WARN: Not react safe.  For reducer use only.\r\n */\r\nexport const outputEvolverIdsFromEvolverIdSelector = (\r\n  state: AppState,\r\n  evolverId: string\r\n) => {\r\n  const { evolversById } = rootCircuitGraphSelector(state);\r\n\r\n  const evolver = evolversById[evolverId];\r\n  if (!evolver) {\r\n    return EmptyIdArray;\r\n  }\r\n\r\n  return flatMap(values(evolver.outputsByPin), (pins) =>\r\n    pins.map((x) => x.evolverId)\r\n  );\r\n};\r\n\r\n/**\r\n * Gets a map of element input pins to their output sources given an element id.\r\n */\r\nexport const inputPinsByPinIdFromEvolverIdSelector = (\r\n  state: AppState,\r\n  evolverId: string\r\n) => {\r\n  const { evolversById } = rootCircuitGraphSelector(state);\r\n  const evolver = evolversById[evolverId];\r\n  if (!evolver) {\r\n    return EmptyPinInputs;\r\n  }\r\n\r\n  return evolver.inputsByPin;\r\n};\r\n","import binarySearch from \"binary-search\";\r\nimport { v4 as uuidV4 } from \"uuid\";\r\nimport pick from \"lodash/pick\";\r\nimport difference from \"lodash/difference\";\r\n\r\nimport { fpSet } from \"@/utils\";\r\nimport { asArray, dropIndexFp } from \"@/arrays\";\r\nimport { AppState } from \"@/store\";\r\nimport { EvolutionResult, OutputTransition } from \"@/logic\";\r\n\r\nimport {\r\n  inputPinsByPinIdFromEvolverIdSelector,\r\n  outputEvolverIdsFromEvolverIdSelector,\r\n} from \"@/services/simulator-graph/selectors/connections\";\r\nimport {\r\n  evolverIdsSelector,\r\n  evolverDefFromEvolverId,\r\n} from \"@/services/simulator-graph/selectors/elements\";\r\n\r\nimport { SimulatorServiceState, defaultSimulatorServiceState } from \"../state\";\r\nimport { SimTransitionWindow, EvolverPinTransition } from \"../types\";\r\n\r\nexport function simInit(\r\n  state: Readonly<SimulatorServiceState>,\r\n  appState: Readonly<AppState>\r\n): SimulatorServiceState {\r\n  const elementIds = evolverIdsSelector(appState);\r\n\r\n  state = defaultSimulatorServiceState;\r\n\r\n  state = elementIds.reduce(\r\n    (state, elementId) => initNode(state, elementId, appState),\r\n    state\r\n  );\r\n\r\n  state = elementIds.reduce(\r\n    (state, elementId) => collectNodeTransitions(state, elementId, appState),\r\n    state\r\n  );\r\n\r\n  return Object.assign({}, state, { initialized: true });\r\n}\r\n\r\nfunction initNode(\r\n  state: Readonly<SimulatorServiceState>,\r\n  elementId: string,\r\n  appState: Readonly<AppState>\r\n): SimulatorServiceState {\r\n  const def = evolverDefFromEvolverId(appState, elementId);\r\n  if (!def) {\r\n    return state;\r\n  }\r\n\r\n  const outputValues: Record<string, boolean> = {};\r\n  def.outputPins.forEach((output) => {\r\n    outputValues[output] = false;\r\n  });\r\n\r\n  return fpSet(\r\n    state,\r\n    \"evolverOutputValuesByEvolverId\",\r\n    elementId,\r\n    outputValues\r\n  );\r\n}\r\n\r\nexport function simTick(\r\n  state: Readonly<SimulatorServiceState>,\r\n  tickCount: number,\r\n  appState: Readonly<AppState>\r\n): SimulatorServiceState {\r\n  const endTick = state.tick + tickCount;\r\n\r\n  // We cannot grab the windows ahead of time, as some windows might generate more windows\r\n  //  for future ticks.\r\n\r\n  // Pre-clone windows as we wil be repeatedly modifying it.\r\n  state = Object.assign({}, state, {\r\n    transitionWindows: state.transitionWindows.slice(),\r\n  });\r\n\r\n  let saftyCount = tickCount + 1;\r\n  while (\r\n    state.transitionWindows.length > 0 &&\r\n    state.transitionWindows[0].tick <= endTick\r\n  ) {\r\n    if (--saftyCount === 0) {\r\n      // If we have seen more windows than ticks, something is creating windows for past ticks.\r\n      throw new Error(\r\n        `Maximum ticks per sim evolution exceeded.  This is an indication that windows are being generated for past ticks.`\r\n      );\r\n    }\r\n\r\n    // We can safely mutate here, as even if the array is regenerated\r\n    //  from a tick it will still be a fresh copy that has not yet been\r\n    //  consumed by redux.\r\n    const window = state.transitionWindows.shift()!;\r\n    state = tickWindow(state, window, appState);\r\n  }\r\n\r\n  // If we did not encounter a window on our last tick, jump ahead to that tick.\r\n  if (state.tick != endTick) {\r\n    state = Object.assign({}, state, {\r\n      tick: endTick,\r\n    });\r\n  }\r\n\r\n  return state;\r\n}\r\n\r\nfunction tickWindow(\r\n  readonlyState: Readonly<SimulatorServiceState>,\r\n  window: SimTransitionWindow,\r\n  appState: Readonly<AppState>\r\n): SimulatorServiceState {\r\n  if (window.transitionIds.length === 0) {\r\n    return readonlyState;\r\n  }\r\n\r\n  // Update the current tick, as it is referenced\r\n  //  during transition collection.\r\n  let state = Object.assign({}, readonlyState, {\r\n    tick: window.tick,\r\n    // pre-clone outputs for mutation below\r\n    evolverOutputValuesByEvolverId: Object.assign(\r\n      {},\r\n      readonlyState.evolverOutputValuesByEvolverId\r\n    ),\r\n  }) as SimulatorServiceState;\r\n\r\n  const updatedEvolverIds = new Set<string>();\r\n  window.transitionIds.forEach((tid) => {\r\n    const { elementId, valuesByOutputPin } = state.transitionsById[tid];\r\n\r\n    if (\r\n      !isOutputsUpdated(\r\n        state.evolverOutputValuesByEvolverId[elementId],\r\n        valuesByOutputPin\r\n      )\r\n    ) {\r\n      // Values are unchanged from current, evolver will not update.\r\n      return;\r\n    }\r\n\r\n    // evolverOutputValuesByEvolverId is pre-cloned\r\n    state.evolverOutputValuesByEvolverId[elementId] = Object.assign(\r\n      {},\r\n      state.evolverOutputValuesByEvolverId[elementId],\r\n      valuesByOutputPin\r\n    );\r\n\r\n    // Add each evolver we output to, to the output list.\r\n    const outputEvolverIds = outputEvolverIdsFromEvolverIdSelector(\r\n      appState,\r\n      elementId\r\n    );\r\n    outputEvolverIds.forEach((evolverId) => updatedEvolverIds.add(evolverId));\r\n  });\r\n\r\n  // Remove all window transitions as they have been consumed.\r\n  // State is cloned above\r\n  state.transitionsById = pick(\r\n    state.transitionsById,\r\n    difference(Object.keys(state.transitionsById), window.transitionIds)\r\n  );\r\n\r\n  for (const elementId of updatedEvolverIds) {\r\n    state = collectNodeTransitions(state, elementId, appState);\r\n  }\r\n\r\n  return state;\r\n}\r\n\r\nfunction isOutputsUpdated(\r\n  outputs: Record<string, boolean>,\r\n  updates: Record<string, boolean>\r\n) {\r\n  return Object.keys(updates).some((key) => outputs[key] !== updates[key]);\r\n}\r\n\r\nexport function collectNodeTransitions(\r\n  state: Readonly<SimulatorServiceState>,\r\n  elementId: string,\r\n  appState: Readonly<AppState>\r\n): SimulatorServiceState {\r\n  const def = evolverDefFromEvolverId(appState, elementId);\r\n  if (!def || !def.evolve) {\r\n    return state;\r\n  }\r\n\r\n  // Build the current input state from the connected pins.\r\n  const inputs = collectNodeInputs(state, elementId, appState);\r\n  const result = def.evolve(\r\n    state.evolverStatesByEvolverId[elementId],\r\n    inputs,\r\n    state.tick\r\n  );\r\n\r\n  return applyEvolutionResult(state, elementId, result);\r\n}\r\n\r\nexport function applyEvolutionResult(\r\n  state: Readonly<SimulatorServiceState>,\r\n  elementId: string,\r\n  evolutionResult: EvolutionResult\r\n) {\r\n  const { state: evolverState, transitions } = evolutionResult;\r\n\r\n  if (evolverState) {\r\n    state = fpSet(state, \"evolverStatesByEvolverId\", elementId, evolverState);\r\n  }\r\n\r\n  if (transitions) {\r\n    const transitionsArray = asArray(transitions);\r\n    state = transitionsArray.reduce(\r\n      (state, transition, i) =>\r\n        applyOutputTransition(\r\n          state,\r\n          elementId,\r\n          transition,\r\n          i === 0 ? \"replace\" : \"append\"\r\n        ),\r\n      state\r\n    );\r\n  }\r\n\r\n  return state;\r\n}\r\n\r\nfunction collectNodeInputs(\r\n  state: Readonly<SimulatorServiceState>,\r\n  elementId: string,\r\n  appState: Readonly<AppState>\r\n): Record<string, boolean> {\r\n  // Build the current input state from the connected pins.\r\n  const inputs: Record<string, boolean> = {};\r\n  const inputSourcesByPin = inputPinsByPinIdFromEvolverIdSelector(\r\n    appState,\r\n    elementId\r\n  );\r\n\r\n  Object.keys(inputSourcesByPin).forEach((inputPin) => {\r\n    const inputConn = inputSourcesByPin[inputPin];\r\n    if (!inputConn) {\r\n      inputs[inputPin] = false;\r\n      return;\r\n    }\r\n\r\n    const { evolverId, pinId: sourcePinId } = inputConn;\r\n    inputs[inputPin] =\r\n      state.evolverOutputValuesByEvolverId[evolverId]?.[sourcePinId] || false;\r\n  });\r\n\r\n  return inputs;\r\n}\r\n\r\nfunction applyOutputTransition(\r\n  state: Readonly<SimulatorServiceState>,\r\n  elementId: string,\r\n  transition: OutputTransition,\r\n  defaultMerger: \"replace\" | \"append\" = \"replace\"\r\n): SimulatorServiceState {\r\n  const {\r\n    tickOffset,\r\n    valuesByPin,\r\n    transitionMerger = defaultMerger,\r\n  } = transition;\r\n\r\n  // Sanity check that we are not producing transitions for the past or current tick.\r\n  const transitionTick = state.tick + (tickOffset > 0 ? tickOffset : 1);\r\n\r\n  // We originally removed old transitions when scheduling new transitions.\r\n  //  Experimenting without this.\r\n  if (transitionMerger === \"replace\") {\r\n    state = removeTransitionsByEvolverId(state, elementId);\r\n  }\r\n\r\n  return addTransition(state, elementId, transitionTick, valuesByPin);\r\n}\r\n\r\nfunction addTransition(\r\n  state: Readonly<SimulatorServiceState>,\r\n  elementId: string,\r\n  tick: number,\r\n  valuesByOutputPin: Record<string, boolean>\r\n): SimulatorServiceState {\r\n  const transitionId = uuidV4();\r\n\r\n  const newTransition: EvolverPinTransition = {\r\n    elementId,\r\n    tick,\r\n    valuesByOutputPin,\r\n  };\r\n\r\n  // Prepare the new transition window.\r\n  const transitionWindows = state.transitionWindows.slice();\r\n\r\n  let index = binarySearch(transitionWindows, tick, (a, b) => a.tick - b);\r\n  if (index < 0) {\r\n    // Need to create a new window\r\n    index = -index - 1;\r\n    const newWindow: SimTransitionWindow = {\r\n      tick,\r\n      transitionIds: [],\r\n    };\r\n    transitionWindows.splice(index, 0, newWindow);\r\n  }\r\n\r\n  const transitionIds = transitionWindows[index].transitionIds.slice();\r\n  transitionIds.push(transitionId);\r\n\r\n  transitionWindows[index] = Object.assign({}, transitionWindows[index], {\r\n    transitionIds,\r\n  });\r\n\r\n  const transitionsById = Object.assign({}, state.transitionsById, {\r\n    [transitionId]: newTransition,\r\n  });\r\n\r\n  return Object.assign({}, state, {\r\n    // Add the new transition window to the id mapping.\r\n    transitionsById,\r\n    transitionWindows,\r\n  });\r\n}\r\n\r\nfunction removeTransitionsByEvolverId(\r\n  state: Readonly<SimulatorServiceState>,\r\n  elementId: string\r\n): SimulatorServiceState {\r\n  function isElementTransition(transition: EvolverPinTransition) {\r\n    return transition.elementId === elementId;\r\n  }\r\n\r\n  const transitionIds = Object.keys(state.transitionsById).filter((id) =>\r\n    isElementTransition(state.transitionsById[id])\r\n  );\r\n\r\n  return transitionIds.reduce(\r\n    (state, transitionId) => removeTransitionById(state, transitionId),\r\n    state\r\n  );\r\n}\r\n\r\nexport function removeTransitionById(\r\n  state: Readonly<SimulatorServiceState>,\r\n  transitionId: string\r\n): SimulatorServiceState {\r\n  const transition = state.transitionsById[transitionId];\r\n  if (!transition) {\r\n    return state;\r\n  }\r\n\r\n  const transitionsById = pick(\r\n    state.transitionsById,\r\n    Object.keys(state.transitionsById).filter((x) => x !== transitionId)\r\n  );\r\n  let transitionWindows = state.transitionWindows;\r\n\r\n  const transitionWindowIndex = binarySearch(\r\n    transitionWindows,\r\n    transition.tick,\r\n    (a, b) => a.tick - b\r\n  );\r\n  if (transitionWindowIndex >= 0) {\r\n    const transitionWindow = transitionWindows[transitionWindowIndex];\r\n    const { transitionIds } = transitionWindow;\r\n\r\n    const tickWindowTransitionIndex = transitionWindow.transitionIds.indexOf(\r\n      transitionId\r\n    );\r\n    if (tickWindowTransitionIndex !== -1) {\r\n      if (transitionWindow.transitionIds.length === 1) {\r\n        // Only one element left, remove the window.\r\n        transitionWindows = dropIndexFp(\r\n          transitionWindows,\r\n          transitionWindowIndex\r\n        );\r\n      } else {\r\n        // Remove the transition from the tick window.\r\n        transitionWindows = transitionWindows.slice();\r\n        transitionWindows[transitionWindowIndex] = Object.assign(\r\n          {},\r\n          transitionWindows[transitionWindowIndex],\r\n          {\r\n            transitionIds: dropIndexFp(\r\n              transitionIds,\r\n              tickWindowTransitionIndex\r\n            ),\r\n          }\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  return Object.assign({}, state, {\r\n    transitionsById,\r\n    transitionWindows,\r\n  });\r\n}\r\n","import { EvolverDefinitionsByType } from \"@/evolvers\";\r\n\r\nimport { isInteractElementAction } from \"@/actions/element-interact\";\r\nimport {\r\n  evolverIdFromElementIdSelector,\r\n  evolverTypeFromEvolverId,\r\n} from \"@/services/simulator-graph/selectors/elements\";\r\n\r\nimport { createSimulatorReducer } from \"../utils\";\r\n\r\nimport { applyEvolutionResult } from \"./utils\";\r\n\r\nexport default createSimulatorReducer((state, action, appState) => {\r\n  if (!isInteractElementAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { elementIdPath, data } = action.payload;\r\n  const evolverId = evolverIdFromElementIdSelector(appState, elementIdPath);\r\n\r\n  if (!evolverId) {\r\n    return state;\r\n  }\r\n\r\n  const elementType = evolverTypeFromEvolverId(appState, evolverId);\r\n  if (!elementType) {\r\n    return state;\r\n  }\r\n\r\n  const def = EvolverDefinitionsByType[elementType];\r\n  if (!def || !def.interact) {\r\n    return state;\r\n  }\r\n\r\n  const evolverState = state.evolverStatesByEvolverId[evolverId];\r\n  const evolutionResult = def.interact(evolverState, data);\r\n\r\n  return applyEvolutionResult(state, evolverId, evolutionResult);\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SIM_START = \"@sim/start\" as const;\r\nexport const startSim = () => ({\r\n  type: ACTION_SIM_START,\r\n});\r\nexport type StartSimAction = ReturnType<typeof startSim>;\r\nexport function isStartSimAction(action: AnyAction): action is StartSimAction {\r\n  return action.type === ACTION_SIM_START;\r\n}\r\n","import { isStartSimAction } from \"@/actions/sim-start\";\r\n\r\nimport { createSimulatorReducer } from \"../utils\";\r\n\r\nimport { simInit } from \"./utils\";\r\n\r\nexport default createSimulatorReducer((state, action, appState) => {\r\n  if (!isStartSimAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return simInit(state, appState);\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SIM_STEP = \"@sim/step\" as const;\r\nexport const stepSim = () => ({\r\n  type: ACTION_SIM_STEP,\r\n});\r\nexport type StepSimAction = ReturnType<typeof stepSim>;\r\nexport function isStepSimAction(action: AnyAction): action is StepSimAction {\r\n  return action.type === ACTION_SIM_STEP;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SIM_TICK = \"@sim/tick\" as const;\r\nexport const tickSim = (tickCount: number) => ({\r\n  type: ACTION_SIM_TICK,\r\n  payload: { tickCount },\r\n});\r\nexport type TickSimAction = ReturnType<typeof tickSim>;\r\nexport function isTickSimAction(action: AnyAction): action is TickSimAction {\r\n  return action.type === ACTION_SIM_TICK;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SIM_STOP = \"@sim/stop\" as const;\r\nexport const stopSim = () => ({\r\n  type: ACTION_SIM_STOP,\r\n});\r\nexport type StartSimAction = ReturnType<typeof stopSim>;\r\nexport function isStopSimAction(action: AnyAction): action is StartSimAction {\r\n  return action.type === ACTION_SIM_STOP;\r\n}\r\n","import { isStopSimAction } from \"@/actions/sim-stop\";\r\n\r\nimport { defaultSimulatorServiceState } from \"../state\";\r\n\r\nimport { createSimulatorReducer } from \"../utils\";\r\n\r\nexport default createSimulatorReducer((state, action) => {\r\n  if (!isStopSimAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultSimulatorServiceState;\r\n});\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport circuitGraphInvalidatedReducer from \"./circuit-graph-invalidated\";\r\nimport elementInteractReducer from \"./element-interact\";\r\nimport simStartReducer from \"./sim-start\";\r\nimport simStepReducer from \"./sim-step\";\r\nimport simStopReducer from \"./sim-stop\";\r\nimport simTickReducer from \"./sim-tick\";\r\n\r\nconst simulatorReducer = concatReducers(\r\n  circuitGraphInvalidatedReducer,\r\n  elementInteractReducer,\r\n  simStartReducer,\r\n  simStepReducer,\r\n  simStopReducer,\r\n  simTickReducer\r\n);\r\n\r\nexport default simulatorReducer;\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { fpSet } from \"@/utils\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { isStepSimAction } from \"@/actions/sim-step\";\r\nimport { tickSim } from \"@/actions/sim-tick\";\r\n\r\nimport { simInit } from \"./utils\";\r\n\r\nexport default function (\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isStepSimAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { initialized } = state.services.simulator;\r\n  if (!initialized) {\r\n    state = fpSet(state, \"services\", \"simulator\", (simState) =>\r\n      simInit(simState, state)\r\n    );\r\n  }\r\n\r\n  // These may have changed as a result of the init process.\r\n  const { tick, transitionWindows } = state.services.simulator;\r\n  if (transitionWindows.length === 0) {\r\n    return state;\r\n  }\r\n\r\n  const windowTick = transitionWindows[0].tick;\r\n\r\n  return rootReducer(state, tickSim(windowTick - tick));\r\n}\r\n","import { isTickSimAction } from \"@/actions/sim-tick\";\r\n\r\nimport { createSimulatorReducer } from \"../utils\";\r\n\r\nimport { simTick } from \"./utils\";\r\n\r\nexport default createSimulatorReducer((state, action, appState) => {\r\n  if (!isTickSimAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { tickCount } = action.payload;\r\n\r\n  const start = performance.now();\r\n\r\n  state = simTick(state, tickCount, appState);\r\n\r\n  const end = performance.now();\r\n\r\n  const updateTime = end - start;\r\n  state = {\r\n    ...state,\r\n    lastTickProcessingTimeMs: updateTime,\r\n  };\r\n\r\n  return state;\r\n});\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createSimulatorControlReducer = createServiceReducerCreator(\r\n  \"simulatorControl\"\r\n);\r\nexport const createSimulatorControlSelector = createServiceSelectorCreator(\r\n  \"simulatorControl\"\r\n);\r\n","import { isProjectMutationAction } from \"@/project-mutation-actions\";\r\n\r\nimport { createSimulatorControlReducer } from \"../utils\";\r\n\r\nexport default createSimulatorControlReducer((state, action) => {\r\n  if (!isProjectMutationAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    mode: \"edit\",\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_SIM_PAUSE = \"@sim/pause\" as const;\r\nexport const pauseSim = (mode: boolean | \"toggle\") => ({\r\n  type: ACTION_SIM_PAUSE,\r\n  payload: { mode },\r\n});\r\nexport type PauseSimAction = ReturnType<typeof pauseSim>;\r\nexport function isPauseSimAction(action: AnyAction): action is PauseSimAction {\r\n  return action.type === ACTION_SIM_PAUSE;\r\n}\r\n","import { createSimulatorControlSelector } from \"../utils\";\r\n\r\nexport const isSimActiveSelector = createSimulatorControlSelector(\r\n  (state) => state.mode !== \"edit\"\r\n);\r\n\r\nexport const isSimRunningSelector = createSimulatorControlSelector(\r\n  (state) => state.mode === \"run\"\r\n);\r\n\r\nexport const isSimPausedSelector = createSimulatorControlSelector(\r\n  (state) => state.mode === \"pause\"\r\n);\r\n\r\nexport const ticksPerSecondSelector = createSimulatorControlSelector(\r\n  (state) => state.ticksPerSecond\r\n);\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport circuitGraphInvalidatedReducer from \"./circuit-graph-invalidated\";\r\nimport simPauseReducer from \"./sim-pause\";\r\nimport simStartReducer from \"./sim-start\";\r\nimport simStepReducer from \"./sim-step\";\r\nimport simStopReducer from \"./sim-stop\";\r\n\r\nconst simulatorReducer = concatReducers(\r\n  circuitGraphInvalidatedReducer,\r\n  simPauseReducer,\r\n  simStartReducer,\r\n  simStepReducer,\r\n  simStopReducer\r\n);\r\n\r\nexport default simulatorReducer;\r\n","import { isPauseSimAction } from \"@/actions/sim-pause\";\r\n\r\nimport { createSimulatorControlReducer } from \"../utils\";\r\nimport { isSimActiveSelector } from \"../selectors/run\";\r\n\r\nexport default createSimulatorControlReducer((state, action) => {\r\n  if (!isPauseSimAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { mode } = action.payload;\r\n\r\n  if (!isSimActiveSelector.local(state)) {\r\n    return state;\r\n  }\r\n\r\n  let runMode = state.mode;\r\n\r\n  switch (mode) {\r\n    case true:\r\n      runMode = \"pause\";\r\n      break;\r\n    case false:\r\n      runMode = \"run\";\r\n      break;\r\n    case \"toggle\":\r\n      runMode = runMode == \"run\" ? \"pause\" : \"run\";\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    mode: runMode,\r\n  };\r\n});\r\n","import { isStartSimAction } from \"@/actions/sim-start\";\r\n\r\nimport { createSimulatorControlReducer } from \"../utils\";\r\n\r\nexport default createSimulatorControlReducer((state, action) => {\r\n  if (!isStartSimAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    mode: \"run\",\r\n  };\r\n});\r\n","import { isStepSimAction } from \"@/actions/sim-step\";\r\n\r\nimport { createSimulatorControlReducer } from \"../utils\";\r\n\r\nexport default createSimulatorControlReducer((state, action) => {\r\n  if (!isStepSimAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    mode: \"pause\",\r\n  };\r\n});\r\n","import { isStopSimAction } from \"@/actions/sim-stop\";\r\n\r\nimport { createSimulatorControlReducer } from \"../utils\";\r\n\r\nimport { defaultSimulatorControlServiceState } from \"../state\";\r\n\r\nexport default createSimulatorControlReducer((state, action) => {\r\n  if (!isStopSimAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  // Reset the simulator but keep the ticks per second choice.\r\n  return {\r\n    ...defaultSimulatorControlServiceState,\r\n    ticksPerSecond: state.ticksPerSecond,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { MaybeArray } from \"@/arrays\";\r\nimport { AnnotatedElement } from \"@/services/tutorial/state\";\r\n\r\nexport const ACTION_TUTORIAL_ANNOTATE = \"@tutorial/annotate\" as const;\r\nexport const tutorialAnnotate = (\r\n  annotations: MaybeArray<AnnotatedElement>\r\n) => ({\r\n  type: ACTION_TUTORIAL_ANNOTATE,\r\n  payload: { annotations },\r\n});\r\nexport type TutorialAnnotateAction = ReturnType<typeof tutorialAnnotate>;\r\nexport function isTutorialAnnotateAction(\r\n  action: AnyAction\r\n): action is TutorialAnnotateAction {\r\n  return action.type === ACTION_TUTORIAL_ANNOTATE;\r\n}\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createTutorialReducer = createServiceReducerCreator(\"tutorial\");\r\nexport const createTutorialSelector = createServiceSelectorCreator(\"tutorial\");\r\n","import { asArray } from \"@/arrays\";\r\n\r\nimport { isTutorialAnnotateAction } from \"@/actions/tutorial-annotate\";\r\n\r\nimport { createTutorialReducer } from \"../utils\";\r\n\r\nexport default createTutorialReducer((state, action) => {\r\n  if (!isTutorialAnnotateAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { annotations } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    annotatedElements: asArray(annotations),\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_TUTORIAL_DISMISS = \"@tutorial/dismiss\" as const;\r\nexport const tutorialDismiss = () => ({\r\n  type: ACTION_TUTORIAL_DISMISS,\r\n});\r\nexport type TutorialDismissAction = ReturnType<typeof tutorialDismiss>;\r\nexport function isTutorialDismissAction(\r\n  action: AnyAction\r\n): action is TutorialDismissAction {\r\n  return action.type === ACTION_TUTORIAL_DISMISS;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_TUTORIAL_START = \"@tutorial/start\" as const;\r\nexport const tutorialStart = (tutorial: string) => ({\r\n  type: ACTION_TUTORIAL_START,\r\n  payload: { tutorial },\r\n});\r\nexport type TutorialStartAction = ReturnType<typeof tutorialStart>;\r\nexport function isTutorialStartAction(\r\n  action: AnyAction\r\n): action is TutorialStartAction {\r\n  return action.type === ACTION_TUTORIAL_START;\r\n}\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport tutorialAnnotateReducer from \"./tutorial-annotate\";\r\nimport tutorialDismissReducer from \"./tutorial-dismiss\";\r\nimport tutorialStartReducer from \"./tutorial-start\";\r\n\r\nexport default concatReducers(\r\n  tutorialAnnotateReducer,\r\n  tutorialDismissReducer,\r\n  tutorialStartReducer\r\n);\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\n\r\nimport { isTutorialDismissAction } from \"@/actions/tutorial-dismiss\";\r\n\r\nexport default (state: AppState = defaultAppState, action: AnyAction) => {\r\n  if (!isTutorialDismissAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return state.services.tutorial.preTutorialState ?? defaultAppState;\r\n};\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { fpSet } from \"@/utils\";\r\nimport { AppState, defaultAppState } from \"@/store\";\r\n\r\nimport { isTutorialStartAction } from \"@/actions/tutorial-start\";\r\n\r\nexport default (state: AppState = defaultAppState, action: AnyAction) => {\r\n  if (!isTutorialStartAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { tutorial } = action.payload;\r\n\r\n  let { preTutorialState } = state.services.tutorial;\r\n  if (!preTutorialState) {\r\n    preTutorialState = state;\r\n  }\r\n\r\n  state = defaultAppState;\r\n\r\n  state = fpSet(state, \"services\", \"project\", \"projectName\", \"Tutorial\");\r\n\r\n  state = fpSet(state, \"services\", \"tutorial\", {\r\n    activeTutorial: tutorial,\r\n    annotatedElements: [],\r\n    preTutorialState,\r\n  });\r\n\r\n  return state;\r\n};\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createUiLayoutReducer = createServiceReducerCreator(\"uiLayout\");\r\nexport const createUiLayoutSelector = createServiceSelectorCreator(\"uiLayout\");\r\n","import { priorityBefore, reducerPriority } from \"@/store/priorities\";\r\n\r\nimport { isDeleteCircuitAction } from \"@/actions/circuit-delete\";\r\n\r\nimport { filterTesselValues } from \"@/components/Tessel/utils\";\r\n\r\nimport { isCircuitEditorTesselWindow } from \"@/pages/ProjectEditorPage/windows/CircuitEditorWindow/tessel-window\";\r\n\r\nimport { editorIdsFromCircuitIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\nimport circuitEditorsCircuitDeleteReducer from \"@/services/circuit-editors/reducer/circuit-delete\";\r\n\r\nimport { createUiLayoutReducer } from \"../utils\";\r\n\r\nexport default reducerPriority(\r\n  priorityBefore(circuitEditorsCircuitDeleteReducer),\r\n  createUiLayoutReducer((state, action, appState) => {\r\n    if (!isDeleteCircuitAction(action)) {\r\n      return state;\r\n    }\r\n\r\n    if (!state.layout) {\r\n      return state;\r\n    }\r\n\r\n    const { circuitId } = action.payload;\r\n\r\n    const removedWindowIds = editorIdsFromCircuitIdSelector(\r\n      appState,\r\n      circuitId\r\n    );\r\n\r\n    const layout = filterTesselValues(state.layout, (value) => {\r\n      if (!isCircuitEditorTesselWindow(value)) {\r\n        return true;\r\n      }\r\n\r\n      if (removedWindowIds.indexOf(value.windowProps.editorId) !== -1) {\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    });\r\n\r\n    return {\r\n      ...state,\r\n      layout,\r\n    };\r\n  })\r\n);\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { TesselValue } from \"@/components/Tessel\";\r\n\r\nexport const ACTION_LAYOUT_REARRANGE = \"@layout/rearrange\" as const;\r\nexport const rearrangeLayout = (layout: TesselValue) => ({\r\n  type: ACTION_LAYOUT_REARRANGE,\r\n  payload: { layout },\r\n});\r\nexport type RearrangeLayoutActionType = ReturnType<typeof rearrangeLayout>;\r\nexport function isRearrangeLayoutAction(\r\n  action: AnyAction\r\n): action is RearrangeLayoutActionType {\r\n  return action.type === ACTION_LAYOUT_REARRANGE;\r\n}\r\n","import { isRearrangeLayoutAction } from \"@/actions/layout-rearrange\";\r\nimport { createUiLayoutReducer } from \"../utils\";\r\n\r\nexport default createUiLayoutReducer((state, action) => {\r\n  if (!isRearrangeLayoutAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { layout } = action.payload;\r\n\r\n  return {\r\n    ...state,\r\n    layout,\r\n  };\r\n});\r\n","import { isNewProjectAction } from \"@/actions/project-new\";\r\nimport { defaultUiLayoutServiceState } from \"../state\";\r\nimport { createUiLayoutReducer } from \"../utils\";\r\n\r\nexport default createUiLayoutReducer((state, action) => {\r\n  if (!isNewProjectAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultUiLayoutServiceState;\r\n});\r\n","import { isViewCircuitAction } from \"@/actions/view-circuit\";\r\n\r\nimport { normalizeTesselItem, TesselValue } from \"@/components/Tessel\";\r\nimport { findAndReplaceTesselValue } from \"@/components/Tessel/utils\";\r\n\r\nimport {\r\n  circuitEditorTesselWindow,\r\n  isCircuitEditorTesselWindow,\r\n} from \"@/pages/ProjectEditorPage/windows/CircuitEditorWindow/tessel-window\";\r\nimport { activeCircuitEditorIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\n\r\nimport { createUiLayoutReducer } from \"../utils\";\r\n\r\nexport default createUiLayoutReducer((state, action, appState) => {\r\n  if (!isViewCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { newWindowId } = action.payload;\r\n\r\n  if (!newWindowId) {\r\n    return state;\r\n  }\r\n\r\n  const window = circuitEditorTesselWindow(newWindowId);\r\n  const activeEditorId = activeCircuitEditorIdSelector(appState);\r\n\r\n  let layout: TesselValue | null = state.layout;\r\n\r\n  if (layout == null) {\r\n    layout = window;\r\n  } else {\r\n    let inserted = false;\r\n\r\n    // Try inserting the window alongside the active editor.\r\n    layout = findAndReplaceTesselValue(layout, (value) => {\r\n      const normalized = normalizeTesselItem(value);\r\n      if (\r\n        isCircuitEditorTesselWindow(normalized) &&\r\n        normalized.windowProps.editorId === activeEditorId\r\n      ) {\r\n        inserted = true;\r\n        return {\r\n          direction: \"row\",\r\n          division: 50,\r\n          first: value,\r\n          second: window,\r\n        };\r\n      }\r\n\r\n      return null;\r\n    });\r\n\r\n    if (!inserted) {\r\n      layout = {\r\n        direction: \"row\",\r\n        division: 50,\r\n        first: layout,\r\n        second: window,\r\n      };\r\n    }\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    layout,\r\n  };\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const VIEW_RESET = \"@view/reset\" as const;\r\nexport const resetView = () => ({\r\n  type: VIEW_RESET,\r\n});\r\nexport type ResetViewAction = ReturnType<typeof resetView>;\r\nexport function isResetViewAction(\r\n  action: AnyAction\r\n): action is ResetViewAction {\r\n  return action.type === VIEW_RESET;\r\n}\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport circuitDeleteReducer from \"./circuit-delete\";\r\nimport layoutRearrangeReducer from \"./layout-rearrange\";\r\nimport projectNewReducer from \"./project-new\";\r\nimport viewCircuitReducer from \"./view-circuit\";\r\nimport viewResetReducer from \"./view-reset\";\r\n\r\nexport default concatReducers(\r\n  circuitDeleteReducer,\r\n  layoutRearrangeReducer,\r\n  projectNewReducer,\r\n  viewCircuitReducer,\r\n  viewResetReducer\r\n);\r\n","import { isResetViewAction } from \"@/actions/view-reset\";\r\nimport { defaultUiLayoutServiceState } from \"../state\";\r\nimport { createUiLayoutReducer } from \"../utils\";\r\n\r\nexport default createUiLayoutReducer((state, action) => {\r\n  if (!isResetViewAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  return defaultUiLayoutServiceState;\r\n});\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const VIEW_ELEMENT_NAMES = \"@view/element-names\" as const;\r\nexport const viewElementNames = (mode: \"all\" | \"named-only\" | \"none\") => ({\r\n  type: VIEW_ELEMENT_NAMES,\r\n  payload: { mode },\r\n});\r\nexport type ViewElementNamesAction = ReturnType<typeof viewElementNames>;\r\nexport function isViewElementNamesAction(\r\n  action: AnyAction\r\n): action is ViewElementNamesAction {\r\n  return action.type === VIEW_ELEMENT_NAMES;\r\n}\r\n","import {\r\n  createServiceReducerCreator,\r\n  createServiceSelectorCreator,\r\n} from \"../service-state-utils\";\r\n\r\nexport const createUiSettingsReducer = createServiceReducerCreator(\r\n  \"uiSettings\"\r\n);\r\nexport const createUiSettingsSelector = createServiceSelectorCreator(\r\n  \"uiSettings\"\r\n);\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport viewElementNamesReducer from \"./view-element-names\";\r\n\r\nexport default concatReducers(viewElementNamesReducer);\r\n","import { isViewElementNamesAction } from \"@/actions/view-element-names\";\r\nimport { createUiSettingsReducer } from \"../utils\";\r\n\r\nexport default createUiSettingsReducer((state, action) => {\r\n  if (!isViewElementNamesAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { mode } = action.payload;\r\n  return {\r\n    ...state,\r\n    elementNameMode: mode,\r\n  };\r\n});\r\n","import servicesReducer from \"@/services/reducer\";\r\n\r\nimport { finalizeReducerList } from \"./utils\";\r\n\r\nconst reducer = finalizeReducerList(servicesReducer);\r\n\r\nexport default reducer;\r\n","import { concatReducers } from \"@/store/utils\";\r\n\r\nimport circuitEditorUiDragReducer from \"./circuit-editor-drag/reducer\";\r\nimport circuitEditorsReducer from \"./circuit-editors/reducer\";\r\nimport clipboardReducer from \"./clipboard/reducer\";\r\nimport dialogReducer from \"./dialog/reducer\";\r\nimport circuitGraphReducer from \"./circuit-graph/reducer\";\r\nimport circuitLayoutReducer from \"./circuit-layout/reducer\";\r\nimport circuitPropertiesReducer from \"./circuit-properties/reducer\";\r\nimport circuitsReducer from \"./circuits/reducer\";\r\nimport projectReducer from \"./project/reducer\";\r\nimport selectionReducer from \"./selection/reducer\";\r\nimport simulatorReducer from \"./simulator/reducer\";\r\nimport simulatorControlReducer from \"./simulator-control/reducers\";\r\nimport tutorialReducer from \"./tutorial/reducer\";\r\nimport uiLayoutReducer from \"./ui-layout/reducer\";\r\nimport uiSettingsReducer from \"./ui-settings/reducer\";\r\n\r\nconst reducer = concatReducers(\r\n  circuitEditorUiDragReducer,\r\n  circuitEditorsReducer,\r\n  clipboardReducer,\r\n  dialogReducer,\r\n  circuitGraphReducer,\r\n  circuitLayoutReducer,\r\n  circuitPropertiesReducer,\r\n  circuitsReducer,\r\n  projectReducer,\r\n  selectionReducer,\r\n  simulatorReducer,\r\n  simulatorControlReducer,\r\n  tutorialReducer,\r\n  uiLayoutReducer,\r\n  uiSettingsReducer\r\n);\r\n\r\nexport default reducer;\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\n\r\nimport { isImportCircuitAction } from \"@/actions/circuit-import\";\r\nimport { importCircuitsFromSave } from \"@/services/savedata/api\";\r\n\r\nexport default function circuitImportReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isImportCircuitAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { circuitIds, saveData } = action.payload;\r\n\r\n  return importCircuitsFromSave(state, circuitIds, saveData);\r\n}\r\n","import { createTutorialSelector } from \"../utils\";\r\n\r\nexport const isTutorialActiveSelector = createTutorialSelector(\r\n  (s) => s.activeTutorial != null\r\n);\r\n\r\nexport const tutorialAnnotationsSelector = createTutorialSelector(\r\n  (s) => s.annotatedElements\r\n);\r\n","import { select, takeEvery } from \"@redux-saga/core/effects\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { PROJECT_MUTATION_ACTIONS } from \"@/project-mutation-actions\";\r\n\r\nimport { createSave } from \"@/services/savedata/api\";\r\nimport { isTutorialActiveSelector } from \"@/services/tutorial/selectors/tutorial\";\r\n\r\nimport { storeAutosave } from \"../api\";\r\n\r\nexport default function* projectMutateSaga() {\r\n  yield takeEvery(PROJECT_MUTATION_ACTIONS, handleProjectMutateAction);\r\n}\r\n\r\nfunction* handleProjectMutateAction() {\r\n  const state: AppState = yield select();\r\n\r\n  if (isTutorialActiveSelector(state)) {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const save = createSave(state);\r\n    storeAutosave(save);\r\n  } catch (e) {\r\n    console.error(\"Failed to make autosave:\", e);\r\n  }\r\n}\r\n","import { SaveData } from \"../savedata/types\";\r\n\r\nexport function storeAutosave(save: SaveData): void {\r\n  localStorage.setItem(\"autosave\", JSON.stringify(save));\r\n}\r\n\r\nexport function hasAutosave(): boolean {\r\n  const str = localStorage.getItem(\"autosave\");\r\n  return Boolean(str);\r\n}\r\n\r\nexport function loadAutosave(): SaveData | null {\r\n  const str = localStorage.getItem(\"autosave\");\r\n  if (!str) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    return JSON.parse(str);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function deleteAutosave() {\r\n  localStorage.removeItem(\"autosave\");\r\n}\r\n","import { takeEvery } from \"@redux-saga/core/effects\";\r\n\r\nimport { ACTION_PROJECT_NEW } from \"@/actions/project-new\";\r\n\r\nimport { deleteAutosave } from \"../api\";\r\n\r\nexport default function* projectResetSaga() {\r\n  yield takeEvery(ACTION_PROJECT_NEW, handleProjectNewAction);\r\n}\r\n\r\nfunction* handleProjectNewAction() {\r\n  deleteAutosave();\r\n}\r\n","import { fork } from \"@redux-saga/core/effects\";\r\n\r\nimport projectMutateSaga from \"./project-mutate\";\r\nimport projectResetSaga from \"./project-reset\";\r\n\r\nexport default function* autosaveSaga() {\r\n  yield fork(projectMutateSaga);\r\n  yield fork(projectResetSaga);\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_PAGE_NAVIGATE = \"@page/navigate\" as const;\r\nexport const navigatePage = (page: string) => ({\r\n  type: ACTION_PAGE_NAVIGATE,\r\n  payload: { page },\r\n});\r\nexport type PageNavigateAction = ReturnType<typeof navigatePage>;\r\nexport function isPageNavigateAction(\r\n  action: AnyAction\r\n): action is PageNavigateAction {\r\n  return action.type === ACTION_PAGE_NAVIGATE;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_PROJECT_RESTORE_PREVIOUS = \"@project/restore-previous\" as const;\r\nexport const restorePreviousProject = () => ({\r\n  type: ACTION_PROJECT_RESTORE_PREVIOUS,\r\n});\r\nexport type RestorePreviousProjectAction = ReturnType<\r\n  typeof restorePreviousProject\r\n>;\r\nexport function isRestorePreviousProjectAction(\r\n  action: AnyAction\r\n): action is RestorePreviousProjectAction {\r\n  return action.type === ACTION_PROJECT_RESTORE_PREVIOUS;\r\n}\r\n","import { createProjectSelector } from \"../utils\";\r\n\r\nexport const projectNameSelector = createProjectSelector(\r\n  (state) => state.projectName\r\n);\r\n\r\nexport const projectModifiedSelector = createProjectSelector(\r\n  (state) => state.projectModified\r\n);\r\n\r\nexport const projectLoadStateSelector = createProjectSelector(\r\n  (state) => state.projectLoadState\r\n);\r\n","import { SagaIterator } from \"redux-saga\";\r\nimport { put, select, takeEvery } from \"@redux-saga/core/effects\";\r\n\r\nimport {\r\n  ACTION_PAGE_NAVIGATE,\r\n  PageNavigateAction,\r\n} from \"@/actions/page-navigate\";\r\nimport { restorePreviousProject } from \"@/actions/project-restore-previous\";\r\n\r\nimport { projectLoadStateSelector } from \"../selectors/project\";\r\nimport { ProjectServiceState } from \"../state\";\r\n\r\nexport default function* pageNavigateEditorSaga() {\r\n  yield takeEvery(ACTION_PAGE_NAVIGATE, onPageNavigate);\r\n}\r\n\r\nfunction* onPageNavigate(action: PageNavigateAction): SagaIterator {\r\n  const { page } = action.payload;\r\n  if (page !== \"editor\") {\r\n    return;\r\n  }\r\n\r\n  const loadState: ProjectServiceState[\"projectLoadState\"] = yield select(\r\n    projectLoadStateSelector\r\n  );\r\n  if (loadState !== \"no-project\") {\r\n    return;\r\n  }\r\n\r\n  yield put(restorePreviousProject());\r\n}\r\n","import { SagaIterator } from \"redux-saga\";\r\nimport { put, take } from \"redux-saga/effects\";\r\n\r\nimport { DialogData, DialogResult, DialogType } from \"@/dialogs/types\";\r\n\r\nimport { showDialog } from \"@/actions/dialog-show\";\r\n\r\nimport {\r\n  AcceptDialogAction,\r\n  ACTION_DIALOG_RESPONSE_ACCEPT,\r\n} from \"@/actions/dialog-response-accept\";\r\nimport {\r\n  CancelDialogAction,\r\n  ACTION_DIALOG_RESPONSE_CANCEL,\r\n} from \"@/actions/dialog-response-cancel\";\r\n\r\nexport function* displayDialogSaga<T extends DialogType>(\r\n  dialogType: T,\r\n  data: DialogData<T>\r\n): SagaIterator<DialogResult<T> | null> {\r\n  yield put(showDialog(dialogType, data));\r\n  const response: AcceptDialogAction | CancelDialogAction = yield take([\r\n    ACTION_DIALOG_RESPONSE_ACCEPT,\r\n    ACTION_DIALOG_RESPONSE_CANCEL,\r\n  ]);\r\n\r\n  if (response.type === ACTION_DIALOG_RESPONSE_ACCEPT) {\r\n    return response.payload.result;\r\n  }\r\n\r\n  return null;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_PROJECT_EXPORT_LINK = \"@project/export-link\" as const;\r\nexport const exportProjectLink = () => ({\r\n  type: ACTION_PROJECT_EXPORT_LINK,\r\n});\r\nexport type ExportProjectLinkAction = ReturnType<typeof exportProjectLink>;\r\nexport function isExportProjectLinkAction(\r\n  action: AnyAction\r\n): action is ExportProjectLinkAction {\r\n  return action.type === ACTION_PROJECT_EXPORT_LINK;\r\n}\r\n","import { call, select, takeEvery } from \"redux-saga/effects\";\r\nimport { Buffer } from \"buffer\";\r\nimport { deflate } from \"pako\";\r\n\r\nimport { rootUrl } from \"@/env\";\r\nimport history from \"@/history\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport { displayDialogSaga } from \"@/services/dialog/api\";\r\n\r\nimport { ACTION_PROJECT_EXPORT_LINK } from \"@/actions/project-export-link\";\r\n\r\nimport { createSave } from \"@/services/savedata/api\";\r\n\r\nexport default function* projectExportLinkSaga() {\r\n  yield takeEvery(ACTION_PROJECT_EXPORT_LINK, onExportLink);\r\n}\r\n\r\nfunction* onExportLink() {\r\n  const state: AppState = yield select();\r\n\r\n  try {\r\n    const save = createSave(state);\r\n    const saveText = JSON.stringify(save);\r\n    const encoded = deflate(saveText);\r\n\r\n    const encodedText = Buffer.from(encoded).toString(\"base64\");\r\n\r\n    const urlData = encodeURIComponent(encodedText);\r\n\r\n    const projectLink =\r\n      rootUrl +\r\n      history.createHref({\r\n        pathname: \"/import\",\r\n        search: `data=${urlData}`,\r\n      });\r\n\r\n    yield call(displayDialogSaga, \"export-project-link\", { projectLink });\r\n  } catch (e) {\r\n    // TODO: Warn user of failure\r\n    console.error(\"Failed to export project as link\", e);\r\n  }\r\n}\r\n","export const ACTION_PROJECT_IMPORT_CIRCUITS = \"@project/import-circuits\" as const;\r\nexport const importCircuitFromProject = () => ({\r\n  type: ACTION_PROJECT_IMPORT_CIRCUITS,\r\n});\r\n","import fileDialog from \"file-dialog\";\r\nimport { SagaIterator } from \"redux-saga\";\r\nimport { call, put, takeEvery } from \"redux-saga/effects\";\r\n\r\nimport { elementTypeToCircuitId } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nimport { ACTION_PROJECT_IMPORT_CIRCUITS } from \"@/actions/project-import-circuits\";\r\nimport { importCircuits } from \"@/actions/circuit-import\";\r\n\r\nimport { SaveData } from \"@/services/savedata/types\";\r\nimport { displayDialogSaga } from \"@/services/dialog/api\";\r\nimport { ROOT_CIRCUIT_ID } from \"@/services/circuits/constants\";\r\n\r\nexport default function* projectImportCircuitsSaga() {\r\n  yield takeEvery(ACTION_PROJECT_IMPORT_CIRCUITS, handleProjectImportCircuits);\r\n}\r\n\r\nfunction* handleProjectImportCircuits(): SagaIterator {\r\n  const [file]: File[] = yield call(fileDialog, {\r\n    accept: \"application/json\",\r\n  });\r\n  const contents = yield call(file.text.bind(file));\r\n  const saveData: SaveData = JSON.parse(contents);\r\n\r\n  const result: string[] | undefined = yield call(\r\n    displayDialogSaga,\r\n    \"import-project-circuits\",\r\n    {\r\n      circuits: saveData.circuits.filter(\r\n        (x) => x.circuitId !== ROOT_CIRCUIT_ID\r\n      ),\r\n    }\r\n  );\r\n\r\n  if (!Array.isArray(result)) {\r\n    return;\r\n  }\r\n\r\n  const scanCircuitIds = result;\r\n  const targetCircuitIds: string[] = [];\r\n  // Scan through the list of circuits and import dependencies.\r\n  let circuitId: string | undefined;\r\n  while ((circuitId = scanCircuitIds.pop())) {\r\n    targetCircuitIds.push(circuitId);\r\n    for (const element of saveData.elements) {\r\n      const { circuitId: elementCircuitId, elementType: elementType } = element;\r\n      if (circuitId !== elementCircuitId) {\r\n        continue;\r\n      }\r\n      const elementIcCircuitId = elementTypeToCircuitId(elementType);\r\n      if (elementIcCircuitId == null) {\r\n        continue;\r\n      }\r\n      scanCircuitIds.push(elementIcCircuitId);\r\n    }\r\n  }\r\n\r\n  yield put(importCircuits(targetCircuitIds, saveData));\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_PROJECT_IMPORT_LINK = \"@project/import-link\" as const;\r\nexport const importProjectLink = (data: string) => ({\r\n  type: ACTION_PROJECT_IMPORT_LINK,\r\n  payload: { data },\r\n});\r\nexport type ImportProjectLinkAction = ReturnType<typeof importProjectLink>;\r\nexport function isImportProjectLinkAction(\r\n  action: AnyAction\r\n): action is ImportProjectLinkAction {\r\n  return action.type === ACTION_PROJECT_IMPORT_LINK;\r\n}\r\n","import { put, takeEvery } from \"redux-saga/effects\";\r\nimport { Buffer } from \"buffer\";\r\n\r\nimport { inflate } from \"pako\";\r\n\r\nimport {\r\n  ACTION_PROJECT_IMPORT_LINK,\r\n  ImportProjectLinkAction,\r\n} from \"@/actions/project-import-link\";\r\n\r\nimport { receiveProject } from \"@/actions/project-receive\";\r\nimport history from \"@/history\";\r\n\r\nexport default function* projectImportLinkSaga() {\r\n  yield takeEvery(ACTION_PROJECT_IMPORT_LINK, onImportLink);\r\n}\r\n\r\nfunction* onImportLink(action: ImportProjectLinkAction) {\r\n  const { data } = action.payload;\r\n  try {\r\n    const dewrapped = decodeURIComponent(data);\r\n    const deflated = Buffer.from(dewrapped, \"base64\");\r\n    const saveText = inflate(deflated, { to: \"string\" });\r\n    const save = JSON.parse(saveText);\r\n\r\n    yield put(receiveProject(\"Linked Project\", save));\r\n\r\n    history.replace(\"/\");\r\n  } catch (e) {\r\n    console.error(\"Failed to import save from link\", e);\r\n  }\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_PROJECT_LOAD = \"@project/load\" as const;\r\nexport const loadProject = () => ({\r\n  type: ACTION_PROJECT_LOAD,\r\n});\r\nexport type LoadProjectAction = ReturnType<typeof loadProject>;\r\nexport function isLoadProjectAction(\r\n  action: AnyAction\r\n): action is LoadProjectAction {\r\n  return action.type === ACTION_PROJECT_LOAD;\r\n}\r\n","import { SagaIterator } from \"redux-saga\";\r\nimport { call, put, takeEvery } from \"redux-saga/effects\";\r\nimport fileDialog from \"file-dialog\";\r\n\r\nimport history from \"@/history\";\r\n\r\nimport { ACTION_PROJECT_LOAD } from \"@/actions/project-load\";\r\nimport { receiveProject } from \"@/actions/project-receive\";\r\n\r\nimport { SaveData } from \"@/services/savedata/types\";\r\n\r\nexport default function* projectLoadSaga() {\r\n  yield takeEvery(ACTION_PROJECT_LOAD, loadProject);\r\n}\r\n\r\nfunction* loadProject(): SagaIterator {\r\n  try {\r\n    const [file]: File[] = yield call(fileDialog, {\r\n      accept: \"application/json\",\r\n    });\r\n    const contents = yield call(file.text.bind(file));\r\n    const saveData: SaveData = JSON.parse(contents);\r\n    let fileName = file.name;\r\n    if (fileName) {\r\n      fileName = fileName.substr(0, fileName.lastIndexOf(\".json\"));\r\n    } else {\r\n      fileName = \"Unnamed Project\";\r\n    }\r\n    yield put(receiveProject(fileName, saveData));\r\n\r\n    history.push(\"/editor\");\r\n  } catch (e) {\r\n    // TODO: Handle error\r\n    console.warn(\"Failed to load project:\", e);\r\n  }\r\n}\r\n","import { ACTION_PROJECT_NEW } from \"@/actions/project-new\";\r\nimport { takeEvery } from \"@redux-saga/core/effects\";\r\n\r\nimport history from \"@/history\";\r\n\r\nexport default function* projectNewSaga() {\r\n  yield takeEvery(ACTION_PROJECT_NEW, handleNewProject);\r\n}\r\n\r\nfunction* handleNewProject() {\r\n  history.push(\"/editor\");\r\n}\r\n","import { put, takeEvery } from \"@redux-saga/core/effects\";\r\n\r\nimport history from \"@/history\";\r\n\r\nimport { loadAutosave } from \"@/services/autosave/api\";\r\n\r\nimport { receiveProject } from \"@/actions/project-receive\";\r\nimport { ACTION_PROJECT_RESTORE_PREVIOUS } from \"@/actions/project-restore-previous\";\r\n\r\nexport default function* projectRestorePreviousSaga() {\r\n  yield takeEvery(\r\n    ACTION_PROJECT_RESTORE_PREVIOUS,\r\n    handleProjectRestorePrevious\r\n  );\r\n}\r\n\r\nfunction* handleProjectRestorePrevious() {\r\n  const previous = loadAutosave();\r\n  if (!previous) {\r\n    return;\r\n  }\r\n\r\n  yield put(receiveProject(\"Previous Project\", previous));\r\n\r\n  history.push(\"/editor\");\r\n}\r\n","import { SagaIterator } from \"redux-saga\";\r\nimport { call, put, select, takeEvery } from \"redux-saga/effects\";\r\nimport { saveAs } from \"file-saver\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nimport {\r\n  ACTION_PROJECT_SAVE,\r\n  saveProjectSuccess,\r\n} from \"@/actions/project-save\";\r\nimport { renameProject } from \"@/actions/project-rename\";\r\n\r\nimport { createSave } from \"@/services/savedata/api\";\r\n\r\nimport { projectNameSelector } from \"../selectors/project\";\r\n\r\nexport default function* projectSaveSaga() {\r\n  yield takeEvery(ACTION_PROJECT_SAVE, saveProject);\r\n}\r\n\r\nfunction* saveProject() {\r\n  const state: AppState = yield select();\r\n\r\n  try {\r\n    if (window.showSaveFilePicker) {\r\n      yield call(saveNativeFileApi, state);\r\n    } else {\r\n      yield call(saveLegacy, state);\r\n    }\r\n    yield put(saveProjectSuccess());\r\n  } catch (e) {\r\n    // TODO: Report error\r\n    console.warn(\"Failed to save project\", e);\r\n  }\r\n}\r\n\r\nfunction* saveNativeFileApi(state: AppState): SagaIterator {\r\n  const projectName = yield select(projectNameSelector);\r\n\r\n  const fileHandle: FileHandle | null = yield call(window.showSaveFilePicker!, {\r\n    // This isn't official yet, even with the not-official showSaveFilePicker\r\n    // https://github.com/WICG/file-system-access/blob/main/SuggestedNameAndDir.md#specifying-suggested-file-name-to-save-as\r\n    // It's so new, chrome does not yet support it, but it will:\r\n    // https://bugs.chromium.org/p/chromium/issues/detail?id=1145102\r\n    suggestedName: projectName,\r\n    types: [\r\n      {\r\n        description: \"Discrelog Project Files\",\r\n        accept: {\r\n          \"application/json\": [\".json\"],\r\n        },\r\n      },\r\n    ],\r\n  });\r\n\r\n  if (!fileHandle) {\r\n    return;\r\n  }\r\n\r\n  // Some confusion over how to get the name of the file...\r\n  // fileHandle.name appears in the debugger for chrome, but does not\r\n  // seem to be documented.\r\n  // getFile().name is documented by mozilla, but gives me undefined.\r\n  let name = fileHandle.name;\r\n  if (!name) {\r\n    name = fileHandle.getFile().name;\r\n  }\r\n  if (name) {\r\n    name = name.substr(0, name.lastIndexOf(\".json\"));\r\n    yield put(renameProject(name));\r\n  }\r\n\r\n  const save = createSave(state);\r\n\r\n  const writable: FileSystemWritableStream = yield call(\r\n    fileHandle.createWritable.bind(fileHandle)\r\n  );\r\n  yield call(writable.write.bind(writable), JSON.stringify(save, null, 2));\r\n  yield call(writable.close.bind(writable));\r\n}\r\n\r\nfunction* saveLegacy(state: AppState): SagaIterator {\r\n  const projectName = yield select(projectNameSelector);\r\n\r\n  const save = createSave(state);\r\n  const blob = new Blob([JSON.stringify(save, null, 2)], {\r\n    type: \"application/json;charset=utf-8\",\r\n  });\r\n\r\n  saveAs(blob, `${projectName}.json`);\r\n}\r\n","import { fork } from \"redux-saga/effects\";\r\n\r\nimport pageNavigateEditorSaga from \"./page-navigate-editor\";\r\nimport projectExportLinkSaga from \"./project-export-link\";\r\nimport projectImportCircuitsSaga from \"./project-import-circuits\";\r\nimport projectImportLinkSaga from \"./project-import-link\";\r\nimport projectLoadSaga from \"./project-load\";\r\nimport projectNewSaga from \"./project-new\";\r\nimport projectRestorePreviousSaga from \"./project-restore-previous\";\r\nimport projectSaveSaga from \"./project-save\";\r\n\r\nexport default function* saveDataSaga() {\r\n  yield fork(pageNavigateEditorSaga);\r\n  yield fork(projectExportLinkSaga);\r\n  yield fork(projectImportCircuitsSaga);\r\n  yield fork(projectImportLinkSaga);\r\n  yield fork(projectLoadSaga);\r\n  yield fork(projectNewSaga);\r\n  yield fork(projectRestorePreviousSaga);\r\n  yield fork(projectSaveSaga);\r\n}\r\n","import { eventChannel, SagaIterator, buffers } from \"redux-saga\";\r\nimport { takeLeading, select, put, take, call } from \"redux-saga/effects\";\r\n\r\nimport { ACTION_SIM_START } from \"@/actions/sim-start\";\r\nimport { ACTION_SIM_PAUSE, pauseSim } from \"@/actions/sim-pause\";\r\nimport { ACTION_SIM_STEP } from \"@/actions/sim-step\";\r\n\r\nimport { tickSim } from \"@/actions/sim-tick\";\r\n\r\nimport { isSimRunningSelector, ticksPerSecondSelector } from \"../selectors/run\";\r\n\r\nexport default function* runModeSaga() {\r\n  yield takeLeading(\r\n    [ACTION_SIM_START, ACTION_SIM_PAUSE, ACTION_SIM_STEP],\r\n    handleRunSim\r\n  );\r\n}\r\n\r\nfunction* handleRunSim(): SagaIterator {\r\n  runSimLoop: while (true) {\r\n    const isRunning = yield select(isSimRunningSelector);\r\n    if (!isRunning) {\r\n      break;\r\n    }\r\n\r\n    try {\r\n      yield put(tickSim(1));\r\n    } catch (e) {\r\n      console.error(e);\r\n      yield put(pauseSim(true));\r\n      return;\r\n    }\r\n\r\n    const shouldContinue = yield call(waitNextTick);\r\n    if (!shouldContinue) {\r\n      break;\r\n    }\r\n  }\r\n}\r\n\r\nfunction* waitNextTick(): SagaIterator<boolean> {\r\n  const tps = yield select(ticksPerSecondSelector);\r\n  const timeToWait = Math.max(Math.ceil(1000 / tps), 1);\r\n  const endWait = performance.now() + timeToWait;\r\n  while (true) {\r\n    const timestamp = yield take(animationFrameChannel);\r\n    const isRunning = yield select(isSimRunningSelector);\r\n    if (!isRunning) {\r\n      return false;\r\n    }\r\n\r\n    if (endWait <= timestamp) {\r\n      return true;\r\n    }\r\n  }\r\n}\r\n\r\n// We cannot use redux-saga delay here, as it uses setInterval.\r\n// On firefox, setInterval has been broken for going on 2 years now:\r\n// https://bugzilla.mozilla.org/show_bug.cgi?id=1566900\r\n// Like most bugs submitted to open source projects, it's been marked WontFix.\r\n// See test here: http://mozilla.pettay.fi/moztests/setInterval16.html\r\n// TODO: Clean this up.  This fires channel events like mad.\r\n// Ideally, this would know how long to wait and only emit events when the time is hit.\r\nconst animationFrameChannel = eventChannel((listener) => {\r\n  let active = true;\r\n\r\n  function awaitAnimationFrame() {\r\n    if (!active) {\r\n      return;\r\n    }\r\n\r\n    requestAnimationFrame((timestamp) => {\r\n      if (!active) {\r\n        return;\r\n      }\r\n      listener(timestamp);\r\n      awaitAnimationFrame();\r\n    });\r\n  }\r\n\r\n  awaitAnimationFrame();\r\n  return () => {\r\n    active = false;\r\n  };\r\n}, buffers.sliding(1));\r\n","import { fork } from \"redux-saga/effects\";\r\n\r\nimport runModeSaga from \"./mode-run\";\r\n\r\nexport default function* simulatorSaga() {\r\n  yield fork(runModeSaga);\r\n}\r\n","export function getCircuitEditorHtmlId(editorId: string) {\r\n  return `circuit-editor-${editorId}`;\r\n}\r\n\r\nexport function getElementHtmlId(editorId: string, elementId: string) {\r\n  return `editor-${editorId}--element-${elementId}`;\r\n}\r\n\r\nexport function getElementPinHtmlId(\r\n  editorId: string,\r\n  elementId: string,\r\n  pinId: string\r\n): string {\r\n  return `editor-${editorId}--element-${elementId}--pin-${pinId}`;\r\n}\r\n\r\nexport function getWireHtmlId(editorId: string, wireId: string) {\r\n  return `editor-${editorId}--wire-${wireId}`;\r\n}\r\n\r\nexport function getWireJointHtmlId(editorId: string, jointId: string) {\r\n  return `editor-${editorId}--wire-joint-${jointId}`;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_TUTORIAL_NEXT = \"@tutorial/next\" as const;\r\nexport const tutorialNext = () => ({\r\n  type: ACTION_TUTORIAL_NEXT,\r\n});\r\nexport type TutorialNextAction = ReturnType<typeof tutorialNext>;\r\nexport function isTutorialNextAction(\r\n  action: AnyAction\r\n): action is TutorialNextAction {\r\n  return action.type === ACTION_TUTORIAL_NEXT;\r\n}\r\n","import { AnyAction } from \"redux\";\r\nimport { SagaIterator } from \"redux-saga\";\r\nimport { call, put, select, take } from \"redux-saga/effects\";\r\nimport { Options } from \"@popperjs/core\";\r\n\r\nimport { ElementDefinition } from \"@/elements/types\";\r\n\r\nimport { activeCircuitEditorIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\nimport { elementDefinitionFromTypeSelector } from \"@/services/element-types/selectors/element-types\";\r\nimport {\r\n  ElementConnection,\r\n  ElementPin,\r\n  elementPinEquals,\r\n} from \"@/services/circuit-graph/types\";\r\nimport { connectionsSelector } from \"@/services/circuit-graph/selectors/connections\";\r\n\r\nimport { ACTION_ELEMENT_ADD, AddElementAction } from \"@/actions/element-add\";\r\nimport { tutorialAnnotate } from \"@/actions/tutorial-annotate\";\r\nimport { ACTION_CIRCUIT_EDITOR_DRAG_END } from \"@/actions/circuit-editor-drag-end\";\r\nimport { ACTION_TUTORIAL_NEXT, tutorialNext } from \"@/actions/tutorial-next\";\r\nimport { getCircuitEditorHtmlId } from \"@/components/CircuitEditor/ids\";\r\n\r\nexport interface AddElementTutorialStepOptions {\r\n  trayMessage?: string;\r\n  fieldMessage?: string;\r\n}\r\nexport function* addElementTutorialStep(\r\n  elementType: string,\r\n  opts: AddElementTutorialStepOptions = {}\r\n): SagaIterator<string | null> {\r\n  const def: ElementDefinition = yield select((state) =>\r\n    elementDefinitionFromTypeSelector(state, elementType)\r\n  );\r\n  if (!def) {\r\n    return null;\r\n  }\r\n\r\n  const activeEditorId: string | null = yield select(\r\n    activeCircuitEditorIdSelector\r\n  );\r\n  if (!activeEditorId) {\r\n    return null;\r\n  }\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: `#element-tray--element-${elementType}`,\r\n        message: opts.trayMessage ?? `This is a ${def.displayName} element`,\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message:\r\n          opts.fieldMessage ??\r\n          `Drag the ${def.displayName} element onto the circuit field.`,\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  const addElementAction: AddElementAction = yield call(() =>\r\n    waitFilterAction(\r\n      ACTION_ELEMENT_ADD,\r\n      ({ payload: { elementType: addedElementType } }) =>\r\n        addedElementType === elementType\r\n    )\r\n  );\r\n\r\n  return addElementAction.payload.elementId;\r\n}\r\n\r\nexport function* waitElementConnected(\r\n  outputPin: ElementPin,\r\n  inputPin: ElementPin\r\n) {\r\n  while (true) {\r\n    const connected: boolean = yield call(isConnected, outputPin, inputPin);\r\n    if (connected) {\r\n      return;\r\n    }\r\n    // TODO: We can only detect wiring through drag end.  Might want to make drag use real actions\r\n    //  and wait on connect action instead.\r\n    yield take(ACTION_CIRCUIT_EDITOR_DRAG_END);\r\n  }\r\n}\r\n\r\nfunction* isConnected(\r\n  outputPin: ElementPin,\r\n  inputPin: ElementPin\r\n): SagaIterator<boolean> {\r\n  const connections: ElementConnection[] = yield select(connectionsSelector);\r\n  return connections.some(\r\n    ({ inputPin: connInputPin, outputPin: connOutputPin }) =>\r\n      elementPinEquals(connInputPin, inputPin) &&\r\n      elementPinEquals(connOutputPin, outputPin)\r\n  );\r\n}\r\n\r\nexport function waitFilterAction(\r\n  actionType: string,\r\n  filter: (action: AnyAction) => boolean\r\n): SagaIterator<AnyAction>;\r\nexport function waitFilterAction<T extends AnyAction>(\r\n  actionType: string,\r\n  filter: (action: T) => boolean\r\n): SagaIterator<T>;\r\nexport function* waitFilterAction(\r\n  actionType: string,\r\n  filter: (action: any) => boolean\r\n): SagaIterator<any> {\r\n  let action: AnyAction;\r\n  while ((action = yield take(actionType))) {\r\n    if (!filter(action)) {\r\n      continue;\r\n    }\r\n    break;\r\n  }\r\n\r\n  return action;\r\n}\r\n\r\nexport interface TutorialNextMessageOptions {\r\n  placement?: Options[\"placement\"];\r\n  additionalSelectors?: string[];\r\n}\r\nexport function* tutorialNextMessage(\r\n  selector: string,\r\n  message: string,\r\n  opts: TutorialNextMessageOptions = {}\r\n) {\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector,\r\n        message,\r\n        placement: opts.placement,\r\n        action: {\r\n          name: \"Next\",\r\n          action: tutorialNext(),\r\n        },\r\n      },\r\n      ...(opts.additionalSelectors ?? []).map((selector) => ({ selector })),\r\n    ])\r\n  );\r\n\r\n  yield take(ACTION_TUTORIAL_NEXT);\r\n}\r\n","import { call, put, select, take } from \"redux-saga/effects\";\r\n\r\nimport { arrayEquals } from \"@/arrays\";\r\n\r\nimport {\r\n  ACTION_ELEMENT_INTERACT,\r\n  InteractElementAction,\r\n} from \"@/actions/element-interact\";\r\nimport { ACTION_SIM_START } from \"@/actions/sim-start\";\r\nimport { tutorialAnnotate } from \"@/actions/tutorial-annotate\";\r\nimport { tutorialDismiss } from \"@/actions/tutorial-dismiss\";\r\n\r\nimport { activeCircuitEditorIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\n\r\nimport {\r\n  getCircuitEditorHtmlId,\r\n  getElementHtmlId,\r\n  getElementPinHtmlId,\r\n} from \"@/components/CircuitEditor/ids\";\r\n\r\nimport {\r\n  addElementTutorialStep,\r\n  tutorialNextMessage,\r\n  waitFilterAction,\r\n  waitElementConnected,\r\n} from \"./utils\";\r\n\r\nexport default function* runBasicsTutorial() {\r\n  yield call(\r\n    tutorialNextMessage,\r\n    \"#element-tray\",\r\n    \"This is where logic elements are stored.\"\r\n  );\r\n\r\n  const gateId: string | null = yield call(addElementTutorialStep, \"logic-not\");\r\n  if (!gateId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  const switchId: string | null = yield call(\r\n    addElementTutorialStep,\r\n    \"interaction-momentary\"\r\n  );\r\n  if (!switchId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  const ledId: string | null = yield call(addElementTutorialStep, \"output-led\");\r\n  if (!ledId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  const activeEditorId: string | null = yield select(\r\n    activeCircuitEditorIdSelector\r\n  );\r\n  if (!activeEditorId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, switchId, \"OUT\"),\r\n        message: \"This is the switch's output pin.\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, gateId, \"IN\"),\r\n        message: \"This is the logic gate's input pin.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: switchId, pinId: \"OUT\" },\r\n    { elementId: gateId, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, gateId, \"OUT\"),\r\n        message: \"This is the logic gate's output pin.\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, ledId, \"IN\"),\r\n        message: \"This is the LED's input pin.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: gateId, pinId: \"OUT\" },\r\n    { elementId: ledId, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate({\r\n      selector: \"#simctrl-run\",\r\n      message: \"Click here to run the simulation.\",\r\n    })\r\n  );\r\n\r\n  yield take(ACTION_SIM_START);\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      // Unfortunately, since we use absolute positioning, the z-index on the element will not function unless\r\n      // we also raise the field\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n      },\r\n      {\r\n        selector: \"#\" + getElementHtmlId(activeEditorId, switchId),\r\n        message:\r\n          \"Click the switch to activate it.  Momentary switches need to be held.\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(() =>\r\n    waitFilterAction<InteractElementAction>(\r\n      ACTION_ELEMENT_INTERACT,\r\n      ({ payload: { elementIdPath, data } }) =>\r\n        data === true && arrayEquals(elementIdPath, [switchId])\r\n    )\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate({\r\n      selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n      placement: \"top\",\r\n      message: \"That's it!\",\r\n      action: {\r\n        name: \"End Tutorial\",\r\n        action: tutorialDismiss(),\r\n      },\r\n    })\r\n  );\r\n}\r\n","export function getCircuitListItemHtmlId(circuitId: string) {\r\n  return `circuit-list--circuit-${circuitId}`;\r\n}\r\n","import { call, put, select, take } from \"redux-saga/effects\";\r\n\r\nimport { arrayEquals } from \"@/arrays\";\r\n\r\nimport { circuitIdToElementType } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nimport { tutorialAnnotate } from \"@/actions/tutorial-annotate\";\r\nimport { tutorialDismiss } from \"@/actions/tutorial-dismiss\";\r\nimport { ACTION_CIRCUIT_ADD, AddCircuitAction } from \"@/actions/circuit-add\";\r\nimport { ACTION_CIRCUIT_RENAME } from \"@/actions/circuit-rename\";\r\nimport { ACTION_VIEW_CIRCUIT, ViewCircuitAction } from \"@/actions/view-circuit\";\r\nimport {\r\n  ACTION_ELEMENT_INTERACT,\r\n  InteractElementAction,\r\n} from \"@/actions/element-interact\";\r\nimport { ACTION_SIM_START } from \"@/actions/sim-start\";\r\nimport {\r\n  ACTION_ELEMENT_RENAME,\r\n  RenameElementAction,\r\n} from \"@/actions/element-rename\";\r\n\r\nimport { activeCircuitEditorIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\nimport { ROOT_CIRCUIT_ID } from \"@/services/circuits/constants\";\r\n\r\nimport { getCircuitListItemHtmlId } from \"@/pages/ProjectEditorPage/windows/CircuitsTreeWindow/ids\";\r\n\r\nimport {\r\n  getCircuitEditorHtmlId,\r\n  getElementHtmlId,\r\n  getElementPinHtmlId,\r\n} from \"@/components/CircuitEditor/ids\";\r\n\r\nimport {\r\n  addElementTutorialStep,\r\n  tutorialNextMessage,\r\n  waitFilterAction,\r\n  waitElementConnected,\r\n} from \"./utils\";\r\n\r\nexport default function* runCircuitsTutorial() {\r\n  yield call(\r\n    tutorialNextMessage,\r\n    \"#circuit-list-window\",\r\n    \"Circuits are collections of elements that can be reused as ICs.\"\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate({\r\n      selector: \"#circuit-list\",\r\n      message: \"Right click on the circuit list to create a new circuit.\",\r\n    })\r\n  );\r\n\r\n  const addCircuitAction: AddCircuitAction = yield take(ACTION_CIRCUIT_ADD);\r\n  const { circuitId } = addCircuitAction.payload;\r\n\r\n  yield put(\r\n    tutorialAnnotate({\r\n      selector: \"#\" + getCircuitListItemHtmlId(circuitId),\r\n      message: \"Here is your circuit.  Double click it to rename it.\",\r\n    })\r\n  );\r\n\r\n  yield take(ACTION_CIRCUIT_RENAME);\r\n\r\n  yield put(\r\n    tutorialAnnotate({\r\n      selector: \"#\" + getCircuitListItemHtmlId(circuitId),\r\n      message: \"Click the circuit to view it in the active editor window.\",\r\n    })\r\n  );\r\n\r\n  yield call(() =>\r\n    waitFilterAction<ViewCircuitAction>(\r\n      ACTION_VIEW_CIRCUIT,\r\n      (action) => action.payload.circuitId === circuitId\r\n    )\r\n  );\r\n\r\n  const activeEditorId: string | null = yield select(\r\n    activeCircuitEditorIdSelector\r\n  );\r\n  if (!activeEditorId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  const inputPinId: string | null = yield call(\r\n    addElementTutorialStep,\r\n    \"pin-input\"\r\n  );\r\n  if (!inputPinId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  yield call(\r\n    tutorialNextMessage,\r\n    \"#\" + getElementHtmlId(activeEditorId, inputPinId),\r\n    \"Input pins take a signal from outside for use in your circuit.\",\r\n    { additionalSelectors: [\"#\" + getCircuitEditorHtmlId(activeEditorId)] }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n      },\r\n      {\r\n        selector: \"#\" + getElementHtmlId(activeEditorId, inputPinId),\r\n        message:\r\n          \"Rename the pin by right clicking it and clicking on the bolded text.  Choose any name you like\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(() =>\r\n    waitFilterAction<RenameElementAction>(\r\n      ACTION_ELEMENT_RENAME,\r\n      (action) => action.payload.elementId === inputPinId\r\n    )\r\n  );\r\n\r\n  yield call(\r\n    tutorialNextMessage,\r\n    \"#\" + getElementHtmlId(activeEditorId, inputPinId),\r\n    \"Pin names will appear on the body of the IC when used in other circuits.  Be sure to name your pins!\"\r\n  );\r\n\r\n  const outputPinId1: string | null = yield call(\r\n    addElementTutorialStep,\r\n    \"pin-output\"\r\n  );\r\n  if (!outputPinId1) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  yield call(\r\n    tutorialNextMessage,\r\n    \"#\" + getElementHtmlId(activeEditorId, outputPinId1),\r\n    \"Output pins take a signal from your circuit and send it to the outside world.\"\r\n  );\r\n\r\n  const outputPinId2: string | null = yield call(\r\n    addElementTutorialStep,\r\n    \"pin-output\",\r\n    {\r\n      trayMessage: \"Let's take another output pin\",\r\n      fieldMessage:\r\n        \"When multiple pins are used, the pins will stack in their vertical orientation on the IC\",\r\n    }\r\n  );\r\n\r\n  if (!outputPinId2) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  yield call(\r\n    tutorialNextMessage,\r\n    \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n    \"Let's put together a simple circuit.\",\r\n    { placement: \"top\" }\r\n  );\r\n\r\n  const bufferId: string | null = yield call(\r\n    addElementTutorialStep,\r\n    \"logic-buffer\"\r\n  );\r\n  if (!bufferId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  const notId: string | null = yield call(addElementTutorialStep, \"logic-not\");\r\n  if (!notId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, inputPinId, \"OUT\"),\r\n        message: \"Connect the input signal pin...\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, bufferId, \"IN\"),\r\n        message: \"...to the buffer's input.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: inputPinId, pinId: \"OUT\" },\r\n    { elementId: bufferId, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, bufferId, \"OUT\"),\r\n        message: \"Connect the buffer's output pin...\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, outputPinId1, \"IN\"),\r\n        message: \"...to the IC's first output.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: bufferId, pinId: \"OUT\" },\r\n    { elementId: outputPinId1, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, inputPinId, \"OUT\"),\r\n        message: \"Connect the input signal pin...\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, notId, \"IN\"),\r\n        message: \"...to the NOT's input.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: inputPinId, pinId: \"OUT\" },\r\n    { elementId: notId, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, notId, \"OUT\"),\r\n        message: \"Connect the NOT's output...\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, outputPinId2, \"IN\"),\r\n        message: \"...to the second IC output.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: notId, pinId: \"OUT\" },\r\n    { elementId: outputPinId2, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate({\r\n      selector: \"#\" + getCircuitListItemHtmlId(ROOT_CIRCUIT_ID),\r\n      message:\r\n        \"We now have a functional IC.  Let's go to the root project and make use of it\",\r\n    })\r\n  );\r\n\r\n  yield call(() =>\r\n    waitFilterAction<ViewCircuitAction>(\r\n      ACTION_VIEW_CIRCUIT,\r\n      (action) => action.payload.circuitId === ROOT_CIRCUIT_ID\r\n    )\r\n  );\r\n\r\n  const icType = circuitIdToElementType(circuitId);\r\n\r\n  const icId: string | null = yield call(addElementTutorialStep, icType);\r\n  if (!icId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  yield call(\r\n    tutorialNextMessage,\r\n    \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n    \"Let's connect it up to see it in action.\",\r\n    { placement: \"top\" }\r\n  );\r\n\r\n  const switchId: string | null = yield call(\r\n    addElementTutorialStep,\r\n    \"interaction-momentary\"\r\n  );\r\n  if (!switchId) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  const led1Id: string | null = yield call(\r\n    addElementTutorialStep,\r\n    \"output-led\",\r\n    { trayMessage: \"Make an LED to check the status of the first pin.\" }\r\n  );\r\n  if (!led1Id) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  const led2Id: string | null = yield call(\r\n    addElementTutorialStep,\r\n    \"output-led\",\r\n    { trayMessage: \"Make an LED to check the status of the second pin.\" }\r\n  );\r\n  if (!led2Id) {\r\n    yield put(tutorialDismiss());\r\n    return;\r\n  }\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, switchId, \"OUT\"),\r\n        message: \"Connect the switch output...\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, icId, inputPinId),\r\n        message: \"...to the IC input.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: switchId, pinId: \"OUT\" },\r\n    { elementId: icId, pinId: inputPinId }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, icId, outputPinId1),\r\n        message: \"Connect the first IC output...\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, led1Id, \"IN\"),\r\n        message: \"...to the first LED.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: icId, pinId: outputPinId1 },\r\n    { elementId: led1Id, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, icId, outputPinId1),\r\n        message: \"Connect the first IC output...\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, led1Id, \"IN\"),\r\n        message: \"...to the first LED.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: icId, pinId: outputPinId1 },\r\n    { elementId: led1Id, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, icId, outputPinId2),\r\n        message: \"Connect the second IC output...\",\r\n        placement: \"top\",\r\n      },\r\n      {\r\n        selector: \"#\" + getElementPinHtmlId(activeEditorId, led2Id, \"IN\"),\r\n        message: \"...to the second LED.\",\r\n        placement: \"bottom\",\r\n      },\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n        message: \"Click and drag from one pin to another to connect them.\",\r\n        placement: \"top\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(\r\n    waitElementConnected,\r\n    { elementId: icId, pinId: outputPinId2 },\r\n    { elementId: led2Id, pinId: \"IN\" }\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate({\r\n      selector: \"#simctrl-run\",\r\n      message: \"Click here to run the simulation.\",\r\n    })\r\n  );\r\n\r\n  yield take(ACTION_SIM_START);\r\n\r\n  yield put(\r\n    tutorialAnnotate([\r\n      // Unfortunately, since we use absolute positioning, the z-index on the element will not function unless\r\n      // we also raise the field\r\n      {\r\n        selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n      },\r\n      {\r\n        selector: \"#\" + getElementHtmlId(activeEditorId, switchId),\r\n        message:\r\n          \"Click the switch to activate it.  Momentary switches need to be held.\",\r\n      },\r\n    ])\r\n  );\r\n\r\n  yield call(() =>\r\n    waitFilterAction<InteractElementAction>(\r\n      ACTION_ELEMENT_INTERACT,\r\n      ({ payload: { elementIdPath, data } }) =>\r\n        data === true && arrayEquals(elementIdPath, [switchId])\r\n    )\r\n  );\r\n\r\n  yield put(\r\n    tutorialAnnotate({\r\n      selector: \"#\" + getCircuitEditorHtmlId(activeEditorId),\r\n      placement: \"top\",\r\n      message:\r\n        \"You can place as many copies of an IC as you want.  Circuits can also contain other ICs.\",\r\n      action: {\r\n        name: \"End Tutorial\",\r\n        action: tutorialDismiss(),\r\n      },\r\n    })\r\n  );\r\n}\r\n","import { call, takeEvery } from \"redux-saga/effects\";\r\n\r\nimport {\r\n  ACTION_TUTORIAL_START,\r\n  TutorialStartAction,\r\n} from \"@/actions/tutorial-start\";\r\n\r\nimport runBasicsTutorial from \"./tutorials/basic\";\r\nimport runCircuitsTutorial from \"./tutorials/circuits\";\r\n\r\nexport default function* startTutorial() {\r\n  yield takeEvery(ACTION_TUTORIAL_START, handleStartTutorial);\r\n}\r\n\r\nfunction* handleStartTutorial(action: TutorialStartAction) {\r\n  const { tutorial } = action.payload;\r\n  switch (tutorial) {\r\n    case \"basics\":\r\n      yield call(runBasicsTutorial);\r\n      return;\r\n    case \"circuits\":\r\n      yield call(runCircuitsTutorial);\r\n  }\r\n}\r\n","import { fork } from \"redux-saga/effects\";\r\n\r\nimport tutorialsSaga from \"./tutorials\";\r\n\r\nexport default function* tutorialSaga() {\r\n  yield fork(tutorialsSaga);\r\n}\r\n","import servicesSaga from \"@/services/saga\";\r\n\r\nexport default servicesSaga;\r\n","import {\r\n  createStore,\r\n  compose,\r\n  applyMiddleware,\r\n  AnyAction,\r\n  Middleware,\r\n} from \"redux\";\r\nimport freeze from \"redux-freeze\";\r\nimport createSagaMiddleware from \"redux-saga\";\r\n\r\nimport { isTruthy } from \"@/utils\";\r\nimport { isDev } from \"@/env\";\r\n\r\nimport { doInit } from \"@/actions/init\";\r\n\r\nimport undoReducer from \"@/undo/reducer\";\r\n\r\nimport {\r\n  actionSanitizer,\r\n  stateSanitizer,\r\n  actionsBlacklist,\r\n} from \"./devtool-sanitizer\";\r\n\r\nimport { AppState, defaultAppState } from \"./state\";\r\nimport saga from \"./saga\";\r\nimport rootReducer from \"./reducer\";\r\n\r\nfunction finalReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  state = undoReducer(state, action);\r\n  state = rootReducer(state, action);\r\n  return state;\r\n}\r\n\r\nconst composeEnhancers =\r\n  isDev && window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__\r\n    ? window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({\r\n        actionSanitizer,\r\n        stateSanitizer,\r\n        actionsBlacklist,\r\n      })\r\n    : compose;\r\n\r\nconst sagaMiddleware = createSagaMiddleware();\r\n\r\nconst middleware: Middleware<any, any, any>[] = [\r\n  isDev && freeze,\r\n  sagaMiddleware,\r\n].filter(isTruthy);\r\n\r\nexport const store = createStore(\r\n  finalReducer,\r\n  composeEnhancers(applyMiddleware(...middleware))\r\n);\r\n\r\nsagaMiddleware.run(saga);\r\nstore.dispatch(doInit());\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\n\r\nimport captureUndoStateReducer from \"./capture-undo-state\";\r\nimport redoReducer from \"./redo\";\r\nimport undoReducer from \"./undo\";\r\n\r\n// The undo reducer is special and returns a single reducer that is always ran outside of the primary reducer stack.\r\n// This is less for reducer priority and more to capture the effects of reentrant reducers like clipboard-paste.\r\n// FIXME: Moving this outside the services system means autosave cannot save undo/redo.  Either move autosave out\r\n//  as well or move undo into services.\r\nexport default function undoServiceReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  state = captureUndoStateReducer(state, action);\r\n  state = redoReducer(state, action);\r\n  state = undoReducer(state, action);\r\n  return state;\r\n}\r\n","import { AnyAction } from \"redux\";\r\nimport last from \"lodash/last\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { isUndoAction } from \"@/actions/undo\";\r\nimport { viewCircuit } from \"@/actions/view-circuit\";\r\n\r\nimport { captureUndoState } from \"../utils\";\r\n\r\nexport default function undoReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isUndoAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { undoStack, redoStack } = state.undo;\r\n\r\n  const stackItem = last(undoStack);\r\n  if (!stackItem) {\r\n    return state;\r\n  }\r\n\r\n  const { serviceStates, viewCircuitId } = stackItem;\r\n\r\n  state = {\r\n    ...state,\r\n    services: {\r\n      ...state.services,\r\n      ...serviceStates,\r\n    },\r\n    undo: {\r\n      ...state.undo,\r\n      undoStack: undoStack.slice(0, undoStack.length - 1),\r\n      redoStack: [...redoStack, captureUndoState(state)],\r\n    },\r\n  };\r\n\r\n  if (viewCircuitId) {\r\n    state = rootReducer(state, viewCircuit(viewCircuitId));\r\n  }\r\n\r\n  return state;\r\n}\r\n","import { AnyAction } from \"redux\";\r\nimport last from \"lodash/last\";\r\n\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport rootReducer from \"@/store/reducer\";\r\n\r\nimport { isRedoAction } from \"@/actions/redo\";\r\nimport { viewCircuit } from \"@/actions/view-circuit\";\r\n\r\nimport { captureUndoState } from \"../utils\";\r\n\r\nexport default function redoReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (!isRedoAction(action)) {\r\n    return state;\r\n  }\r\n\r\n  const { undoStack, redoStack } = state.undo;\r\n\r\n  const stackItem = last(redoStack);\r\n  if (!stackItem) {\r\n    return state;\r\n  }\r\n\r\n  const { serviceStates, viewCircuitId } = stackItem;\r\n\r\n  state = {\r\n    ...state,\r\n    services: {\r\n      ...state.services,\r\n      ...serviceStates,\r\n    },\r\n    undo: {\r\n      ...state.undo,\r\n      undoStack: [...undoStack, captureUndoState(state)],\r\n      redoStack: redoStack.slice(0, redoStack.length - 1),\r\n    },\r\n  };\r\n\r\n  if (viewCircuitId) {\r\n    state = rootReducer(state, viewCircuit(viewCircuitId));\r\n  }\r\n\r\n  return state;\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nimport { isProjectMutationAction } from \"@/project-mutation-actions\";\r\nimport { AppState, defaultAppState } from \"@/store\";\r\nimport { fpSet } from \"@/utils\";\r\n\r\nimport { isUndoAction } from \"@/actions/undo\";\r\nimport { isRedoAction } from \"@/actions/redo\";\r\n\r\nimport { captureUndoState } from \"../utils\";\r\n\r\n// If this was part of the normal reducer stack, we would want to give it a very low priority\r\n// so it occurs after all other reducers.\r\n// However, in order to capture reentrant reducers, our master undo reducer wraps\r\n// the root reducer especially and always occurs last.\r\nexport default function captureUndoStateReducer(\r\n  state: AppState = defaultAppState,\r\n  action: AnyAction\r\n): AppState {\r\n  if (\r\n    !isProjectMutationAction(action) ||\r\n    isUndoAction(action) ||\r\n    isRedoAction(action)\r\n  ) {\r\n    return state;\r\n  }\r\n\r\n  return fpSet(state, \"undo\", (undoState) => {\r\n    const capturedUndoState = captureUndoState(state);\r\n\r\n    // Limiting undo to 25 entries, since we store the entire project every slice.\r\n    let { undoStack } = undoState;\r\n    if (undoStack.length >= 25) {\r\n      undoStack = [...undoStack.slice(1, 25), capturedUndoState];\r\n    } else {\r\n      undoStack = [...undoStack, capturedUndoState];\r\n    }\r\n\r\n    return {\r\n      ...undoState,\r\n\r\n      undoStack,\r\n      redoStack: [],\r\n    };\r\n  });\r\n}\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\nimport { AnyAction } from \"redux\";\r\n\r\nexport function useAction(actionCreator: () => AnyAction): () => AnyAction;\r\nexport function useAction<Args>(\r\n  actionCreator: (...args: Args[]) => AnyAction\r\n): () => AnyAction;\r\nexport function useAction<A0, Args>(\r\n  actionCreator: (a0: A0, ...args: Args[]) => AnyAction,\r\n  a0: A0\r\n): () => AnyAction;\r\nexport function useAction(\r\n  actionCreator: (...args: any[]) => AnyAction,\r\n  ...preBind: any[]\r\n): () => AnyAction {\r\n  const dispatch = useDispatch();\r\n  return React.useCallback(\r\n    () => {\r\n      const action = actionCreator(...preBind);\r\n      if (action) {\r\n        dispatch(action);\r\n      }\r\n    },\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [dispatch, actionCreator, ...preBind]\r\n  ) as any;\r\n}\r\n\r\nexport function useClickAction(\r\n  actionCreator: (...args: any[]) => AnyAction,\r\n  ...preBind: any[]\r\n): (e: React.MouseEvent) => AnyAction {\r\n  const dispatch = useDispatch();\r\n  return React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      e.preventDefault();\r\n      const action = actionCreator(...preBind);\r\n      if (action) {\r\n        dispatch(action);\r\n      }\r\n    },\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [dispatch, actionCreator, ...preBind]\r\n  ) as any;\r\n}\r\n","import { fork } from \"redux-saga/effects\";\r\n\r\nimport autosaveSaga from \"./autosave/saga\";\r\nimport projectSaga from \"./project/saga\";\r\nimport simulatorControlSaga from \"./simulator-control/saga\";\r\nimport tutorialSaga from \"./tutorial/saga\";\r\n\r\nexport default function* appSaga() {\r\n  yield fork(autosaveSaga);\r\n  yield fork(projectSaga);\r\n  yield fork(simulatorControlSaga);\r\n  yield fork(tutorialSaga);\r\n}\r\n","import { AnyAction } from \"redux\";\r\n\r\nexport const ACTION_INIT = \"@init\";\r\nexport const doInit = () => ({ type: ACTION_INIT });\r\nexport type InitAction = ReturnType<typeof doInit>;\r\nexport function isInitAction(action: AnyAction): action is InitAction {\r\n  return action.type === ACTION_INIT;\r\n}\r\n","// extracted by mini-css-extract-plugin\nexport default {\"button\":\"button--Ui3Hp\",\"disabled\":\"disabled--bnSiC\",\"button--size-small\":\"button--size-small--289kb\",\"button--variant-primary\":\"button--variant-primary--2qpAa\",\"button--variant-text\":\"button--variant-text--2oReW\",\"button--variant-menu\":\"button--variant-menu--3lEZ1\"};","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nexport interface ButtonProps extends React.HTMLAttributes<HTMLButtonElement> {\r\n  variant?: \"default\" | \"primary\" | \"text\" | \"menu\";\r\n  size?: \"default\" | \"small\";\r\n  disabled?: boolean;\r\n}\r\n\r\nimport styles from \"./Button.module.css\";\r\n\r\nconst Button: React.FC<ButtonProps> = ({\r\n  variant = \"default\",\r\n  size = \"default\",\r\n  disabled,\r\n  ...props\r\n}) => {\r\n  return (\r\n    <button\r\n      className={cls(\r\n        styles[\"button\"],\r\n        (styles as any)[`button--variant-${variant}`],\r\n        (styles as any)[`button--size-${size}`],\r\n        disabled && styles[\"disabled\"]\r\n      )}\r\n      type=\"button\"\r\n      {...props}\r\n    >\r\n      {props.children}\r\n    </button>\r\n  );\r\n};\r\n\r\nexport default Button;\r\n","import Button from \"./Button\";\r\nexport default Button;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"root\":\"root--2DezE\",\"content\":\"content--2cUqW\",\"footer\":\"footer--lY1Go\",\"panel\":\"panel--uw2LA\",\"button-container\":\"button-container--3zi4e\"};","import HomePage from \"./HomePage\";\r\nexport default HomePage;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\nimport { appVersion } from \"@/env\";\r\n\r\nimport flex from \"@/styles/flex.module.css\";\r\n\r\nimport { useAction } from \"@/hooks/useAction\";\r\n\r\nimport { hasAutosave } from \"@/services/autosave/api\";\r\nimport { restorePreviousProject } from \"@/actions/project-restore-previous\";\r\nimport { navigatePage } from \"@/actions/page-navigate\";\r\n\r\nimport { newProject } from \"@/actions/project-new\";\r\nimport { loadProject } from \"@/actions/project-load\";\r\n\r\nimport Button from \"@/components/Button\";\r\n\r\nimport styles from \"./HomePage.module.css\";\r\n\r\nconst HomePage: React.FC = () => {\r\n  const onNavigateHome = useAction(navigatePage, \"home\");\r\n  const onNewProject = useAction(newProject);\r\n  const onLoadProject = useAction(loadProject);\r\n  const onLoadPreviousProject = useAction(restorePreviousProject);\r\n\r\n  React.useEffect(() => {\r\n    onNavigateHome();\r\n  }, [onNavigateHome]);\r\n\r\n  const hasPreviousSave = hasAutosave();\r\n\r\n  return (\r\n    <div className={styles.root}>\r\n      <div className={styles.content}>\r\n        <div className={styles.panel}>\r\n          <h1>Discrelog</h1>\r\n          <h3>\r\n            Discrelog is a discrete logic simulator for exploring TTL logic\r\n            systems.\r\n          </h3>\r\n        </div>\r\n        <div className={cls(flex[\"flex-row\"], flex[\"flex-space-around\"])}>\r\n          <div\r\n            className={cls(\r\n              styles.panel,\r\n              styles[\"button-container\"],\r\n              flex[\"flexitem-grow\"]\r\n            )}\r\n          >\r\n            <Button onClick={onNewProject}>Start a new project</Button>\r\n          </div>\r\n          <div\r\n            className={cls(\r\n              styles.panel,\r\n              styles[\"button-container\"],\r\n              flex[\"flexitem-grow\"]\r\n            )}\r\n          >\r\n            <Button onClick={onLoadProject}>Load an existing project</Button>\r\n          </div>\r\n          <div\r\n            className={cls(\r\n              styles.panel,\r\n              styles[\"button-container\"],\r\n              flex[\"flexitem-grow\"]\r\n            )}\r\n          >\r\n            <Button disabled={!hasPreviousSave} onClick={onLoadPreviousProject}>\r\n              Restore previous project\r\n            </Button>\r\n          </div>\r\n        </div>\r\n        <div className={cls(styles.footer, styles.panel)}>{appVersion}</div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default HomePage;\r\n","import { useSelector as useSelectorRedux } from \"react-redux\";\r\n\r\nimport { AppState } from \"@/store\";\r\n\r\nexport default function useSelector<T>(selector: (s: AppState) => T) {\r\n  return useSelectorRedux<AppState, T>(selector);\r\n}\r\n","import * as React from \"react\";\r\n\r\nexport function useNativeEvent<\r\n  T extends GlobalEventHandlers,\r\n  K extends keyof GlobalEventHandlersEventMap\r\n>(\r\n  ref: React.RefObject<T | null>,\r\n  type: K,\r\n  listener: (\r\n    this: GlobalEventHandlers,\r\n    ev: GlobalEventHandlersEventMap[K]\r\n  ) => any,\r\n  options?: boolean | AddEventListenerOptions\r\n) {\r\n  React.useEffect(() => {\r\n    if (!ref.current) {\r\n      return;\r\n    }\r\n\r\n    // De-reference the target so we remove from the right element.\r\n    const listenTarget = ref.current;\r\n\r\n    listenTarget.addEventListener(type, listener, options);\r\n    return () => {\r\n      listenTarget.removeEventListener(type, listener, options);\r\n    };\r\n  }, [type, listener, ref, options]);\r\n}\r\n","import { createUiLayoutSelector } from \"../utils\";\r\n\r\nexport const layoutSelector = createUiLayoutSelector((s) => s.layout);\r\n","import TitleBar from \"./TitleBar\";\r\nexport default TitleBar;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport styles from \"./TitleBar.module.css\";\r\n\r\nexport interface TitleBarProps {\r\n  className?: string;\r\n  title?: string;\r\n}\r\nconst TitleBar: React.FC<TitleBarProps> = ({ className, title, children }) => {\r\n  return (\r\n    <div className={cls(styles.titlebar, className)}>\r\n      <span className={styles[\"titlebar-heading\"]}>Discrelog</span>\r\n      <div className={styles[\"titlebar-divider\"]} />\r\n      {title && <div className={styles[\"titlebar-title\"]}>{title}</div>}\r\n      {children}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default TitleBar;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"titlebar\":\"titlebar--3-TCE\",\"titlebar-heading\":\"titlebar-heading--3RAl1\",\"titlebar-divider\":\"titlebar-divider--Wl_27\",\"titlebar-title\":\"titlebar-title--HXGig\"};","import * as React from \"react\";\r\n\r\nexport interface PopoverChildContext {\r\n  registerPopoverChild(element: HTMLElement): void;\r\n  unregisterPopoverChild(element: HTMLElement): void;\r\n}\r\n\r\nfunction noop() {\r\n  // no op.\r\n}\r\nconst noopPopoverChildContext: PopoverChildContext = {\r\n  registerPopoverChild: noop,\r\n  unregisterPopoverChild: noop,\r\n};\r\n\r\nexport const PopoverChildContext = React.createContext<PopoverChildContext | null>(\r\n  null\r\n);\r\n\r\nexport const usePopoverChildContext = () =>\r\n  React.useContext(PopoverChildContext);\r\n\r\nexport const PopoverChildContextProvider: React.FC<PopoverChildContext> = ({\r\n  registerPopoverChild: contextRegister,\r\n  unregisterPopoverChild: contextUnregister,\r\n  children,\r\n}) => {\r\n  const parent = usePopoverChildContext();\r\n  const parentRegister = parent?.registerPopoverChild;\r\n  const parentUnregister = parent?.unregisterPopoverChild;\r\n\r\n  const registerPopoverChild = React.useCallback(\r\n    (element: HTMLElement) => {\r\n      if (parentRegister) {\r\n        parentRegister(element);\r\n      }\r\n      contextRegister(element);\r\n    },\r\n    [contextRegister, parentRegister]\r\n  );\r\n\r\n  const unregisterPopoverChild = React.useCallback(\r\n    (element: HTMLElement) => {\r\n      contextUnregister(element);\r\n      if (parentUnregister) {\r\n        parentUnregister;\r\n      }\r\n    },\r\n    [contextUnregister, parentUnregister]\r\n  );\r\n\r\n  const providedContext = React.useMemo(\r\n    () => ({\r\n      registerPopoverChild,\r\n      unregisterPopoverChild,\r\n    }),\r\n    [registerPopoverChild, unregisterPopoverChild]\r\n  );\r\n\r\n  return (\r\n    <PopoverChildContext.Provider value={providedContext}>\r\n      {children}\r\n    </PopoverChildContext.Provider>\r\n  );\r\n};\r\n\r\nexport function usePopoverChild(element: HTMLElement | null) {\r\n  const popoverContext =\r\n    React.useContext(PopoverChildContext) ?? noopPopoverChildContext;\r\n\r\n  // We do not want to trigger the effect when\r\n  //  the context changes, as the context will change\r\n  //  as a result of calling register and unregister.\r\n  // As a result, we will not function right if somehow our\r\n  //  element transfers to a different popup chain without re-rendering.\r\n  const ctxRef = React.useRef(popoverContext);\r\n  React.useEffect(() => {\r\n    ctxRef.current = popoverContext;\r\n  });\r\n\r\n  React.useEffect(() => {\r\n    if (element) {\r\n      ctxRef.current.registerPopoverChild(element);\r\n      return () => ctxRef.current.unregisterPopoverChild(element);\r\n    }\r\n  }, [element]);\r\n}\r\n","import * as React from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\n\r\nimport { Options, VirtualElement } from \"@popperjs/core\";\r\nimport { usePopper } from \"react-popper\";\r\n\r\nimport { useOutsideMouseEvent } from \"@/hooks/useOutsideMouseEvent\";\r\nimport { useArrayState } from \"@/hooks/useArrayState\";\r\n\r\nimport {\r\n  PopoverChildContextProvider,\r\n  usePopoverChild,\r\n} from \"./PopoverChildContext\";\r\n\r\nexport interface PopoverProps {\r\n  anchorEl: Element | VirtualElement | null;\r\n  placement?: Options[\"placement\"];\r\n  isOpen: boolean;\r\n  onRequestClose?(): void;\r\n}\r\n\r\nconst noop = () => {\r\n  /*no op*/\r\n};\r\n\r\nconst Popover: React.FC<PopoverProps> = ({\r\n  isOpen,\r\n  anchorEl,\r\n  placement = \"auto\",\r\n  onRequestClose = noop,\r\n  children,\r\n}) => {\r\n  const [popoverRef, setPopoverRef] = React.useState<HTMLDivElement | null>(\r\n    null\r\n  );\r\n  const { attributes, styles } = usePopper(\r\n    isOpen ? anchorEl : null,\r\n    popoverRef,\r\n    {\r\n      placement,\r\n    }\r\n  );\r\n\r\n  // Register us as a child of a parent popover, if any is present.\r\n  usePopoverChild(popoverRef);\r\n\r\n  const [\r\n    popoverChildren,\r\n    registerPopoverChild,\r\n    unregisterPopoverChild,\r\n  ] = useArrayState<HTMLElement>();\r\n\r\n  // Close when a click happens on the outside.\r\n  // We still want to handle this even if we are a child, as the user\r\n  // may have clicked on a parent popover which should close us.\r\n  const insideRefs = React.useMemo(() => [popoverRef, ...popoverChildren], [\r\n    popoverChildren,\r\n    popoverRef,\r\n  ]);\r\n  useOutsideMouseEvent(insideRefs, onRequestClose);\r\n\r\n  if (!isOpen) {\r\n    return null;\r\n  }\r\n\r\n  return createPortal(\r\n    <PopoverChildContextProvider\r\n      registerPopoverChild={registerPopoverChild}\r\n      unregisterPopoverChild={unregisterPopoverChild}\r\n    >\r\n      <div\r\n        ref={setPopoverRef}\r\n        style={{ ...styles.popper, zIndex: 10 }}\r\n        {...attributes.popper}\r\n      >\r\n        {children}\r\n      </div>\r\n    </PopoverChildContextProvider>,\r\n    document.body\r\n  );\r\n};\r\n\r\nexport default Popover;\r\n","export * from \"./Popover\";\r\nimport Popover from \"./Popover\";\r\nexport default Popover;\r\n","import * as React from \"react\";\r\nimport difference from \"lodash/difference\";\r\n\r\nexport type UseArrayState<T> = [\r\n  items: T[],\r\n  addItem: (value: T) => void,\r\n  removeItem: (value: T) => void,\r\n  setItems: (items: T[]) => void\r\n];\r\n\r\nexport function useArrayState<T>(defaultValue: T[] = []): UseArrayState<T> {\r\n  const [items, setItems] = React.useState(defaultValue);\r\n  const addItem = React.useCallback(\r\n    (item: T) => {\r\n      setItems([...items, item]);\r\n    },\r\n    [items]\r\n  );\r\n  const removeItem = React.useCallback(\r\n    (item: T) => {\r\n      setItems(difference(items, [item]));\r\n    },\r\n    [items]\r\n  );\r\n\r\n  return [items, addItem, removeItem, setItems];\r\n}\r\n","import * as React from \"react\";\r\n\r\nimport { asArray, MaybeArray } from \"@/arrays\";\r\nimport { isTruthy } from \"@/utils\";\r\n\r\nexport function useOutsideMouseEvent(\r\n  element: MaybeArray<HTMLElement | null>,\r\n  onOutsideEvent: () => void,\r\n  when = true\r\n) {\r\n  const onEvent = React.useCallback(\r\n    (e: MouseEvent | TouchEvent) => {\r\n      const elements = asArray(element).filter(isTruthy);\r\n      if (!elements.length) {\r\n        return;\r\n      }\r\n\r\n      if (elements.every((element) => !element.contains(e.target as any))) {\r\n        onOutsideEvent();\r\n      }\r\n    },\r\n    [element, onOutsideEvent]\r\n  );\r\n\r\n  React.useEffect(() => {\r\n    if (!when) {\r\n      return;\r\n    }\r\n\r\n    document.addEventListener(\"mousedown\", onEvent);\r\n    document.addEventListener(\"touchstart\", onEvent);\r\n\r\n    return () => {\r\n      document.removeEventListener(\"mousedown\", onEvent);\r\n      document.removeEventListener(\"touchstart\", onEvent);\r\n    };\r\n  }, [onEvent, when]);\r\n}\r\n","import * as React from \"react\";\r\n\r\nfunction noop() {\r\n  /* Do nothing */\r\n}\r\n\r\nconst MenuCloseContext = React.createContext<() => void>(noop);\r\n\r\nexport function useMenuCloseContext() {\r\n  return React.useContext(MenuCloseContext);\r\n}\r\n\r\nexport const MenuCloseContextProvider = MenuCloseContext.Provider;\r\n","import * as React from \"react\";\r\nimport { Options } from \"@popperjs/core\";\r\n\r\nimport Popover from \"./Popover\";\r\nimport { MenuCloseContextProvider } from \"./Menus/MenuCloseContext\";\r\n\r\nexport interface AutoPopoverProps {\r\n  content: JSX.Element;\r\n  placement?: Options[\"placement\"];\r\n}\r\n\r\nconst AutoPopover: React.FC<AutoPopoverProps> = ({\r\n  content,\r\n  placement,\r\n  children,\r\n}) => {\r\n  const anchorEl = React.useRef<HTMLDivElement | null>(null);\r\n\r\n  const [open, setOpen] = React.useState(false);\r\n  const onClick = React.useCallback(() => {\r\n    setOpen(true);\r\n  }, []);\r\n  const onClose = React.useCallback(() => {\r\n    setOpen(false);\r\n  }, []);\r\n\r\n  return (\r\n    <MenuCloseContextProvider value={onClose}>\r\n      <div ref={anchorEl} onClick={onClick}>\r\n        {children}\r\n      </div>\r\n      <Popover\r\n        anchorEl={anchorEl.current}\r\n        isOpen={open}\r\n        placement={placement}\r\n        onRequestClose={onClose}\r\n      >\r\n        {open && content}\r\n      </Popover>\r\n    </MenuCloseContextProvider>\r\n  );\r\n};\r\n\r\nexport default AutoPopover;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"menu\":\"menu--3E86w\",\"menu-item\":\"menu-item--2dcyN\",\"menu-item--disabled\":\"menu-item--disabled--RJJTK\",\"menu-item-content\":\"menu-item-content--3s1DG\",\"menu-item-text\":\"menu-item-text--1F41V\",\"menu-item-secondary\":\"menu-item-secondary--2PJLF\",\"menu-item-icon\":\"menu-item-icon--JTlha\",\"menu-divider\":\"menu-divider--1QPGp\"};","import * as React from \"react\";\r\n\r\nimport styles from \"./Menus.module.css\";\r\n\r\nconst Menu: React.FC = ({ children }) => {\r\n  return <ul className={styles[\"menu\"]}>{children}</ul>;\r\n};\r\n\r\nexport default Menu;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport styles from \"./Menus.module.css\";\r\nimport { useMenuCloseContext } from \"./MenuCloseContext\";\r\n\r\nexport interface MenuItemProps {\r\n  disabled?: boolean;\r\n  secondary?: string;\r\n  onClick?(e: React.MouseEvent<HTMLElement>): void;\r\n}\r\nconst MenuItem: React.FC<MenuItemProps> = ({\r\n  disabled,\r\n  onClick,\r\n  secondary,\r\n  children,\r\n}) => {\r\n  const requestMenuClose = useMenuCloseContext();\r\n  const onItemClick = React.useCallback(\r\n    (e: React.MouseEvent<HTMLAnchorElement>) => {\r\n      if (onClick) {\r\n        onClick(e);\r\n      }\r\n      requestMenuClose();\r\n    },\r\n    [requestMenuClose, onClick]\r\n  );\r\n  return (\r\n    <li\r\n      className={cls(\r\n        styles[\"menu-item\"],\r\n        disabled && styles[\"menu-item--disabled\"]\r\n      )}\r\n    >\r\n      <a className={styles[\"menu-item-content\"]} onClick={onItemClick}>\r\n        <span className={styles[\"menu-item-text\"]}>{children}</span>\r\n        {secondary && (\r\n          <span className={styles[\"menu-item-secondary\"]}>{secondary}</span>\r\n        )}\r\n      </a>\r\n    </li>\r\n  );\r\n};\r\n\r\nexport default MenuItem;\r\n","import * as React from \"react\";\r\n\r\nimport styles from \"./Menus.module.css\";\r\n\r\nconst DividerMenuItem: React.FC = () => {\r\n  return <div className={styles[\"menu-divider\"]} />;\r\n};\r\n\r\nexport default DividerMenuItem;\r\n","import * as React from \"react\";\r\n\r\nimport { useAction } from \"@/hooks/useAction\";\r\nimport { newProject } from \"@/actions/project-new\";\r\nimport { saveProject } from \"@/actions/project-save\";\r\nimport { loadProject } from \"@/actions/project-load\";\r\nimport { exportProjectLink } from \"@/actions/project-export-link\";\r\nimport { importCircuitFromProject } from \"@/actions/project-import-circuits\";\r\n\r\nimport Menu from \"@/components/Menus/Menu\";\r\nimport MenuItem from \"@/components/Menus/MenuItem\";\r\nimport DividerMenuItem from \"@/components/Menus/DividerMenuItem\";\r\n\r\nconst FileMenu: React.FC = () => {\r\n  const onNewProject = useAction(newProject);\r\n  const onSaveProject = useAction(saveProject);\r\n  const onLoadProject = useAction(loadProject);\r\n  const onImportProjectCircuits = useAction(importCircuitFromProject);\r\n  const onExportLink = useAction(exportProjectLink);\r\n\r\n  return (\r\n    <Menu>\r\n      <MenuItem onClick={onNewProject}>New</MenuItem>\r\n      <DividerMenuItem />\r\n      <MenuItem onClick={onLoadProject}>Load</MenuItem>\r\n      <MenuItem onClick={onSaveProject}>Save</MenuItem>\r\n      <DividerMenuItem />\r\n      <MenuItem onClick={onImportProjectCircuits}>Import Circuits</MenuItem>\r\n      <DividerMenuItem />\r\n      <MenuItem onClick={onExportLink}>Export Link</MenuItem>\r\n    </Menu>\r\n  );\r\n};\r\n\r\nexport default FileMenu;\r\n","import { os } from \"platform\";\r\n\r\nconst OS_MAC = /(Mac|iOS|OS\\ X)/;\r\n\r\nexport const keyboardIsMac = OS_MAC.test((os || \"undefined\").toString());\r\n\r\nexport const keyboardCommandModifier = keyboardIsMac ? \"command\" : \"ctrl\";\r\n","import { AppState } from \"@/store\";\r\n\r\nexport const canUndoSelector = (state: AppState) =>\r\n  state.undo.undoStack.length > 0;\r\nexport const canRedoSelector = (state: AppState) =>\r\n  state.undo.redoStack.length > 0;\r\n","import { createClipboardSelector } from \"../utils\";\r\n\r\nexport const canPasteSelector = createClipboardSelector(\r\n  (s) => s.clipboardElements.length > 0\r\n);\r\n","import * as React from \"react\";\r\n\r\nimport { keyboardCommandModifier } from \"@/runtime-env\";\r\n\r\nimport { useAction } from \"@/hooks/useAction\";\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { canRedoSelector, canUndoSelector } from \"@/undo/selectors\";\r\n\r\nimport { selectedElementIdsSelector } from \"@/services/selection/selectors/selection\";\r\nimport { canPasteSelector } from \"@/services/clipboard/selectors/clipboard\";\r\n\r\nimport { undo } from \"@/actions/undo\";\r\nimport { redo } from \"@/actions/redo\";\r\nimport { copySelection } from \"@/actions/selection-copy\";\r\nimport { paste } from \"@/actions/clipboard-paste\";\r\n\r\nimport Menu from \"@/components/Menus/Menu\";\r\nimport MenuItem from \"@/components/Menus/MenuItem\";\r\nimport DividerMenuItem from \"@/components/Menus/DividerMenuItem\";\r\n\r\nconst EditMenu: React.FC = () => {\r\n  const canUndo = useSelector(canUndoSelector);\r\n  const onUndo = useAction(undo);\r\n  const canRedo = useSelector(canRedoSelector);\r\n  const onRedo = useAction(redo);\r\n\r\n  const canCopy = useSelector(selectedElementIdsSelector).length > 0;\r\n  const onCopy = useAction(copySelection);\r\n  const canPaste = useSelector(canPasteSelector);\r\n  const onPaste = useAction(paste);\r\n\r\n  return (\r\n    <Menu>\r\n      <MenuItem\r\n        disabled={!canUndo}\r\n        secondary={`${keyboardCommandModifier}+z`}\r\n        onClick={onUndo}\r\n      >\r\n        Undo\r\n      </MenuItem>\r\n      <MenuItem\r\n        disabled={!canRedo}\r\n        secondary={`${keyboardCommandModifier}+shift+z`}\r\n        onClick={onRedo}\r\n      >\r\n        Redo\r\n      </MenuItem>\r\n      <DividerMenuItem />\r\n      <MenuItem\r\n        disabled={!canCopy}\r\n        secondary={`${keyboardCommandModifier}+c`}\r\n        onClick={onCopy}\r\n      >\r\n        Copy\r\n      </MenuItem>\r\n      <MenuItem\r\n        disabled={!canPaste}\r\n        secondary={`${keyboardCommandModifier}+v`}\r\n        onClick={onPaste}\r\n      >\r\n        Paste\r\n      </MenuItem>\r\n    </Menu>\r\n  );\r\n};\r\n\r\nexport default EditMenu;\r\n","import { AppState } from \"@/store\";\r\n\r\nimport {\r\n  elementNameFromElementIdSelector,\r\n  elementNameOrDefaultFromElementIdSelector,\r\n} from \"@/services/circuit-graph/selectors/elements\";\r\nimport { createUiSettingsSelector } from \"../utils\";\r\n\r\nexport const elementNameModeSelector = createUiSettingsSelector(\r\n  (s) => s.elementNameMode\r\n);\r\n\r\nexport const elementFieldDisplayNameFromElementId = (\r\n  state: AppState,\r\n  elementId: string\r\n) => {\r\n  const mode = state.services.uiSettings.elementNameMode;\r\n  switch (mode) {\r\n    case \"all\":\r\n    default:\r\n      return elementNameOrDefaultFromElementIdSelector(state, elementId);\r\n    case \"named-only\":\r\n      return elementNameFromElementIdSelector(state, elementId);\r\n    case \"none\":\r\n      return null;\r\n  }\r\n};\r\n","export * from \"./Checkbox\";\r\nimport Checkbox from \"./Checkbox\";\r\nexport default Checkbox;\r\n","import * as React from \"react\";\r\n\r\nimport styles from \"./Checkbox.module.css\";\r\n\r\nexport interface CheckboxProps {\r\n  className?: string;\r\n  value: boolean;\r\n  onChange(e: React.ChangeEvent<HTMLInputElement>): void;\r\n}\r\n\r\nconst Checkbox: React.FC<CheckboxProps> = ({\r\n  className,\r\n  value,\r\n  onChange,\r\n  children,\r\n}) => {\r\n  return (\r\n    <label className={className}>\r\n      <span className={styles[\"checkbox-span\"]}>\r\n        <input type=\"checkbox\" checked={value} onChange={onChange} />\r\n      </span>\r\n      {children}\r\n    </label>\r\n  );\r\n};\r\n\r\nexport default Checkbox;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"checkbox-span\":\"checkbox-span--1EWGs\"};","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport Checkbox from \"@/components/Checkbox\";\r\n\r\nimport styles from \"./Menus.module.css\";\r\n\r\nexport interface CheckboxMenuItemProps {\r\n  disabled?: boolean;\r\n  secondary?: string;\r\n  value: boolean;\r\n  onChange(e: React.ChangeEvent<HTMLInputElement>): void;\r\n}\r\nconst CheckboxMenuItem: React.FC<CheckboxMenuItemProps> = ({\r\n  disabled,\r\n  secondary,\r\n  value,\r\n  onChange,\r\n  children,\r\n}) => {\r\n  return (\r\n    <li\r\n      className={cls(\r\n        styles[\"menu-item\"],\r\n        disabled && styles[\"menu-item--disabled\"]\r\n      )}\r\n    >\r\n      <Checkbox\r\n        className={styles[\"menu-item-content\"]}\r\n        value={value}\r\n        onChange={onChange}\r\n      >\r\n        <span className={styles[\"menu-item-text\"]}>{children}</span>\r\n        {secondary && (\r\n          <span className={styles[\"menu-item-secondary\"]}>{secondary}</span>\r\n        )}\r\n      </Checkbox>\r\n    </li>\r\n  );\r\n};\r\n\r\nexport default CheckboxMenuItem;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport AutoPopover from \"@/components/AutoPopover\";\r\n\r\nimport styles from \"./Menus.module.css\";\r\n\r\nexport interface SubMenuItemProps {\r\n  disabled?: boolean;\r\n  secondary?: string;\r\n  content: JSX.Element;\r\n}\r\nconst SubMenuItem: React.FC<SubMenuItemProps> = ({\r\n  disabled,\r\n  secondary,\r\n  content,\r\n  children,\r\n}) => {\r\n  return (\r\n    <li\r\n      className={cls(\r\n        styles[\"menu-item\"],\r\n        disabled && styles[\"menu-item--disabled\"]\r\n      )}\r\n    >\r\n      <AutoPopover placement=\"right-start\" content={content}>\r\n        <a className={styles[\"menu-item-content\"]}>\r\n          <span className={styles[\"menu-item-text\"]}>{children}</span>\r\n          {secondary && (\r\n            <span className={styles[\"menu-item-secondary\"]}>{secondary}</span>\r\n          )}\r\n          <svg className={styles[\"menu-item-icon\"]} width={12} height={12}>\r\n            <path d=\"M0,0 l6,6 l-6,6 z\" fill=\"black\" strokeWidth={0} />\r\n          </svg>\r\n        </a>\r\n      </AutoPopover>\r\n    </li>\r\n  );\r\n};\r\n\r\nexport default SubMenuItem;\r\n","import * as React from \"react\";\r\n\r\nimport { useAction } from \"@/hooks/useAction\";\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { viewElementNames } from \"@/actions/view-element-names\";\r\nimport { resetView } from \"@/actions/view-reset\";\r\n\r\nimport { elementNameModeSelector } from \"@/services/ui-settings/selectors/element-name\";\r\n\r\nimport Menu from \"@/components/Menus/Menu\";\r\nimport CheckboxMenuItemItem from \"@/components/Menus/CheckboxMenuItem\";\r\nimport SubMenuItem from \"@/components/Menus/SubMenuItem\";\r\nimport DividerMenuItem from \"@/components/Menus/DividerMenuItem\";\r\nimport MenuItem from \"@/components/Menus/MenuItem\";\r\n\r\nconst ViewMenu: React.FC = () => {\r\n  const onResetView = useAction(resetView);\r\n  return (\r\n    <Menu>\r\n      <SubMenuItem content={<ElementNamesMenu />}>Element Names</SubMenuItem>\r\n      <DividerMenuItem />\r\n      <MenuItem onClick={onResetView}>Reset View</MenuItem>\r\n    </Menu>\r\n  );\r\n};\r\n\r\nconst ElementNamesMenu: React.FC = () => {\r\n  const mode = useSelector(elementNameModeSelector);\r\n  const onAlwaysVisible = useAction(viewElementNames, \"all\");\r\n  const onNamedOnly = useAction(viewElementNames, \"named-only\");\r\n  const onHidden = useAction(viewElementNames, \"none\");\r\n\r\n  return (\r\n    <Menu>\r\n      <CheckboxMenuItemItem value={mode === \"all\"} onChange={onAlwaysVisible}>\r\n        Always visible\r\n      </CheckboxMenuItemItem>\r\n      <CheckboxMenuItemItem\r\n        value={mode === \"named-only\"}\r\n        onChange={onNamedOnly}\r\n      >\r\n        Named Items Only\r\n      </CheckboxMenuItemItem>\r\n      <CheckboxMenuItemItem value={mode === \"none\"} onChange={onHidden}>\r\n        Hidden\r\n      </CheckboxMenuItemItem>\r\n    </Menu>\r\n  );\r\n};\r\n\r\nexport default ViewMenu;\r\n","import * as React from \"react\";\r\n\r\nimport { useAction } from \"@/hooks/useAction\";\r\n\r\nimport { tutorialStart } from \"@/actions/tutorial-start\";\r\n\r\nimport Menu from \"@/components/Menus/Menu\";\r\nimport MenuItem from \"@/components/Menus/MenuItem\";\r\nimport SubMenuItem from \"@/components/Menus/SubMenuItem\";\r\n\r\nconst HelpMenu: React.FC = () => {\r\n  return (\r\n    <Menu>\r\n      <SubMenuItem content={<TutorialsMenu />}>Tutorials</SubMenuItem>\r\n    </Menu>\r\n  );\r\n};\r\n\r\nconst TutorialsMenu: React.FC = () => {\r\n  const onBasicsTutorial = useAction(tutorialStart, \"basics\");\r\n  const onCircuitsTutorial = useAction(tutorialStart, \"circuits\");\r\n  return (\r\n    <Menu>\r\n      <MenuItem onClick={onBasicsTutorial}>Basics</MenuItem>\r\n      <MenuItem onClick={onCircuitsTutorial}>Circuits</MenuItem>\r\n    </Menu>\r\n  );\r\n};\r\n\r\nexport default HelpMenu;\r\n","import { createSimulatorSelector } from \"../utils\";\r\n\r\nexport const averageMsecsPerTickSelector = createSimulatorSelector(\r\n  (state) => state.lastTickProcessingTimeMs\r\n);\r\n","// extracted by mini-css-extract-plugin\nexport default {\"icon\":\"icon--3Vly6\"};","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport styles from \"./Icons.module.css\";\r\n\r\nconst PlayIcon: React.FC<React.SVGProps<SVGSVGElement>> = (props) => {\r\n  return (\r\n    <svg\r\n      width={16}\r\n      height={16}\r\n      {...props}\r\n      className={cls(styles.icon, props.className)}\r\n    >\r\n      <path d=\"M3,0 L13,8 L3,16 z\" />\r\n    </svg>\r\n  );\r\n};\r\n\r\nexport default PlayIcon;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport styles from \"./Icons.module.css\";\r\n\r\nconst StopIcon: React.FC<React.SVGProps<SVGSVGElement>> = (props) => {\r\n  return (\r\n    <svg\r\n      width={16}\r\n      height={16}\r\n      {...props}\r\n      className={cls(styles.icon, props.className)}\r\n    >\r\n      <path d=\"M1,1 L15,1 L15,15 L1,15 z\" />\r\n    </svg>\r\n  );\r\n};\r\n\r\nexport default StopIcon;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport styles from \"./Icons.module.css\";\r\n\r\nconst PauseIcon: React.FC<React.SVGProps<SVGSVGElement>> = (props) => {\r\n  return (\r\n    <svg\r\n      width={16}\r\n      height={16}\r\n      {...props}\r\n      className={cls(styles.icon, props.className)}\r\n    >\r\n      <path d=\"M2.5,1 L6.5,1 L6.5,15 L2.5,15 z M9.5,1 L13.5,1 L13.5,15 L9.5,15 z\" />\r\n    </svg>\r\n  );\r\n};\r\n\r\nexport default PauseIcon;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport styles from \"./Icons.module.css\";\r\n\r\nconst StepIcon: React.FC<React.SVGProps<SVGSVGElement>> = (props) => {\r\n  return (\r\n    <svg\r\n      width={16}\r\n      height={16}\r\n      {...props}\r\n      className={cls(styles.icon, props.className)}\r\n    >\r\n      <path d=\"M3,0 L13,8 L3,16 z M11,1 l2,0 l0,14 l-2,0 z\" />\r\n    </svg>\r\n  );\r\n};\r\n\r\nexport default StepIcon;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"button\":\"button--2N_ol\",\"button-play\":\"button-play--1vWfq\",\"button-stop\":\"button-stop--1dD4-\",\"button-pause\":\"button-pause--1UoHJ\",\"selected\":\"selected--Ev2q8\",\"button-step\":\"button-step--3Fat5\",\"button--disabled\":\"button--disabled--3caLv\",\"simrate\":\"simrate--NKBi_\"};","import SimControls from \"./SimControls\";\r\nexport default SimControls;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useClickAction } from \"@/hooks/useAction\";\r\n\r\nimport { startSim } from \"@/actions/sim-start\";\r\nimport { stopSim } from \"@/actions/sim-stop\";\r\nimport { pauseSim } from \"@/actions/sim-pause\";\r\nimport { stepSim } from \"@/actions/sim-step\";\r\n\r\nimport {\r\n  isSimActiveSelector,\r\n  isSimPausedSelector,\r\n} from \"@/services/simulator-control/selectors/run\";\r\nimport { averageMsecsPerTickSelector } from \"@/services/simulator/selectors/performance\";\r\n\r\nimport PlayIcon from \"@/components/Icons/Play\";\r\nimport StopIcon from \"@/components/Icons/Stop\";\r\nimport PauseIcon from \"@/components/Icons/Pause\";\r\nimport StepIcon from \"@/components/Icons/Step\";\r\n\r\nimport styles from \"./SimControls.module.css\";\r\n\r\nconst PlayPauseButton: React.FC = () => {\r\n  const isActive = useSelector(isSimActiveSelector);\r\n  const isPaused = useSelector(isSimPausedSelector);\r\n\r\n  const avgMsecsPerTick = useSelector(averageMsecsPerTickSelector);\r\n\r\n  const onPlayClick = useClickAction(startSim);\r\n  const onStopClick = useClickAction(stopSim);\r\n  const onPauseClick = useClickAction(pauseSim, \"toggle\");\r\n  const onStepClick = useClickAction(stepSim);\r\n\r\n  const onMuteMouseDown = React.useCallback((e: React.MouseEvent) => {\r\n    // Prevent rapid clicks from selecting nearby text.\r\n    e.preventDefault();\r\n  }, []);\r\n\r\n  return (\r\n    <span>\r\n      {isActive && (\r\n        <span className={styles[\"simrate\"]}>\r\n          {avgMsecsPerTick.toFixed(2)} ms\r\n        </span>\r\n      )}\r\n      {isActive ? (\r\n        <StopIcon\r\n          id=\"simctrl-stop\"\r\n          className={cls(styles[\"button\"], styles[\"button-stop\"])}\r\n          onClick={onStopClick}\r\n          onMouseDown={onMuteMouseDown}\r\n        />\r\n      ) : (\r\n        <PlayIcon\r\n          id=\"simctrl-run\"\r\n          className={cls(styles[\"button\"], styles[\"button-play\"])}\r\n          onClick={onPlayClick}\r\n          onMouseDown={onMuteMouseDown}\r\n        />\r\n      )}\r\n      <StepIcon\r\n        id=\"simctrl-step\"\r\n        className={cls(styles[\"button\"], styles[\"button-step\"])}\r\n        onClick={onStepClick}\r\n        onMouseDown={onMuteMouseDown}\r\n      />\r\n      <PauseIcon\r\n        id=\"simctrl-pause\"\r\n        className={cls(\r\n          styles[\"button\"],\r\n          styles[\"button-pause\"],\r\n          !isActive && styles[\"button--disabled\"],\r\n          isPaused && styles[\"selected\"]\r\n        )}\r\n        onClick={onPauseClick}\r\n        onMouseDown={onMuteMouseDown}\r\n      />\r\n    </span>\r\n  );\r\n};\r\n\r\nexport default PlayPauseButton;\r\n","import ProjectEditorTitleBar from \"./ProjectEditorTitleBar\";\r\nexport default ProjectEditorTitleBar;\r\n","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport {\r\n  projectModifiedSelector,\r\n  projectNameSelector,\r\n} from \"@/services/project/selectors/project\";\r\n\r\nimport TitleBar from \"@/components/TitleBar\";\r\nimport AutoPopover from \"@/components/AutoPopover\";\r\nimport Button from \"@/components/Button\";\r\n\r\nimport FileMenu from \"../FileMenu\";\r\nimport EditMenu from \"../EditMenu\";\r\nimport ViewMenu from \"../ViewMenu\";\r\nimport HelpMenu from \"../HelpMenu\";\r\nimport SimControls from \"../SimControls\";\r\n\r\nimport styles from \"./ProjectEditorTitleBar.module.css\";\r\n\r\nexport interface ProjectEditorTitleBarProps {\r\n  className?: string;\r\n}\r\nconst ProjectEditorTitleBar: React.FC<ProjectEditorTitleBarProps> = ({\r\n  className,\r\n}) => {\r\n  const projectName = useSelector(projectNameSelector);\r\n  const projectModified = useSelector(projectModifiedSelector);\r\n\r\n  const title = `${projectName}${projectModified ? \"*\" : \"\"}`;\r\n\r\n  return (\r\n    <TitleBar className={className} title={title}>\r\n      <AutoPopover content={<FileMenu />} placement=\"bottom-start\">\r\n        <Button variant=\"menu\">File</Button>\r\n      </AutoPopover>\r\n      <AutoPopover content={<EditMenu />} placement=\"bottom-start\">\r\n        <Button variant=\"menu\">Edit</Button>\r\n      </AutoPopover>\r\n      <AutoPopover content={<ViewMenu />} placement=\"bottom-start\">\r\n        <Button variant=\"menu\">View</Button>\r\n      </AutoPopover>\r\n      <AutoPopover content={<HelpMenu />} placement=\"bottom-start\">\r\n        <Button variant=\"menu\">Help</Button>\r\n      </AutoPopover>\r\n      <div className={styles[\"project-titlebar-controls\"]}>\r\n        <SimControls />\r\n      </div>\r\n    </TitleBar>\r\n  );\r\n};\r\n\r\nexport default ProjectEditorTitleBar;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"project-titlebar-controls\":\"project-titlebar-controls--1c1Qn\"};","// extracted by mini-css-extract-plugin\nexport default {\"circuit-element-breadcrumb\":\"circuit-element-breadcrumb--1CYNC\"};","import * as React from \"react\";\r\nimport last from \"lodash/last\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { elementTypeToCircuitId } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nimport { viewCircuit } from \"@/actions/view-circuit\";\r\n\r\nimport {\r\n  elementNameOrDefaultFromElementIdSelector,\r\n  elementTypeFromElementIdSelector,\r\n} from \"@/services/circuit-graph/selectors/elements\";\r\nimport { circuitNameFromIdSelector } from \"@/services/circuit-properties/selectors/circuits\";\r\nimport { ROOT_CIRCUIT_ID } from \"@/services/circuits/constants\";\r\n\r\nimport Button from \"../Button\";\r\n\r\nimport styles from \"./CircuitNodeBreadcrumb.module.css\";\r\n\r\nexport interface CircuitNodeBreadcrumbProps {\r\n  circuitId: string;\r\n  elementIdPath: string[];\r\n}\r\nconst CircuitNodeBreadcrumb: React.FC<CircuitNodeBreadcrumbProps> = ({\r\n  circuitId,\r\n  elementIdPath,\r\n}) => {\r\n  const elements: JSX.Element[] = elementIdPath.map((elementId, index) => {\r\n    const elementPath = elementIdPath.slice(0, index + 1);\r\n    return (\r\n      <React.Fragment key={elementId}>\r\n        <span>&gt;</span>\r\n        <CircuitNodeBreadcrumbItem elementIdPath={elementPath} />\r\n      </React.Fragment>\r\n    );\r\n  });\r\n\r\n  return (\r\n    <div\r\n      className={cls(\r\n        \"circuit-element-breadcrumb\",\r\n        styles[\"circuit-element-breadcrumb\"]\r\n      )}\r\n    >\r\n      <CircuitNodeBreadcrumbRootItem\r\n        circuitId={circuitId}\r\n        elementIdPath={elementIdPath}\r\n      />\r\n      {elements}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CircuitNodeBreadcrumb;\r\n\r\ninterface CircuitNodeBreadcrumbRootItemProps {\r\n  circuitId: string;\r\n  elementIdPath: string[];\r\n}\r\nconst CircuitNodeBreadcrumbRootItem: React.FC<CircuitNodeBreadcrumbRootItemProps> = ({\r\n  circuitId,\r\n  elementIdPath,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n  const rootCircuitName = useSelector((state) =>\r\n    circuitNameFromIdSelector(state, ROOT_CIRCUIT_ID)\r\n  );\r\n  const circuitName = useSelector((state) =>\r\n    circuitNameFromIdSelector(state, circuitId)\r\n  );\r\n\r\n  const onClick = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      e.preventDefault();\r\n      dispatch(viewCircuit(ROOT_CIRCUIT_ID, []));\r\n    },\r\n    [dispatch]\r\n  );\r\n\r\n  return (\r\n    <Button variant=\"text\" size=\"small\" onClick={onClick}>\r\n      {elementIdPath.length === 0 ? circuitName : rootCircuitName}\r\n    </Button>\r\n  );\r\n};\r\n\r\ninterface CircuitNodeBreadcrumbItemProps {\r\n  elementIdPath: string[];\r\n}\r\n\r\nconst CircuitNodeBreadcrumbItem: React.FC<CircuitNodeBreadcrumbItemProps> = ({\r\n  elementIdPath: elementIdPath,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n  const elementId = last(elementIdPath)!;\r\n\r\n  const elementType = useSelector((state) =>\r\n    elementTypeFromElementIdSelector(state, elementId)\r\n  );\r\n  const elementName = useSelector((state) =>\r\n    elementNameOrDefaultFromElementIdSelector(state, elementId)\r\n  );\r\n\r\n  const circuitId = elementType ? elementTypeToCircuitId(elementType) : null;\r\n  const circuitName = useSelector((state) =>\r\n    circuitId ? circuitNameFromIdSelector(state, circuitId) : null\r\n  );\r\n\r\n  const onClick = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      e.preventDefault();\r\n      if (!circuitId) {\r\n        return;\r\n      }\r\n      dispatch(viewCircuit(circuitId, elementIdPath));\r\n    },\r\n    [circuitId, elementIdPath, dispatch]\r\n  );\r\n\r\n  return (\r\n    <Button variant=\"text\" size=\"small\" onClick={onClick}>\r\n      {elementName} [{circuitName}]\r\n    </Button>\r\n  );\r\n};\r\n","import CircuitNodeBreadcrumb from \"./CircuitNodeBreadcrumb\";\r\nexport default CircuitNodeBreadcrumb;\r\n","import { createSelector } from \"reselect\";\r\nimport values from \"lodash/values\";\r\n\r\nimport { Rectangle, union } from \"@/geometry\";\r\n\r\nimport { wireJointPositionByJointIdSelector } from \"@/services/circuit-graph/selectors/wire-positions\";\r\n\r\nimport { elementRectsByIdSelector } from \"./element-bounds\";\r\n\r\nconst MinFieldRect: Readonly<Rectangle> = Object.freeze({\r\n  p1: {\r\n    x: -100,\r\n    y: -100,\r\n  },\r\n  p2: {\r\n    x: 100,\r\n    y: 100,\r\n  },\r\n});\r\n\r\nexport const fieldRectSelector = createSelector(\r\n  elementRectsByIdSelector,\r\n  wireJointPositionByJointIdSelector,\r\n  (elementRectsById, jointsById) => {\r\n    const elementRects = values(elementRectsById);\r\n    const jointRects = values(jointsById).map((p) => ({ p1: p, p2: p }));\r\n\r\n    return [...elementRects, ...jointRects].reduce(union, MinFieldRect);\r\n  }\r\n);\r\n","import { DragObjectWithType } from \"react-dnd\";\r\n\r\nexport const NEW_ELEMENT_DRAG_OBJECT = \"@element/new\" as const;\r\nexport const newElementDragObject = (elementType: string) => ({\r\n  type: NEW_ELEMENT_DRAG_OBJECT,\r\n  payload: { elementType },\r\n});\r\nexport type NewElementDragObject = ReturnType<typeof newElementDragObject>;\r\nexport function isNewElementDragObject(\r\n  item: DragObjectWithType\r\n): item is NewElementDragObject {\r\n  return item.type === NEW_ELEMENT_DRAG_OBJECT;\r\n}\r\n","import * as React from \"react\";\r\n\r\nexport interface ViewportContext {\r\n  zoomFactor: number;\r\n  zoom(factor: number): void;\r\n}\r\n\r\nconst viewportContext = React.createContext<ViewportContext>({\r\n  zoomFactor: 1,\r\n  zoom: () => {\r\n    /* no op */\r\n  },\r\n});\r\n\r\nexport function useViewportContext(): ViewportContext {\r\n  return React.useContext(viewportContext);\r\n}\r\n\r\nconst SCALE_FACTOR = 1.03;\r\n\r\nexport const ViewportContextProvider: React.FC = ({ children }) => {\r\n  const [zoomFactor, setZoomFactor] = React.useState(1);\r\n  const zoom = React.useCallback((delta: number) => {\r\n    setZoomFactor((zoomFactor) =>\r\n      delta > 0\r\n        ? zoomFactor * delta * SCALE_FACTOR\r\n        : zoomFactor / (-delta * SCALE_FACTOR)\r\n    );\r\n  }, []);\r\n\r\n  const context = React.useMemo<ViewportContext>(\r\n    () => ({\r\n      zoomFactor,\r\n      zoom,\r\n    }),\r\n    [zoom, zoomFactor]\r\n  );\r\n  return (\r\n    <viewportContext.Provider value={context}>\r\n      {children}\r\n    </viewportContext.Provider>\r\n  );\r\n};\r\n","import * as React from \"react\";\r\n\r\nexport interface FieldSvgElementContext {\r\n  svgRef: React.RefObject<SVGSVGElement | null>;\r\n  scalerRef: React.RefObject<SVGGraphicsElement | null>;\r\n}\r\nconst nullRef = { current: null };\r\nexport const fieldSvgElementContext = React.createContext<\r\n  FieldSvgElementContext\r\n>({ svgRef: nullRef, scalerRef: nullRef });\r\n\r\nconst ContextProvider = fieldSvgElementContext.Provider;\r\n\r\nexport const FieldSvgElementProvider: React.FC<{\r\n  svgRef: React.RefObject<SVGSVGElement | null>;\r\n  scalerRef: React.RefObject<SVGGraphicsElement | null>;\r\n}> = ({ svgRef, scalerRef, children }) => {\r\n  const context = React.useMemo(\r\n    () => ({\r\n      svgRef,\r\n      scalerRef,\r\n    }),\r\n    [svgRef, scalerRef]\r\n  );\r\n  return <ContextProvider value={context}>{children}</ContextProvider>;\r\n};\r\n","import { AppState } from \"@/store\";\r\n\r\nimport { circuitIdToElementType } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nimport { CircuitGraphServiceState } from \"../state\";\r\nimport { createCircuitGraphSelector } from \"../utils\";\r\n\r\nconst circuitIdForElementIdSelector = createCircuitGraphSelector(\r\n  (state: CircuitGraphServiceState, elementId: string) => {\r\n    const { elementIdsByCircuitId } = state;\r\n    const circuitIds = Object.keys(elementIdsByCircuitId);\r\n    for (const circuitId of circuitIds) {\r\n      if (elementIdsByCircuitId[circuitId].indexOf(elementId) !== -1) {\r\n        return circuitId;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n);\r\n\r\nexport const circuitWouldRecurseSelector = (\r\n  state: AppState,\r\n  circuitId: string | null,\r\n  targetCircuitId: string\r\n): boolean => {\r\n  if (!circuitId) {\r\n    return false;\r\n  }\r\n  if (circuitId === targetCircuitId) {\r\n    return true;\r\n  }\r\n\r\n  const targetCircuitNodeType = circuitIdToElementType(targetCircuitId);\r\n  const { elementsById } = state.services.circuitGraph;\r\n  const targetCircuitElementIds = Object.keys(elementsById).filter(\r\n    (elementId) => elementsById[elementId].elementType === targetCircuitNodeType\r\n  );\r\n\r\n  return targetCircuitElementIds.some((elementId) => {\r\n    const targetContainingCircuitId = circuitIdForElementIdSelector(\r\n      state,\r\n      elementId\r\n    );\r\n    if (!targetContainingCircuitId) {\r\n      return false;\r\n    }\r\n    return circuitWouldRecurseSelector(\r\n      state,\r\n      circuitId,\r\n      targetContainingCircuitId\r\n    );\r\n  });\r\n};\r\n","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { circuitEditorStateFromIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\n\r\nexport interface CircuitEditorContext {\r\n  editorId: string;\r\n  circuitId: string;\r\n  elementIdPath: string[];\r\n}\r\n\r\nconst circuitEditorContext = React.createContext<CircuitEditorContext>({\r\n  editorId: \"~none\",\r\n  circuitId: \"~none\",\r\n  elementIdPath: [],\r\n});\r\n\r\nexport function useCircuitEditor(): CircuitEditorContext {\r\n  return React.useContext(circuitEditorContext);\r\n}\r\n\r\nexport interface CircuitEditorProviderProps {\r\n  editorId: string;\r\n}\r\nexport const CircuitEditorProvider: React.FC<CircuitEditorProviderProps> = ({\r\n  editorId,\r\n  children,\r\n}) => {\r\n  const editorState = useSelector((state) =>\r\n    circuitEditorStateFromIdSelector(state, editorId)\r\n  );\r\n  const { circuitId, elementIdPath } = editorState ?? {\r\n    circuitId: \"~none\",\r\n    elementIdPath: [],\r\n  };\r\n\r\n  const context = React.useMemo<CircuitEditorContext>(\r\n    () => ({\r\n      editorId,\r\n      circuitId,\r\n      elementIdPath: elementIdPath,\r\n    }),\r\n    [circuitId, elementIdPath, editorId]\r\n  );\r\n\r\n  if (!editorState) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <circuitEditorContext.Provider value={context}>\r\n      {children}\r\n    </circuitEditorContext.Provider>\r\n  );\r\n};\r\n","import { Point } from \"@/geometry\";\r\n\r\nexport function getFieldCoord(\r\n  field: SVGSVGElement,\r\n  scaler: SVGGraphicsElement,\r\n  p: Point\r\n) {\r\n  const ctm = scaler.getScreenCTM();\r\n  if (!ctm) {\r\n    return p;\r\n  }\r\n\r\n  const pt = field.createSVGPoint();\r\n  pt.x = p.x;\r\n  pt.y = p.y;\r\n  const translated = pt.matrixTransform(ctm.inverse());\r\n  return { x: translated.x, y: translated.y };\r\n}\r\n","import * as React from \"react\";\r\n\r\nimport { Point, ZeroPoint } from \"@/geometry\";\r\n\r\nimport { fieldSvgElementContext } from \"../contexts/fieldSvgElement\";\r\nimport { getFieldCoord } from \"../../../utils\";\r\n\r\nexport function useMouseCoords(): (p: Point) => Point {\r\n  const { svgRef, scalerRef } = React.useContext(fieldSvgElementContext);\r\n  return React.useCallback(\r\n    (p: Point) => {\r\n      if (!svgRef.current || !scalerRef.current) {\r\n        return p;\r\n      }\r\n      return getFieldCoord(svgRef.current, scalerRef.current, p);\r\n    },\r\n    [svgRef, scalerRef]\r\n  );\r\n}\r\n\r\nexport function useEventMouseCoords(): (\r\n  e: MouseEvent | React.MouseEvent\r\n) => Point {\r\n  const { svgRef, scalerRef } = React.useContext(fieldSvgElementContext);\r\n  return React.useCallback(\r\n    (e: MouseEvent | React.MouseEvent) => {\r\n      if (!svgRef.current || !scalerRef.current) {\r\n        return ZeroPoint;\r\n      }\r\n      const p: Point = {\r\n        x: e.pageX,\r\n        y: e.pageY,\r\n      };\r\n      return getFieldCoord(svgRef.current, scalerRef.current, p);\r\n    },\r\n    [svgRef, scalerRef]\r\n  );\r\n}\r\n","// extracted by mini-css-extract-plugin\nexport default {\"text-unselectable\":\"text-unselectable--2tvXe\"};","// extracted by mini-css-extract-plugin\nexport default {\"element-interaction-toggle\":\"element-interaction-toggle--1eeE2\",\"element-interaction-momentary\":\"element-interaction-momentary--12_iQ\"};","import * as React from \"react\";\r\n\r\nimport {\r\n  ElementComponentType,\r\n  ElementVisualDefinition,\r\n} from \"@/elements/types\";\r\n\r\nimport { IntegratedCircuitElementVisual } from \"./IntegratedCircuitElementVisual\";\r\nimport { MomentaryInteractionElementVisual } from \"./MomentaryInteractionElementVisual\";\r\nimport { ToggleInteractionElementVisual } from \"./ToggleInteractionElementVisual\";\r\n\r\nconst NamedElementComponents: Record<string, ElementComponentType> = {\r\n  \"integrated-circuit\": IntegratedCircuitElementVisual,\r\n  \"interaction-momentary\": MomentaryInteractionElementVisual,\r\n  \"interaction-toggle\": ToggleInteractionElementVisual,\r\n};\r\n\r\nconst ErrorComponent: React.FC<{ componentName: string }> = ({\r\n  componentName,\r\n}) => {\r\n  return (\r\n    <g>\r\n      <rect width={50} height={50} fill=\"red\" />\r\n      <text x={25} y={25} dominantBaseline=\"middle\">\r\n        {componentName}\r\n      </text>\r\n    </g>\r\n  );\r\n};\r\n\r\nexport function getNodeVisualElement(\r\n  elementId: string | undefined,\r\n  elementPath: string[] | undefined,\r\n  evolverState: any,\r\n  visual: ElementVisualDefinition\r\n): JSX.Element {\r\n  const { component, componentProps } = visual;\r\n\r\n  const elementProps = {\r\n    elementId,\r\n    elementPath,\r\n    evolverState,\r\n    ...componentProps,\r\n  };\r\n\r\n  let Component: ElementComponentType;\r\n  if (typeof component === \"string\") {\r\n    Component = NamedElementComponents[component];\r\n    if (!Component) {\r\n      // Making a new component here each pass will invalidate the dom on every render,\r\n      //  but this only is for exceptional error cases anyway.\r\n      Component = () => <ErrorComponent componentName={component} />;\r\n    }\r\n  } else {\r\n    Component = component;\r\n  }\r\n\r\n  return <Component {...elementProps} />;\r\n}\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport { viewCircuit } from \"@/actions/view-circuit\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport interaction from \"@/styles/interaction.module.css\";\r\n\r\nimport { circuitNameFromIdSelector } from \"@/services/circuit-properties/selectors/circuits\";\r\nimport { elementNamesByElementIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { ElementComponentProps } from \"@/elements/types\";\r\n\r\nimport { getICBorderPath } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nexport interface IntegratedCircuitElementVisualProps {\r\n  circuitId: string;\r\n  inputPinIds: string[];\r\n  outputPinIds: string[];\r\n}\r\n\r\nexport const IntegratedCircuitElementVisual: React.FC<\r\n  IntegratedCircuitElementVisualProps & ElementComponentProps\r\n> = ({ elementId, elementPath, circuitId, inputPinIds, outputPinIds }) => {\r\n  const dispatch = useDispatch();\r\n  // TODO: Now that we are relying on components being in a tessel path, we\r\n  // definitely should move element components into children of CircuitEditor\r\n  // and connect to them from element-types using ids.\r\n  // More practically: this should ignore tessel path and instead rely on ui-layout\r\n  // to open us up in the last interacted with view.\r\n  const circuitName = useSelector((state) =>\r\n    circuitNameFromIdSelector(state, circuitId)\r\n  );\r\n\r\n  const elementNamesById = useSelector(elementNamesByElementIdSelector);\r\n\r\n  const borderPath = getICBorderPath(inputPinIds.length, outputPinIds.length);\r\n\r\n  const onViewCircuit = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (!elementId) {\r\n        return;\r\n      }\r\n\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      e.preventDefault();\r\n\r\n      dispatch(viewCircuit(circuitId, [...(elementPath || []), elementId]));\r\n    },\r\n    [elementId, dispatch, circuitId, elementPath]\r\n  );\r\n\r\n  const inputPins = inputPinIds.map((pinId, i) => {\r\n    const y = i * 50 + 25;\r\n    return (\r\n      <g key={pinId}>\r\n        <line\r\n          className=\"element-select-highlight--stroke\"\r\n          stroke=\"black\"\r\n          strokeWidth={2}\r\n          x1={4}\r\n          y1={y}\r\n          x2={10}\r\n          y2={y}\r\n        />\r\n        <text\r\n          className={interaction[\"text-unselectable\"]}\r\n          x={15}\r\n          y={y}\r\n          dominantBaseline=\"middle\"\r\n          fontSize=\".7em\"\r\n        >\r\n          {elementNamesById[pinId]}\r\n        </text>\r\n      </g>\r\n    );\r\n  });\r\n\r\n  const outputPins = outputPinIds.map((pinId, i) => {\r\n    const y = i * 50 + 25;\r\n    return (\r\n      <g key={pinId}>\r\n        <line\r\n          key={i}\r\n          className=\"element-select-highlight--stroke\"\r\n          stroke=\"black\"\r\n          strokeWidth={2}\r\n          x1={90}\r\n          y1={y}\r\n          x2={100}\r\n          y2={y}\r\n        />\r\n        <text\r\n          className={interaction[\"text-unselectable\"]}\r\n          x={85}\r\n          y={y}\r\n          textAnchor=\"end\"\r\n          dominantBaseline=\"middle\"\r\n          fontSize=\".7em\"\r\n        >\r\n          {elementNamesById[pinId]}\r\n        </text>\r\n      </g>\r\n    );\r\n  });\r\n\r\n  return (\r\n    <g>\r\n      <text\r\n        className={cls(\r\n          interaction[\"text-unselectable\"],\r\n          \"element-select-highlight--fill\"\r\n        )}\r\n        textAnchor=\"middle\"\r\n        x={50}\r\n        y={0}\r\n      >\r\n        {circuitName}\r\n      </text>\r\n      <path\r\n        className=\"element-select-highlight--stroke element-select-highlight--fill\"\r\n        stroke=\"black\"\r\n        fill=\"white\"\r\n        d={borderPath}\r\n        onDoubleClick={onViewCircuit}\r\n      />\r\n      {inputPins}\r\n      {outputPins}\r\n    </g>\r\n  );\r\n};\r\n","import React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport interaction from \"@/styles/interaction.module.css\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { interactElement } from \"@/actions/element-interact\";\r\n\r\nimport { ElementComponentProps } from \"@/elements/types\";\r\nimport { elementOutputsFromCircuitElementIdSelector } from \"@/services/simulator/selectors/elements\";\r\nimport { isSimActiveSelector } from \"@/services/simulator-control/selectors/run\";\r\n\r\nimport styles from \"./element-visuals.module.css\";\r\n\r\nexport const MomentaryInteractionElementVisual: React.FC<ElementComponentProps> = ({\r\n  elementId,\r\n  elementPath,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n  const isSimActive = useSelector(isSimActiveSelector);\r\n\r\n  const circuitIdPath = React.useMemo(\r\n    () => [...(elementPath || []), elementId ?? \"~~none\"],\r\n    [elementPath, elementId]\r\n  );\r\n\r\n  const outputs = useSelector((state) =>\r\n    elementOutputsFromCircuitElementIdSelector(state, circuitIdPath)\r\n  );\r\n\r\n  const onPress = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (!isSimActive) {\r\n        return;\r\n      }\r\n\r\n      if (e.button !== 0) {\r\n        return;\r\n      }\r\n\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      e.preventDefault();\r\n\r\n      dispatch(interactElement(circuitIdPath, true));\r\n    },\r\n    [circuitIdPath, dispatch, isSimActive]\r\n  );\r\n\r\n  const onRelease = React.useCallback(() => {\r\n    if (!isSimActive) {\r\n      return;\r\n    }\r\n\r\n    dispatch(interactElement(circuitIdPath, false));\r\n  }, [circuitIdPath, dispatch, isSimActive]);\r\n\r\n  let onColor = \"darkgreen\";\r\n  let onTextColor = \"lightgrey\";\r\n  if (outputs) {\r\n    if (outputs.OUT) {\r\n      onColor = \"lightgreen\";\r\n      onTextColor = \"black\";\r\n    }\r\n  }\r\n\r\n  return (\r\n    <g\r\n      onMouseDown={onPress}\r\n      onMouseUp={onRelease}\r\n      onMouseLeave={onRelease}\r\n      className={styles[\"element-interaction-toggle\"]}\r\n    >\r\n      <rect\r\n        className=\"element-select-highlight--stroke element-select-highlight--fill\"\r\n        x={5}\r\n        y={5}\r\n        width={40}\r\n        height={40}\r\n        stroke=\"black\"\r\n        fill=\"#AFAFAF\"\r\n        strokeWidth={1}\r\n      />\r\n\r\n      <line x1={45} y1={25} x2={50} y2={25} stroke=\"black\" strokeWidth={2} />\r\n\r\n      <circle cx={25} cy={25} r={17} fill={onColor} />\r\n\r\n      <text\r\n        className={interaction[\"text-unselectable\"]}\r\n        x={25}\r\n        y={25}\r\n        fontSize=\".8em\"\r\n        fill={onTextColor}\r\n        textAnchor=\"middle\"\r\n        dominantBaseline=\"middle\"\r\n      >\r\n        Push\r\n      </text>\r\n    </g>\r\n  );\r\n};\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport interaction from \"@/styles/interaction.module.css\";\r\n\r\nimport { interactElement } from \"@/actions/element-interact\";\r\n\r\nimport { ElementComponentProps } from \"@/elements/types\";\r\n\r\nimport { ToggleEvolverState } from \"@/evolvers/definitions/input-toggle\";\r\n\r\nimport styles from \"./element-visuals.module.css\";\r\n\r\nexport const ToggleInteractionElementVisual: React.FC<ElementComponentProps<\r\n  ToggleEvolverState\r\n>> = ({ elementId, elementPath, evolverState }) => {\r\n  const dispatch = useDispatch();\r\n\r\n  const onClick = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (!elementId) {\r\n        return;\r\n      }\r\n\r\n      if (e.button !== 0) {\r\n        return;\r\n      }\r\n\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      e.preventDefault();\r\n\r\n      dispatch(interactElement([...(elementPath || []), elementId]));\r\n    },\r\n    [elementId, dispatch, elementPath]\r\n  );\r\n\r\n  let onColor = \"darkgreen\";\r\n  let onTextColor = \"lightgrey\";\r\n  let offColor = \"darkred\";\r\n  if (evolverState) {\r\n    const { toggleState } = evolverState;\r\n    if (toggleState) {\r\n      onColor = \"lightgreen\";\r\n      onTextColor = \"black\";\r\n    } else {\r\n      offColor = \"red\";\r\n    }\r\n  }\r\n\r\n  return (\r\n    <g onClick={onClick} className={styles[\"element-interaction-toggle\"]}>\r\n      <rect\r\n        className=\"element-select-highlight--stroke element-select-highlight--fill\"\r\n        x={5}\r\n        y={5}\r\n        width={40}\r\n        height={40}\r\n        stroke=\"black\"\r\n        fill=\"#AFAFAF\"\r\n        strokeWidth={1}\r\n      />\r\n      <line x1={45} y1={25} x2={50} y2={25} stroke=\"black\" strokeWidth={2} />\r\n      <rect\r\n        x={10}\r\n        y={10}\r\n        width={30}\r\n        height={15}\r\n        strokeWidth={0}\r\n        fill={onColor}\r\n      />\r\n      <text\r\n        className={interaction[\"text-unselectable\"]}\r\n        x={25}\r\n        y={19}\r\n        fontSize=\".8em\"\r\n        fill={onTextColor}\r\n        textAnchor=\"middle\"\r\n        dominantBaseline=\"middle\"\r\n      >\r\n        On\r\n      </text>\r\n      <rect\r\n        x={10}\r\n        y={25}\r\n        width={30}\r\n        height={15}\r\n        strokeWidth={0}\r\n        fill={offColor}\r\n      />\r\n      <text\r\n        className={interaction[\"text-unselectable\"]}\r\n        x={25}\r\n        y={34}\r\n        fontSize=\".8em\"\r\n        fill=\"lightgrey\"\r\n        textAnchor=\"middle\"\r\n        dominantBaseline=\"middle\"\r\n      >\r\n        Off\r\n      </text>\r\n    </g>\r\n  );\r\n};\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { elementDefinitionFromTypeSelector } from \"@/services/element-types/selectors/element-types\";\r\nimport { getNodeVisualElement } from \"@/elements/visuals\";\r\n\r\nexport interface ElementVisualProps {\r\n  className?: string;\r\n  elementId?: string;\r\n  x?: number;\r\n  y?: number;\r\n  elementType: string;\r\n}\r\n\r\nconst EmptyState = Object.freeze({});\r\n\r\nconst ElementVisual: React.FC<ElementVisualProps> = React.memo(\r\n  function ElementVisual({ className, elementId, x = 0, y = 0, elementType }) {\r\n    const def = useSelector((state) =>\r\n      elementDefinitionFromTypeSelector(state, elementType)\r\n    );\r\n\r\n    let body: React.ReactNode;\r\n    if (!def) {\r\n      body = <rect x={x} y={y} width={50} height={50} fill=\"red\" />;\r\n    } else {\r\n      body = getNodeVisualElement(elementId, [], EmptyState, def.visual);\r\n    }\r\n\r\n    const transform = x != 0 || y != 0 ? `translate(${x}, ${y})` : undefined;\r\n    return (\r\n      <g className={cls(className, \"element-visual\")} transform={transform}>\r\n        {body}\r\n      </g>\r\n    );\r\n  }\r\n);\r\n\r\nexport default ElementVisual;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\nimport { useDrop } from \"react-dnd\";\r\n\r\nimport { Point, snapPoint } from \"@/geometry\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { addElement } from \"@/actions/element-add\";\r\n\r\nimport { elementTypeToCircuitId } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nimport { gridElementSnapSelector } from \"@/services/circuit-editor-drag/selectors/snap\";\r\nimport { circuitWouldRecurseSelector } from \"@/services/circuit-graph/selectors/circuits\";\r\n\r\nimport {\r\n  isNewElementDragObject,\r\n  NEW_ELEMENT_DRAG_OBJECT,\r\n} from \"../../../drag-items/new-element\";\r\n\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\nimport { useViewportContext } from \"../../../contexts/viewport-context\";\r\n\r\nimport { useMouseCoords } from \"../hooks/useMouseCoords\";\r\n\r\nimport ElementVisual from \"./ElementVisual\";\r\n\r\nconst DragNewElementLayer: React.FC = React.memo(\r\n  function DragNewElementLayer() {\r\n    const dispatch = useDispatch();\r\n    const { circuitId } = useCircuitEditor();\r\n    const snap = useSelector(gridElementSnapSelector);\r\n    const getMouseCoords = useMouseCoords();\r\n    const { zoomFactor } = useViewportContext();\r\n\r\n    function counterScale(value: number) {\r\n      return value * (1 / zoomFactor);\r\n    }\r\n\r\n    const [dragType, setDragType] = React.useState<string | null>(null);\r\n    const [dragPos, setDragPos] = React.useState<Point | null>(null);\r\n\r\n    const dropTargetWouldRecurse = useSelector((state) =>\r\n      circuitWouldRecurseSelector(\r\n        state,\r\n        elementTypeToCircuitId(dragType),\r\n        circuitId\r\n      )\r\n    );\r\n\r\n    const [, dropRef] = useDrop(\r\n      {\r\n        accept: NEW_ELEMENT_DRAG_OBJECT,\r\n        collect: (monitor) => {\r\n          // We need to clear this out on mouse out\r\n          if (!monitor.isOver()) {\r\n            setDragPos(null);\r\n            setDragType(null);\r\n          }\r\n        },\r\n        hover: (item, monitor) => {\r\n          if (!isNewElementDragObject(item)) {\r\n            setDragPos(null);\r\n            setDragType(null);\r\n            return;\r\n          }\r\n\r\n          const pos = monitor.getClientOffset();\r\n          if (!pos) {\r\n            return;\r\n          }\r\n          const coords = getMouseCoords({ x: pos.x, y: pos.y });\r\n          setDragType(item.payload.elementType);\r\n          setDragPos(coords);\r\n        },\r\n        drop: (item, monitor) => {\r\n          if (!isNewElementDragObject(item)) {\r\n            return;\r\n          }\r\n\r\n          if (dropTargetWouldRecurse) {\r\n            return;\r\n          }\r\n\r\n          const pos = monitor.getClientOffset();\r\n          if (!pos) {\r\n            return;\r\n          }\r\n          const coords = getMouseCoords({ x: pos.x, y: pos.y });\r\n          dispatch(\r\n            addElement(\r\n              item.payload.elementType,\r\n              circuitId,\r\n              snapPoint(coords, snap)\r\n            )\r\n          );\r\n        },\r\n      },\r\n      [circuitId, getMouseCoords, snap, dropTargetWouldRecurse]\r\n    );\r\n\r\n    const snapDragPos = dragPos && snapPoint(dragPos, snap);\r\n\r\n    const counterScaledSize = `${counterScale(1) * 100}%`;\r\n\r\n    return (\r\n      <g id=\"drag-new-element-layer\">\r\n        {!dropTargetWouldRecurse && snapDragPos && dragType && (\r\n          <g opacity={0.5}>\r\n            <ElementVisual\r\n              x={snapDragPos.x}\r\n              y={snapDragPos.y}\r\n              elementType={dragType}\r\n            />\r\n          </g>\r\n        )}\r\n        {dropTargetWouldRecurse && (\r\n          <g transform={`scale(${counterScale(1)})`}>\r\n            <rect width=\"100%\" height=\"100%\" opacity={0.7} fill=\"black\" />\r\n            {/* FIXME: Should center this text in the screen viewport. */}\r\n            <text x=\"100\" y=\"25%\" fill=\"white\">\r\n              The current circuit is already inside the dragged IC.\r\n            </text>\r\n          </g>\r\n        )}\r\n        <rect\r\n          ref={dropRef}\r\n          width={counterScaledSize}\r\n          height={counterScaledSize}\r\n          fill=\"transparent\"\r\n        />\r\n      </g>\r\n    );\r\n  }\r\n);\r\n\r\nexport default DragNewElementLayer;\r\n","import { createCircuitEditorDragSelector } from \"../utils\";\r\nimport { CircuitEditorDragServiceState } from \"../state\";\r\n\r\nexport const dragModeSelector = createCircuitEditorDragSelector(\r\n  (s) => s.dragMode\r\n);\r\n\r\nexport const isEditorDraggingSelector = createCircuitEditorDragSelector(\r\n  (s: CircuitEditorDragServiceState, editorId: string) => {\r\n    if (s.dragMode == null) {\r\n      return false;\r\n    }\r\n\r\n    if (s.dragStartEditorId !== s.dragEndEditorId) {\r\n      return false;\r\n    }\r\n\r\n    return s.dragStartEditorId === editorId;\r\n  }\r\n);\r\n\r\nexport const isDraggingSelector = createCircuitEditorDragSelector(\r\n  (s) => s.dragMode != null\r\n);\r\n\r\nexport const dragStartSelector = createCircuitEditorDragSelector((s) => {\r\n  if (!s.dragMode) {\r\n    return null;\r\n  }\r\n\r\n  return s.dragStart;\r\n});\r\n\r\nexport const dragEndSelector = createCircuitEditorDragSelector((s) => {\r\n  if (!s.dragMode) {\r\n    return null;\r\n  }\r\n\r\n  return s.dragEnd;\r\n});\r\n","import { AppState } from \"@/store\";\r\n\r\nimport {\r\n  normalize,\r\n  Point,\r\n  pointAdd,\r\n  pointEquals,\r\n  pointSubtract,\r\n  snapPoint,\r\n  ZeroPoint,\r\n} from \"@/geometry\";\r\nimport { immutableEmptyArray } from \"@/arrays\";\r\n\r\nimport {\r\n  selectedElementIdsSelector,\r\n  selectedJointIdsSelector,\r\n} from \"@/services/selection/selectors/selection\";\r\nimport { segmentIdsForJointIdSelector } from \"@/services/circuit-graph/selectors/wires\";\r\nimport { ElementPin, WireSegment } from \"@/services/circuit-graph/types\";\r\nimport { elementPinPositionFromElementPinSelector } from \"@/services/circuit-layout/selectors/element-pin-positions\";\r\nimport {\r\n  wireJointPositionByJointIdSelector,\r\n  wireJointPositionFromJointIdSelector,\r\n} from \"@/services/circuit-graph/selectors/wire-positions\";\r\nimport { elementPositionsByElementIdSelector } from \"@/services/circuit-layout/selectors/element-positions\";\r\n\r\nimport { gridElementSnapSelector, gridJointSnapSelector } from \"./snap\";\r\n\r\nlet cachedDragMoveOffset: Point | null = null;\r\nexport const dragMoveOffsetSelector = (state: AppState) => {\r\n  const dragState = state.services.circuitEditorDrag;\r\n  if (dragState.dragMode !== \"move\") {\r\n    return null;\r\n  }\r\n\r\n  const selectedElementIds = selectedElementIdsSelector(state);\r\n\r\n  let gridSnap: number;\r\n  if (selectedElementIds.length > 0) {\r\n    gridSnap = gridElementSnapSelector(state);\r\n  } else {\r\n    gridSnap = gridJointSnapSelector(state);\r\n  }\r\n\r\n  const { dragStart, dragEnd, dragModifierKeys } = dragState;\r\n  if (!dragEnd) {\r\n    return null;\r\n  }\r\n\r\n  let offset = pointSubtract(dragEnd, dragStart);\r\n\r\n  if (dragModifierKeys.shiftKey) {\r\n    const lineVector = normalize(pointSubtract(dragEnd, dragStart));\r\n    if (Math.abs(lineVector.x) >= 0.5) {\r\n      offset = {\r\n        x: offset.x,\r\n        y: 0,\r\n      };\r\n    } else {\r\n      offset = {\r\n        x: 0,\r\n        y: offset.y,\r\n      };\r\n    }\r\n  }\r\n\r\n  if (!dragModifierKeys.ctrlMetaKey) {\r\n    offset = snapPoint(offset, gridSnap);\r\n  }\r\n\r\n  if (!cachedDragMoveOffset || !pointEquals(offset, cachedDragMoveOffset)) {\r\n    cachedDragMoveOffset = offset;\r\n  }\r\n\r\n  return cachedDragMoveOffset;\r\n};\r\n\r\nexport const dragMoveElementPositionsByIdSelector = (state: AppState) => {\r\n  const offset = dragMoveOffsetSelector(state);\r\n\r\n  if (!offset) {\r\n    return null;\r\n  }\r\n\r\n  const selectedElementIds = selectedElementIdsSelector(state);\r\n  const elementPositionsById = elementPositionsByElementIdSelector(state);\r\n\r\n  const dragMoveElementPositionsById: Record<string, Point> = {};\r\n  for (const elementId of selectedElementIds) {\r\n    dragMoveElementPositionsById[elementId] = pointAdd(\r\n      elementPositionsById[elementId],\r\n      offset\r\n    );\r\n  }\r\n  return dragMoveElementPositionsById;\r\n};\r\n\r\nexport const dragMoveJointPositionsByIdSelector = (state: AppState) => {\r\n  const offset = dragMoveOffsetSelector(state);\r\n\r\n  if (!offset) {\r\n    return null;\r\n  }\r\n\r\n  const selectedJointIds = selectedJointIdsSelector(state);\r\n  const JointPositionsById = wireJointPositionByJointIdSelector(state);\r\n\r\n  const dragMoveJointPositionsById: Record<string, Point> = {};\r\n  for (const jointId of selectedJointIds) {\r\n    dragMoveJointPositionsById[jointId] = pointAdd(\r\n      JointPositionsById[jointId],\r\n      offset\r\n    );\r\n  }\r\n  return dragMoveJointPositionsById;\r\n};\r\n\r\nexport const dragMoveGhostLinesSelector = (\r\n  state: AppState\r\n): [start: Point, end: Point][] => {\r\n  const dragService = state.services.circuitEditorDrag;\r\n  if (dragService.dragMode !== \"move\") {\r\n    return immutableEmptyArray<[Point, Point]>();\r\n  }\r\n\r\n  const selectedJointIds = selectedJointIdsSelector(state);\r\n  const selectedElementIds = selectedElementIdsSelector(state);\r\n  const offset = dragMoveOffsetSelector(state);\r\n  if (!offset) {\r\n    return immutableEmptyArray<[Point, Point]>();\r\n  }\r\n\r\n  function getPinPosition(pin: ElementPin): Point {\r\n    let pos = elementPinPositionFromElementPinSelector(\r\n      state,\r\n      pin.elementId,\r\n      pin.pinId\r\n    );\r\n    if (selectedElementIds.indexOf(pin.elementId) !== -1) {\r\n      pos = pointAdd(pos, offset!);\r\n    }\r\n    return pos;\r\n  }\r\n\r\n  function getJointPosition(jointId: string): Point {\r\n    let pos = wireJointPositionFromJointIdSelector(state, jointId);\r\n    if (!pos) {\r\n      return ZeroPoint;\r\n    }\r\n    if (selectedJointIds.indexOf(jointId) !== -1) {\r\n      pos = pointAdd(pos, offset!);\r\n    }\r\n    return pos;\r\n  }\r\n\r\n  function getSegmentGhostLine(segment: WireSegment): [Point, Point] | null {\r\n    switch (segment.type) {\r\n      case \"output\":\r\n        return [\r\n          getPinPosition(segment.outputPin),\r\n          getJointPosition(segment.jointId),\r\n        ];\r\n      case \"input\":\r\n        return [\r\n          getJointPosition(segment.jointId),\r\n          getPinPosition(segment.inputPin),\r\n        ];\r\n      case \"bridge\":\r\n        return [\r\n          getJointPosition(segment.jointAId),\r\n          getJointPosition(segment.jointBId),\r\n        ];\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  const ghostLines: [Point, Point][] = [];\r\n  const visitedSegments = new Set<string>();\r\n  for (const jointId of selectedJointIds) {\r\n    const segmentIds = segmentIdsForJointIdSelector(state, jointId);\r\n    for (const segmentId of segmentIds) {\r\n      if (visitedSegments.has(segmentId)) {\r\n        continue;\r\n      }\r\n      visitedSegments.add(segmentId);\r\n      const ghostLine = getSegmentGhostLine(\r\n        state.services.circuitGraph.wireSegmentsById[segmentId]\r\n      );\r\n      if (!ghostLine) {\r\n        continue;\r\n      }\r\n      ghostLines.push(ghostLine);\r\n    }\r\n  }\r\n\r\n  return ghostLines;\r\n};\r\n","import * as React from \"react\";\r\n\r\nimport mapValues from \"lodash/mapValues\";\r\nimport values from \"lodash/values\";\r\n\r\nimport { elementTypesByElementIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\nimport { isEditorDraggingSelector } from \"@/services/circuit-editor-drag/selectors/drag\";\r\nimport {\r\n  dragMoveElementPositionsByIdSelector,\r\n  dragMoveGhostLinesSelector,\r\n  dragMoveJointPositionsByIdSelector,\r\n} from \"@/services/circuit-editor-drag/selectors/drag-move\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\n\r\nimport ElementVisual from \"./ElementVisual\";\r\n\r\nconst DragMovePreviewLayer: React.FC = React.memo(\r\n  function DragElementPreviewLayer() {\r\n    const { editorId } = useCircuitEditor();\r\n\r\n    const isDragging = useSelector((state) =>\r\n      isEditorDraggingSelector(state, editorId)\r\n    );\r\n\r\n    const dragMoveElementPositionsByElementId = useSelector(\r\n      dragMoveElementPositionsByIdSelector\r\n    );\r\n    const elementTypesByElementId = useSelector(\r\n      elementTypesByElementIdSelector\r\n    );\r\n\r\n    const dragMoveJointPositionsByJointId = useSelector(\r\n      dragMoveJointPositionsByIdSelector\r\n    );\r\n\r\n    const ghostLines = useSelector(dragMoveGhostLinesSelector);\r\n\r\n    if (!isDragging) {\r\n      return null;\r\n    }\r\n\r\n    const movingElements = values(\r\n      mapValues(dragMoveElementPositionsByElementId, (p, elementId) => (\r\n        <ElementVisual\r\n          key={elementId}\r\n          elementType={elementTypesByElementId[elementId]}\r\n          x={p.x}\r\n          y={p.y}\r\n        />\r\n      ))\r\n    );\r\n\r\n    const movingJoints = values(\r\n      mapValues(dragMoveJointPositionsByJointId, (p, jointId) => (\r\n        <circle\r\n          key={jointId}\r\n          cx={p.x}\r\n          cy={p.y}\r\n          r={2}\r\n          stroke=\"none\"\r\n          fill=\"black\"\r\n        />\r\n      ))\r\n    );\r\n\r\n    // FIXME: Get wire style and opacity from css\r\n    const ghostLineElements = ghostLines.map(([start, end], i) => (\r\n      <line\r\n        key={i}\r\n        x1={start.x}\r\n        y1={start.y}\r\n        x2={end.x}\r\n        y2={end.y}\r\n        stroke=\"black\"\r\n        strokeWidth={2}\r\n      />\r\n    ));\r\n\r\n    return (\r\n      // FIXME: Get opacity from css\r\n      <g id=\"drag-element-move-preview-layer\" opacity={0.4}>\r\n        {movingElements}\r\n        {movingJoints}\r\n        {ghostLineElements}\r\n      </g>\r\n    );\r\n  }\r\n);\r\n\r\nexport default DragMovePreviewLayer;\r\n","import { Point } from \"@/geometry\";\r\nimport * as React from \"react\";\r\n\r\nexport interface UseMouseDragDetector {\r\n  startTracking(e: React.MouseEvent): void;\r\n}\r\n\r\nexport interface UseMouseDragDetectorOpts {\r\n  dragThreshold?: number;\r\n  onClick?(e: MouseEvent): void;\r\n  onDragStart?(e: MouseEvent, originalCoords: Point): void;\r\n}\r\nexport function useMouseDragDetector({\r\n  dragThreshold = 5,\r\n  onClick,\r\n  onDragStart,\r\n}: UseMouseDragDetectorOpts): UseMouseDragDetector {\r\n  // We need both state and ref for this.\r\n  //  State lets us trigger a rerender / useEffect.\r\n  //  Ref lets us check for cancellation when handling document events.\r\n  //  We seem to get a few rogue onMouseMove events after we try to stop tracking.\r\n  const [isTracking, setTracking] = React.useState(false);\r\n  const mouseDownRef = React.useRef<Point | null>(null);\r\n\r\n  const onMouseDown = React.useCallback((e: React.MouseEvent) => {\r\n    if (!e.preventDefault) {\r\n      return;\r\n    }\r\n\r\n    setTracking(true);\r\n    mouseDownRef.current = { x: e.pageX, y: e.pageY };\r\n  }, []);\r\n\r\n  const onMouseMove = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      if (!mouseDownRef.current) {\r\n        return;\r\n      }\r\n\r\n      const d = mouseDownRef.current;\r\n      if (\r\n        Math.abs(d.x - e.pageX) >= dragThreshold ||\r\n        Math.abs(d.y - e.pageY) >= dragThreshold\r\n      ) {\r\n        if (onDragStart) {\r\n          onDragStart(e, mouseDownRef.current);\r\n        }\r\n        setTracking(false);\r\n        mouseDownRef.current = null;\r\n      }\r\n    },\r\n    [dragThreshold, onDragStart]\r\n  );\r\n\r\n  const onMouseUp = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      if (!mouseDownRef.current) {\r\n        return;\r\n      }\r\n\r\n      if (onClick) {\r\n        onClick(e);\r\n      }\r\n\r\n      setTracking(false);\r\n      mouseDownRef.current = null;\r\n    },\r\n    [onClick]\r\n  );\r\n\r\n  React.useEffect(() => {\r\n    if (!isTracking) {\r\n      return;\r\n    }\r\n\r\n    document.addEventListener(\"mousemove\", onMouseMove);\r\n    document.addEventListener(\"mouseup\", onMouseUp);\r\n\r\n    return () => {\r\n      document.removeEventListener(\"mousemove\", onMouseMove);\r\n      document.removeEventListener(\"mouseup\", onMouseUp);\r\n    };\r\n  }, [isTracking, onMouseMove, onMouseUp]);\r\n\r\n  return {\r\n    startTracking: onMouseDown,\r\n  };\r\n}\r\n","import { keyboardIsMac } from \"./runtime-env\";\r\n\r\nexport const MODIFIER_KEYS_NONE = Object.freeze<ModifierKeys>({});\r\n\r\nexport interface ModifierKeys {\r\n  ctrlMetaKey?: boolean;\r\n  shiftKey?: boolean;\r\n  altKey?: boolean;\r\n}\r\n\r\nexport interface MouseEventModifierKeys {\r\n  ctrlKey: boolean;\r\n  altKey: boolean;\r\n  shiftKey: boolean;\r\n  metaKey: boolean;\r\n}\r\nexport function getModifiers(e: MouseEventModifierKeys): ModifierKeys {\r\n  const { ctrlKey, altKey, shiftKey, metaKey } = e;\r\n  return {\r\n    // Mac reserves ctrl for system use, apps use meta.\r\n    ctrlMetaKey: keyboardIsMac ? metaKey : ctrlKey,\r\n    altKey,\r\n    shiftKey,\r\n  };\r\n}\r\n","import { createSelector } from \"reselect\";\r\n\r\nimport { normalizeRectangle } from \"@/geometry\";\r\n\r\nimport { createCircuitEditorDragSelector } from \"../utils\";\r\n\r\nimport { dragEndSelector, dragModeSelector, dragStartSelector } from \"./drag\";\r\n\r\nexport const selectionRectSelector = createCircuitEditorDragSelector(\r\n  createSelector(\r\n    dragModeSelector.local,\r\n    dragStartSelector.local,\r\n    dragEndSelector.local,\r\n    (dragMode, dragStart, dragEnd) =>\r\n      dragMode === \"select\" && dragStart && dragEnd\r\n        ? normalizeRectangle(dragStart, dragEnd)\r\n        : null\r\n  )\r\n);\r\n","import * as React from \"react\";\r\nimport { VirtualElement } from \"@popperjs/core\";\r\n\r\nimport { Point } from \"@/geometry\";\r\n\r\nimport { MenuCloseContextProvider } from \"./Menus/MenuCloseContext\";\r\n\r\nimport Popover from \"./Popover\";\r\n\r\nexport interface ContextMenuProps {\r\n  x: number;\r\n  y: number;\r\n  open: boolean;\r\n  onRequestClose(): void;\r\n}\r\n\r\nconst ContextMenu: React.FC<ContextMenuProps> = ({\r\n  x,\r\n  y,\r\n  open,\r\n  onRequestClose,\r\n  children,\r\n}) => {\r\n  const anchorEl = React.useMemo<VirtualElement>(\r\n    () => ({\r\n      getBoundingClientRect: () => ({\r\n        left: x,\r\n        top: y,\r\n        right: x,\r\n        bottom: y,\r\n        width: 0,\r\n        height: 0,\r\n        x,\r\n        y,\r\n      }),\r\n    }),\r\n    [x, y]\r\n  );\r\n\r\n  return (\r\n    <MenuCloseContextProvider value={onRequestClose}>\r\n      <Popover\r\n        isOpen={open}\r\n        onRequestClose={onRequestClose}\r\n        anchorEl={anchorEl}\r\n        placement=\"bottom-start\"\r\n      >\r\n        {children}\r\n      </Popover>\r\n    </MenuCloseContextProvider>\r\n  );\r\n};\r\n\r\nexport default ContextMenu;\r\n\r\nexport interface ContextMenuRenderProps {\r\n  point: Point;\r\n}\r\nexport interface UseContextMenu {\r\n  renderContextMenu(\r\n    content:\r\n      | React.ReactNode\r\n      | ((renderProps: ContextMenuRenderProps) => React.ReactNode)\r\n  ): React.ReactNode;\r\n  openContextMenu(e: React.MouseEvent): void;\r\n}\r\nexport function useContextMenu(): UseContextMenu {\r\n  const [ctxPos, setCtxPos] = React.useState<Point | null>(null);\r\n\r\n  const openContextMenu = React.useCallback((e: React.MouseEvent) => {\r\n    setCtxPos({ x: e.pageX, y: e.pageY });\r\n  }, []);\r\n\r\n  const onCloseContextMenu = React.useCallback(() => {\r\n    setCtxPos(null);\r\n  }, []);\r\n\r\n  const renderContextMenu = React.useCallback(\r\n    (\r\n      content:\r\n        | React.ReactNode\r\n        | ((renderProps: ContextMenuRenderProps) => React.ReactNode)\r\n    ) => {\r\n      if (!ctxPos) {\r\n        return null;\r\n      }\r\n\r\n      if (typeof content === \"function\") {\r\n        content = content({ point: ctxPos });\r\n      }\r\n\r\n      return (\r\n        <ContextMenu\r\n          open\r\n          onRequestClose={onCloseContextMenu}\r\n          x={ctxPos.x}\r\n          y={ctxPos.y}\r\n        >\r\n          {content}\r\n        </ContextMenu>\r\n      );\r\n    },\r\n    [ctxPos, onCloseContextMenu]\r\n  );\r\n\r\n  return {\r\n    openContextMenu,\r\n    renderContextMenu,\r\n  };\r\n}\r\n","import * as React from \"react\";\r\n\r\nimport { keyboardCommandModifier } from \"@/runtime-env\";\r\nimport { Point } from \"@/geometry\";\r\n\r\nimport { useAction } from \"@/hooks/useAction\";\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { selectedElementIdsSelector } from \"@/services/selection/selectors/selection\";\r\nimport { canPasteSelector } from \"@/services/clipboard/selectors/clipboard\";\r\n\r\nimport { paste } from \"@/actions/clipboard-paste\";\r\nimport { selectionAlignToGrid } from \"@/actions/selection-align-to-grid\";\r\nimport { deleteSelection } from \"@/actions/selection-delete\";\r\nimport { copySelection } from \"@/actions/selection-copy\";\r\n\r\nimport MenuItem from \"@/components/Menus/MenuItem\";\r\nimport DividerMenuItem from \"@/components/Menus/DividerMenuItem\";\r\n\r\nexport interface ContextMenuItemsProps {\r\n  fieldPosition: Point;\r\n}\r\nconst ContextMenuItems: React.FC<ContextMenuItemsProps> = ({\r\n  fieldPosition,\r\n}) => {\r\n  const onAlignToGrid = useAction(selectionAlignToGrid);\r\n\r\n  const canCopy = useSelector(selectedElementIdsSelector).length > 0;\r\n  const onCopy = useAction(copySelection);\r\n  const canPaste = useSelector(canPasteSelector);\r\n  const onPaste = useAction(paste, { pastePosition: fieldPosition });\r\n\r\n  const onDelete = useAction(deleteSelection);\r\n\r\n  return (\r\n    <>\r\n      <MenuItem onClick={onAlignToGrid}>Align Selection To Grid</MenuItem>\r\n      <DividerMenuItem />\r\n      <MenuItem\r\n        disabled={!canCopy}\r\n        secondary={`${keyboardCommandModifier}+c`}\r\n        onClick={onCopy}\r\n      >\r\n        Copy\r\n      </MenuItem>\r\n      <MenuItem\r\n        disabled={!canPaste}\r\n        secondary={`${keyboardCommandModifier}+v`}\r\n        onClick={onPaste}\r\n      >\r\n        Paste\r\n      </MenuItem>\r\n      <DividerMenuItem />\r\n      <MenuItem onClick={onDelete}>Delete Selected</MenuItem>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default ContextMenuItems;\r\n","import * as React from \"react\";\r\n\r\nimport { Point } from \"@/geometry\";\r\n\r\nimport Menu from \"@/components/Menus/Menu\";\r\n\r\nimport ContextMenuItems from \"./ContextMenuItems\";\r\n\r\nexport interface FieldContextMenuProps {\r\n  fieldPosition: Point;\r\n}\r\nconst FieldContextMenu: React.FC<FieldContextMenuProps> = ({\r\n  fieldPosition,\r\n}) => {\r\n  return (\r\n    <Menu>\r\n      <ContextMenuItems fieldPosition={fieldPosition} />\r\n    </Menu>\r\n  );\r\n};\r\n\r\nexport default FieldContextMenu;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useMouseDragDetector } from \"@/hooks/useMouseDragDetector\";\r\n\r\nimport { getModifiers } from \"@/modifier-keys\";\r\n\r\nimport { isEditorDraggingSelector } from \"@/services/circuit-editor-drag/selectors/drag\";\r\nimport { selectionRectSelector } from \"@/services/circuit-editor-drag/selectors/drag-select\";\r\n\r\nimport { useContextMenu } from \"@/components/ContextMenu\";\r\n\r\nimport { clearSelection } from \"@/actions/select-clear\";\r\nimport { circuitEditorDragStartSelect } from \"@/actions/circuit-editor-drag-start-select\";\r\n\r\nimport { useViewportContext } from \"../../../contexts/viewport-context\";\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\n\r\nimport { useMouseCoords } from \"../hooks/useMouseCoords\";\r\n\r\nimport FieldContextMenu from \"./FieldContextMenu\";\r\n\r\nconst DragSelectLayer: React.FC = React.memo(function DragSelectLayer() {\r\n  const dispatch = useDispatch();\r\n  const { editorId } = useCircuitEditor();\r\n  const { zoomFactor } = useViewportContext();\r\n\r\n  const isDragging = useSelector((state) =>\r\n    isEditorDraggingSelector(state, editorId)\r\n  );\r\n\r\n  const selectionRect = useSelector(selectionRectSelector);\r\n\r\n  function counterScale(value: number) {\r\n    return value * (1 / zoomFactor);\r\n  }\r\n\r\n  const getCoords = useMouseCoords();\r\n\r\n  const { openContextMenu, renderContextMenu } = useContextMenu();\r\n\r\n  const onContextMenu = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      e.preventDefault();\r\n      openContextMenu(e);\r\n    },\r\n    [openContextMenu]\r\n  );\r\n\r\n  const onClick = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      if (e.button !== 0) {\r\n        return;\r\n      }\r\n      const modifiers = getModifiers(e);\r\n      if (!modifiers.ctrlMetaKey && !modifiers.shiftKey) {\r\n        dispatch(clearSelection());\r\n      }\r\n    },\r\n    [dispatch]\r\n  );\r\n\r\n  const onDragStart = React.useCallback(\r\n    (e: MouseEvent, originalPoint: Point) => {\r\n      const p = getCoords(originalPoint);\r\n      const modifierKeys = getModifiers(e);\r\n      dispatch(circuitEditorDragStartSelect(p, modifierKeys, editorId));\r\n    },\r\n    [dispatch, editorId, getCoords]\r\n  );\r\n\r\n  const { startTracking: onMouseDown } = useMouseDragDetector({\r\n    onClick,\r\n    onDragStart,\r\n  });\r\n\r\n  return (\r\n    <g className=\"circuit-editor-mouse-layer\">\r\n      <rect\r\n        /*\r\n         Our width and height get scaled by the parent scaler.\r\n         We have to be inside the parent scaler to make our mouse coordinate values match up.\r\n         Scale us back out so we continue to cover the whole screen.\r\n         */\r\n        width={`${counterScale(1) * 100}%`}\r\n        height={`${counterScale(1) * 100}%`}\r\n        fill=\"transparent\"\r\n        onMouseDown={onMouseDown}\r\n        onContextMenu={onContextMenu}\r\n      />\r\n      {isDragging && selectionRect && (\r\n        <g\r\n          transform={`translate(${selectionRect.p1.x}, ${selectionRect.p1.y})`}\r\n        >\r\n          <rect\r\n            width={selectionRect.p2.x - selectionRect.p1.x}\r\n            height={selectionRect.p2.y - selectionRect.p1.y}\r\n            strokeWidth={counterScale(2)}\r\n            strokeDasharray={`${counterScale(5)} ${counterScale(3)}`}\r\n            stroke=\"skyblue\"\r\n            fill=\"transparent\"\r\n          />\r\n        </g>\r\n      )}\r\n      {renderContextMenu(({ point }) => (\r\n        <FieldContextMenu fieldPosition={getCoords(point)} />\r\n      ))}\r\n    </g>\r\n  );\r\n});\r\n\r\nexport default DragSelectLayer;\r\n","import * as React from \"react\";\r\nimport { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport { useViewportContext } from \"../../../contexts/viewport-context\";\r\n\r\nconst GridBackground: React.FC = React.memo(function GridBackground() {\r\n  const [gridId] = React.useState(`grid-${uuidV4()}`);\r\n  const { zoomFactor } = useViewportContext();\r\n\r\n  const gridSize = 50 * zoomFactor;\r\n\r\n  return (\r\n    <svg width=\"100%\" height=\"100%\" xmlns=\"http://www.w3.org/2000/svg\">\r\n      <defs>\r\n        <pattern\r\n          id={gridId}\r\n          width={gridSize}\r\n          height={gridSize}\r\n          patternUnits=\"userSpaceOnUse\"\r\n        >\r\n          <path\r\n            d={`M ${gridSize} 0 L 0 0 0 ${gridSize}`}\r\n            fill=\"none\"\r\n            stroke=\"gray\"\r\n            strokeWidth={0.5}\r\n          />\r\n        </pattern>\r\n      </defs>\r\n\r\n      <rect width=\"100%\" height=\"100%\" fill={`url(#${gridId})`} />\r\n    </svg>\r\n  );\r\n});\r\n\r\nexport default GridBackground;\r\n","import * as React from \"react\";\r\n\r\nexport interface AtomicTextInputProps {\r\n  className?: string;\r\n  autoFocus?: boolean;\r\n  defaultValue?: string;\r\n  value?: string;\r\n  onChange?(e: React.ChangeEvent<HTMLInputElement>): void;\r\n  onBeginEdit?(): void;\r\n  onCommit?(value: string): void;\r\n  onCancel?(): void;\r\n  onKeyUp?(e: React.KeyboardEvent<HTMLInputElement>): void;\r\n  onBlur?(e: React.FocusEvent<HTMLInputElement>): void;\r\n}\r\n\r\nconst AtomicTextInput = React.forwardRef<\r\n  HTMLInputElement,\r\n  AtomicTextInputProps\r\n>(\r\n  (\r\n    {\r\n      className,\r\n      autoFocus,\r\n      defaultValue,\r\n      value,\r\n      onChange,\r\n      onBeginEdit,\r\n      onCommit,\r\n      onCancel,\r\n      onBlur,\r\n      onKeyUp,\r\n    },\r\n    ref\r\n  ) => {\r\n    const [editValue, setEditValue] = React.useState<string | null>(null);\r\n\r\n    const onInputChange = React.useCallback(\r\n      (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (editValue == null && onBeginEdit) {\r\n          onBeginEdit();\r\n        }\r\n\r\n        setEditValue(e.target.value);\r\n\r\n        if (onChange) {\r\n          onChange(e);\r\n        }\r\n      },\r\n      [editValue, onBeginEdit, onChange]\r\n    );\r\n\r\n    const onInputKeyUp = React.useCallback(\r\n      (e: React.KeyboardEvent<HTMLInputElement>) => {\r\n        if (onKeyUp) {\r\n          onKeyUp(e);\r\n        }\r\n        if (e.defaultPrevented) {\r\n          return;\r\n        }\r\n\r\n        if (editValue == null) {\r\n          return;\r\n        }\r\n\r\n        if (e.key === \"Escape\") {\r\n          e.preventDefault();\r\n          if (onCancel) {\r\n            onCancel();\r\n          }\r\n        } else if (e.key === \"Enter\") {\r\n          e.preventDefault();\r\n          if (onCommit) {\r\n            onCommit(editValue);\r\n          }\r\n        }\r\n      },\r\n      [onKeyUp, editValue, onCancel, onCommit]\r\n    );\r\n\r\n    const onInputBlur = React.useCallback(\r\n      (e: React.FocusEvent<HTMLInputElement>) => {\r\n        if (onBlur) {\r\n          onBlur(e);\r\n        }\r\n\r\n        if (editValue != null && onCommit) {\r\n          onCommit(editValue);\r\n        }\r\n      },\r\n      [onBlur, editValue, onCommit]\r\n    );\r\n\r\n    return (\r\n      <input\r\n        ref={ref}\r\n        className={className}\r\n        autoFocus={autoFocus}\r\n        defaultValue={defaultValue}\r\n        value={value}\r\n        type=\"text\"\r\n        onChange={onInputChange}\r\n        onKeyUp={onInputKeyUp}\r\n        onBlur={onInputBlur}\r\n      />\r\n    );\r\n  }\r\n);\r\n\r\nexport default AtomicTextInput;\r\n","import { cls } from \"@/utils\";\r\nimport * as React from \"react\";\r\nimport AtomicTextInput from \"./AtomicTextInput\";\r\n\r\nexport interface EditableTextProps {\r\n  className?: string;\r\n  textClassname?: string;\r\n  inputClassname?: string;\r\n  label?: JSX.Element;\r\n  defaultValue: string;\r\n  isEditing: boolean;\r\n  onRequestEdit?(): void;\r\n  onCommit(value: string): void;\r\n  onCancel(): void;\r\n}\r\n\r\nconst EditableText: React.FC<EditableTextProps> = ({\r\n  className,\r\n  textClassname,\r\n  inputClassname,\r\n  label,\r\n  defaultValue,\r\n  isEditing,\r\n  onRequestEdit,\r\n  onCommit,\r\n  onCancel,\r\n}) => {\r\n  const inputRef = React.useRef<HTMLInputElement | null>(null);\r\n\r\n  const onSpanDoubleClick = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (!onRequestEdit) {\r\n        return;\r\n      }\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      e.preventDefault();\r\n      onRequestEdit();\r\n    },\r\n    [onRequestEdit]\r\n  );\r\n\r\n  // AtomicTextInput enters editing mode when the user changes something.\r\n  // It will not call cancel on blur.\r\n  // We want to exit when blurred\r\n  const onKeyUp = React.useCallback(\r\n    (e: React.KeyboardEvent<HTMLInputElement>) => {\r\n      if (e.key === \"Escape\" && isEditing) {\r\n        onCancel();\r\n      }\r\n    },\r\n    [isEditing, onCancel]\r\n  );\r\n\r\n  const onBlur = React.useCallback(() => {\r\n    if (isEditing) {\r\n      onCancel();\r\n    }\r\n  }, [isEditing, onCancel]);\r\n\r\n  React.useEffect(() => {\r\n    if (isEditing && inputRef.current) {\r\n      inputRef.current.select();\r\n    }\r\n  }, [isEditing]);\r\n\r\n  if (!isEditing) {\r\n    return (\r\n      <span\r\n        className={cls(className, textClassname)}\r\n        onDoubleClick={onSpanDoubleClick}\r\n      >\r\n        {label ?? defaultValue}\r\n      </span>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <AtomicTextInput\r\n      ref={inputRef}\r\n      className={cls(className, inputClassname)}\r\n      autoFocus\r\n      defaultValue={defaultValue}\r\n      onBlur={onBlur}\r\n      onKeyUp={onKeyUp}\r\n      onCommit={onCommit}\r\n      onCancel={onCancel}\r\n    />\r\n  );\r\n};\r\n\r\nexport default EditableText;\r\n","import * as React from \"react\";\r\n\r\nimport EditableText, { EditableTextProps } from \"../EditableText\";\r\n\r\nimport { useMenuCloseContext } from \"./MenuCloseContext\";\r\n\r\nimport styles from \"./Menus.module.css\";\r\n\r\nexport type EditableTextMenuItemProps = EditableTextProps;\r\nconst EditableTextMenuItem: React.FC<EditableTextMenuItemProps> = (props) => {\r\n  const { onRequestEdit, onCommit } = props;\r\n\r\n  const requestMenuClose = useMenuCloseContext();\r\n\r\n  const onClick = React.useCallback(() => {\r\n    if (onRequestEdit) {\r\n      onRequestEdit();\r\n    }\r\n  }, [onRequestEdit]);\r\n\r\n  const onEditableCommit = React.useCallback(\r\n    (value: string) => {\r\n      onCommit(value);\r\n      requestMenuClose();\r\n    },\r\n    [onCommit, requestMenuClose]\r\n  );\r\n\r\n  return (\r\n    <li className={styles[\"menu-item\"]} onClick={onClick}>\r\n      <EditableText {...props} onCommit={onEditableCommit} />\r\n    </li>\r\n  );\r\n};\r\n\r\nexport default EditableTextMenuItem;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { Point } from \"@/geometry\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { elementTypeToCircuitId } from \"@/elements/definitions/integrated-circuits/utils\";\r\n\r\nimport { renameElement } from \"@/actions/element-rename\";\r\nimport { viewCircuit } from \"@/actions/view-circuit\";\r\n\r\nimport {\r\n  elementNameOrDefaultFromElementIdSelector,\r\n  elementTypeFromElementIdSelector,\r\n} from \"@/services/circuit-graph/selectors/elements\";\r\nimport { isSimActiveSelector } from \"@/services/simulator-control/selectors/run\";\r\n\r\nimport Menu from \"@/components/Menus/Menu\";\r\nimport DividerMenuItem from \"@/components/Menus/DividerMenuItem\";\r\nimport EditableTextMenuItem from \"@/components/Menus/EditableTextMenuItem\";\r\nimport MenuItem from \"@/components/Menus/MenuItem\";\r\n\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\n\r\nimport ContextMenuItems from \"./ContextMenuItems\";\r\n\r\nexport interface NodeContextMenuProps {\r\n  fieldPosition: Point;\r\n  elementId: string;\r\n}\r\n\r\nconst ElementContextMenu: React.FC<NodeContextMenuProps> = ({\r\n  elementId,\r\n  fieldPosition,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n\r\n  const { elementIdPath } = useCircuitEditor();\r\n\r\n  const isSimActive = useSelector(isSimActiveSelector);\r\n\r\n  const elementName = useSelector((state) =>\r\n    elementNameOrDefaultFromElementIdSelector(state, elementId)\r\n  );\r\n  const elementType = useSelector((state) =>\r\n    elementTypeFromElementIdSelector(state, elementId)\r\n  );\r\n  const elementCircuitId = elementType\r\n    ? elementTypeToCircuitId(elementType)\r\n    : null;\r\n\r\n  const [isRenaming, setIsRenaming] = React.useState(false);\r\n  const onRename = React.useCallback(() => {\r\n    setIsRenaming(true);\r\n  }, []);\r\n  const onRenameCancel = React.useCallback(() => {\r\n    setIsRenaming(false);\r\n  }, []);\r\n  const onRenameCommit = React.useCallback(\r\n    (value: string) => {\r\n      setIsRenaming(false);\r\n      dispatch(renameElement(elementId, value));\r\n    },\r\n    [dispatch, elementId]\r\n  );\r\n\r\n  const onOpenCircuitInNewWindow = React.useCallback(() => {\r\n    if (!elementCircuitId) {\r\n      return;\r\n    }\r\n    dispatch(\r\n      viewCircuit(elementCircuitId, [...elementIdPath, elementId], {\r\n        newWindow: true,\r\n      })\r\n    );\r\n  }, [elementIdPath, dispatch, elementCircuitId, elementId]);\r\n\r\n  if (isSimActive) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <Menu>\r\n      <EditableTextMenuItem\r\n        defaultValue={elementName ?? \"<unknown>\"}\r\n        label={<span style={{ fontWeight: 600 }}>{elementName}</span>}\r\n        isEditing={isRenaming}\r\n        onRequestEdit={onRename}\r\n        onCommit={onRenameCommit}\r\n        onCancel={onRenameCancel}\r\n      />\r\n      <DividerMenuItem />\r\n      {elementCircuitId && (\r\n        <>\r\n          <MenuItem onClick={onOpenCircuitInNewWindow}>\r\n            Open in New Window\r\n          </MenuItem>\r\n          <DividerMenuItem />\r\n        </>\r\n      )}\r\n      <ContextMenuItems fieldPosition={fieldPosition} />\r\n    </Menu>\r\n  );\r\n};\r\n\r\nexport default ElementContextMenu;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\nimport { Point, Rectangle, ZeroPoint } from \"@/geometry\";\r\nimport { getModifiers } from \"@/modifier-keys\";\r\nimport { getSelectMode } from \"@/selection-mode\";\r\n\r\nimport { getNodeVisualElement } from \"@/elements/visuals\";\r\n\r\nimport interaction from \"@/styles/interaction.module.css\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useMouseDragDetector } from \"@/hooks/useMouseDragDetector\";\r\n\r\nimport { evolverStateFromCircuitElementIdSelector } from \"@/services/simulator/selectors/elements\";\r\nimport { isElementSelectedFromElementIdSelector } from \"@/services/selection/selectors/selection\";\r\nimport { elementPositionFromElementIdSelector } from \"@/services/circuit-layout/selectors/element-positions\";\r\nimport { isSimActiveSelector } from \"@/services/simulator-control/selectors/run\";\r\nimport { elementDefinitionFromElementIdSelector } from \"@/services/circuit-graph/selectors/element-def\";\r\nimport { elementFieldDisplayNameFromElementId } from \"@/services/ui-settings/selectors/element-name\";\r\n\r\nimport { circuitEditorDragStartElement } from \"@/actions/circuit-editor-drag-start-element\";\r\nimport { selectElements } from \"@/actions/select-elements\";\r\n\r\nimport { useContextMenu } from \"@/components/ContextMenu\";\r\n\r\nimport { useCircuitEditor } from \"../../../../contexts/circuit-editor-context\";\r\nimport { useViewportContext } from \"../../../../contexts/viewport-context\";\r\nimport { getElementHtmlId } from \"../../../../ids\";\r\n\r\nimport { useMouseCoords } from \"../../hooks/useMouseCoords\";\r\n\r\nimport ElementContextMenu from \"../ElementContextMenu\";\r\n\r\nimport \"./Element.module.css\";\r\n\r\nexport interface NodeProps {\r\n  elementId: string;\r\n}\r\n\r\nconst Element: React.FC<NodeProps> = React.memo(function Node({ elementId }) {\r\n  const dispatch = useDispatch();\r\n  const { editorId, elementIdPath } = useCircuitEditor();\r\n  const isSimActive = useSelector(isSimActiveSelector);\r\n\r\n  const { openContextMenu, renderContextMenu } = useContextMenu();\r\n\r\n  const def = useSelector((state) =>\r\n    elementDefinitionFromElementIdSelector(state, elementId)\r\n  );\r\n  const { x, y } = useSelector((s) =>\r\n    elementPositionFromElementIdSelector(s, elementId)\r\n  );\r\n  const evolverState = useSelector((s) =>\r\n    evolverStateFromCircuitElementIdSelector(s, [...elementIdPath, elementId])\r\n  );\r\n  const isSelected = useSelector((s) =>\r\n    isElementSelectedFromElementIdSelector(s, elementId)\r\n  );\r\n\r\n  const getCoords = useMouseCoords();\r\n\r\n  const onClick = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      if (isSimActive) {\r\n        return;\r\n      }\r\n\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      if (e.button !== 0) {\r\n        return;\r\n      }\r\n\r\n      e.preventDefault();\r\n\r\n      const modifiers = getModifiers(e);\r\n      const selectionMode = getSelectMode(modifiers);\r\n      dispatch(selectElements(elementId, selectionMode));\r\n    },\r\n    [dispatch, isSimActive, elementId]\r\n  );\r\n\r\n  const onContextMenu = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      e.preventDefault();\r\n\r\n      const modifiers = getModifiers(e);\r\n      const selectionMode = getSelectMode(modifiers, \"set-if-unselected\");\r\n      dispatch(selectElements(elementId, selectionMode));\r\n      openContextMenu(e);\r\n    },\r\n    [dispatch, elementId, openContextMenu]\r\n  );\r\n\r\n  const onDragStart = React.useCallback(\r\n    (e: MouseEvent, originalPoint: Point) => {\r\n      const p = getCoords(originalPoint);\r\n      const modifiers = getModifiers(e);\r\n      dispatch(\r\n        circuitEditorDragStartElement(elementId, p, modifiers, editorId)\r\n      );\r\n    },\r\n    [getCoords, dispatch, elementId, editorId]\r\n  );\r\n\r\n  const { startTracking } = useMouseDragDetector({\r\n    onClick,\r\n    onDragStart,\r\n  });\r\n\r\n  const onMouseDown = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      // Handle this regardless, to stop mosue clicks\r\n      // selecting nearby text.\r\n      e.preventDefault();\r\n\r\n      if (isSimActive) {\r\n        return;\r\n      }\r\n\r\n      if (e.button !== 0) {\r\n        return;\r\n      }\r\n\r\n      startTracking(e);\r\n    },\r\n    [isSimActive, startTracking]\r\n  );\r\n\r\n  let body: React.ReactNode;\r\n  let rect: Rectangle;\r\n  if (!def) {\r\n    body = (\r\n      <rect\r\n        x={x}\r\n        y={y}\r\n        width={50}\r\n        height={50}\r\n        fill={isSelected ? \"goldenrod\" : \"red\"}\r\n      />\r\n    );\r\n    rect = { p1: ZeroPoint, p2: { x: 50, y: 50 } };\r\n  } else {\r\n    const { hitRect } = def.visual;\r\n    body = getNodeVisualElement(\r\n      elementId,\r\n      elementIdPath,\r\n      evolverState,\r\n      def.visual\r\n    );\r\n    rect = hitRect;\r\n  }\r\n\r\n  const transform = x != 0 || y != 0 ? `translate(${x}, ${y})` : undefined;\r\n  return (\r\n    <g transform={transform}>\r\n      <g\r\n        id={getElementHtmlId(editorId, elementId)}\r\n        className={cls(\r\n          \"circuit-field-element\",\r\n          isSelected && \"element-selected\"\r\n        )}\r\n        onMouseDown={onMouseDown}\r\n        onContextMenu={onContextMenu}\r\n      >\r\n        {body}\r\n      </g>\r\n      <NodeName elementId={elementId} hitRect={rect} />\r\n      {renderContextMenu(({ point }) => (\r\n        <ElementContextMenu\r\n          elementId={elementId}\r\n          fieldPosition={getCoords(point)}\r\n        />\r\n      ))}\r\n    </g>\r\n  );\r\n});\r\n\r\ninterface NodeNameProps extends NodeProps {\r\n  hitRect: Rectangle;\r\n}\r\nconst NodeName: React.FC<NodeNameProps> = React.memo(function NodeName({\r\n  elementId,\r\n  hitRect,\r\n}) {\r\n  const { zoomFactor } = useViewportContext();\r\n  const elementName = useSelector((s) =>\r\n    elementFieldDisplayNameFromElementId(s, elementId)\r\n  );\r\n\r\n  // FIXME: This is really rough, especially the y offset.\r\n  // There is a noticable jump in position between >1 and >1 scale.\r\n  const textScale = Math.max(0.7, zoomFactor);\r\n  let textYOffset = 15;\r\n  if (textScale > 1) {\r\n    textYOffset -= textScale * 2;\r\n  } else {\r\n    textYOffset += (1 / textScale) * 7;\r\n  }\r\n\r\n  if (!elementName) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <text\r\n      fontSize={`${1.2 / textScale}em`}\r\n      className={interaction[\"text-unselectable\"]}\r\n      textAnchor=\"middle\"\r\n      x={hitRect.p1.x + (hitRect.p2.x - hitRect.p1.x) / 2}\r\n      y={hitRect.p2.y + textYOffset}\r\n    >\r\n      {elementName}\r\n    </text>\r\n  );\r\n});\r\n\r\nexport default Element;\r\n","import Element from \"./Element\";\r\nexport * from \"./Element\";\r\nexport default Element;\r\n","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { elementIdsFromCircuitIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\n\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\n\r\nimport Element from \"./Element\";\r\n\r\nconst ElementsLayer: React.FC = React.memo(function ElementsLayer() {\r\n  const { circuitId } = useCircuitEditor();\r\n  const elementIds = useSelector((state) =>\r\n    elementIdsFromCircuitIdSelector(state, circuitId)\r\n  );\r\n\r\n  const elements = elementIds.map((elementId) => {\r\n    return <Element key={elementId} elementId={elementId} />;\r\n  });\r\n\r\n  return <g>{elements}</g>;\r\n});\r\nexport default ElementsLayer;\r\n","import values from \"lodash/values\";\r\nimport { orderBy } from \"natural-orderby\";\r\n\r\nimport { isTruthy } from \"@/utils\";\r\n\r\nimport { CircuitGraphServiceState } from \"../state\";\r\nimport {\r\n  ElementPin,\r\n  isInputOutputWireSegment,\r\n  isInputWireSegment,\r\n  isOutputWireSegment,\r\n  WireSegment,\r\n} from \"../types\";\r\nimport { collectWireLineIds, createCircuitGraphSelector } from \"../utils\";\r\n\r\nimport { wireIdFromWireSegmentIdSelector } from \"./wires\";\r\nimport { elementNameOrDefaultFromElementIdSelector } from \"./elements\";\r\nimport { pinNameFromElementPinSelector } from \"./pins\";\r\n\r\nexport interface WireLineCandidate {\r\n  name: string;\r\n  lineId: string;\r\n  selected: boolean;\r\n}\r\n\r\nexport const wireLineCandidatesForSegmentId = createCircuitGraphSelector(\r\n  (state: CircuitGraphServiceState, segmentId: string) => {\r\n    const segment = state.wireSegmentsById[segmentId];\r\n    if (!segment || isInputOutputWireSegment(segment)) {\r\n      return [];\r\n    }\r\n\r\n    const wireId = wireIdFromWireSegmentIdSelector.local(state, segmentId);\r\n    if (!wireId) {\r\n      return [];\r\n    }\r\n\r\n    const [inputLineIds, outputLineIds] = collectWireLineIds(state, wireId);\r\n\r\n    let candidates: WireLineCandidate[] = [];\r\n    if (isInputWireSegment(segment)) {\r\n      candidates = outputLineIds\r\n        .map((lineId) => {\r\n          const elementPin = outputElementPinFromLineId(state, lineId);\r\n          if (!elementPin) {\r\n            return null;\r\n          }\r\n          const elementName = elementNameOrDefaultFromElementIdSelector.local(\r\n            state,\r\n            elementPin.elementId\r\n          );\r\n          const pinName = pinNameFromElementPinSelector.local(\r\n            state,\r\n            elementPin.elementId,\r\n            elementPin.pinId\r\n          );\r\n          return {\r\n            name: `From [${elementName}]:[${pinName}]`,\r\n            lineId,\r\n            selected: lineId === segment.lineId,\r\n          };\r\n        })\r\n        .filter(isTruthy);\r\n    } else if (isOutputWireSegment(segment)) {\r\n      candidates = inputLineIds\r\n        .filter((lineId) => !lineHasOutput(state, lineId, segment))\r\n        .map((lineId) => {\r\n          const inputPins = inputElementPinsFromLineId(state, lineId);\r\n          if (inputPins.length === 0) {\r\n            return null;\r\n          }\r\n          const firstElementName = elementNameOrDefaultFromElementIdSelector.local(\r\n            state,\r\n            inputPins[0].elementId\r\n          );\r\n          const firstPinName = pinNameFromElementPinSelector.local(\r\n            state,\r\n            inputPins[0].elementId,\r\n            inputPins[0].pinId\r\n          );\r\n          let name = `To [${firstElementName}]:[${firstPinName}]`;\r\n          if (inputPins.length > 1) {\r\n            name += `(+${inputPins.length - 1})`;\r\n          }\r\n          return {\r\n            name,\r\n            lineId,\r\n            selected: lineId === segment.lineId,\r\n          };\r\n        })\r\n        .filter(isTruthy);\r\n    }\r\n\r\n    return orderBy(candidates, \"name\", \"asc\");\r\n  }\r\n);\r\n\r\nfunction outputElementPinFromLineId(\r\n  state: CircuitGraphServiceState,\r\n  lineId: string\r\n): ElementPin | null {\r\n  for (const segment of values(state.wireSegmentsById)) {\r\n    if (!isOutputWireSegment(segment) || segment.lineId !== lineId) {\r\n      continue;\r\n    }\r\n    return segment.outputPin;\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction inputElementPinsFromLineId(\r\n  state: CircuitGraphServiceState,\r\n  lineId: string\r\n): ElementPin[] {\r\n  const inputPins: ElementPin[] = [];\r\n  for (const segment of values(state.wireSegmentsById)) {\r\n    if (!isInputWireSegment(segment) || segment.lineId !== lineId) {\r\n      continue;\r\n    }\r\n    inputPins.push(segment.inputPin);\r\n  }\r\n\r\n  return inputPins;\r\n}\r\n\r\nfunction lineHasOutput(\r\n  state: CircuitGraphServiceState,\r\n  lineId: string,\r\n  excludeSegment?: WireSegment\r\n): boolean {\r\n  for (const segment of values(state.wireSegmentsById)) {\r\n    if (excludeSegment === segment) {\r\n      continue;\r\n    }\r\n    if (isOutputWireSegment(segment) && segment.lineId === lineId) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\nimport { v4 as uuidV4 } from \"uuid\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { wireSegmentSetLine } from \"@/actions/wire-segment-set-line\";\r\n\r\nimport { pinDirectionFromElementPinSelector } from \"@/services/circuit-graph/selectors/pins\";\r\nimport { wireSegmentIdFromElementPinSelector } from \"@/services/circuit-graph/selectors/wires\";\r\nimport { wireLineCandidatesForSegmentId } from \"@/services/circuit-graph/selectors/lines\";\r\nimport { isSimActiveSelector } from \"@/services/simulator-control/selectors/run\";\r\n\r\nimport Menu from \"@/components/Menus/Menu\";\r\nimport CheckboxMenuItem from \"@/components/Menus/CheckboxMenuItem\";\r\nimport SubMenuItem from \"@/components/Menus/SubMenuItem\";\r\n\r\nexport interface PinContextMenuProps {\r\n  elementId: string;\r\n  pinId: string;\r\n}\r\n\r\nconst PinContextMenu: React.FC<PinContextMenuProps> = ({\r\n  elementId,\r\n  pinId,\r\n}) => {\r\n  const isSimActive = useSelector(isSimActiveSelector);\r\n\r\n  const direction = useSelector((state) =>\r\n    pinDirectionFromElementPinSelector(state, elementId, pinId)\r\n  );\r\n\r\n  const segmentId = useSelector((state) =>\r\n    wireSegmentIdFromElementPinSelector(state, elementId, pinId)\r\n  );\r\n\r\n  if (isSimActive || !direction || !segmentId) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <Menu>\r\n      <SubMenuItem\r\n        content={<SetLineIdMenu segmentId={segmentId} direction={direction} />}\r\n      >\r\n        Set {direction === \"input\" ? \"Input\" : \"Output\"}\r\n      </SubMenuItem>\r\n    </Menu>\r\n  );\r\n};\r\n\r\nexport default PinContextMenu;\r\n\r\ninterface SetLineIdMenuProps {\r\n  direction: \"input\" | \"output\";\r\n  segmentId: string;\r\n}\r\nconst SetLineIdMenu: React.FC<SetLineIdMenuProps> = ({\r\n  segmentId,\r\n  direction,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n\r\n  const candidates = useSelector((state) =>\r\n    wireLineCandidatesForSegmentId(state, segmentId)\r\n  );\r\n  return (\r\n    <Menu>\r\n      <CheckboxMenuItem\r\n        value={false}\r\n        onChange={() => dispatch(wireSegmentSetLine(segmentId, uuidV4()))}\r\n      >\r\n        New {direction === \"input\" ? \"Input\" : \"Output\"}\r\n      </CheckboxMenuItem>\r\n      {candidates.map(({ lineId, name, selected }) => (\r\n        <CheckboxMenuItem\r\n          key={lineId}\r\n          value={selected}\r\n          onChange={() => dispatch(wireSegmentSetLine(segmentId, lineId))}\r\n        >\r\n          {name}\r\n        </CheckboxMenuItem>\r\n      ))}\r\n    </Menu>\r\n  );\r\n};\r\n","// extracted by mini-css-extract-plugin\nexport default {\"element-pin-output\":\"element-pin-output--1jFy-\",\"highlight\":\"highlight--Q2iLD\",\"is-drag-target\":\"is-drag-target--1NYuw\",\"element-pin-input\":\"element-pin-input--1urBY\"};","import ElementPin from \"./ElementPin\";\r\nexport default ElementPin;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\nimport { describeArc } from \"@/svg\";\r\nimport { getModifiers } from \"@/modifier-keys\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useMouseDragDetector } from \"@/hooks/useMouseDragDetector\";\r\n\r\nimport { useContextMenu } from \"@/components/ContextMenu\";\r\n\r\nimport { circuitEditorDragStartWire } from \"@/actions/circuit-editor-drag-start-wire\";\r\n\r\nimport { elementPinPositionFromElementPinSelector } from \"@/services/circuit-layout/selectors/element-pin-positions\";\r\nimport { pinDirectionFromElementPinSelector } from \"@/services/circuit-graph/selectors/pins\";\r\nimport { isPinDragWireTarget } from \"@/services/circuit-editor-drag/selectors/drag-wire\";\r\n\r\nimport { useCircuitEditor } from \"../../../../contexts/circuit-editor-context\";\r\nimport { getElementPinHtmlId } from \"../../../../ids\";\r\n\r\nimport { useMouseCoords } from \"../../hooks/useMouseCoords\";\r\n\r\nimport PinContextMenu from \"../PinContextMenu\";\r\n\r\nimport styles from \"./ElementPin.module.css\";\r\n\r\nexport interface ElementPinProps {\r\n  elementId: string;\r\n  pinId: string;\r\n}\r\n\r\nconst ElementPin: React.FC<ElementPinProps> = React.memo(function ElementPin({\r\n  elementId,\r\n  pinId,\r\n}) {\r\n  const dispatch = useDispatch();\r\n\r\n  const { editorId } = useCircuitEditor();\r\n  const getMouseCoords = useMouseCoords();\r\n\r\n  const { openContextMenu, renderContextMenu } = useContextMenu();\r\n\r\n  const [highlight, setHighlight] = React.useState(false);\r\n\r\n  const position = useSelector((s) =>\r\n    elementPinPositionFromElementPinSelector(s, elementId, pinId)\r\n  );\r\n  const direction = useSelector((s) =>\r\n    pinDirectionFromElementPinSelector(s, elementId, pinId)\r\n  );\r\n\r\n  const isDragTargetPin = useSelector((state) =>\r\n    isPinDragWireTarget(state, elementId, pinId)\r\n  );\r\n\r\n  const onDragStart = React.useCallback(\r\n    (e, originalPoint) => {\r\n      const p = getMouseCoords(originalPoint);\r\n      const modifierKeys = getModifiers(e);\r\n      dispatch(\r\n        circuitEditorDragStartWire(\r\n          p,\r\n          { type: \"pin\", pin: { elementId, pinId } },\r\n          modifierKeys,\r\n          editorId\r\n        )\r\n      );\r\n    },\r\n    [dispatch, editorId, getMouseCoords, elementId, pinId]\r\n  );\r\n\r\n  const { startTracking } = useMouseDragDetector({\r\n    onDragStart,\r\n  });\r\n\r\n  const onMouseDown = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.button !== 0) {\r\n        return;\r\n      }\r\n\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      e.preventDefault();\r\n\r\n      e.stopPropagation();\r\n\r\n      startTracking(e);\r\n    },\r\n    [startTracking]\r\n  );\r\n\r\n  const onMouseEnter = React.useCallback(() => {\r\n    setHighlight(true);\r\n  }, []);\r\n  const onMouseLeave = React.useCallback(() => {\r\n    setHighlight(false);\r\n  }, []);\r\n\r\n  const onContextMenu = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n      e.preventDefault();\r\n\r\n      openContextMenu(e);\r\n    },\r\n    [openContextMenu]\r\n  );\r\n\r\n  if (!position) {\r\n    return null;\r\n  }\r\n\r\n  const { x, y } = position;\r\n\r\n  let pinVisual: JSX.Element;\r\n\r\n  if (direction === \"input\") {\r\n    pinVisual = (\r\n      <path\r\n        d={describeArc(x, y, 4, -45, 225)}\r\n        strokeWidth={2}\r\n        className={cls(\r\n          styles[\"element-pin-input\"],\r\n          isDragTargetPin && styles[\"is-drag-target\"],\r\n          highlight && styles.highlight\r\n        )}\r\n      />\r\n    );\r\n  } else {\r\n    pinVisual = (\r\n      <circle\r\n        className={cls(\r\n          styles[\"element-pin-output\"],\r\n          isDragTargetPin && styles[\"is-drag-target\"],\r\n          highlight && styles.highlight\r\n        )}\r\n        cx={x}\r\n        cy={y}\r\n        r={3}\r\n      />\r\n    );\r\n  }\r\n\r\n  return (\r\n    <g\r\n      id={getElementPinHtmlId(editorId, elementId, pinId)}\r\n      onMouseEnter={onMouseEnter}\r\n      onMouseLeave={onMouseLeave}\r\n      onContextMenu={onContextMenu}\r\n    >\r\n      {pinVisual}\r\n      <circle\r\n        stroke=\"none\"\r\n        fill=\"transparent\"\r\n        cx={x}\r\n        cy={y}\r\n        r={5}\r\n        onMouseDown={onMouseDown}\r\n      />\r\n      {renderContextMenu(\r\n        <PinContextMenu elementId={elementId} pinId={pinId} />\r\n      )}\r\n    </g>\r\n  );\r\n});\r\n\r\nexport default ElementPin;\r\n","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { elementDefinitionFromElementIdSelector } from \"@/services/circuit-graph/selectors/element-def\";\r\n\r\nimport ElementPin from \"./ElementPin\";\r\n\r\nexport interface NodePinsProps {\r\n  elementId: string;\r\n}\r\n\r\nconst ElementPins: React.FC<NodePinsProps> = React.memo(function ElementPins({\r\n  elementId,\r\n}) {\r\n  const def = useSelector((state) =>\r\n    elementDefinitionFromElementIdSelector(state, elementId)\r\n  );\r\n\r\n  const pins = def?.pins ?? {};\r\n\r\n  const elements = Object.keys(pins).map((pinId) => (\r\n    <ElementPin key={pinId} elementId={elementId} pinId={pinId} />\r\n  ));\r\n\r\n  return <>{elements}</>;\r\n});\r\n\r\nexport default ElementPins;\r\n","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { elementIdsFromCircuitIdSelector } from \"@/services/circuit-graph/selectors/elements\";\r\n\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\n\r\nimport ElementPins from \"./ElementPins\";\r\n\r\nconst ElementPinsLayer: React.FC = React.memo(function ElementPinsLayer() {\r\n  const { circuitId } = useCircuitEditor();\r\n  const elementIds = useSelector((state) =>\r\n    elementIdsFromCircuitIdSelector(state, circuitId)\r\n  );\r\n\r\n  const elements = elementIds.map((elementId) => (\r\n    <ElementPins key={elementId} elementId={elementId} />\r\n  ));\r\n\r\n  return <g>{elements}</g>;\r\n});\r\n\r\nexport default ElementPinsLayer;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { getModifiers } from \"@/modifier-keys\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { isDraggingSelector } from \"@/services/circuit-editor-drag/selectors/drag\";\r\n\r\nimport { circuitEditorDragContinue } from \"@/actions/circuit-editor-drag-continue\";\r\nimport { circuitEditorDragEnd } from \"@/actions/circuit-editor-drag-end\";\r\nimport { circuitEditorDragAbort } from \"@/actions/circuit-editor-drag-abort\";\r\n\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\nimport { useViewportContext } from \"../../../contexts/viewport-context\";\r\n\r\nimport { useEventMouseCoords } from \"../hooks/useMouseCoords\";\r\n\r\nconst EditorDragReceiver: React.FC = () => {\r\n  const dispatch = useDispatch();\r\n  const { editorId } = useCircuitEditor();\r\n  const { zoomFactor } = useViewportContext();\r\n\r\n  const isDragging = useSelector(isDraggingSelector);\r\n\r\n  function counterScale(value: number) {\r\n    return value * (1 / zoomFactor);\r\n  }\r\n\r\n  const getCoords = useEventMouseCoords();\r\n\r\n  const onMouseMove = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.buttons === 0) {\r\n        // It would be nice if we could take a mouse capture and get notified\r\n        // of the mouse up elsewhere, but we need to allow other circuit editors\r\n        // to receive the mouse events so the drag can transfer.\r\n        // As a second best, detect mouse up when it comes back into us and cancel.\r\n        dispatch(circuitEditorDragAbort());\r\n        return;\r\n      }\r\n\r\n      const coords = getCoords(e);\r\n      const modifierKeys = getModifiers(e);\r\n      dispatch(circuitEditorDragContinue(coords, modifierKeys, editorId));\r\n    },\r\n    [dispatch, editorId, getCoords]\r\n  );\r\n\r\n  const onMouseUp = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      const coords = getCoords(e);\r\n      const modifierKeys = getModifiers(e);\r\n      dispatch(circuitEditorDragEnd(coords, modifierKeys, editorId));\r\n    },\r\n    [dispatch, editorId, getCoords]\r\n  );\r\n\r\n  if (!isDragging) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <rect\r\n      width={`${counterScale(1) * 100}%`}\r\n      height={`${counterScale(1) * 100}%`}\r\n      fill=\"transparent\"\r\n      onMouseMove={onMouseMove}\r\n      onMouseUp={onMouseUp}\r\n    />\r\n  );\r\n};\r\n\r\nexport default EditorDragReceiver;\r\n","import WireSegment from \"./WireSegment\";\r\nexport default WireSegment;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport {\r\n  dotProduct,\r\n  normalize,\r\n  Point,\r\n  pointAdd,\r\n  pointSubtract,\r\n  scale,\r\n  snapValue,\r\n} from \"@/geometry\";\r\nimport { getModifiers } from \"@/modifier-keys\";\r\nimport { getSelectMode } from \"@/selection-mode\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useMouseDragDetector } from \"@/hooks/useMouseDragDetector\";\r\n\r\nimport {\r\n  endPositionForWireSegmentId,\r\n  startPositionForWireSegmentId,\r\n} from \"@/services/circuit-graph/selectors/wire-positions\";\r\nimport { isSimActiveSelector } from \"@/services/simulator-control/selectors/run\";\r\nimport { isDraggingSelector } from \"@/services/circuit-editor-drag/selectors/drag\";\r\nimport {\r\n  segmentIsWiredSelector,\r\n  wireSegmentPoweredSelector,\r\n  wireSegmentTypeFromSegmentIdSelector,\r\n} from \"@/services/circuit-graph/selectors/wires\";\r\nimport { gridJointSnapSelector } from \"@/services/circuit-editor-drag/selectors/snap\";\r\nimport { isSegmentSelectedFromSegmentIdSelector } from \"@/services/selection/selectors/selection\";\r\nimport { segmentDragWireTargetOffset } from \"@/services/circuit-editor-drag/selectors/drag-wire\";\r\n\r\nimport { circuitEditorDragStartWireSegment } from \"@/actions/circuit-editor-drag-start-wire-segment\";\r\nimport { selectWireSegments } from \"@/actions/select-wire-segments\";\r\n\r\nimport { useCircuitEditor } from \"../../../../contexts/circuit-editor-context\";\r\n\r\nimport { useMouseCoords } from \"../../hooks/useMouseCoords\";\r\n\r\nimport styles from \"./WireSegment.module.css\";\r\n\r\nexport interface WireSegmentProps {\r\n  wireId: string;\r\n  wireSegmentId: string;\r\n}\r\n\r\nconst WireSegment: React.FC<WireSegmentProps> = ({ wireId, wireSegmentId }) => {\r\n  const dispatch = useDispatch();\r\n  const { editorId, elementIdPath } = useCircuitEditor();\r\n  const getCoords = useMouseCoords();\r\n\r\n  const isMouseGesturePending = React.useRef<boolean>(false);\r\n  const [insertJointPos, setInsertJointPos] = React.useState<Point | null>(\r\n    null\r\n  );\r\n\r\n  const isSimActive = useSelector(isSimActiveSelector);\r\n\r\n  const isSelected = useSelector((state) =>\r\n    isSegmentSelectedFromSegmentIdSelector(state, wireSegmentId)\r\n  );\r\n  const isPowered = useSelector((state) =>\r\n    wireSegmentPoweredSelector(state, elementIdPath, wireSegmentId)\r\n  );\r\n  const isWired = useSelector((state) =>\r\n    segmentIsWiredSelector(state, wireSegmentId)\r\n  );\r\n  const dragTargetWireLength = useSelector((state) =>\r\n    segmentDragWireTargetOffset(state, wireSegmentId)\r\n  );\r\n\r\n  const isDragging = useSelector(isDraggingSelector);\r\n\r\n  const snap = useSelector(gridJointSnapSelector);\r\n\r\n  const segmentType = useSelector((state) =>\r\n    wireSegmentTypeFromSegmentIdSelector(state, wireSegmentId)\r\n  );\r\n\r\n  const startPos = useSelector((state) =>\r\n    startPositionForWireSegmentId(state, wireSegmentId)\r\n  );\r\n  const endPos = useSelector((state) =>\r\n    endPositionForWireSegmentId(state, wireSegmentId)\r\n  );\r\n\r\n  const lineVector = normalize(pointSubtract(endPos, startPos));\r\n\r\n  const dragConnectPos = dragTargetWireLength\r\n    ? pointAdd(startPos, scale(lineVector, dragTargetWireLength))\r\n    : null;\r\n\r\n  const onMouseMove = (e: React.MouseEvent<SVGLineElement>) => {\r\n    if (isDragging || isSimActive || isMouseGesturePending.current) {\r\n      return;\r\n    }\r\n\r\n    const modifierKeys = getModifiers(e);\r\n    const p = getCoords({ x: e.pageX, y: e.pageY });\r\n    const v = pointSubtract(p, startPos);\r\n    const d = dotProduct(v, lineVector);\r\n    const dotPos = pointAdd(startPos, scale(lineVector, d));\r\n\r\n    if (!modifierKeys.ctrlMetaKey) {\r\n      // If snapping is enabled, snap to the axis the line follows.\r\n      if (Math.abs(lineVector.x) === 1) {\r\n        dotPos.x = snapValue(dotPos.x, snap);\r\n      }\r\n      if (Math.abs(lineVector.y) === 1) {\r\n        dotPos.y = snapValue(dotPos.y, snap);\r\n      }\r\n    }\r\n\r\n    setInsertJointPos(dotPos);\r\n  };\r\n\r\n  const onMouseLeave = () => {\r\n    if (!isMouseGesturePending.current) {\r\n      setInsertJointPos(null);\r\n    }\r\n  };\r\n\r\n  const onDragStart = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      isMouseGesturePending.current = false;\r\n      if (!insertJointPos) {\r\n        return;\r\n      }\r\n\r\n      const modifierKeys = getModifiers(e);\r\n      dispatch(\r\n        circuitEditorDragStartWireSegment(\r\n          insertJointPos,\r\n          wireId,\r\n          wireSegmentId,\r\n          modifierKeys,\r\n          editorId\r\n        )\r\n      );\r\n\r\n      setInsertJointPos(null);\r\n    },\r\n    [dispatch, editorId, insertJointPos, wireId, wireSegmentId]\r\n  );\r\n\r\n  const onClick = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      e.preventDefault();\r\n\r\n      isMouseGesturePending.current = false;\r\n      setInsertJointPos(null);\r\n\r\n      const modifierKeys = getModifiers(e);\r\n      const selectionMode = getSelectMode(modifierKeys);\r\n      dispatch(selectWireSegments(wireSegmentId, selectionMode));\r\n    },\r\n    [dispatch, wireSegmentId]\r\n  );\r\n\r\n  const { startTracking } = useMouseDragDetector({\r\n    onDragStart,\r\n    onClick,\r\n  });\r\n\r\n  const onMouseDown = (e: React.MouseEvent) => {\r\n    if (e.defaultPrevented) {\r\n      return;\r\n    }\r\n\r\n    if (isDragging || isSimActive) {\r\n      return;\r\n    }\r\n\r\n    isMouseGesturePending.current = true;\r\n    startTracking(e);\r\n  };\r\n\r\n  return (\r\n    <g\r\n      className={cls(\r\n        styles[\"wire-segment\"],\r\n        !isWired && styles[\"unwired\"],\r\n        isSelected && styles[\"selected\"],\r\n        isPowered && styles[\"powered\"]\r\n      )}\r\n      onMouseMove={onMouseMove}\r\n      onMouseLeave={onMouseLeave}\r\n      onMouseDown={onMouseDown}\r\n    >\r\n      <line\r\n        x1={startPos.x}\r\n        x2={endPos.x}\r\n        y1={startPos.y}\r\n        y2={endPos.y}\r\n        stroke=\"inherit\"\r\n        strokeWidth={2}\r\n      />\r\n      <line\r\n        x1={startPos.x}\r\n        x2={endPos.x}\r\n        y1={startPos.y}\r\n        y2={endPos.y}\r\n        stroke=\"transparent\"\r\n        strokeWidth={4}\r\n      />\r\n      {(segmentType === \"input\" || segmentType === \"input-output\") && (\r\n        <circle\r\n          cx={endPos.x}\r\n          cy={endPos.y}\r\n          r={2}\r\n          stroke=\"none\"\r\n          fill=\"inherit\"\r\n        />\r\n      )}\r\n      {!dragConnectPos && insertJointPos && (\r\n        <circle\r\n          cx={insertJointPos.x}\r\n          cy={insertJointPos.y}\r\n          r={3}\r\n          fill=\"orange\"\r\n          stroke=\"none\"\r\n        />\r\n      )}\r\n      {dragConnectPos && (\r\n        <circle\r\n          className={styles[\"drag-wire-target\"]}\r\n          cx={dragConnectPos.x}\r\n          cy={dragConnectPos.y}\r\n          r={3}\r\n          stroke=\"none\"\r\n        />\r\n      )}\r\n    </g>\r\n  );\r\n};\r\n\r\nexport default WireSegment;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"wire-segment\":\"wire-segment--3ENBk\",\"unwired\":\"unwired--2GWhN\",\"powered\":\"powered--I4EaN\",\"drag-wire-target\":\"drag-wire-target--20uzz\",\"selected\":\"selected--1ceWg\"};","import WireJoint from \"./WireJoint\";\r\nexport default WireJoint;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\nimport { getModifiers } from \"@/modifier-keys\";\r\nimport { describeArc } from \"@/svg\";\r\n\r\nimport { useMouseDragDetector } from \"@/hooks/useMouseDragDetector\";\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { getSelectMode } from \"@/selection-mode\";\r\n\r\nimport { circuitEditorDragStartWireJoint } from \"@/actions/circuit-editor-drag-start-wire-joint\";\r\nimport { selectWireJoints } from \"@/actions/select-wire-joints\";\r\nimport { circuitEditorDragStartWire } from \"@/actions/circuit-editor-drag-start-wire\";\r\n\r\nimport { wireJointPositionFromJointIdSelector } from \"@/services/circuit-graph/selectors/wire-positions\";\r\nimport { isJointSelectedFromJointIdSelector } from \"@/services/selection/selectors/selection\";\r\nimport { isSimActiveSelector } from \"@/services/simulator-control/selectors/run\";\r\nimport { isJointDragWireTarget } from \"@/services/circuit-editor-drag/selectors/drag-wire\";\r\n\r\nimport { useCircuitEditor } from \"../../../../contexts/circuit-editor-context\";\r\nimport { getWireJointHtmlId } from \"../../../../ids\";\r\n\r\nimport { useMouseCoords } from \"../../hooks/useMouseCoords\";\r\n\r\nimport styles from \"./WireJoint.module.css\";\r\n\r\nexport interface WireJointProps {\r\n  wireId: string;\r\n  jointId: string;\r\n}\r\n\r\nconst WireJoint: React.FC<WireJointProps> = ({ wireId, jointId }) => {\r\n  const dispatch = useDispatch();\r\n  const { editorId } = useCircuitEditor();\r\n  const getCoords = useMouseCoords();\r\n  const isSimActive = useSelector(isSimActiveSelector);\r\n\r\n  const position = useSelector((state) =>\r\n    wireJointPositionFromJointIdSelector(state, jointId)\r\n  );\r\n  const isSelected = useSelector((state) =>\r\n    isJointSelectedFromJointIdSelector(state, jointId)\r\n  );\r\n  const isDragTargetJoint = useSelector((state) =>\r\n    isJointDragWireTarget(state, jointId)\r\n  );\r\n\r\n  const [mouseOver, setMouseOver] = React.useState(false);\r\n\r\n  const onMouseOver = () => {\r\n    setMouseOver(true);\r\n  };\r\n\r\n  const onMouseLeave = () => {\r\n    setMouseOver(false);\r\n  };\r\n\r\n  const onDragStart = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      const p = getCoords({ x: e.pageX, y: e.pageY });\r\n      const modifierKeys = getModifiers(e);\r\n      dispatch(\r\n        circuitEditorDragStartWireJoint(\r\n          p,\r\n          wireId,\r\n          jointId,\r\n          modifierKeys,\r\n          editorId\r\n        )\r\n      );\r\n    },\r\n    [dispatch, editorId, getCoords, jointId, wireId]\r\n  );\r\n\r\n  const onNewSegmentMouseDown = (e: React.MouseEvent) => {\r\n    const p = getCoords({ x: e.pageX, y: e.pageY });\r\n    const modifierKeys = getModifiers(e);\r\n    dispatch(\r\n      circuitEditorDragStartWire(\r\n        p,\r\n        {\r\n          type: \"joint\",\r\n          jointId,\r\n        },\r\n        modifierKeys,\r\n        editorId\r\n      )\r\n    );\r\n  };\r\n\r\n  const onClick = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      e.preventDefault();\r\n\r\n      const modifierKeys = getModifiers(e);\r\n      const selectionMode = getSelectMode(modifierKeys);\r\n      dispatch(selectWireJoints(jointId, selectionMode));\r\n    },\r\n    [dispatch, jointId]\r\n  );\r\n\r\n  const { startTracking } = useMouseDragDetector({\r\n    onDragStart,\r\n    onClick,\r\n  });\r\n\r\n  const newSegmentArc = `${describeArc(\r\n    position.x,\r\n    position.y,\r\n    8.5,\r\n    0,\r\n    180\r\n  )} ${describeArc(position.x, position.y, 8.5, 180, 0)} z ${describeArc(\r\n    position.x,\r\n    position.y,\r\n    5,\r\n    0,\r\n    180\r\n  )} ${describeArc(position.x, position.y, 5, 180, 0)}`;\r\n\r\n  if (!position) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <g\r\n      id={getWireJointHtmlId(editorId, jointId)}\r\n      onMouseOver={onMouseOver}\r\n      onMouseLeave={onMouseLeave}\r\n    >\r\n      <circle\r\n        cx={position.x}\r\n        cy={position.y}\r\n        r={6}\r\n        fill=\"transparent\"\r\n        stroke=\"none\"\r\n      />\r\n      <circle\r\n        className={cls(isDragTargetJoint && styles[\"is-drag-target\"])}\r\n        cx={position.x}\r\n        cy={position.y}\r\n        r={3}\r\n        fill=\"black\"\r\n        stroke=\"none\"\r\n      />\r\n      {!isSimActive && !isDragTargetJoint && (mouseOver || isSelected) && (\r\n        <g\r\n          className={cls(\r\n            styles[\"wire-joint--interactor\"],\r\n            isSelected && styles[\"selected\"]\r\n          )}\r\n        >\r\n          {mouseOver && (\r\n            <g onMouseDown={onNewSegmentMouseDown}>\r\n              <circle\r\n                cx={position.x}\r\n                cy={position.y}\r\n                r={8.5}\r\n                stroke=\"none\"\r\n                fill=\"transparent\"\r\n                className={styles[\"mouse-detector\"]}\r\n              />\r\n              <path\r\n                shapeRendering=\"geometricPrecision\"\r\n                stroke=\"none\"\r\n                fill=\"black\"\r\n                fillRule=\"evenodd\"\r\n                d={newSegmentArc}\r\n              />\r\n            </g>\r\n          )}\r\n          <circle\r\n            cx={position.x}\r\n            cy={position.y}\r\n            r={3}\r\n            fill=\"black\"\r\n            stroke=\"none\"\r\n            onMouseDown={startTracking}\r\n          />\r\n        </g>\r\n      )}\r\n    </g>\r\n  );\r\n};\r\n\r\nexport default WireJoint;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"wire-joint--interactor\":\"wire-joint--interactor--3h5o4\",\"selected\":\"selected--2L-Hh\",\"mouse-detector\":\"mouse-detector--23NpN\",\"is-drag-target\":\"is-drag-target--1nP1l\"};","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport {\r\n  wireJointIdsFromWireIdSelector,\r\n  wireSegmentIdsFromWireIdSelector,\r\n} from \"@/services/circuit-graph/selectors/wires\";\r\n\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\nimport { getWireHtmlId } from \"../../../ids\";\r\n\r\nimport WireSegment from \"./WireSegment\";\r\nimport WireJoint from \"./WireJoint\";\r\n\r\nexport interface WireProps {\r\n  wireId: string;\r\n}\r\n\r\nconst Wire: React.FC<WireProps> = ({ wireId }) => {\r\n  const { editorId } = useCircuitEditor();\r\n  const wireSegmentIds = useSelector((state) =>\r\n    wireSegmentIdsFromWireIdSelector(state, wireId)\r\n  );\r\n  const wireJointIds = useSelector((state) =>\r\n    wireJointIdsFromWireIdSelector(state, wireId)\r\n  );\r\n\r\n  const segmentElements = wireSegmentIds.map((id) => (\r\n    <WireSegment key={id} wireId={wireId} wireSegmentId={id} />\r\n  ));\r\n\r\n  // TODO: Might want to render joints on a new layer so they are always rendered above other wire segments\r\n  const jointElements = wireJointIds.map((id) => (\r\n    <WireJoint key={id} wireId={wireId} jointId={id} />\r\n  ));\r\n\r\n  return (\r\n    <g id={getWireHtmlId(editorId, wireId)}>\r\n      {segmentElements}\r\n      {jointElements}\r\n    </g>\r\n  );\r\n};\r\n\r\nexport default Wire;\r\n","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { wireIdsFromCircuitIdSelector } from \"@/services/circuit-graph/selectors/wires\";\r\n\r\nimport { useCircuitEditor } from \"../../../contexts/circuit-editor-context\";\r\n\r\nimport Wire from \"./Wire\";\r\n\r\nconst WiresLayer = React.memo(function WiresLayer() {\r\n  const { circuitId } = useCircuitEditor();\r\n  const wireIds = useSelector((state) =>\r\n    wireIdsFromCircuitIdSelector(state, circuitId)\r\n  );\r\n\r\n  const elements = wireIds.map((wireId) => (\r\n    <Wire key={wireId} wireId={wireId} />\r\n  ));\r\n\r\n  return <g className=\"circuit-editor-wires-layer\">{elements}</g>;\r\n});\r\n\r\nexport default WiresLayer;\r\n","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport {\r\n  dragJointGhostLinesSelector,\r\n  dragWireJointPositionSelector,\r\n  dragWireSegmentEndPositionSelector,\r\n  dragWireSegmentStartPositionSelector,\r\n} from \"@/services/circuit-editor-drag/selectors/drag-wire\";\r\n\r\nconst DragWirePreviewLayer: React.FC = () => {\r\n  const jointPos = useSelector(dragWireJointPositionSelector);\r\n  const dragStart = useSelector(dragWireSegmentStartPositionSelector);\r\n  const dragEnd = useSelector(dragWireSegmentEndPositionSelector);\r\n\r\n  const ghostLines = useSelector(dragJointGhostLinesSelector);\r\n\r\n  const ghostLineElements = ghostLines.map(([start, end], i) => (\r\n    <line\r\n      key={i}\r\n      x1={start.x}\r\n      y1={start.y}\r\n      x2={end.x}\r\n      y2={end.y}\r\n      stroke=\"black\"\r\n      strokeWidth={2}\r\n      opacity={0.4}\r\n    />\r\n  ));\r\n\r\n  if (!dragStart && !dragEnd && !jointPos && ghostLineElements.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  // FIXME: Use css for opacity on all dragging elements.\r\n  return (\r\n    <g className=\"circuit-editor-drag-wire-preview\">\r\n      {ghostLineElements}\r\n      {jointPos && (\r\n        <circle\r\n          cx={jointPos.x}\r\n          cy={jointPos.y}\r\n          r={2}\r\n          opacity={0.4}\r\n          stroke=\"none\"\r\n          fill=\"black\"\r\n        />\r\n      )}\r\n      {dragStart && dragEnd && (\r\n        <line\r\n          x1={dragStart.x}\r\n          y1={dragStart.y}\r\n          x2={dragEnd.x}\r\n          y2={dragEnd.y}\r\n          stroke=\"black\"\r\n          strokeWidth={2}\r\n          opacity={0.4}\r\n        />\r\n      )}\r\n    </g>\r\n  );\r\n};\r\n\r\nexport default DragWirePreviewLayer;\r\n","import CircuitFieldSurface from \"./CircuitFieldSurface\";\r\nexport default CircuitFieldSurface;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\nimport { useDrop } from \"react-dnd\";\r\n\r\nimport { circuitEditorMouseLeave } from \"@/actions/circuit-editor-mouse-leave\";\r\n\r\nimport { NEW_ELEMENT_DRAG_OBJECT } from \"../../drag-items/new-element\";\r\nimport { useViewportContext } from \"../../contexts/viewport-context\";\r\n\r\nimport { FieldSvgElementProvider } from \"./contexts/fieldSvgElement\";\r\n\r\nimport DragNewElementLayer from \"./components/DragNewElementLayer\";\r\nimport DragMovePreviewLayer from \"./components/DragMovePreviewLayer\";\r\nimport FieldMouseLayer from \"./components/FieldMouseLayer\";\r\nimport GridBackground from \"./components/GridBackground\";\r\nimport ElementsLayer from \"./components/ElementsLayer\";\r\nimport ElementPinsLayer from \"./components/ElementPinsLayer\";\r\nimport EditorDragReceiver from \"./components/EditorDragReceiver\";\r\nimport WiresLayer from \"./components/WiresLayer\";\r\nimport DragWirePreviewLayer from \"./components/DragWirePreviewLayer\";\r\n\r\nimport styles from \"./CircuitFieldSurface.module.css\";\r\n\r\nexport interface CircuitFieldSurfaceProps {\r\n  width: number;\r\n  height: number;\r\n}\r\nconst CircuitFieldSurface: React.FC<CircuitFieldSurfaceProps> = ({\r\n  width,\r\n  height,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n  const { zoomFactor } = useViewportContext();\r\n\r\n  const svgRef = React.useRef<SVGSVGElement | null>(null);\r\n  const scalerRef = React.useRef<SVGGElement | null>(null);\r\n\r\n  const onMouseDown = React.useCallback(() => {\r\n    svgRef.current?.focus();\r\n  }, []);\r\n\r\n  const onMouseLeave = React.useCallback(() => {\r\n    dispatch(circuitEditorMouseLeave());\r\n  }, [dispatch]);\r\n\r\n  // We need to capture the drag event at a deeper parent,\r\n  // because mouse events cannot pass through DragNewElementLayer's\r\n  // drag capture rect to the underlying DragSelectLayer and other elements.\r\n  // In contrast, we cannot handle the drag here as\r\n  // we do not know the coordinate system from our scaler.\r\n  // Instead, just capture whether or not we are being dragged into,\r\n  // and enable the new element drag layer only when we are dragging.\r\n  const [{ isDraggingNewElement }, dragRef] = useDrop({\r\n    accept: NEW_ELEMENT_DRAG_OBJECT,\r\n    collect: (monitor) => {\r\n      return {\r\n        isDraggingNewElement: monitor.isOver(),\r\n      };\r\n    },\r\n  });\r\n\r\n  return (\r\n    <svg\r\n      tabIndex={-1}\r\n      ref={(ref) => {\r\n        svgRef.current = ref;\r\n        dragRef(ref);\r\n      }}\r\n      width={width}\r\n      height={height}\r\n      onMouseDown={onMouseDown}\r\n      onMouseLeave={onMouseLeave}\r\n      className={styles[\"circuit-field-svg\"]}\r\n    >\r\n      <GridBackground />\r\n      <g\r\n        ref={scalerRef}\r\n        transform-origin=\"0 0\"\r\n        transform={`scale(${zoomFactor})`}\r\n      >\r\n        <FieldSvgElementProvider svgRef={svgRef} scalerRef={scalerRef}>\r\n          <FieldMouseLayer />\r\n          <ElementsLayer />\r\n          <WiresLayer />\r\n          <ElementPinsLayer />\r\n          <DragMovePreviewLayer />\r\n          <DragWirePreviewLayer />\r\n          {isDraggingNewElement && <DragNewElementLayer />}\r\n          <EditorDragReceiver />\r\n        </FieldSvgElementProvider>\r\n      </g>\r\n    </svg>\r\n  );\r\n};\r\n\r\nexport default CircuitFieldSurface;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"circuit-field-svg\":\"circuit-field-svg--o7YIn\"};","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\nimport { calcSize } from \"@/geometry\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useNativeEvent } from \"@/hooks/useNativeEvent\";\r\nimport { useComponentBounds } from \"@/hooks/useComponentBounds\";\r\n\r\nimport { fieldRectSelector } from \"@/services/circuit-layout/selectors/field\";\r\nimport { isSimActiveSelector } from \"@/services/simulator-control/selectors/run\";\r\n\r\nimport CircuitFieldSurface from \"./components/CircuitFieldSurface\";\r\n\r\nimport { CircuitEditorProvider } from \"./contexts/circuit-editor-context\";\r\nimport {\r\n  useViewportContext,\r\n  ViewportContextProvider,\r\n} from \"./contexts/viewport-context\";\r\n\r\nimport styles from \"./CircuitEditor.module.css\";\r\n\r\nimport { getCircuitEditorHtmlId } from \"./ids\";\r\n\r\nexport interface CircuitEditorProps {\r\n  className?: string;\r\n  editorId: string;\r\n}\r\n\r\nconst CircuitEditor: React.FC<CircuitEditorProps> = ({\r\n  className,\r\n  editorId,\r\n}) => {\r\n  const isSimActive = useSelector(isSimActiveSelector);\r\n\r\n  // svg seems to have an implicit bottom margin against its parent div\r\n  // Wrapping it in a div of the same size fixes it.\r\n  return (\r\n    <CircuitEditorProvider editorId={editorId}>\r\n      <div\r\n        id={getCircuitEditorHtmlId(editorId)}\r\n        className={cls(\r\n          \"circuit-editor\",\r\n          styles[\"circuit-editor\"],\r\n          isSimActive && \"simulator-active\",\r\n          className\r\n        )}\r\n      >\r\n        <div className={styles[\"circuit-editor-scrollarea\"]}>\r\n          <ViewportContextProvider>\r\n            <ZoomingCircuitFieldSurface />\r\n          </ViewportContextProvider>\r\n        </div>\r\n      </div>\r\n    </CircuitEditorProvider>\r\n  );\r\n};\r\n\r\nexport default CircuitEditor;\r\n\r\nconst ZoomingCircuitFieldSurface: React.FC = ({}) => {\r\n  const sizeRef = React.useRef<HTMLDivElement | null>(null);\r\n  const { width: componentWidth, height: componentHeight } = useComponentBounds(\r\n    sizeRef\r\n  );\r\n\r\n  const { zoomFactor, zoom } = useViewportContext();\r\n\r\n  const fieldRect = useSelector(fieldRectSelector);\r\n  const { width: fieldWidth, height: fieldHeight } = calcSize(fieldRect);\r\n\r\n  const width = Math.max(componentWidth, fieldWidth * zoomFactor);\r\n  const height = Math.max(componentHeight, fieldHeight * zoomFactor);\r\n\r\n  const onWheel = React.useCallback(\r\n    (e: WheelEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      if (e.ctrlKey) {\r\n        zoom(e.deltaY > 0 ? -1 : 1);\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n      }\r\n    },\r\n    [zoom]\r\n  );\r\n\r\n  // React listens to the root listener for all events,\r\n  //  and chrome assumes the root event listener for mouse events\r\n  //  never wants to preventDefault.\r\n  // We need to take a local event listener and mark it as not passive.\r\n  // https://github.com/facebook/react/issues/14856\r\n  useNativeEvent(sizeRef, \"wheel\", onWheel, { passive: false });\r\n\r\n  return (\r\n    <div ref={sizeRef} style={{ width: \"100%\", height: \"100%\" }}>\r\n      <CircuitFieldSurface width={width} height={height} />\r\n    </div>\r\n  );\r\n};\r\n","import CircuitEditor from \"./CircuitEditor\";\r\nexport default CircuitEditor;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"circuit-editor\":\"circuit-editor--2jFUa\",\"circuit-editor-scrollarea\":\"circuit-editor-scrollarea--12k0x\"};","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport styles from \"./Icons.module.css\";\r\n\r\nconst CloseIcon: React.FC<React.SVGProps<SVGSVGElement>> = (props) => {\r\n  return (\r\n    <svg\r\n      width={16}\r\n      height={16}\r\n      {...props}\r\n      className={cls(styles.icon, props.className)}\r\n    >\r\n      <path d=\"M4,4 L12,12 M4,12 L12,4\" />\r\n    </svg>\r\n  );\r\n};\r\n\r\nexport default CloseIcon;\r\n","import * as React from \"react\";\r\n\r\nimport { useDrag } from \"react-dnd\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport { tesselWindowDragObject } from \"./drag-items/tessel-window\";\r\n\r\nimport { useTesselInteraction, useTesselPath } from \"./TesselContext\";\r\nimport TesselDropCapture from \"./TesselDropCapture\";\r\n\r\nimport styles from \"./Tessel.module.css\";\r\nimport CloseIcon from \"../Icons/Close\";\r\n\r\nexport interface TesselWindowProps {\r\n  className?: string;\r\n  id?: string;\r\n  title: string;\r\n}\r\nconst TesselWindow: React.FC<TesselWindowProps> = ({\r\n  className,\r\n  id,\r\n  title,\r\n  children,\r\n}) => {\r\n  const path = useTesselPath();\r\n\r\n  const { closeWindow } = useTesselInteraction();\r\n  const onCloseWindow = React.useCallback(() => {\r\n    closeWindow(path);\r\n  }, [closeWindow, path]);\r\n\r\n  const [, dragSourceRef] = useDrag({\r\n    item: tesselWindowDragObject(path),\r\n  });\r\n\r\n  return (\r\n    <TesselDropCapture id={id} className={styles[\"tessel-window\"]}>\r\n      <div ref={dragSourceRef} className={styles[\"tessel-window-titlebar\"]}>\r\n        <div className={styles[\"tessel-window-title\"]}>{title}</div>\r\n        <div className={styles[\"tessel-window-controls\"]}>\r\n          <CloseIcon\r\n            className={styles[\"tessel-window-controls-close\"]}\r\n            onClick={onCloseWindow}\r\n          />\r\n        </div>\r\n      </div>\r\n      <div className={cls(styles[\"tessel-window-content\"], className)}>\r\n        {children}\r\n      </div>\r\n    </TesselDropCapture>\r\n  );\r\n};\r\n\r\nexport default TesselWindow;\r\n","import { keyboardCommandModifier } from \"@/runtime-env\";\r\n\r\nexport const KEYMAP_SIM_STEP = \"keymap:CircuitEditor/SimStep\" as const;\r\nexport const KEYMAP_SELECT_ALL = \"keymap:CircuitEditor/SelectAll\" as const;\r\nexport const KEYMAP_COPY = \"keymap:CircuitEditor/Copy\" as const;\r\nexport const KEYMAP_PASTE = \"keymap:CircuitEditor/Paste\" as const;\r\nexport const KEYMAP_DELETE = \"keymap:CircuitEditor/Delete\" as const;\r\nexport const KEYMAP_UNDO = \"keymap:CircuitEditor/Undo\" as const;\r\nexport const KEYMAP_REDO = \"keymap:CircuitEditor/Redo\" as const;\r\n\r\nconst keymap = {\r\n  [KEYMAP_SIM_STEP]: \"space\",\r\n  [KEYMAP_SELECT_ALL]: `${keyboardCommandModifier}+a`,\r\n  [KEYMAP_COPY]: `${keyboardCommandModifier}+c`,\r\n  [KEYMAP_PASTE]: `${keyboardCommandModifier}+v`,\r\n  [KEYMAP_DELETE]: [\"backspace\", \"del\"],\r\n  [KEYMAP_UNDO]: `${keyboardCommandModifier}+z`,\r\n  [KEYMAP_REDO]: [\r\n    `${keyboardCommandModifier}+y`,\r\n    `${keyboardCommandModifier}+shift+z`,\r\n  ],\r\n};\r\nexport default keymap;\r\n\r\nexport type KeymapKeys = keyof typeof keymap;\r\nexport type KeymapHandler = Record<KeymapKeys, HotkeyHandler>;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\nimport { HotKeys } from \"react-hotkeys\";\r\nimport { AnyAction } from \"redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport sizing from \"@/styles/sizing.module.css\";\r\nimport flex from \"@/styles/flex.module.css\";\r\n\r\nimport { circuitEditorStateFromIdSelector } from \"@/services/circuit-editors/selectors/editor\";\r\nimport { circuitNameFromIdSelector } from \"@/services/circuit-properties/selectors/circuits\";\r\n\r\nimport { paste } from \"@/actions/clipboard-paste\";\r\nimport { copySelection } from \"@/actions/selection-copy\";\r\nimport { deleteSelection } from \"@/actions/selection-delete\";\r\nimport { selectAll } from \"@/actions/select-all\";\r\nimport { undo } from \"@/actions/undo\";\r\nimport { redo } from \"@/actions/redo\";\r\nimport { circuitEditorReceiveFocus } from \"@/actions/circuit-editor-receive-focus\";\r\nimport { stepSim } from \"@/actions/sim-step\";\r\n\r\nimport CircuitNodeBreadcrumb from \"@/components/CircuitNodeBreadcrumb\";\r\nimport CircuitField from \"@/components/CircuitEditor\";\r\nimport TesselWindow from \"@/components/Tessel/TesselWindow\";\r\n\r\nimport keymap, {\r\n  KeymapHandler,\r\n  KEYMAP_SIM_STEP,\r\n  KEYMAP_COPY,\r\n  KEYMAP_PASTE,\r\n  KEYMAP_DELETE,\r\n  KEYMAP_SELECT_ALL,\r\n  KEYMAP_UNDO,\r\n  KEYMAP_REDO,\r\n} from \"./keymap\";\r\n\r\nexport interface CircuitEditorWindowProps {\r\n  editorId: string;\r\n}\r\nconst CircuitEditorWindow: React.FC<CircuitEditorWindowProps> = ({\r\n  editorId,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n  const { circuitId, elementIdPath } = useSelector((state) =>\r\n    circuitEditorStateFromIdSelector(state, editorId)\r\n  ) ?? { circuitId: null, elementIdPath: [] };\r\n\r\n  const circuitName =\r\n    useSelector((state) => circuitNameFromIdSelector(state, circuitId)) ??\r\n    \"<Circuit Missing>\";\r\n\r\n  // FIXME: Move key handling into CircuitEditor\r\n  const keyHandlers = React.useMemo(() => {\r\n    function createEventDispatcher(action: AnyAction): HotkeyHandler {\r\n      return (e?: KeyboardEvent) => {\r\n        if (e) {\r\n          if (e.defaultPrevented) {\r\n            return;\r\n          }\r\n          e.preventDefault();\r\n        }\r\n        dispatch(action);\r\n      };\r\n    }\r\n    const keyHandlers: KeymapHandler = {\r\n      [KEYMAP_SIM_STEP]: createEventDispatcher(stepSim()),\r\n      [KEYMAP_SELECT_ALL]: createEventDispatcher(selectAll()),\r\n      [KEYMAP_COPY]: createEventDispatcher(copySelection()),\r\n      [KEYMAP_PASTE]: createEventDispatcher(paste()),\r\n      [KEYMAP_DELETE]: createEventDispatcher(deleteSelection()),\r\n      [KEYMAP_UNDO]: createEventDispatcher(undo()),\r\n      [KEYMAP_REDO]: createEventDispatcher(redo()),\r\n    };\r\n    return keyHandlers;\r\n  }, [dispatch]);\r\n\r\n  const onViewActivated = React.useCallback(() => {\r\n    dispatch(circuitEditorReceiveFocus(editorId));\r\n  }, [dispatch, editorId]);\r\n\r\n  return (\r\n    <TesselWindow title={`${circuitName} [Circuit]`}>\r\n      <HotKeys keyMap={keymap} handlers={keyHandlers} component={FillParent}>\r\n        <div\r\n          onFocus={onViewActivated}\r\n          className={cls(\r\n            \"circuit-field-view\",\r\n            sizing[\"fill-parent\"],\r\n            flex[\"flex-column\"]\r\n          )}\r\n        >\r\n          <CircuitNodeBreadcrumb\r\n            circuitId={circuitId}\r\n            elementIdPath={elementIdPath}\r\n          />\r\n          <CircuitField\r\n            className={cls(sizing[\"fill-parent\"], flex[\"flexitem-shrink\"])}\r\n            editorId={editorId}\r\n          />\r\n        </div>\r\n      </HotKeys>\r\n    </TesselWindow>\r\n  );\r\n};\r\n\r\nconst FillParent: React.FC = ({ children, ...props }) => {\r\n  return (\r\n    <div {...props} className={sizing[\"fill-parent\"]}>\r\n      {children}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CircuitEditorWindow;\r\n","import * as React from \"react\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport interaction from \"@/styles/interaction.module.css\";\r\n\r\nimport styles from \"./SelectionList.module.css\";\r\n\r\nexport interface SelectionListItem {\r\n  id?: string;\r\n  value: string;\r\n  label: React.ReactNode;\r\n  isSelected?: boolean;\r\n}\r\n\r\nexport interface SelectionListProps {\r\n  className?: string;\r\n  id?: string;\r\n  items: SelectionListItem[];\r\n  onItemSelected(value: string): void;\r\n}\r\n\r\nconst SelectionList: React.FC<SelectionListProps> = ({\r\n  className,\r\n  id,\r\n  items,\r\n  onItemSelected,\r\n}) => {\r\n  return (\r\n    <ul\r\n      id={id}\r\n      className={cls(\"selection-list\", styles[\"selection-list\"], className)}\r\n    >\r\n      {items.map((item) => (\r\n        <SelectionListItem\r\n          key={item.value}\r\n          {...item}\r\n          onItemSelected={onItemSelected}\r\n        />\r\n      ))}\r\n    </ul>\r\n  );\r\n};\r\n\r\nexport default SelectionList;\r\n\r\ninterface SelectionListItemProps extends SelectionListItem {\r\n  onItemSelected(value: string): void;\r\n}\r\n\r\nconst SelectionListItem: React.FC<SelectionListItemProps> = ({\r\n  id,\r\n  value,\r\n  label,\r\n  isSelected,\r\n  onItemSelected,\r\n}) => {\r\n  const onClick = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.defaultPrevented) {\r\n        return;\r\n      }\r\n\r\n      e.preventDefault();\r\n      onItemSelected(value);\r\n    },\r\n    [onItemSelected, value]\r\n  );\r\n\r\n  return (\r\n    <li\r\n      id={id}\r\n      className={cls(\r\n        \"selection-list-item\",\r\n        styles[\"selection-list-item\"],\r\n        isSelected && styles[\"selection-list-item--selected\"]\r\n      )}\r\n      onClick={onClick}\r\n    >\r\n      <div\r\n        className={cls(\r\n          styles[\"selection-list-item-content\"],\r\n          interaction[\"text-unselectable\"]\r\n        )}\r\n      >\r\n        {label}\r\n      </div>\r\n    </li>\r\n  );\r\n};\r\n","// extracted by mini-css-extract-plugin\nexport default {\"selection-list\":\"selection-list--3yujH\",\"selection-list-item\":\"selection-list-item--errDr\",\"selection-list-item--selected\":\"selection-list-item--selected--3MkqB\",\"selection-list-item-content\":\"selection-list-item-content--321YU\"};","import SelectionList from \"./SelectionList\";\r\nexport * from \"./SelectionList\";\r\nexport default SelectionList;\r\n","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport sizing from \"@/styles/sizing.module.css\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { deleteCircuit } from \"@/actions/circuit-delete\";\r\nimport { viewCircuit } from \"@/actions/view-circuit\";\r\nimport { addCircuit } from \"@/actions/circuit-add\";\r\nimport { renameCircuit } from \"@/actions/circuit-rename\";\r\n\r\nimport {\r\n  circuitNameFromIdSelector,\r\n  circuitNamesByIdSelector,\r\n} from \"@/services/circuit-properties/selectors/circuits\";\r\nimport { ROOT_CIRCUIT_ID } from \"@/services/circuits/constants\";\r\n\r\nimport { useContextMenu } from \"@/components/ContextMenu\";\r\nimport Menu from \"@/components/Menus/Menu\";\r\nimport MenuItem from \"@/components/Menus/MenuItem\";\r\nimport DividerMenuItem from \"@/components/Menus/DividerMenuItem\";\r\nimport SelectionList, { SelectionListItem } from \"@/components/SelectionList\";\r\nimport EditableText from \"@/components/EditableText\";\r\nimport TesselWindow from \"@/components/Tessel/TesselWindow\";\r\n\r\nimport { getCircuitListItemHtmlId } from \"./ids\";\r\n\r\nimport styles from \"./CircuitsTreeWindow.module.css\";\r\n\r\nconst CircuitsTreeWindow: React.FC = () => {\r\n  const dispatch = useDispatch();\r\n\r\n  const circuitNamesById = useSelector(circuitNamesByIdSelector);\r\n\r\n  const { openContextMenu, renderContextMenu } = useContextMenu();\r\n\r\n  const onCircuitSelected = React.useCallback(\r\n    (circuitId: string) => {\r\n      dispatch(viewCircuit(circuitId));\r\n    },\r\n    [dispatch]\r\n  );\r\n\r\n  const onContextMenu = React.useCallback(\r\n    (e: React.MouseEvent<HTMLDivElement>) => {\r\n      e.preventDefault();\r\n      openContextMenu(e);\r\n    },\r\n    [openContextMenu]\r\n  );\r\n\r\n  const listItems: SelectionListItem[] = React.useMemo(\r\n    () =>\r\n      Object.keys(circuitNamesById).map((circuitId) => {\r\n        return {\r\n          id: getCircuitListItemHtmlId(circuitId),\r\n          value: circuitId,\r\n          label: <CircuitTreeNodeCircuitLabel circuitId={circuitId} />,\r\n        };\r\n      }),\r\n    [circuitNamesById]\r\n  );\r\n\r\n  return (\r\n    <TesselWindow\r\n      id=\"circuit-list-window\"\r\n      title=\"Circuits\"\r\n      className={cls(styles.circuitstree)}\r\n    >\r\n      <div className={sizing[\"fill-parent\"]} onContextMenu={onContextMenu}>\r\n        <SelectionList\r\n          className={sizing[\"fill-parent\"]}\r\n          id=\"circuit-list\"\r\n          items={listItems}\r\n          onItemSelected={onCircuitSelected}\r\n        />\r\n      </div>\r\n      {renderContextMenu(<CircuitTreeContextMenu />)}\r\n    </TesselWindow>\r\n  );\r\n};\r\n\r\nexport default CircuitsTreeWindow;\r\n\r\ninterface CircuitTreeNodeLabelProps {\r\n  circuitId: string;\r\n}\r\n\r\nconst CircuitTreeNodeCircuitLabel: React.FC<CircuitTreeNodeLabelProps> = ({\r\n  circuitId,\r\n}) => {\r\n  const dispatch = useDispatch();\r\n  const circuitName = useSelector((state) =>\r\n    circuitNameFromIdSelector(state, circuitId)\r\n  );\r\n  const [isRenaming, setIsRenaming] = React.useState(false);\r\n\r\n  const { openContextMenu, renderContextMenu } = useContextMenu();\r\n\r\n  const onRequestRename = React.useCallback(() => {\r\n    if (circuitId === ROOT_CIRCUIT_ID) {\r\n      return;\r\n    }\r\n    setIsRenaming(true);\r\n  }, [circuitId]);\r\n\r\n  const onCancelRename = React.useCallback(() => {\r\n    setIsRenaming(false);\r\n  }, []);\r\n\r\n  const onRename = React.useCallback(\r\n    (newName) => {\r\n      dispatch(renameCircuit(circuitId, newName));\r\n      setIsRenaming(false);\r\n    },\r\n    [circuitId, dispatch]\r\n  );\r\n\r\n  const onOpenNewWindow = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      e.preventDefault();\r\n      dispatch(viewCircuit(circuitId, null, { newWindow: true }));\r\n    },\r\n    [circuitId, dispatch]\r\n  );\r\n\r\n  const onDelete = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      e.preventDefault();\r\n      dispatch(deleteCircuit(circuitId));\r\n    },\r\n    [dispatch, circuitId]\r\n  );\r\n\r\n  const onContextMenu = React.useCallback(\r\n    (e: React.MouseEvent<HTMLElement>) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      openContextMenu(e);\r\n    },\r\n    [openContextMenu]\r\n  );\r\n\r\n  return (\r\n    <div\r\n      className={styles[\"circuitstree-item\"]}\r\n      onContextMenu={onContextMenu}\r\n      onDoubleClick={onRequestRename}\r\n    >\r\n      <EditableText\r\n        defaultValue={circuitName}\r\n        isEditing={isRenaming}\r\n        onRequestEdit={onRequestRename}\r\n        onCommit={onRename}\r\n        onCancel={onCancelRename}\r\n      />\r\n      {renderContextMenu(\r\n        <Menu>\r\n          {circuitId !== ROOT_CIRCUIT_ID && (\r\n            <>\r\n              <MenuItem onClick={onRequestRename}>Rename Circuit</MenuItem>\r\n              <DividerMenuItem />\r\n            </>\r\n          )}\r\n          <MenuItem onClick={onOpenNewWindow}>Open in New Window</MenuItem>\r\n          {circuitId !== ROOT_CIRCUIT_ID && (\r\n            <>\r\n              <DividerMenuItem />\r\n              <MenuItem onClick={onDelete}>Delete Circuit</MenuItem>\r\n            </>\r\n          )}\r\n        </Menu>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst CircuitTreeContextMenu: React.FC = () => {\r\n  const dispatch = useDispatch();\r\n  const onNewCircuit = React.useCallback(() => {\r\n    dispatch(addCircuit());\r\n  }, [dispatch]);\r\n\r\n  return (\r\n    <Menu>\r\n      <MenuItem onClick={onNewCircuit}>New Circuit</MenuItem>\r\n    </Menu>\r\n  );\r\n};\r\n","// extracted by mini-css-extract-plugin\nexport default {\"circuitstree\":\"circuitstree--QeaI9\",\"circuitstree-item\":\"circuitstree-item--22dzG\"};","import Tooltip from \"./Tooltip\";\r\nexport default Tooltip;\r\n","import * as React from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\n\r\nimport { Options, VirtualElement } from \"@popperjs/core\";\r\nimport { usePopper } from \"react-popper\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nexport interface PopoverProps {\r\n  className?: string;\r\n  anchorEl: Element | VirtualElement | null;\r\n  placement?: Options[\"placement\"];\r\n  isOpen: boolean;\r\n}\r\n\r\nimport styles from \"./Tooltip.module.css\";\r\n\r\nconst Tooltip: React.FC<PopoverProps> = ({\r\n  className,\r\n  isOpen,\r\n  anchorEl,\r\n  placement = \"auto\",\r\n  children,\r\n}) => {\r\n  const [popoverRef, setPopoverRef] = React.useState<HTMLDivElement | null>(\r\n    null\r\n  );\r\n  const [arrowRef, setArrowRef] = React.useState<HTMLDivElement | null>(null);\r\n\r\n  const { attributes, styles: popperStyles } = usePopper(\r\n    isOpen ? anchorEl : null,\r\n    popoverRef,\r\n    {\r\n      placement,\r\n      modifiers: [\r\n        {\r\n          name: \"arrow\",\r\n          options: {\r\n            element: arrowRef,\r\n          },\r\n        },\r\n        {\r\n          name: \"offset\",\r\n          options: {\r\n            offset: [0, 8],\r\n          },\r\n        },\r\n      ],\r\n    }\r\n  );\r\n\r\n  if (!isOpen) {\r\n    return null;\r\n  }\r\n\r\n  return createPortal(\r\n    <div\r\n      ref={setPopoverRef}\r\n      className={cls(styles[\"tooltip\"], className)}\r\n      style={popperStyles.popper}\r\n      role=\"tooltip\"\r\n      {...attributes.popper}\r\n    >\r\n      {children}\r\n      <div\r\n        ref={setArrowRef}\r\n        data-popper-arrow\r\n        className={styles[\"tooltip-arrow\"]}\r\n        style={popperStyles.arrow}\r\n        {...attributes.arrow}\r\n      />\r\n    </div>,\r\n    document.body\r\n  );\r\n};\r\n\r\nexport default Tooltip;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"tooltip\":\"tooltip--2yxRI\",\"tooltip-arrow\":\"tooltip-arrow--2mJMo\"};","import * as React from \"react\";\r\nimport uniq from \"lodash/uniq\";\r\nimport { useDrag } from \"react-dnd\";\r\n\r\nimport interaction from \"@/styles/interaction.module.css\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { ElementDefinition } from \"@/elements/types\";\r\nimport { getNodeVisualElement } from \"@/elements/visuals\";\r\n\r\nimport {\r\n  elementDefinitionFromTypeSelector,\r\n  elementDefinitionsSelector,\r\n} from \"@/services/element-types/selectors/element-types\";\r\n\r\nimport { newElementDragObject } from \"@/components/CircuitEditor/drag-items/new-element\";\r\nimport TesselWindow from \"@/components/Tessel/TesselWindow\";\r\nimport Tooltip from \"@/components/Tooltip\";\r\n\r\nimport styles from \"./ElementTrayWindow.module.css\";\r\n\r\nconst CategoryNames: Record<ElementDefinition[\"category\"], string> = {\r\n  \"input-output\": \"I/O\",\r\n  \"integrated-circuit\": \"Integrated Circuits\",\r\n  logic: \"Logic\",\r\n};\r\n\r\nconst ElementTrayWindow: React.FC = () => {\r\n  const elementDefinitions = useSelector(elementDefinitionsSelector);\r\n  const categories = uniq(elementDefinitions.map((x) => x.category));\r\n  const [search, setSearch] = React.useState(\"\");\r\n  const onSearchChanged = React.useCallback(\r\n    (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      setSearch(e.target.value.toLowerCase());\r\n    },\r\n    []\r\n  );\r\n\r\n  return (\r\n    <TesselWindow\r\n      id=\"element-tray\"\r\n      title=\"Elements\"\r\n      className={styles[\"element-tray\"]}\r\n    >\r\n      <div>\r\n        <input\r\n          className={styles[\"element-tray-search\"]}\r\n          type=\"text\"\r\n          value={search}\r\n          onChange={onSearchChanged}\r\n          placeholder=\"Search\"\r\n        />\r\n      </div>\r\n      <div className={styles[\"element-tray-element-container\"]}>\r\n        <ul className={styles[\"element-tray-element-list\"]}>\r\n          {categories.map((category) => (\r\n            <TrayCategory key={category} category={category} search={search} />\r\n          ))}\r\n        </ul>\r\n      </div>\r\n    </TesselWindow>\r\n  );\r\n};\r\nexport default ElementTrayWindow;\r\n\r\ninterface TrayCategoryProps {\r\n  category: ElementDefinition[\"category\"];\r\n  search: string;\r\n}\r\n\r\nconst TrayCategory: React.FC<TrayCategoryProps> = ({ category, search }) => {\r\n  const elementDefinitions = useSelector(elementDefinitionsSelector);\r\n  const defInCategory = elementDefinitions.filter(\r\n    (def) => def.category === category\r\n  );\r\n\r\n  function shouldShowElement(def: ElementDefinition) {\r\n    if (def.category !== category) {\r\n      return false;\r\n    }\r\n\r\n    if (\r\n      search !== null &&\r\n      def.displayName.toLowerCase().indexOf(search) === -1\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  const elements = defInCategory.filter(shouldShowElement).map((def) => {\r\n    return <TrayElement key={def.type} elementType={def.type} />;\r\n  });\r\n\r\n  if (elements.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <li className={styles[\"element-tray-category\"]}>\r\n        {CategoryNames[category]}\r\n      </li>\r\n      {elements}\r\n    </>\r\n  );\r\n};\r\n\r\ninterface TrayElementProps {\r\n  elementType: string;\r\n}\r\nconst TrayElement: React.FC<TrayElementProps> = ({ elementType }) => {\r\n  const [liRef, setLiRef] = React.useState<HTMLElement | null>(null);\r\n  const def = useSelector((state) =>\r\n    elementDefinitionFromTypeSelector(state, elementType)\r\n  );\r\n\r\n  const [showTooltip, setShowTooltip] = React.useState(false);\r\n  const onShowTooltip = React.useCallback((e: React.MouseEvent) => {\r\n    e.preventDefault();\r\n    setShowTooltip(true);\r\n  }, []);\r\n  const onHideTooltip = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      if (e.target !== liRef) {\r\n        return;\r\n      }\r\n      setShowTooltip(false);\r\n    },\r\n    [liRef]\r\n  );\r\n\r\n  const [, dragRef] = useDrag({\r\n    item: newElementDragObject(elementType),\r\n  });\r\n\r\n  let elementTrayVisual: JSX.Element;\r\n  let displayName = elementType;\r\n  let viewBox = \"0 0 50 50\";\r\n  if (def) {\r\n    const { trayComponent, hitRect } = def.visual;\r\n    if (trayComponent) {\r\n      const TrayComponent = trayComponent;\r\n      elementTrayVisual = <TrayComponent />;\r\n    } else {\r\n      elementTrayVisual = getNodeVisualElement(\r\n        undefined,\r\n        [],\r\n        undefined,\r\n        def.visual\r\n      );\r\n      viewBox = `${hitRect.p1.x} ${hitRect.p1.y} ${hitRect.p2.x} ${hitRect.p2.y}`;\r\n    }\r\n    displayName = def.displayName;\r\n  } else {\r\n    elementTrayVisual = <NodeTrayErrorComponent />;\r\n  }\r\n\r\n  return (\r\n    <li\r\n      id={`element-tray--element-${elementType}`}\r\n      ref={(ref) => {\r\n        setLiRef(ref);\r\n        dragRef(ref);\r\n      }}\r\n      className={styles[\"element-tray-item\"]}\r\n      onClick={onShowTooltip}\r\n      onMouseOut={onHideTooltip}\r\n    >\r\n      <Tooltip placement=\"top\" isOpen={showTooltip} anchorEl={liRef}>\r\n        Click and drag to create a new circuit element.\r\n      </Tooltip>\r\n      <span className={styles[\"element-tray-item-preview\"]}>\r\n        <svg width={30} height={30} viewBox={viewBox}>\r\n          {elementTrayVisual}\r\n        </svg>\r\n      </span>\r\n      <span className={interaction[\"text-unselectable\"]}>{displayName}</span>\r\n    </li>\r\n  );\r\n};\r\n\r\nconst NodeTrayErrorComponent = () => (\r\n  <rect fill=\"red\" x1={0} y1={0} x2={50} y2={50} />\r\n);\r\n","// extracted by mini-css-extract-plugin\nexport default {\"element-tray\":\"element-tray--2OmR6\",\"element-tray-search\":\"element-tray-search--2PYcp\",\"element-tray-element-container\":\"element-tray-element-container--1jqen\",\"element-tray-element-list\":\"element-tray-element-list--3RXLA\",\"element-tray-category\":\"element-tray-category--3K8sv\",\"element-tray-item\":\"element-tray-item--32gev\",\"element-tray-item-preview\":\"element-tray-item-preview--12k1m\"};","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { cls } from \"@/utils\";\r\n\r\nimport sizing from \"@/styles/sizing.module.css\";\r\nimport flex from \"@/styles/flex.module.css\";\r\n\r\nimport { rearrangeLayout } from \"@/actions/layout-rearrange\";\r\nimport { circuitEditorDragAbort } from \"@/actions/circuit-editor-drag-abort\";\r\nimport { navigatePage } from \"@/actions/page-navigate\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useNativeEvent } from \"@/hooks/useNativeEvent\";\r\n\r\nimport Tessel, { TesselValue, TesselWindowItem } from \"@/components/Tessel\";\r\n\r\nimport { layoutSelector } from \"@/services/ui-layout/selectors/layout\";\r\n\r\nimport ProjectEditorTitleBar from \"./components/ProjectEditorTitleBar\";\r\n\r\nimport CircuitFieldWindow from \"./windows/CircuitEditorWindow\";\r\nimport CircuitsTreeWindow from \"./windows/CircuitsTreeWindow\";\r\nimport ElementTrayWindow from \"./windows/ElementTrayWindow\";\r\n\r\nconst WindowsById: Record<string, React.ComponentType<any>> = {\r\n  \"element-tray\": ElementTrayWindow,\r\n  \"circuit-field\": CircuitFieldWindow,\r\n  \"circuits-list\": CircuitsTreeWindow,\r\n};\r\n\r\nfunction renderWindow(window: TesselWindowItem): React.ReactElement | null {\r\n  const Component = WindowsById[window.windowId];\r\n  if (!Component) {\r\n    return null;\r\n  }\r\n  return <Component {...window.windowProps} />;\r\n}\r\n\r\nconst ProjectEditorPage: React.FC = () => {\r\n  const dispatch = useDispatch();\r\n\r\n  React.useEffect(() => {\r\n    dispatch(navigatePage(\"editor\"));\r\n  }, [dispatch]);\r\n\r\n  const layout = useSelector(layoutSelector);\r\n  const onLayoutChange = React.useCallback(\r\n    (layout: TesselValue) => {\r\n      dispatch(rearrangeLayout(layout));\r\n    },\r\n    [dispatch]\r\n  );\r\n\r\n  // A bit hacky, but we need some singleton component to install a global check\r\n  // to look for drag cancellations when we mouse up outside of any circuit editor.\r\n  const onMouseUp = React.useCallback(\r\n    (e: MouseEvent) => {\r\n      let element: Element | null = e.target as Element;\r\n      while (element != null) {\r\n        if (element.classList.contains(\"circuit-editor\")) {\r\n          return;\r\n        }\r\n        element = element.parentElement;\r\n      }\r\n      dispatch(circuitEditorDragAbort());\r\n    },\r\n    [dispatch]\r\n  );\r\n\r\n  useNativeEvent({ current: document.body }, \"mouseup\", onMouseUp);\r\n\r\n  return (\r\n    <div className={cls(sizing[\"fill-parent\"], flex[\"flex-column\"])}>\r\n      <ProjectEditorTitleBar className={flex[\"flexitem-fix\"]} />\r\n      <div className={cls(sizing[\"fill-parent\"], flex[\"flexitem-shrink\"])}>\r\n        <Tessel\r\n          className={cls(\"project-editor\", sizing[\"fill-parent\"])}\r\n          rootItem={layout}\r\n          onLayoutChange={onLayoutChange}\r\n          renderWindow={renderWindow}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ProjectEditorPage;\r\n","import ProjectEditorPage from \"./ProjectEditorPage\";\r\nexport default ProjectEditorPage;\r\n","import ProjectImporterPage from \"./ProjectImporterPage\";\r\nexport default ProjectImporterPage;\r\n","import { importProjectLink } from \"@/actions/project-import-link\";\r\nimport * as React from \"react\";\r\n\r\nimport { useDispatch } from \"react-redux\";\r\nimport { RouteChildrenProps } from \"react-router-dom\";\r\n\r\nconst ProjectImporterPage: React.FC<RouteChildrenProps> = ({ location }) => {\r\n  const dispatch = useDispatch();\r\n  const [importError, setImportError] = React.useState(false);\r\n\r\n  React.useEffect(() => {\r\n    let searchParams: URLSearchParams;\r\n    try {\r\n      searchParams = new URLSearchParams(location.search);\r\n    } catch (e) {\r\n      setImportError(true);\r\n      return;\r\n    }\r\n\r\n    const data = searchParams.get(\"data\");\r\n    if (!data) {\r\n      setImportError(true);\r\n      return;\r\n    }\r\n\r\n    dispatch(importProjectLink(data));\r\n\r\n    // This is an effect, these are not dependencies.  Stop warning me about this.\r\n    // We only want to run on page load.\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // TODO: better styling.\r\n\r\n  if (importError) {\r\n    // TODO: Better error message\r\n    return <div>Failed to import project</div>;\r\n  }\r\n\r\n  return <div>Importing Project...</div>;\r\n};\r\n\r\nexport default ProjectImporterPage;\r\n","import * as React from \"react\";\r\n\r\nimport { Switch, Route } from \"react-router-dom\";\r\n\r\nimport HomePage from \"@/pages/HomePage\";\r\nimport ProjectEditorPage from \"@/pages/ProjectEditorPage\";\r\nimport ProjectImporterPage from \"@/pages/ProjectImporterPage\";\r\n\r\nconst Routes: React.FC = () => {\r\n  return (\r\n    <Switch>\r\n      <Route exact path=\"/\" component={HomePage} />\r\n      <Route exact path=\"/editor\" component={ProjectEditorPage} />\r\n      <Route exact path=\"/import\" component={ProjectImporterPage} />\r\n    </Switch>\r\n  );\r\n};\r\n\r\nexport default Routes;\r\n","import { createDialogSelector } from \"../utils\";\r\n\r\nexport const dialogTypeSelector = createDialogSelector((s) => s.dialogType);\r\nexport const dialogDataSelector = createDialogSelector((s) => s.data);\r\n","// extracted by mini-css-extract-plugin\nexport default {\"modal\":\"modal--25LBN\",\"modal-content\":\"modal-content--1H0T_\"};","export * from \"./Modal\";\r\nimport Modal from \"./Modal\";\r\nexport default Modal;\r\n","import { cls } from \"@/utils\";\r\nimport * as React from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { FocusOn, AutoFocusInside } from \"react-focus-on\";\r\n\r\nimport sizing from \"@/styles/sizing.module.css\";\r\n\r\nimport styles from \"./Modal.module.css\";\r\n\r\nexport interface ModalProps {\r\n  className?: string;\r\n  isOpen: boolean;\r\n  onRequestClose?(): void;\r\n}\r\n\r\nconst Modal: React.FC<ModalProps> = ({\r\n  className,\r\n  isOpen,\r\n  onRequestClose,\r\n  children,\r\n}) => {\r\n  if (!isOpen) {\r\n    return null;\r\n  }\r\n\r\n  return createPortal(\r\n    <div className={cls(\"modal\", styles[\"modal\"])}>\r\n      <FocusOn onClickOutside={onRequestClose} onEscapeKey={onRequestClose}>\r\n        <div className={cls(styles[\"modal-content\"], className)}>\r\n          <AutoFocusInside className={sizing[\"fill-parent\"]}>\r\n            {children}\r\n          </AutoFocusInside>\r\n        </div>\r\n      </FocusOn>\r\n    </div>,\r\n    document.body\r\n  );\r\n};\r\n\r\nexport default Modal;\r\n","export * from \"./Dialog\";\r\nimport Dialog from \"./Dialog\";\r\nexport default Dialog;\r\n","import * as React from \"react\";\r\n\r\nimport Button from \"@/components/Button\";\r\nimport Modal from \"@/components/Modal\";\r\n\r\nimport styles from \"./Dialog.module.css\";\r\n\r\nexport interface DialogProps {\r\n  isOpen: boolean;\r\n  title: string;\r\n  acceptText?: string;\r\n  cancelText?: string;\r\n  footer?: React.ReactNode;\r\n  onAccept?(): void;\r\n  onCancel?(): void;\r\n}\r\n\r\nconst Dialog: React.FC<DialogProps> = ({\r\n  isOpen,\r\n  title,\r\n  acceptText,\r\n  cancelText,\r\n  onAccept,\r\n  onCancel,\r\n  footer,\r\n  children,\r\n}) => {\r\n  return (\r\n    <Modal\r\n      className={styles[\"dialog\"]}\r\n      isOpen={isOpen}\r\n      onRequestClose={onCancel}\r\n    >\r\n      <div className={styles[\"dialog-title\"]}>{title}</div>\r\n      <div>{children}</div>\r\n      <div className={styles[\"dialog-footer\"]}>\r\n        {footer}\r\n        {onCancel && (\r\n          <Button onClick={onCancel}>{cancelText ?? \"Cancel\"}</Button>\r\n        )}\r\n        {onAccept && (\r\n          <Button variant=\"primary\" onClick={onAccept}>\r\n            {acceptText ?? \"Accept\"}\r\n          </Button>\r\n        )}\r\n      </div>\r\n    </Modal>\r\n  );\r\n};\r\n\r\nexport default Dialog;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"dialog\":\"dialog--1eQi6\",\"dialog-title\":\"dialog-title--1DWsL\",\"dialog-footer\":\"dialog-footer--2hYdr\"};","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useAction } from \"@/hooks/useAction\";\r\n\r\nimport { acceptDialog } from \"@/actions/dialog-response-accept\";\r\n\r\nimport { dialogDataSelector } from \"@/services/dialog/selectors/dialog\";\r\n\r\nimport Button from \"@/components/Button\";\r\nimport Dialog from \"@/components/Dialog\";\r\n\r\nimport styles from \"./ExportProjectLinkDialog.module.css\";\r\n\r\nimport { ExportProjectLinkDialogData } from \"./types\";\r\n\r\nconst ExportProjectLinkDialog: React.FC = () => {\r\n  const onCloseDialog = useAction(acceptDialog);\r\n  const dialogData: ExportProjectLinkDialogData | null = useSelector(\r\n    dialogDataSelector\r\n  ) as any;\r\n\r\n  const projectLink = dialogData?.projectLink;\r\n\r\n  const onCopy = React.useCallback(() => {\r\n    if (!projectLink) {\r\n      return;\r\n    }\r\n    // TODO: Show link in dialog on failure\r\n    navigator.clipboard.writeText(projectLink).catch(() => {\r\n      /* do nothing */\r\n    });\r\n  }, [projectLink]);\r\n\r\n  if (!projectLink) {\r\n    return null;\r\n  }\r\n\r\n  const dialogFooter = (\r\n    <Button variant=\"primary\" onClick={onCopy}>\r\n      Copy to Clipboard\r\n    </Button>\r\n  );\r\n\r\n  return (\r\n    <Dialog\r\n      isOpen={true}\r\n      title=\"Export Project Link\"\r\n      cancelText=\"Close\"\r\n      onCancel={onCloseDialog}\r\n      footer={dialogFooter}\r\n    >\r\n      <div className={styles[\"export-link-dialog-link-container\"]}>\r\n        <code className={styles[\"export-link-dialog-link\"]}>{projectLink}</code>\r\n      </div>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default ExportProjectLinkDialog;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"export-link-dialog-link-container\":\"export-link-dialog-link-container--phwUA\",\"export-link-dialog-link\":\"export-link-dialog-link--1dOdK\"};","import * as React from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\nimport uniq from \"lodash/uniq\";\r\n\r\nimport { useAction } from \"@/hooks/useAction\";\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { acceptDialog } from \"@/actions/dialog-response-accept\";\r\nimport { cancelDialog } from \"@/actions/dialog-response-cancel\";\r\n\r\nimport { dialogDataSelector } from \"@/services/dialog/selectors/dialog\";\r\n\r\nimport Dialog from \"@/components/Dialog\";\r\nimport Checkbox from \"@/components/Checkbox\";\r\n\r\nimport styles from \"./ImportProjectCircuitsDialog.module.css\";\r\nimport { ImportProjectCircuitsDialogData } from \"./types\";\r\n\r\nconst ImportProjectCircuitsDialog: React.FC = () => {\r\n  const dispatch = useDispatch();\r\n  const dialogData: ImportProjectCircuitsDialogData | null = useSelector(\r\n    dialogDataSelector\r\n  ) as any;\r\n\r\n  const [selectedIds, setSelectedIds] = React.useState<string[]>([]);\r\n\r\n  const onCloseDialog = useAction(cancelDialog);\r\n  const onAcceptDialog = React.useCallback(() => {\r\n    dispatch(acceptDialog(selectedIds));\r\n  }, [dispatch, selectedIds]);\r\n\r\n  if (!dialogData) {\r\n    return null;\r\n  }\r\n\r\n  const { circuits } = dialogData;\r\n\r\n  return (\r\n    <Dialog\r\n      isOpen={true}\r\n      title=\"Import Circuits\"\r\n      onAccept={onAcceptDialog}\r\n      onCancel={onCloseDialog}\r\n      acceptText=\"Import Circuits\"\r\n    >\r\n      <div>\r\n        <p>Choose the circuits to import.</p>\r\n        <p>\r\n          Any chosen circuits that depend on other circuits will import their\r\n          dependencies automatically.\r\n        </p>\r\n        <p>\r\n          If any circuits already exist in your project, they will not be\r\n          re-imported.\r\n        </p>\r\n      </div>\r\n      <ul className={styles[\"import-project-circuits-list\"]}>\r\n        {circuits.map(({ circuitId, circuitName }) => (\r\n          <li key={circuitId}>\r\n            <ImportCircuitCheckbox\r\n              circuitId={circuitId}\r\n              circuitName={circuitName}\r\n              selectedIds={selectedIds}\r\n              onSetSelectedIds={setSelectedIds}\r\n            />\r\n          </li>\r\n        ))}\r\n      </ul>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\ninterface ImportCircuitCheckboxProps {\r\n  circuitId: string;\r\n  circuitName: string;\r\n  selectedIds: string[];\r\n  onSetSelectedIds(selectedIds: string[]): void;\r\n}\r\nconst ImportCircuitCheckbox: React.FC<ImportCircuitCheckboxProps> = ({\r\n  circuitId,\r\n  circuitName,\r\n  selectedIds,\r\n  onSetSelectedIds,\r\n}) => {\r\n  const onChange = React.useCallback(\r\n    (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      if (e.target.checked) {\r\n        onSetSelectedIds(uniq([...selectedIds, circuitId]));\r\n      }\r\n    },\r\n    [circuitId, onSetSelectedIds, selectedIds]\r\n  );\r\n\r\n  return (\r\n    <Checkbox onChange={onChange} value={selectedIds.indexOf(circuitId) !== -1}>\r\n      {circuitName}\r\n    </Checkbox>\r\n  );\r\n};\r\n\r\nexport default ImportProjectCircuitsDialog;\r\n","// extracted by mini-css-extract-plugin\nexport default {\"import-project-circuits-list\":\"import-project-circuits-list--2ODCz\"};","import * as React from \"react\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\n\r\nimport { dialogTypeSelector } from \"@/services/dialog/selectors/dialog\";\r\n\r\nimport { getDialogComponent } from \"@/dialogs/renderer\";\r\n\r\nconst DialogManager: React.FC = () => {\r\n  const dialogType = useSelector(dialogTypeSelector);\r\n\r\n  if (!dialogType) {\r\n    return null;\r\n  }\r\n\r\n  const DialogComponent = getDialogComponent(dialogType);\r\n  return <DialogComponent />;\r\n};\r\n\r\nexport default DialogManager;\r\n","import DialogManager from \"./DialogManager\";\r\nexport default DialogManager;\r\n","import React from \"react\";\r\nimport { DialogType } from \"./types\";\r\n\r\nimport { ExportProjectLinkDialog } from \"./dialog-types/export-project-link\";\r\nimport { ImportProjectCircuitsDialog } from \"./dialog-types/import-project-circuits\";\r\n\r\nexport function getDialogComponent(type: DialogType): React.ComponentType {\r\n  switch (type) {\r\n    case \"export-project-link\":\r\n      return ExportProjectLinkDialog;\r\n    case \"import-project-circuits\":\r\n      return ImportProjectCircuitsDialog;\r\n    default:\r\n      return unknownDialog(type);\r\n  }\r\n}\r\n\r\nfunction unknownDialog(dialogType: never): never {\r\n  throw new Error(`Unknown dialog type ${dialogType}`);\r\n}\r\n","import * as React from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { useDispatch } from \"react-redux\";\r\n\r\nimport { asArray } from \"@/arrays\";\r\n\r\nimport useSelector from \"@/hooks/useSelector\";\r\nimport { useQuerySelector } from \"@/hooks/useQuerySelector\";\r\n\r\nimport {\r\n  isTutorialActiveSelector,\r\n  tutorialAnnotationsSelector,\r\n} from \"@/services/tutorial/selectors/tutorial\";\r\nimport { AnnotatedElement } from \"@/services/tutorial/state\";\r\n\r\nimport Button from \"../Button\";\r\nimport Tooltip from \"../Tooltip\";\r\n\r\nimport styles from \"./Tutorial.module.css\";\r\n\r\nconst Tutorial: React.FC = () => {\r\n  const isTutorialActive = useSelector(isTutorialActiveSelector);\r\n  const tutorialAnnotations = useSelector(tutorialAnnotationsSelector);\r\n\r\n  if (!isTutorialActive) {\r\n    return null;\r\n  }\r\n\r\n  const annotations = tutorialAnnotations.map((annotation) => (\r\n    <Annotation key={annotation.selector} {...annotation} />\r\n  ));\r\n\r\n  const css = tutorialAnnotations\r\n    .map(\r\n      ({ selector }) => `\r\n    ${selector} {\r\n      position: relative;\r\n      z-index: 10;\r\n    }\r\n  `\r\n    )\r\n    .join(\"\\n\");\r\n\r\n  return createPortal(\r\n    <div className={styles[\"tutorial\"]}>\r\n      <div className={styles[\"tutorial-backdrop\"]} />\r\n      <style>{css}</style>\r\n      {annotations}\r\n    </div>,\r\n    document.body\r\n  );\r\n};\r\n\r\nexport default Tutorial;\r\n\r\nconst Annotation: React.FC<AnnotatedElement> = ({\r\n  selector,\r\n  message,\r\n  placement,\r\n  action = [],\r\n}) => {\r\n  const dispatch = useDispatch();\r\n\r\n  const element = useQuerySelector(selector);\r\n\r\n  React.useEffect(() => {\r\n    if (element) {\r\n      element.scrollIntoView();\r\n    }\r\n  }, [element]);\r\n\r\n  const actions = asArray(action);\r\n\r\n  if (!element || (!message && !actions.length)) {\r\n    return null;\r\n  }\r\n\r\n  const actionElements = actions.map(({ name, action }) => {\r\n    return (\r\n      <Button key={name} size=\"small\" onClick={() => dispatch(action)}>\r\n        {name}\r\n      </Button>\r\n    );\r\n  });\r\n\r\n  return (\r\n    <Tooltip\r\n      className={styles[\"tutorial-tooltip\"]}\r\n      anchorEl={element}\r\n      placement={placement}\r\n      isOpen={true}\r\n    >\r\n      {message}\r\n      {actionElements && (\r\n        <div className={styles[\"tutorial-tooltip-actions\"]}>\r\n          {actionElements}\r\n        </div>\r\n      )}\r\n    </Tooltip>\r\n  );\r\n};\r\n","import * as React from \"react\";\r\n\r\nexport function useQuerySelector(selector: string): Element | null {\r\n  const [element, setElement] = React.useState<Element | null>(null);\r\n  React.useEffect(() => {\r\n    const observer = new MutationObserver(() => {\r\n      setElement(document.querySelector(selector));\r\n    });\r\n\r\n    observer.observe(document.body, {\r\n      childList: true,\r\n      subtree: true,\r\n    });\r\n\r\n    setElement(document.querySelector(selector));\r\n\r\n    return () => {\r\n      observer.disconnect();\r\n    };\r\n  }, [selector]);\r\n\r\n  return element;\r\n}\r\n","// extracted by mini-css-extract-plugin\nexport default {\"tutorial\":\"tutorial--jscuw\",\"tutorial-tooltip\":\"tutorial-tooltip--3gwli\",\"tutorial-tooltip-actions\":\"tutorial-tooltip-actions--ENkg1\",\"tutorial-backdrop\":\"tutorial-backdrop--3I0WR\"};","import Tutorial from \"./Tutorial\";\r\nexport default Tutorial;\r\n","import * as React from \"react\";\r\nimport * as ReactDOM from \"react-dom\";\r\nimport \"resize-observer-polyfill\";\r\n\r\nimport { Provider } from \"react-redux\";\r\nimport { Router } from \"react-router-dom\";\r\n\r\nimport { DndProvider } from \"react-dnd\";\r\nimport { HTML5Backend } from \"react-dnd-html5-backend\";\r\n\r\nimport history from \"./history\";\r\nimport \"./styles\";\r\n\r\nimport { store } from \"./store\";\r\n\r\nimport App from \"./components/App\";\r\n\r\nconst rootEl = document.getElementById(\"root\");\r\n\r\nReactDOM.render(\r\n  <DndProvider backend={HTML5Backend}>\r\n    <Router history={history}>\r\n      <Provider store={store}>\r\n        <App />\r\n      </Provider>\r\n    </Router>\r\n  </DndProvider>,\r\n  rootEl\r\n);\r\n","import * as React from \"react\";\r\n\r\nimport Routes from \"@/router\";\r\n\r\nimport DialogManager from \"../DialogManager\";\r\nimport Tutorial from \"../Tutorial\";\r\n\r\nconst App: React.FC = () => {\r\n  return (\r\n    <>\r\n      <Routes />\r\n      <DialogManager />\r\n      <Tutorial />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default App;\r\n","import { Point } from \"./geometry\";\r\n\r\n// Arc code from https://stackoverflow.com/questions/5736398/how-to-calculate-the-svg-path-for-an-arc-of-a-circle\r\nexport function describeArc(\r\n  x: number,\r\n  y: number,\r\n  radius: number,\r\n  startAngle: number,\r\n  endAngle: number\r\n): string {\r\n  const start = polarToCartesian(x, y, radius, endAngle);\r\n  const end = polarToCartesian(x, y, radius, startAngle);\r\n\r\n  const largeArcFlag = endAngle - startAngle <= 180 ? \"0\" : \"1\";\r\n\r\n  const d = [\r\n    \"M\",\r\n    start.x,\r\n    start.y,\r\n    \"A\",\r\n    radius,\r\n    radius,\r\n    0,\r\n    largeArcFlag,\r\n    0,\r\n    end.x,\r\n    end.y,\r\n  ].join(\" \");\r\n\r\n  return d;\r\n}\r\n\r\nfunction polarToCartesian(\r\n  centerX: number,\r\n  centerY: number,\r\n  radius: number,\r\n  angleInDegrees: number\r\n): Point {\r\n  const angleInRadians = ((angleInDegrees - 90) * Math.PI) / 180.0;\r\n\r\n  return {\r\n    x: centerX + radius * Math.cos(angleInRadians),\r\n    y: centerY + radius * Math.sin(angleInRadians),\r\n  };\r\n}\r\n"],"sourceRoot":""}